#!/bin/bash
set -e

echo "========================================="
echo "üîß –°–∫—Ä–∏–ø—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö"
echo "========================================="
echo ""

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "–®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è"
echo "-----------------------------------"

if [ ! -f .env ]; then
    echo -e "${RED}‚úó –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
    if [ -f .env.example ]; then
        echo -e "${YELLOW}–ö–æ–ø–∏—Ä—É—é .env.example –≤ .env...${NC}"
        cp .env.example .env
        echo -e "${GREEN}‚úì .env —Å–æ–∑–¥–∞–Ω${NC}"
    else
        echo -e "${RED}‚úó .env.example —Ç–æ–∂–µ –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
        exit 1
    fi
else
    echo -e "${GREEN}‚úì –§–∞–π–ª .env —Å—É—â–µ—Å—Ç–≤—É–µ—Ç${NC}"
fi

echo ""
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ DATABASE_URL –≤ .env:"
grep DATABASE_URL .env || echo -e "${RED}DATABASE_URL –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"

echo ""
echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ ./data/ –î–û –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏:"
ls -lh ./data/

echo ""
echo "–®–∞–≥ 2: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
echo "-----------------------------------"
docker-compose down
echo -e "${GREEN}‚úì –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã${NC}"

echo ""
echo "–®–∞–≥ 3: –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –ë–ï–ó –∫–µ—à–∞"
echo "-----------------------------------"
echo -e "${YELLOW}–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç...${NC}"
docker-compose build --no-cache seller-platform
echo -e "${GREEN}‚úì –û–±—Ä–∞–∑ –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω${NC}"

echo ""
echo "–®–∞–≥ 4: –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
echo "-----------------------------------"
docker-compose up -d seller-platform
echo -e "${GREEN}‚úì –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω${NC}"

echo ""
echo "–®–∞–≥ 5: –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (10 —Å–µ–∫—É–Ω–¥)"
echo "-----------------------------------"
for i in {10..1}; do
    echo -n "$i "
    sleep 1
done
echo ""

echo ""
echo "–®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏"
echo "-----------------------------------"
docker-compose logs seller-platform | grep -E "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö|–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä|–ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î"

echo ""
echo "–®–∞–≥ 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
echo "-----------------------------------"
if [ -f ./data/seller_platform.db ]; then
    DB_SIZE=$(du -h ./data/seller_platform.db | cut -f1)
    echo -e "${GREEN}‚úì –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞!${NC}"
    echo "  –ü—É—Ç—å: ./data/seller_platform.db"
    echo "  –†–∞–∑–º–µ—Ä: $DB_SIZE"

    echo ""
    echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ ./data/ –ü–û–°–õ–ï –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏:"
    ls -lh ./data/

    echo ""
    echo -e "${GREEN}=========================================${NC}"
    echo -e "${GREEN}‚úì –£–°–ü–ï–®–ù–û! –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ${NC}"
    echo -e "${GREEN}=========================================${NC}"
    echo ""
    echo "–¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É:"
    echo "  URL: http://–≤–∞—à-—Å–µ—Ä–≤–µ—Ä:5001"
    echo "  –õ–æ–≥–∏–Ω: admin"
    echo "  –ü–∞—Ä–æ–ª—å: admin123"
else
    echo -e "${RED}‚úó –û–®–ò–ë–ö–ê! –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ù–ï —Å–æ–∑–¥–∞–Ω–∞ –≤ ./data/${NC}"
    echo ""
    echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ ./data/ –ü–û–°–õ–ï –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏:"
    ls -lh ./data/

    echo ""
    echo "–ü–æ–ª–Ω—ã–µ –ª–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
    docker-compose logs seller-platform | tail -50

    echo ""
    echo -e "${RED}=========================================${NC}"
    echo -e "${RED}–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞${NC}"
    echo -e "${RED}=========================================${NC}"
    exit 1
fi
