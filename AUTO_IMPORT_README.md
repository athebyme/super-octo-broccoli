# Система автоимпорта товаров

## Обзор

Система автоимпорта позволяет автоматически загружать товары из внешних источников (CSV файлы) в платформу Wildberries с валидацией, маппингом категорий и обработкой изображений.

## Основные возможности

- ✅ **Парсинг CSV файлов** - поддержка различных форматов (sexoptovik, fixprice, custom)
- ✅ **Автоматический маппинг категорий** - умное сопоставление категорий источника с категориями WB
- ✅ **Обработка изображений** - автоматическое изменение размера до 1200x1200 с паддингом
- ✅ **Валидация товаров** - проверка всех обязательных полей перед импортом
- ✅ **Фильтр дубликатов** - импорт только новых товаров
- ✅ **Поддержка блюренных изображений** - приоритет цензурированных фото
- ✅ **Гибкая настройка артикулов** - шаблоны для формирования артикулов
- ✅ **Автоматическое расписание** - периодический импорт (раз в N часов)

## Установка

### 1. Установить зависимости

```bash
pip install -r requirements.txt
```

### 2. Применить миграцию базы данных

```bash
python migrate_add_auto_import.py
```

Эта команда создаст следующие таблицы:
- `auto_import_settings` - настройки автоимпорта для продавца
- `imported_products` - импортированные товары
- `category_mappings` - маппинг категорий источника → WB

### 3. Добавить роуты в приложение

В файле `seller_platform.py` добавьте после инициализации app:

```python
# Регистрация роутов автоимпорта
from auto_import_routes import register_auto_import_routes
register_auto_import_routes(app)
```

## Формат CSV файла (sexoptovik)

CSV файл должен содержать следующие колонки (без заголовков):

| № | Название | Описание | Пример |
|---|----------|----------|--------|
| 1 | ID товара | Формат: id-<id>-<код_продавца> | id-12345-SP001 |
| 2 | Артикул поставщика | Модель товара | ART-001 |
| 3 | Название | Название товара | Вибратор классический |
| 4 | Категория | Через # разные категории | Вибраторы#Игрушки для взрослых |
| 5 | Бренд | Название бренда | LoveShop |
| 6 | Страна | Страна производства | Китай |
| 7 | Общая категория | Верхнеуровневая категория | Игрушки |
| 8 | Особенности | Дополнительные характеристики | Водонепроницаемый |
| 9 | Пол | Целевой пол | Унисекс |
| 10 | Цвет | Через запятую | Розовый,Фиолетовый |
| 11 | Размеры | Размеры товара | One Size |
| 12 | Комплект | Что входит в комплект | Товар,Батарейки,Инструкция |
| 13 | (пусто) | Резерв | - |
| 14 | Фото | Номера фотографий через запятую | 1,2,3,4 |
| 15 | Баркод | Баркоды через запятую | 1234567890123 |
| 16 | Материал | Материалы через запятую | Силикон,ABS пластик |
| 17 | Батарейки | Информация о батарейках | 2xAAA, в комплекте |

### Формат URLs фотографий

**Без цензуры:**
```
http://sexoptovik.ru/_project/user_images/prods_res/{id}/{id}_{номер}_1200.jpg
```

**С цензурой (блюр):**
```
https://x-story.ru/mp/_project/img_sx0_1200/{id}_{номер}_1200.jpg
```

Система автоматически проверяет наличие блюренных фото и использует их при наличии.

## Настройка

### 1. Основные настройки

- **Код поставщика** (обязательно) - используется для формирования артикулов
- **Шаблон артикула** - паттерн для генерации артикулов. Доступные переменные:
  - `{product_id}` - ID товара из CSV
  - `{supplier_code}` - код поставщика

  Пример: `id-{product_id}-{supplier_code}` → `id-12345-SP001`

- **URL CSV файла** (обязательно) - адрес файла с товарами
- **Тип источника** - sexoptovik / fixprice / custom

### 2. Параметры импорта

- **Импортировать только новые** - пропускать уже импортированные товары
- **Автоматически активировать** - делать товары активными сразу после импорта
- **Использовать блюр** - приоритет цензурированным фото
- **Интервал автоимпорта** - частота автоматического импорта (1-168 часов)

### 3. Обработка изображений

- **Изменение размера** - автоматическое приведение к 1200x1200
- **Цвет фона** - white / black / gray для паддинга

## Маппинг категорий

Система автоматически сопоставляет категории из источника с категориями WB.

### Предустановленные маппинги (sexoptovik)

| Категория источника | WB Category | Subject ID | Confidence |
|---------------------|-------------|------------|------------|
| Вибраторы | Вибраторы | 5994 | 1.0 |
| Фаллоимитаторы | Фаллоимитаторы | 5995 | 1.0 |
| Белье эротическое | Белье | 3 | 0.8 |
| Костюмы эротические | Эротические костюмы | 6007 | 1.0 |
| Игрушки для взрослых | Игрушки для взрослых | 5993 | 0.9 |
| Массажеры | Массажеры | 469 | 0.7 |
| Лубриканты | Лубриканты | 6003 | 1.0 |
| Смазки | Лубриканты | 6003 | 1.0 |
| Наручники | Наручники и фиксаторы | 5998 | 1.0 |
| Маски | Маски и повязки | 6000 | 0.8 |
| Стимуляторы | Стимуляторы | 5996 | 0.9 |
| Анальные игрушки | Анальные игрушки | 5997 | 1.0 |
| Вакуумные помпы | Вакуумные помпы | 5999 | 1.0 |
| Кольца | Эрекционные кольца | 6001 | 0.9 |

### Добавление новых маппингов

Маппинги можно добавлять через админ-панель или напрямую в БД:

```python
from models import CategoryMapping, db

mapping = CategoryMapping(
    source_category="Новая категория",
    source_type="sexoptovik",
    wb_category_name="Категория WB",
    wb_subject_id=1234,
    wb_subject_name="Название предмета WB",
    priority=0,
    is_auto_mapped=False,
    confidence_score=1.0
)
db.session.add(mapping)
db.session.commit()
```

## Валидация товаров

Перед импортом каждый товар проходит валидацию:

### Обязательные поля:
- ✅ Название (мин. 3 символа)
- ✅ Артикул
- ✅ Категория
- ✅ Бренд
- ✅ Хотя бы одна фотография (макс. 30)
- ✅ Хотя бы один баркод
- ✅ Subject ID (категория WB)

### Автоматические дефолты:
- Размер: "One Size" (если не указан)
- Цвет: "Разноцветный" (если не указан)

## Использование

### Через веб-интерфейс

1. Перейдите в **Автоимпорт** из главного меню
2. Настройте параметры в **Настройки**
3. Нажмите **Запустить импорт**
4. Отслеживайте прогресс на дашборде
5. Просматривайте импортированные товары в **Все товары**

### Программно

```python
from models import Seller, AutoImportSettings
from auto_import_manager import AutoImportManager

# Получить продавца и настройки
seller = Seller.query.first()
settings = AutoImportSettings.query.filter_by(seller_id=seller.id).first()

# Запустить импорт
manager = AutoImportManager(seller, settings)
stats = manager.run_import()

print(f"Импортировано: {stats['imported']}")
print(f"Пропущено: {stats['skipped']}")
print(f"Ошибок: {stats['failed']}")
```

## Статусы товаров

| Статус | Описание |
|--------|----------|
| `pending` | Товар обнаружен, ожидает обработки |
| `validated` | Товар прошел валидацию, готов к импорту в WB |
| `imported` | Товар успешно импортирован в WB |
| `failed` | Товар не прошел валидацию или импорт |

## Структура проекта

```
super-octo-broccoli/
├── models.py                    # Модели БД (AutoImportSettings, ImportedProduct, CategoryMapping)
├── auto_import_manager.py       # Основная логика автоимпорта
│   ├── CSVProductParser         # Парсер CSV файлов
│   ├── CategoryMapper           # Маппинг категорий
│   ├── ImageProcessor           # Обработка изображений
│   ├── ProductValidator         # Валидация товаров
│   └── AutoImportManager        # Главный менеджер
├── auto_import_routes.py        # Flask роуты для автоимпорта
├── migrate_add_auto_import.py   # Миграция БД
└── templates/
    ├── auto_import_dashboard.html    # Дашборд
    ├── auto_import_settings.html     # Настройки
    ├── auto_import_products.html     # Список товаров
    └── auto_import_product_detail.html  # Детали товара
```

## Логирование

Все операции логируются в `seller_platform.log`:

```python
import logging
logger = logging.getLogger(__name__)

logger.info("Импорт запущен")
logger.warning("Товар не прошел валидацию")
logger.error("Ошибка скачивания CSV", exc_info=True)
```

## Безопасность

- ✅ API ключи шифруются в БД
- ✅ Валидация всех входных данных
- ✅ Проверка MIME-типов для изображений
- ✅ Ограничение размеров файлов
- ✅ Санитизация URL'ов

## Производительность

- Импорт выполняется в фоновом потоке
- Пакетная обработка товаров
- Кеширование маппингов категорий
- Оптимизированные запросы к БД

## Известные ограничения

1. **Формат CSV** - поддерживается только формат sexoptovik (без заголовков)
2. **Размер файла** - рекомендуется до 10000 товаров за импорт
3. **Изображения** - поддерживаются только JPEG форматы
4. **Скорость** - ~50-100 товаров/минуту (зависит от сети и размера фото)

## Roadmap

- [ ] Поддержка других форматов CSV (с заголовками)
- [ ] Автогенерация описаний через нейронку
- [ ] Массовое обновление существующих товаров
- [ ] Интеграция с API поставщиков
- [ ] Отчеты и аналитика по импорту
- [ ] Экспорт в Excel для ручной правки

## Troubleshooting

### Ошибка: "Settings not configured"
Убедитесь, что указаны URL CSV файла и код поставщика в настройках.

### Ошибка: "Import is already running"
Дождитесь завершения текущего импорта или перезапустите приложение.

### Товары не импортируются
1. Проверьте формат CSV файла
2. Убедитесь, что категории мапятся корректно
3. Просмотрите ошибки валидации в деталях товара

### Проблемы с изображениями
1. Проверьте доступность URL'ов фотографий
2. Убедитесь, что изображения в формате JPEG
3. Проверьте настройки обработки изображений

## Поддержка

По вопросам и багам обращайтесь:
- GitHub Issues: [ссылка на репозиторий]
- Email: support@example.com

## Лицензия

[Ваша лицензия]
