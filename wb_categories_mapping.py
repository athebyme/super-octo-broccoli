"""
Полный маппинг категорий WB для товаров для взрослых
Основано на официальном API WB
"""

# Полный список категорий WB для взрослых (parentID=5038)
WB_ADULT_CATEGORIES = {
    7732: "Аксессуары для игрушек эротик",
    5065: "Анальные бусы",
    5193: "Анальные груши",
    5068: "Анальные крюки",
    5064: "Анальные пробки",
    5066: "Анальные шарики",
    5784: "Ароматизаторы эротик",
    5051: "Бандажи эротик",
    5783: "Благовония эротик",
    2602: "Боди эротик",
    5049: "Браслеты эротик",
    2603: "Бюстгальтеры эротик",
    5293: "Вагинальные тренажеры",
    5072: "Вагинальные шарики",
    5576: "Вакуумно-волновые стимуляторы",
    5073: "Вакуумные помпы эротик",
    5121: "Веревки для бондажа",
    5067: "Вибраторы",
    5116: "Вибропули",
    5129: "Вибротрусики",
    5118: "Виброяйца",
    5948: "Возбуждающие напитки",
    5478: "Возбуждающие препараты",
    5779: "Возбуждающие средства",
    5042: "Галстуки эротик",
    5052: "Гартеры эротик",
    5075: "Гидропомпы эротик",
    5039: "Головные уборы эротик",
    5043: "Гольфы эротик",
    2604: "Грации эротик",
    5070: "Мастурбаторы мужские",
    6302: "Насадки на мастурбатор",
    2865: "Презервативы",  # parentID=4268, но тоже товары для взрослых
}

# Расширенный маппинг: ключевые слова -> WB category
CATEGORY_KEYWORDS_MAPPING = {
    # Анальные игрушки
    'анальные бусы': 5065,
    'анальные груши': 5193,
    'анальная груша': 5193,
    'анальные крюки': 5068,
    'анальный крюк': 5068,
    'анальные пробки': 5064,
    'анальная пробка': 5064,
    'пробка': 5064,
    'втулка': 5064,
    'анальные шарики': 5066,
    'анальный шарик': 5066,

    # Вибраторы и стимуляторы
    'вибратор': 5067,
    'вибраторы': 5067,
    'вибропуля': 5116,
    'вибропули': 5116,
    'виброкольцо': 5067,  # Может быть отдельная категория
    'вибротрусики': 5129,
    'виброяйцо': 5118,
    'виброяйца': 5118,
    'вакуумно-волновой': 5576,
    'вакуумный стимулятор': 5576,
    'волновой стимулятор': 5576,
    'клиторальный стимулятор': 5576,

    # Вагинальные игрушки
    'вагинальные шарики': 5072,
    'вагинальный шарик': 5072,
    'шарики': 5072,
    'вагинальные тренажеры': 5293,
    'вагинальный тренажер': 5293,
    'тренажер кегеля': 5293,

    # Вакуумные помпы
    'вакуумная помпа': 5073,
    'вакуумные помпы': 5073,
    'помпа': 5073,
    'гидропомпа': 5075,
    'гидропомпы': 5075,

    # Белье
    'боди': 2602,
    'бюстгальтер': 2603,
    'лифчик': 2603,
    'грация': 2604,
    'бандаж': 5051,
    'гартер': 5052,
    'гартеры': 5052,
    'пояс для чулок': 5052,
    'галстук': 5042,
    'гольфы': 5043,
    'головной убор': 5039,

    # БДСМ
    'веревка для бондажа': 5121,
    'веревки для бондажа': 5121,
    'веревка': 5121,
    'канат': 5121,
    'браслет': 5049,
    'браслеты': 5049,

    # Средства и препараты
    'ароматизатор': 5784,
    'ароматизаторы': 5784,
    'благовоние': 5783,
    'благовония': 5783,
    'возбуждающий напиток': 5948,
    'возбуждающие напитки': 5948,
    'возбуждающий препарат': 5478,
    'возбуждающие препараты': 5478,
    'возбуждающее средство': 5779,
    'возбуждающие средства': 5779,
    'презерватив': 2865,
    'презервативы': 2865,

    # Аксессуары
    'аксессуар для игрушек': 7732,
    'аксессуары для игрушек': 7732,

    # Мастурбаторы
    'мастурбатор': 5070,
    'мастурбаторы': 5070,
    'мастурбатор мужской': 5070,
    'насадка на мастурбатор': 6302,
    'насадки на мастурбатор': 6302,
}

# Маппинг по точным совпадениям категорий из CSV (sexoptovik)
CSV_TO_WB_EXACT_MAPPING = {
    # Анальные
    'Анальные стимуляторы и пробки': 5064,
    'Анальные стимуляторы': 5064,  # Добавлено
    'Анальные пробки': 5064,
    'Анальные пробки, втулки': 5064,
    'Анальные бусы': 5065,
    'Анальные груши': 5193,
    'Анальные шарики': 5066,
    'Анальные крюки': 5068,  # Добавлено

    # Вибраторы
    'Вибраторы и фаллоимитаторы': 5067,
    'Вибраторы': 5067,
    'Нереалистичные': 5067,
    'Реалистичные': 5067,
    'С вибрацией': 5067,
    'Классические': 5067,
    'Точки G': 5067,
    'Фаллоимитаторы': 5067,  # Добавлено

    # Женские стимуляторы
    'Женские стимуляторы': 5576,
    'Клиторальные стимуляторы': 5576,
    'Вакуумные стимуляторы': 5576,
    'Вакуумно-волновые стимуляторы': 5576,  # Добавлено

    # Вагинальные
    'Вагинальные шарики': 5072,
    'Вагинальные тренажеры': 5293,

    # Виброяйца и пули
    'Виброяйца': 5118,
    'Вибропули': 5116,
    'Вибротрусики': 5129,  # Добавлено

    # Помпы
    'Вакуумные помпы': 5073,
    'Помпы': 5073,
    'Гидропомпы': 5075,  # Добавлено

    # Белье
    'Эротическое белье для женщин': 2602,
    'Боди, ками, корсаж': 2602,
    'Боди': 2602,  # Добавлено
    'Пеньюары, сорочки, пижамы': 2602,
    'Трусики': 2602,
    'Бюстгальтеры': 2603,
    'Платья, мини-платья': 2602,  # Добавлено - платья относятся к боди эротик
    'Платья': 2602,  # Добавлено
    'Мини-платья': 2602,  # Добавлено
    'Грации': 2604,  # Добавлено
    'Гартеры': 5052,  # Добавлено
    'Гольфы': 5043,  # Добавлено
    'Головные уборы': 5039,  # Добавлено
    'Галстуки': 5042,  # Добавлено

    # БДСМ
    'БДСМ товары и фетиш': 5121,
    'Плетки, стеки, шлепалки': 5121,
    'Плетки': 5121,  # Добавлено
    'Стеки': 5121,  # Добавлено
    'Маски, шлемы': 5039,
    'Маски': 5039,  # Добавлено
    'Шлемы': 5039,  # Добавлено
    'Ошейники, поводки': 5049,
    'Ошейники': 5049,  # Добавлено
    'Поводки': 5049,  # Добавлено
    'Наручники, фиксаторы': 5049,
    'Наручники': 5049,  # Добавлено
    'Фиксаторы': 5049,  # Добавлено
    'Браслеты': 5049,  # Добавлено
    'Веревки для бондажа': 5121,  # Добавлено

    # Смазки и гели
    'Смазки и гели': 5779,
    'Смазки': 5779,  # Добавлено
    'Гели': 5779,  # Добавлено
    'Возбуждающие': 5779,
    'Возбуждающие средства': 5779,  # Добавлено
    'Возбуждающие препараты': 5478,  # Добавлено
    'Возбуждающие напитки': 5948,  # Добавлено

    # Презервативы и средства
    'Презервативы': 2865,
    'Ароматизаторы': 5784,  # Добавлено
    'Благовония': 5783,  # Добавлено

    # Мастурбаторы
    'Мастурбаторы': 5070,
    'Мастурбаторы мужские': 5070,
    'Насадки на мастурбатор': 6302,

    # Наборы
    'Секс-наборы': 7732,  # Аксессуары для игрушек
    'Наборы': 7732,  # Аксессуары для игрушек
}


def get_best_category_match(csv_category: str, product_title: str = '', all_categories: list = None) -> tuple:
    """
    Определяет наилучшее совпадение категории WB

    Args:
        csv_category: Основная категория из CSV
        product_title: Название товара
        all_categories: Все категории товара (список)

    Returns:
        (subject_id, subject_name, confidence)
    """

    # 1. Точное совпадение с CSV категориями
    if csv_category in CSV_TO_WB_EXACT_MAPPING:
        subject_id = CSV_TO_WB_EXACT_MAPPING[csv_category]
        return subject_id, WB_ADULT_CATEGORIES[subject_id], 1.0

    # 2. Проверяем все категории из цепочки
    if all_categories:
        for cat in all_categories:
            if cat in CSV_TO_WB_EXACT_MAPPING:
                subject_id = CSV_TO_WB_EXACT_MAPPING[cat]
                return subject_id, WB_ADULT_CATEGORIES[subject_id], 0.95

    # 3. Поиск по ключевым словам в категории
    csv_lower = csv_category.lower()
    best_match = None
    best_score = 0.0

    for keyword, subject_id in CATEGORY_KEYWORDS_MAPPING.items():
        if keyword in csv_lower:
            # Чем длиннее совпадение, тем выше score
            score = len(keyword) / len(csv_lower) if len(csv_lower) > 0 else 0
            if score > best_score:
                best_score = score
                best_match = (subject_id, WB_ADULT_CATEGORIES.get(subject_id, 'Unknown'), min(score * 1.2, 0.9))

    if best_match and best_score > 0.3:
        return best_match

    # 4. Поиск по ключевым словам в названии товара
    if product_title:
        title_lower = product_title.lower()
        title_match = None
        title_score = 0.0

        for keyword, subject_id in CATEGORY_KEYWORDS_MAPPING.items():
            if keyword in title_lower:
                score = 0.8  # Немного ниже уверенность при определении по названию
                if score > title_score:
                    title_score = score
                    title_match = (subject_id, WB_ADULT_CATEGORIES.get(subject_id, 'Unknown'), score)

        if title_match and title_score > 0.5:
            return title_match

    # 5. Дефолт - общая категория "Товары для взрослых"
    return 5038, 'Товары для взрослых', 0.3
