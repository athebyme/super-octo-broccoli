# Руководство по настройке API Wildberries

## Обзор

Этот проект включает полнофункциональную интеграцию с API Wildberries для автоматической синхронизации карточек товаров и управления данными.

## Что реализовано

### 1. API клиент (`wb_api_client.py`)

**Оптимизированный клиент с:**
- ✅ Connection pooling для переиспользования HTTP-соединений
- ✅ Автоматические retry при временных ошибках
- ✅ Rate limiting (100 запросов/мин по умолчанию)
- ✅ LRU кэширование результатов
- ✅ Подробное логирование всех запросов
- ✅ Поддержка sandbox-окружения для тестирования

**Доступные методы:**
- `get_cards_list()` - получить список карточек товаров
- `get_all_cards()` - получить все карточки с автопагинацией
- `get_sales_report()` - получить отчет о продажах
- `get_orders()` - получить заказы
- `get_stocks()` - получить остатки товаров
- `test_connection()` - проверить подключение к API

### 2. Модели базы данных (`models.py`)

**Новые таблицы:**
- `Product` - карточки товаров с полями nm_id, vendor_code, title, brand и т.д.
- `APILog` - логи всех API-запросов с временем выполнения и статусом

**Индексы для быстрой работы:**
- Составной индекс (seller_id, nm_id)
- Индекс по vendor_code для быстрого поиска
- Индекс по (seller_id, is_active) для фильтрации

**Шифрование API ключей:**
- Используется Fernet (AES-128)
- Ключ шифрования хранится в переменной окружения `ENCRYPTION_KEY`
- Автоматическое шифрование при сохранении
- Автоматическая расшифровка при чтении

### 3. Веб-интерфейс

**Новые страницы:**

#### `/api-settings` - Настройка API ключа
- Форма ввода API ключа
- Автоматическая проверка валидности ключа
- Инструкции по получению ключа
- Статус последней синхронизации

#### `/products` - Список карточек товаров
- Таблица со всеми товарами
- Пагинация (50 товаров на страницу)
- Поиск по артикулу, названию, бренду
- Фильтр "только активные"
- Кнопка синхронизации с WB API
- Миниатюры фотографий товаров

#### `/products/<id>` - Детали товара
- Галерея фотографий
- Полная информация о товаре
- Таблица размеров и баркодов
- Ссылка на карточку на WB

#### `/api-logs` - Логи API запросов
- История всех запросов к WB API
- Статистика успешности
- Время выполнения каждого запроса
- Пагинация логов

## Установка и настройка

### Шаг 1: Установка зависимостей

```bash
pip install -r requirements.txt
```

Новые зависимости:
- `cryptography==41.0.7` - для шифрования API ключей

### Шаг 2: Генерация ключа шифрования

```bash
python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
```

Сохраните сгенерированный ключ.

### Шаг 3: Настройка переменных окружения

Создайте файл `.env` в корне проекта:

```bash
# Flask
SECRET_KEY=ваш-секретный-ключ-flask
DATABASE_URL=sqlite:///seller_platform.db
PORT=5001

# Шифрование API ключей
ENCRYPTION_KEY=сгенерированный-ключ-fernet

# Опционально: настройки WB API
WB_API_RATE_LIMIT=100
WB_API_TIMEOUT=30
```

### Шаг 4: Инициализация базы данных

```bash
python seller_platform.py
```

При первом запуске Flask создаст все таблицы автоматически.

Или вручную:

```bash
flask --app seller_platform db create_all
```

### Шаг 5: Миграция данных (если уже есть продавцы)

Если у вас уже есть продавцы в БД, выполните миграцию:

```python
from seller_platform import app, db
from models import Seller, Product, APILog

with app.app_context():
    # Создание новых таблиц
    db.create_all()

    # Проверка миграции
    print(f"Продавцов: {Seller.query.count()}")
    print(f"Товаров: {Product.query.count()}")
    print(f"Логов: {APILog.query.count()}")
```

## Использование

### 1. Получение API ключа Wildberries

1. Зайдите в личный кабинет продавца Wildberries
2. Перейдите в **Профиль → Настройки → Доступ к API**
3. Выберите тип токена **"Content"** (для карточек товаров)
4. Нажмите "Создать токен"
5. **ВАЖНО:** Скопируйте токен сразу (показывается только один раз!)

### 2. Настройка API ключа в платформе

1. Войдите в систему как продавец
2. Перейдите в **Настройки API** через дашборд
3. Вставьте скопированный API ключ
4. Нажмите "Сохранить и проверить"
5. Система автоматически проверит подключение

### 3. Синхронизация карточек товаров

1. Перейдите в **Карточки товаров**
2. Нажмите кнопку **"Синхронизировать"**
3. Дождитесь завершения (страница обновится автоматически)
4. Просмотрите загруженные карточки

### 4. Просмотр логов API

1. Перейдите в **Логи API**
2. Просмотрите историю запросов
3. Проверьте статистику успешности

## Производительность и оптимизации

### Connection Pooling

API клиент использует connection pool для переиспользования HTTP-соединений:
- Максимум 10 connection pools
- Максимум 20 соединений в каждом pool
- Значительно ускоряет множественные запросы

### Rate Limiting

Встроенный rate limiter автоматически ограничивает скорость запросов:
- По умолчанию: 100 запросов в минуту
- Автоматическое ожидание при достижении лимита
- Предотвращает блокировку со стороны WB API

### Retry механизм

Автоматические повторы при временных ошибках:
- 3 попытки для каждого запроса
- Экспоненциальная задержка (1s, 2s, 4s)
- Retry для статусов 429, 500, 502, 503, 504

### Кэширование

Опциональное LRU-кэширование через `CachedWBAPIClient`:
- Размер кэша: 128 элементов
- TTL: 5 минут по умолчанию
- Ускоряет повторные запросы одинаковых данных

### Индексы БД

Оптимизированные индексы для быстрых запросов:
- Составные индексы для частых запросов
- Индексы внешних ключей
- Индексы для полей сортировки

### Пагинация

Все списки с пагинацией для снижения нагрузки:
- Карточки товаров: 50 на страницу
- Логи API: 50 на страницу
- Lazy loading в шаблонах

## Безопасность

### Шифрование API ключей

**Как это работает:**

1. При сохранении:
   ```python
   seller.wb_api_key = "plain_text_key"
   # Автоматически шифруется с помощью Fernet
   ```

2. При чтении:
   ```python
   api_key = seller.wb_api_key
   # Автоматически расшифровывается
   ```

3. В базе данных хранится зашифрованное значение

**Важно:**
- Никогда не коммитьте `.env` файл в Git
- Храните `ENCRYPTION_KEY` в секрете
- Используйте разные ключи для dev/staging/production

### Логирование

Все API запросы логируются:
- Эндпоинт
- HTTP метод
- Статус ответа
- Время выполнения
- Сообщение об ошибке (если есть)

Логи доступны в интерфейсе и могут использоваться для:
- Отладки
- Мониторинга производительности
- Выявления проблем с API

## Примеры кода

### Использование API клиента напрямую

```python
from wb_api_client import WildberriesAPIClient

# Базовое использование
with WildberriesAPIClient(api_key="your_key") as client:
    # Получить 100 карточек
    data = client.get_cards_list(limit=100)
    cards = data.get('cards', [])

    # Получить все карточки (автопагинация)
    all_cards = client.get_all_cards()

    # Получить продажи за период
    sales = client.get_sales_report(
        date_from="2024-01-01",
        date_to="2024-01-31"
    )

# С кэшированием
from wb_api_client import CachedWBAPIClient

with CachedWBAPIClient(api_key="your_key", cache_ttl=600) as client:
    # Первый запрос - идет в API
    cards1 = client.get_cards_list(limit=100)

    # Второй запрос - из кэша (быстрее)
    cards2 = client.get_cards_list(limit=100)
```

### Работа с моделями

```python
from seller_platform import app, db
from models import Product, Seller

with app.app_context():
    # Найти все товары продавца
    seller = Seller.query.filter_by(id=1).first()
    products = seller.products.all()

    # Поиск по артикулу
    product = Product.query.filter_by(
        seller_id=1,
        vendor_code="ABC123"
    ).first()

    # Фильтрация активных товаров
    active_products = Product.query.filter_by(
        seller_id=1,
        is_active=True
    ).all()

    # Полнотекстовый поиск
    search = "футболка"
    results = Product.query.filter(
        db.or_(
            Product.title.ilike(f'%{search}%'),
            Product.brand.ilike(f'%{search}%')
        )
    ).all()
```

## Troubleshooting

### Ошибка "Invalid encryption key"

**Проблема:** Не настроен `ENCRYPTION_KEY`

**Решение:**
1. Сгенерируйте ключ: `python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"`
2. Добавьте в `.env`: `ENCRYPTION_KEY=сгенерированный-ключ`

### Ошибка 401 при проверке API ключа

**Проблема:** Неверный или истекший API ключ

**Решение:**
1. Проверьте, что скопировали весь ключ целиком
2. Убедитесь, что ключ не истек (180 дней для обычного токена)
3. Создайте новый токен в ЛК Wildberries

### Ошибка 429 "Rate limit exceeded"

**Проблема:** Превышен лимит запросов

**Решение:**
- Встроенный rate limiter должен предотвращать это
- Если возникает регулярно, уменьшите `WB_API_RATE_LIMIT` в `.env`
- Используйте `CachedWBAPIClient` для снижения количества запросов

### Медленная синхронизация

**Оптимизации:**
1. Убедитесь, что используется connection pooling (по умолчанию включен)
2. Проверьте скорость интернета
3. Используйте кэширование для повторных запросов
4. Рассмотрите асинхронную синхронизацию (Celery) для больших объемов

## Roadmap

### Планируется добавить:

- [ ] Асинхронная синхронизация через Celery
- [ ] Webhook для получения обновлений от WB
- [ ] Синхронизация цен и остатков
- [ ] Работа с заказами через API
- [ ] Экспорт данных в Excel/CSV
- [ ] Графики и аналитика продаж
- [ ] Уведомления при ошибках синхронизации

## Полезные ссылки

- [Официальная документация WB API](https://dev.wildberries.ru/)
- [Swagger спецификация](https://dev.wildberries.ru/swagger/)
- [FAQ по интеграции](https://dev.wildberries.ru/en/faq)
- [Sandbox для тестирования](https://statistics-api-sandbox.wildberries.ru/)

## Поддержка

При возникновении проблем:
1. Проверьте логи API в интерфейсе (`/api-logs`)
2. Просмотрите логи приложения
3. Убедитесь, что все зависимости установлены
4. Проверьте переменные окружения

---

**Разработано:** 2025-11-03
**Версия:** 1.0.0
