# -*- coding: utf-8 -*-
"""
AI Service - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
- Cloud.ru Foundation Models (–æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä —Å OAuth2)
- OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ API
- –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∑–∞–¥–∞—á
- –í–∞–ª–∏–¥–∞—Ü–∏—é –æ—Ç–≤–µ—Ç–æ–≤ AI
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Ä–æ—Ç–∞—Ü–∏—é —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è Cloud.ru
"""
import json
import re
import logging
import threading
import time
from abc import ABC, abstractmethod
from typing import Optional, Dict, List, Any, Tuple, Callable
from dataclasses import dataclass, field
from enum import Enum
from datetime import datetime
import requests
from html import unescape

logger = logging.getLogger(__name__)


# ============================================================================
# HTML STRIPPING UTILITY
# ============================================================================

def strip_html_tags(text: str) -> str:
    """
    –£–¥–∞–ª—è–µ—Ç HTML —Ç–µ–≥–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∏ –æ—á–∏—â–∞–µ—Ç –æ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤

    Args:
        text: –¢–µ–∫—Å—Ç —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ HTML —Ç–µ–≥–∞–º–∏

    Returns:
        –û—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ HTML —Ç–µ–≥–æ–≤
    """
    if not text:
        return text

    # –£–¥–∞–ª—è–µ–º HTML —Ç–µ–≥–∏
    clean = re.sub(r'<[^>]+>', '', text)
    # –î–µ–∫–æ–¥–∏—Ä—É–µ–º HTML entities (&nbsp;, &amp;, etc.)
    clean = unescape(clean)
    # –ó–∞–º–µ–Ω—è–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
    clean = re.sub(r'\s+', ' ', clean)
    # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
    clean = clean.strip()

    return clean


def clean_ai_response(response: str, strip_html: bool = True) -> str:
    """
    –û—á–∏—â–∞–µ—Ç –æ—Ç–≤–µ—Ç AI –æ—Ç –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤

    Args:
        response: –û—Ç–≤–µ—Ç AI
        strip_html: –£–¥–∞–ª—è—Ç—å –ª–∏ HTML —Ç–µ–≥–∏

    Returns:
        –û—á–∏—â–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
    """
    if not response:
        return response

    text = response.strip()

    # –£–¥–∞–ª—è–µ–º markdown code blocks –µ—Å–ª–∏ –µ—Å—Ç—å
    if text.startswith("```"):
        text = re.sub(r'^```(?:json)?\n?', '', text)
        text = re.sub(r'\n?```$', '', text)

    # –£–¥–∞–ª—è–µ–º HTML –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if strip_html:
        text = strip_html_tags(text)

    return text


# ============================================================================
# AI REQUEST LOGGER (–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö AI –∑–∞–ø—Ä–æ—Å–æ–≤)
# ============================================================================

# Callback –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è AI –∑–∞–ø—Ä–æ—Å–æ–≤ (–±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ routes)
_ai_request_logger: Optional[Callable] = None


def set_ai_request_logger(logger_callback: Callable):
    """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç callback –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è AI –∑–∞–ø—Ä–æ—Å–æ–≤"""
    global _ai_request_logger
    _ai_request_logger = logger_callback


def log_ai_request(
    seller_id: int,
    action_type: str,
    provider: str,
    model: str,
    system_prompt: str,
    user_prompt: str,
    response: Optional[str],
    success: bool,
    error_message: Optional[str] = None,
    response_time_ms: int = 0,
    tokens_used: int = 0,
    source_module: str = 'ai_service',
    product_id: Optional[int] = None
):
    """
    –õ–æ–≥–∏—Ä—É–µ—Ç AI –∑–∞–ø—Ä–æ—Å –≤ –∏—Å—Ç–æ—Ä–∏—é

    Args:
        seller_id: ID –ø—Ä–æ–¥–∞–≤—Ü–∞
        action_type: –¢–∏–ø –¥–µ–π—Å—Ç–≤–∏—è (seo_title, keywords, etc.)
        provider: –ü—Ä–æ–≤–∞–π–¥–µ—Ä AI
        model: –ú–æ–¥–µ–ª—å
        system_prompt: –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        user_prompt: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç
        response: –û—Ç–≤–µ—Ç AI
        success: –£—Å–ø–µ—à–µ–Ω –ª–∏ –∑–∞–ø—Ä–æ—Å
        error_message: –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        response_time_ms: –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –≤ –º—Å
        tokens_used: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤
        source_module: –ú–æ–¥—É–ª—å-–∏—Å—Ç–æ—á–Ω–∏–∫ –∑–∞–ø—Ä–æ—Å–∞
        product_id: ID —Ç–æ–≤–∞—Ä–∞ (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)
    """
    if _ai_request_logger:
        try:
            _ai_request_logger(
                seller_id=seller_id,
                action_type=action_type,
                provider=provider,
                model=model,
                system_prompt=system_prompt,
                user_prompt=user_prompt,
                response=response,
                success=success,
                error_message=error_message,
                response_time_ms=response_time_ms,
                tokens_used=tokens_used,
                source_module=source_module,
                product_id=product_id
            )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è AI –∑–∞–ø—Ä–æ—Å–∞: {e}")


# ============================================================================
# CLOUD.RU TOKEN MANAGER
# ============================================================================

import base64


class CloudRuApiKeyManager:
    """
    –ú–µ–Ω–µ–¥–∂–µ—Ä API-–∫–ª—é—á–µ–π –¥–ª—è Cloud.ru Foundation Models API

    Cloud.ru –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ —Å–ø–æ—Å–æ–±–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:
    1. API-–∫–ª—é—á (—Ñ–æ—Ä–º–∞—Ç {base64}.{secret}) - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é:
       Authorization: Api-Key {api_key}

    2. –ö–ª—é—á –¥–æ—Å—Ç—É–ø–∞ (–æ—Ç–¥–µ–ª—å–Ω—ã–µ Key ID –∏ Key Secret) - —Ç—Ä–µ–±—É–µ—Ç –æ–±–º–µ–Ω–∞ –Ω–∞ —Ç–æ–∫–µ–Ω:
       Authorization: Bearer {access_token}

    –≠—Ç–æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞:
    - –ï—Å–ª–∏ –∫–ª—é—á —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ—á–∫—É - —ç—Ç–æ API-–∫–ª—é—á, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é —Å Api-Key
    - –ï—Å–ª–∏ –∫–ª—é—á –≤ —Ñ–æ—Ä–º–∞—Ç–µ "keyId:secret" - —ç—Ç–æ –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞, –æ–±–º–µ–Ω–∏–≤–∞–µ–º –Ω–∞ —Ç–æ–∫–µ–Ω
    """

    # URL –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ Cloud.ru IAM API (–¥–ª—è –∫–ª—é—á–µ–π –¥–æ—Å—Ç—É–ø–∞)
    TOKEN_URL = "https://iam.api.cloud.ru/api/v1/auth/token"
    TOKEN_REFRESH_BUFFER = 300  # 5 –º–∏–Ω—É—Ç

    def __init__(self, api_key: str):
        """
        Args:
            api_key: API-–∫–ª—é—á –∏–ª–∏ –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "keyId:secret"
        """
        self.original_key = api_key
        self._access_token: Optional[str] = None
        self._token_expires_at: float = 0
        self._lock = threading.Lock()

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–ª—é—á–∞
        if ':' in api_key and '.' not in api_key:
            # –§–æ—Ä–º–∞—Ç "keyId:secret" - –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞, —Ç—Ä–µ–±—É–µ—Ç –æ–±–º–µ–Ω–∞ –Ω–∞ —Ç–æ–∫–µ–Ω
            self.auth_type = 'access_key'
            parts = api_key.split(':', 1)
            self.key_id = parts[0]
            self.secret = parts[1] if len(parts) > 1 else ''
            logger.info(f"‚úÖ Cloud.ru –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞: keyId={self.key_id[:8]}...")
        else:
            # API-–∫–ª—é—á - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é
            self.auth_type = 'api_key'
            self.api_key = api_key
            logger.info(f"‚úÖ Cloud.ru API-–∫–ª—é—á: {api_key[:12]}...")

    @classmethod
    def from_key_secret(cls, key_secret: str) -> 'CloudRuApiKeyManager':
        """–°–æ–∑–¥–∞–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä –∏–∑ –∫–ª—é—á–∞"""
        return cls(key_secret)

    def get_access_token(self) -> Optional[str]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω/–∫–ª—é—á –¥–ª—è Authorization –∑–∞–≥–æ–ª–æ–≤–∫–∞

        Returns:
            –¢–æ–∫–µ–Ω –∏–ª–∏ API-–∫–ª—é—á
        """
        if self.auth_type == 'api_key':
            # API-–∫–ª—é—á –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é
            return self.api_key

        # –ö–ª—é—á –¥–æ—Å—Ç—É–ø–∞ - –Ω—É–∂–µ–Ω –æ–±–º–µ–Ω –Ω–∞ —Ç–æ–∫–µ–Ω
        with self._lock:
            current_time = time.time()

            if (self._access_token is None or
                current_time >= self._token_expires_at - self.TOKEN_REFRESH_BUFFER):

                logger.info("üîÑ –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–π access token –æ—Ç Cloud.ru...")
                success = self._fetch_new_token()
                if not success:
                    return None

            return self._access_token

    def get_auth_header(self) -> Optional[str]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π Authorization –∑–∞–≥–æ–ª–æ–≤–æ–∫

        Returns:
            "Bearer {key}" –¥–ª—è API-–∫–ª—é—á–∞ –∏–ª–∏ "Bearer {token}" –¥–ª—è –∫–ª—é—á–∞ –¥–æ—Å—Ç—É–ø–∞
        """
        token = self.get_access_token()
        if not token:
            return None

        # Cloud.ru Foundation Models –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Bearer
        return f'Bearer {token}'

    def _fetch_new_token(self) -> bool:
        """–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–π access token —É Cloud.ru IAM API"""
        try:
            payload = {
                "keyId": self.key_id,
                "secret": self.secret
            }

            headers = {
                "Content-Type": "application/json"
            }

            logger.info(f"üîë –ó–∞–ø—Ä–æ—Å —Ç–æ–∫–µ–Ω–∞ –∫ {self.TOKEN_URL} —Å keyId={self.key_id[:8]}...")

            response = requests.post(
                self.TOKEN_URL,
                json=payload,
                headers=headers,
                timeout=30
            )

            if response.status_code != 200:
                logger.error(f"‚ùå Cloud.ru Token –æ—à–∏–±–∫–∞: {response.status_code}")
                logger.error(f"Response: {response.text[:500]}")
                return False

            data = response.json()
            self._access_token = data.get("access_token")
            expires_in = data.get("expires_in", 3600)
            self._token_expires_at = time.time() + expires_in

            logger.info(f"‚úÖ Cloud.ru access token –ø–æ–ª—É—á–µ–Ω (expires_in: {expires_in}s)")
            return True

        except Exception as e:
            logger.error(f"‚ùå Cloud.ru Token error: {e}")
            return False

    def invalidate_token(self):
        """–ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ç–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω"""
        with self._lock:
            self._access_token = None
            self._token_expires_at = 0


# –ê–ª–∏–∞—Å –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
CloudRuTokenManager = CloudRuApiKeyManager


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à
_token_managers: Dict[str, CloudRuApiKeyManager] = {}
_token_managers_lock = threading.Lock()


def get_cloudru_token_manager(key_secret: str) -> CloudRuApiKeyManager:
    """–ü–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞"""
    with _token_managers_lock:
        cache_key = key_secret[:20] if len(key_secret) > 20 else key_secret
        if cache_key not in _token_managers:
            _token_managers[cache_key] = CloudRuApiKeyManager.from_key_secret(key_secret)
        return _token_managers[cache_key]


def reset_cloudru_token_managers():
    """–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤—Å–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã"""
    global _token_managers
    with _token_managers_lock:
        _token_managers = {}


class AIProvider(Enum):
    """–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã"""
    OPENAI = "openai"
    CLOUDRU = "cloudru"  # Cloud.ru Foundation Models
    CUSTOM = "custom"  # –õ—é–±–æ–π OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π API


# –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è Cloud.ru Foundation Models
CLOUDRU_MODELS = {
    "openai/gpt-oss-120b": {
        "name": "GPT OSS 120B",
        "description": "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∑–∞–¥–∞—á",
        "recommended": True
    },
    "deepseek/DeepSeek-R1-Distill-Llama-70B": {
        "name": "DeepSeek R1 Distill Llama 70B",
        "description": "–í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ state-of-the-art —Ä–µ—à–µ–Ω–∏–π",
        "recommended": True
    },
    "deepseek/DeepSeek-V3": {
        "name": "DeepSeek V3",
        "description": "–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –º–æ–¥–µ–ª—å DeepSeek",
        "recommended": False
    },
    "qwen/Qwen2.5-72B-Instruct": {
        "name": "Qwen 2.5 72B Instruct",
        "description": "–ú–æ–¥–µ–ª—å –æ—Ç Alibaba –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π",
        "recommended": False
    },
    "meta-llama/Llama-3.3-70B-Instruct": {
        "name": "Llama 3.3 70B Instruct",
        "description": "–ú–æ–¥–µ–ª—å –æ—Ç Meta",
        "recommended": False
    }
}

# –ú–æ–¥–µ–ª–∏ OpenAI
OPENAI_MODELS = {
    "gpt-4o-mini": {
        "name": "GPT-4o Mini",
        "description": "–ë–∞–ª–∞–Ω—Å —Ü–µ–Ω—ã –∏ –∫–∞—á–µ—Å—Ç–≤–∞",
        "recommended": True
    },
    "gpt-4o": {
        "name": "GPT-4o",
        "description": "–õ—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ",
        "recommended": False
    },
    "gpt-4-turbo": {
        "name": "GPT-4 Turbo",
        "description": "–ë—ã—Å—Ç—Ä–∞—è –≤–µ—Ä—Å–∏—è GPT-4",
        "recommended": False
    }
}


# ============================================================================
# –°–ò–°–¢–ï–ú–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ
# ============================================================================

DEFAULT_INSTRUCTIONS = {
    "seo_title": {
        "name": "SEO-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞",
        "description": "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–∞ WB",
        "template": """–¢—ã SEO-—ç–∫—Å–ø–µ—Ä—Ç –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ Wildberries.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å–æ–∑–¥–∞—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ø–æ–∏—Å–∫–µ.

–ü–†–ê–í–ò–õ–ê:
1. –ú–∞–∫—Å–∏–º—É–º 100 —Å–∏–º–≤–æ–ª–æ–≤
2. –ù–∞—á–∏–Ω–∞–π —Å –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞ (—Ç–∏–ø —Ç–æ–≤–∞—Ä–∞)
3. –í–∫–ª—é—á–∞–π –≤–∞–∂–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–º–∞—Ç–µ—Ä–∏–∞–ª, —Ä–∞–∑–º–µ—Ä, —Ü–≤–µ—Ç)
4. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π CAPS LOCK –∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã
5. –ò–∑–±–µ–≥–∞–π –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π —Å–ª–æ–≤
6. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–∞: "–ª—É—á—à–∏–π", "—Ç–æ–ø", "—Ö–∏—Ç", "‚Ññ1"
7. –ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º –∏ —á–∏—Ç–∞–µ–º—ã–º

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û JSON):
{
    "title": "<–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫>",
    "keywords_used": ["–∫–ª—é—á–µ–≤–æ–µ1", "–∫–ª—é—á–µ–≤–æ–µ2"],
    "improvements": ["—á—Ç–æ —É–ª—É—á—à–µ–Ω–æ"]
}

–í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON."""
    },

    "keywords": {
        "name": "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤",
        "description": "–°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–∞",
        "template": """–¢—ã SEO-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ Wildberries.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —Ç–æ–≤–∞—Ä–∞.

–ü–†–ê–í–ò–õ–ê:
1. –ì–µ–Ω–µ—Ä–∏—Ä—É–π 15-30 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
2. –í–∫–ª—é—á–∞–π —Å–∏–Ω–æ–Ω–∏–º—ã –∏ –≤–∞—Ä–∏–∞—Ü–∏–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏—è
3. –î–æ–±–∞–≤–ª—è–π –æ–±—â–∏–µ –∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
4. –£—á–∏—Ç—ã–≤–∞–π —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—é –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
5. –ù–µ –¥—É–±–ª–∏—Ä—É–π —Å–ª–æ–≤–∞ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é
6. –ò–∑–±–µ–≥–∞–π –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Å–ª–æ–≤

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û JSON):
{
    "keywords": ["—Å–ª–æ–≤–æ1", "—Å–ª–æ–≤–æ2", ...],
    "search_queries": ["–ø–æ–ø—É–ª—è—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å 1", "–ø–æ–ø—É–ª—è—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å 2"]
}

–í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON."""
    },

    "bullet_points": {
        "name": "–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞",
        "description": "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫—Ä–∞—Ç–∫–∏—Ö bullet points —Å –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–º–∏",
        "template": """–¢—ã –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ Wildberries.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å–æ–∑–¥–∞—Ç—å –∫—Ä–∞—Ç–∫–∏–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞ (bullet points).

–ü–†–ê–í–ò–õ–ê:
1. 4-6 –∫—Ä–∞—Ç–∫–∏—Ö –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤
2. –ö–∞–∂–¥–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ - 1 —Å—Ç—Ä–æ–∫–∞ (–¥–æ 50 —Å–∏–º–≤–æ–ª–æ–≤)
3. –ù–∞—á–∏–Ω–∞–π —Å –≥–ª–∞–≥–æ–ª–∞ –∏–ª–∏ —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–≥–æ
4. –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª—å–∑–µ –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
5. –ö–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞ –≤–º–µ—Å—Ç–æ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π
6. –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è
7. –ë–ï–ó —ç–º–æ–¥–∑–∏ –∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤ (–∑–∞–ø—Ä–µ—â–µ–Ω–æ –Ω–∞ WB!)

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û JSON):
{
    "bullet_points": [
        "–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ 1",
        "–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ 2"
    ],
    "target_audience": "<—Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è>"
}

–í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON. –ë–µ–∑ —ç–º–æ–¥–∑–∏!"""
    },

    "description_enhance": {
        "name": "–£–ª—É—á—à–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è",
        "description": "SEO-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞",
        "template": """–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —É–ª—É—á—à–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –∫–æ–Ω–≤–µ—Ä—Å–∏–∏.

–ü–†–ê–í–ò–õ–ê:
1. –°–æ—Ö—Ä–∞–Ω–∏ –≤—Å–µ —Ñ–∞–∫—Ç—ã –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
2. –î–æ–±–∞–≤—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É (–∞–±–∑–∞—Ü—ã, —Å–ø–∏—Å–∫–∏)
3. –ü–µ—Ä–≤—ã–π –∞–±–∑–∞—Ü - –∫—Ä–∞—Ç–∫–æ–µ –£–¢–ü (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
4. –í—Ç–æ—Ä–æ–π –∞–±–∑–∞—Ü - –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
5. –ò—Å–ø–æ–ª—å–∑—É–π –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ
6. –ú–∞–∫—Å–∏–º—É–º 1000 —Å–∏–º–≤–æ–ª–æ–≤
7. –ë–µ–∑ –≤–æ–¥—ã –∏ –ø—É—Å—Ç—ã—Ö —Ñ—Ä–∞–∑

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û JSON):
{
    "description": "<—É–ª—É—á—à–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ>",
    "structure": {
        "intro": "<–≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ>",
        "features": ["–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å1", "–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å2"],
        "call_to_action": "<–ø—Ä–∏–∑—ã–≤>"
    }
}

–í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON."""
    },

    "rich_content": {
        "name": "Rich –∫–æ–Ω—Ç–µ–Ω—Ç",
        "description": "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–¥–∞—é—â–µ–≥–æ rich –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ WB",
        "template": """–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω–µ—Ä –∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è Wildberries, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–∏ Rich-–∫–æ–Ω—Ç–µ–Ω—Ç–∞.

Rich-–∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ WB - —ç—Ç–æ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ (—Å–ª–∞–π–¥—ã) —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –∏ —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ –Ω–∞–ª–æ–∂–µ–Ω–∏—è–º–∏.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å–æ–∑–¥–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ –º–∞–∫–µ—Ç—ã –¥–ª—è 6-10 —Å–ª–∞–π–¥–æ–≤ –∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∏.

–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø WB:
- –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: 1440x810 px (—Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ 16:9)
- –§–æ—Ä–º–∞—Ç: JPEG –∏–ª–∏ PNG, –¥–æ 5 –ú–ë
- –ú–∞–∫—Å–∏–º—É–º 10 –±–ª–æ–∫–æ–≤

–°–¢–†–û–ì–ò–ï –ó–ê–ü–†–ï–¢–´ WB:
- –≠–º–æ–¥–∑–∏ –∏ —Å–º–∞–π–ª–∏–∫–∏
- –¶–µ–Ω—ã, —Å–∫–∏–¥–∫–∏, –∞–∫—Ü–∏–∏
- –í–æ–¥—è–Ω—ã–µ –∑–Ω–∞–∫–∏, –ª–æ–≥–æ—Ç–∏–ø—ã —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –±—Ä–µ–Ω–¥–æ–≤
- QR-–∫–æ–¥—ã, —Å—Å—ã–ª–∫–∏, –∫–æ–Ω—Ç–∞–∫—Ç—ã
- –ù–∞–¥–ø–∏—Å–∏: "—Ö–∏—Ç –ø—Ä–æ–¥–∞–∂", "–ª—É—á—à–∞—è —Ü–µ–Ω–∞", "—Ç–æ–ø", "–±–µ—Å—Ç—Å–µ–ª–ª–µ—Ä"
- –ü—Ä–∏–∑—ã–≤—ã: "–ø–æ–∑–≤–æ–Ω–∏—Ç–µ", "–∑–∞–∫–∞–∂–∏—Ç–µ —Å–µ–π—á–∞—Å"

–°–¢–†–£–ö–¢–£–†–ê –°–õ–ê–ô–î–û–í:
1. HERO (–≥–ª–∞–≤–Ω—ã–π) - –∫—Ä—É–ø–Ω–æ–µ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ + –£–¢–ü
2. –ü–†–û–ë–õ–ï–ú–ê - –±–æ–ª—å –∫–ª–∏–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—É—é —Ä–µ—à–∞–µ—Ç —Ç–æ–≤–∞—Ä
3-4. –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê - –ø–æ –æ–¥–Ω–æ–º—É –∫–ª—é—á–µ–≤–æ–º—É –Ω–∞ —Å–ª–∞–π–¥
5-6. –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò - –º–∞—Ç–µ—Ä–∏–∞–ª—ã, —Ä–∞–∑–º–µ—Ä—ã, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏
7-8. –ü–†–ò–ú–ï–ù–ï–ù–ò–ï - —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è, –¥–ª—è –∫–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∏—Ç
9. –ö–û–ú–ü–õ–ï–ö–¢–ê–¶–ò–Ø - —á—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ –Ω–∞–±–æ—Ä
10. –î–û–í–ï–†–ò–ï - –≥–∞—Ä–∞–Ω—Ç–∏—è, —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

–ü–†–ê–í–ò–õ–ê –¢–ï–ö–°–¢–ê –î–õ–Ø –°–õ–ê–ô–î–û–í:
- –ó–∞–≥–æ–ª–æ–≤–æ–∫: 2-5 —Å–ª–æ–≤, –ö–†–£–ü–ù–û, —á–∏—Ç–∞–µ—Ç—Å—è –∑–∞ 1 —Å–µ–∫—É–Ω–¥—É
- –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫: 1 –∫–æ—Ä–æ—Ç–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏–ª–∏ 3-5 —Å–ª–æ–≤
- –ë—É–ª–ª–µ—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å): –º–∞–∫—Å–∏–º—É–º 3-4 –ø—É–Ω–∫—Ç–∞ –ø–æ 2-4 —Å–ª–æ–≤–∞

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û JSON):
{
    "slides": [
        {
            "number": 1,
            "type": "hero",
            "title": "–ö–û–†–û–¢–ö–ò–ô –ó–ê–ì–û–õ–û–í–û–ö",
            "subtitle": "–ü–æ—è—Å–Ω–µ–Ω–∏–µ –≤ 5-8 —Å–ª–æ–≤",
            "bullets": null,
            "image_concept": {
                "main_object": "–ß—Ç–æ –≥–ª–∞–≤–Ω–æ–µ –Ω–∞ —Ñ–æ—Ç–æ (—Ç–æ–≤–∞—Ä, —Ä—É–∫–∏ —Å —Ç–æ–≤–∞—Ä–æ–º, —Ç–æ–≤–∞—Ä –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏)",
                "background": "–¢–∏–ø —Ñ–æ–Ω–∞ (–æ–¥–Ω–æ—Ç–æ–Ω–Ω—ã–π —Å–≤–µ—Ç–ª—ã–π/—Ç–µ–º–Ω—ã–π, –≥—Ä–∞–¥–∏–µ–Ω—Ç, lifestyle —Ñ–æ—Ç–æ)",
                "composition": "left/center/right - –≥–¥–µ —Ç–æ–≤–∞—Ä –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏",
                "mood": "–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ (–ø—Ä–µ–º–∏—É–º, —É—é—Ç–Ω—ã–π, —ç–Ω–µ—Ä–≥–∏—á–Ω—ã–π, –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π)"
            },
            "text_layout": {
                "title_position": "top-left/top-center/top-right/center/bottom-left/bottom-center/bottom-right",
                "title_color": "–¶–≤–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ (–±–µ–ª—ã–π –Ω–∞ —Ç–µ–º–Ω–æ–º —Ñ–æ–Ω–µ / —Ç–µ–º–Ω—ã–π –Ω–∞ —Å–≤–µ—Ç–ª–æ–º)",
                "subtitle_position": "–ü–æ–∑–∏—Ü–∏—è –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞",
                "text_background": "none/semi-transparent-dark/semi-transparent-light/solid-box"
            }
        },
        {
            "number": 2,
            "type": "problem",
            "title": "–ó–ù–ê–ö–û–ú–ê–Ø –ü–†–û–ë–õ–ï–ú–ê?",
            "subtitle": "–û–ø–∏—Å–∞–Ω–∏–µ –±–æ–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞",
            "bullets": ["–ü—Ä–æ–±–ª–µ–º–∞ 1", "–ü—Ä–æ–±–ª–µ–º–∞ 2", "–ü—Ä–æ–±–ª–µ–º–∞ 3"],
            "image_concept": {
                "main_object": "–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–±–ª–µ–º—ã –∏–ª–∏ –∫–æ–Ω—Ç—Ä–∞—Å—Ç –¥–æ/–ø–æ—Å–ª–µ",
                "background": "–ü—Ä–∏–≥–ª—É—à–µ–Ω–Ω—ã–µ —Ç–æ–Ω–∞ –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ —Å —Ä–µ—à–µ–Ω–∏–µ–º",
                "composition": "center",
                "mood": "–°–æ—á—É–≤—Å—Ç–≤—É—é—â–∏–π, –ø–æ–Ω–∏–º–∞—é—â–∏–π"
            },
            "text_layout": {
                "title_position": "top-center",
                "title_color": "dark",
                "subtitle_position": "below-title",
                "text_background": "semi-transparent-light"
            }
        }
    ],
    "design_recommendations": {
        "color_palette": ["#–æ—Å–Ω–æ–≤–Ω–æ–π", "#–∞–∫—Ü–µ–Ω—Ç", "#—Ñ–æ–Ω", "#—Ç–µ–∫—Å—Ç"],
        "font_style": "modern/classic/bold/elegant",
        "overall_mood": "–û–±—â–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏",
        "key_visual_elements": ["—ç–ª–µ–º–µ–Ω—Ç 1", "—ç–ª–µ–º–µ–Ω—Ç 2"]
    },
    "total_slides": 6,
    "main_usp": "–ì–ª–∞–≤–Ω–æ–µ –£–¢–ü —Ç–æ–≤–∞—Ä–∞ –≤ 5-7 —Å–ª–æ–≤–∞—Ö",
    "target_audience": "–î–ª—è –∫–æ–≥–æ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä"
}

–í–ê–ñ–ù–û:
- –°–æ–∑–¥–∞–π 6-10 —Å–ª–∞–π–¥–æ–≤ —Å –ü–û–õ–ù–û–ô –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞
- –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –û–ß–ï–ù–¨ –∫–æ—Ä–æ—Ç–∫–∏–º - —ç—Ç–æ –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫!
- –ë–ï–ó –≠–ú–û–î–ó–ò! –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON."""
    },

    "card_analysis": {
        "name": "–ê–Ω–∞–ª–∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏",
        "description": "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞",
        "template": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ Wildberries.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –∏ –¥–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.

–û–¶–ï–ù–ò:
1. –ó–∞–≥–æ–ª–æ–≤–æ–∫ (SEO, —á–∏—Ç–∞–µ–º–æ—Å—Ç—å)
2. –û–ø–∏—Å–∞–Ω–∏–µ (–ø–æ–ª–Ω–æ—Ç–∞, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
3. –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å)
4. –§–æ—Ç–æ (–ø–æ –æ–ø–∏—Å–∞–Ω–∏—é)
5. –¶–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ)

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û JSON):
{
    "score": <—á–∏—Å–ª–æ 1-100>,
    "issues": [
        {"priority": "high/medium/low", "issue": "–ø—Ä–æ–±–ª–µ–º–∞", "fix": "—Ä–µ—à–µ–Ω–∏–µ"}
    ],
    "recommendations": [
        "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1",
        "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2"
    ],
    "strengths": ["—Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ 1"]
}

–í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON."""
    },

    "category_detection": {
        "name": "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π WB",
        "description": "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ Wildberries",
        "template": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ Wildberries.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é WB –¥–ª—è —Ç–æ–≤–∞—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ –¥–∞–Ω–Ω—ã—Ö.

–î–û–°–¢–£–ü–ù–´–ï –ö–ê–¢–ï–ì–û–†–ò–ò WB:
{categories_list}

–ü–†–ê–í–ò–õ–ê:
1. –í—ã–±–∏—Ä–∞–π –¢–û–õ–¨–ö–û –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
2. –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä –º–æ–∂–µ—Ç –æ—Ç–Ω–æ—Å–∏—Ç—å—Å—è –∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º - –≤—ã–±–∏—Ä–∞–π –Ω–∞–∏–±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—É—é
3. –£—á–∏—Ç—ã–≤–∞–π –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞, –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
4. –î–ª—è –∏–Ω—Ç–∏–º-—Ç–æ–≤–∞—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–í–∏–±—Ä–∞—Ç–æ—Ä—ã, –§–∞–ª–ª–æ–∏–º–∏—Ç–∞—Ç–æ—Ä—ã –∏ —Ç.–¥.)
5. –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω - –≤—ã–±–∏—Ä–∞–π –±–æ–ª–µ–µ –æ–±—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û JSON):
{{
    "category_id": <—á–∏—Å–ª–æ - ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ —Å–ø–∏—Å–∫–∞>,
    "category_name": "<–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏>",
    "confidence": <—á–∏—Å–ª–æ –æ—Ç 0.0 –¥–æ 1.0 - —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å>,
    "reasoning": "<–∫—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞>"
}}

–í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."""
    },

    "size_parsing": {
        "name": "–ü–∞—Ä—Å–∏–Ω–≥ —Ä–∞–∑–º–µ—Ä–æ–≤",
        "description": "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ —Ç–æ–≤–∞—Ä–∞",
        "template": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø–∞—Ä—Å–∏–Ω–≥—É —Ä–∞–∑–º–µ—Ä–æ–≤ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –∏–∑–≤–ª–µ—á—å –í–°–ï —Ä–∞–∑–º–µ—Ä—ã –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –í–°–ï –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø–æ–ª—è.

–î–û–°–¢–£–ü–ù–´–ï –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò –î–õ–Ø –ó–ê–ü–û–õ–ù–ï–ù–ò–Ø:
{characteristics_list}

–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
1. –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å –û–î–ù–û –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä "–¥–ª–∏–Ω–∞ 7,5 —Å–º") - –∑–∞–ø–æ–ª–Ω–∏ –∏–º –í–°–ï —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –¥–ª–∏–Ω—ã —Ç–æ–≤–∞—Ä–∞ (–Ω–µ —É–ø–∞–∫–æ–≤–∫–∏)
2. –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –¥–∏–∞–º–µ—Ç—Ä–∞, —à–∏—Ä–∏–Ω—ã –∏ –¥—Ä—É–≥–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ - –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω—è–π –∫–æ –≤—Å–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º
3. –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —É–ø–∞–∫–æ–≤–∫–∏ (—Å —Å–ª–æ–≤–æ–º "—É–ø–∞–∫–æ–≤–∫–∞/—É–ø–∞–∫") –∑–∞–ø–æ–ª–Ω—è–π –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω—ã —Ä–∞–∑–º–µ—Ä—ã —É–ø–∞–∫–æ–≤–∫–∏
4. –ü—Ä–µ–æ–±—Ä–∞–∑—É–π –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ (—Å–º, –≥, –º–ª)
5. –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –¥–∏–∞–ø–∞–∑–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, "15-18 —Å–º") - –∏—Å–ø–æ–ª—å–∑—É–π —Å—Ä–µ–¥–Ω–µ–µ –∏–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
6. –ß–∏—Å–ª–∞ —Å –∑–∞–ø—è—Ç–æ–π (7,5) –ø—Ä–µ–æ–±—Ä–∞–∑—É–π –≤ —Ñ–æ—Ä–º–∞—Ç —Å —Ç–æ—á–∫–æ–π (7.5)

–ü–†–ò–ú–ï–†–´:
- "–¥–ª–∏–Ω–∞ –≤–∏–±—Ä–æ–ø—É–ª–∏ 7,5 —Å–º" ‚Üí –∑–∞–ø–æ–ª–Ω–∏: "–î–ª–∏–Ω–∞ –∏–∑–¥–µ–ª–∏—è": "7.5", "–î–ª–∏–Ω–∞": "7.5", "–†–∞–±–æ—á–∞—è –¥–ª–∏–Ω–∞": "7.5" (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ)
- "–¥–∏–∞–º–µ—Ç—Ä 2 —Å–º" ‚Üí –∑–∞–ø–æ–ª–Ω–∏: "–î–∏–∞–º–µ—Ç—Ä": "2", "–î–∏–∞–º–µ—Ç—Ä –∏–∑–¥–µ–ª–∏—è": "2" (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ)
- "—Ä–∞–∑–º–µ—Ä —Ç—Ä—É—Å–∏–∫–æ–≤ 48-50" ‚Üí –∑–∞–ø–æ–ª–Ω–∏: "–†–∞–∑–º–µ—Ä": "48-50"

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û JSON):
{{
    "characteristics": {{
        "–ù–∞–∑–≤–∞–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–∑ —Å–ø–∏—Å–∫–∞": "–∑–Ω–∞—á–µ–Ω–∏–µ",
        ...
    }},
    "raw_sizes": ["–∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç —Ä–∞–∑–º–µ—Ä–æ–≤"],
    "has_clothing_sizes": true/false,
    "confidence": <—á–∏—Å–ª–æ –æ—Ç 0.0 –¥–æ 1.0>
}}

–í–ê–ñ–ù–û:
- –ó–∞–ø–æ–ª–Ω—è–π –ú–ê–ö–°–ò–ú–£–ú —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∏–∑ —Å–ø–∏—Å–∫–∞ –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥—Ö–æ–¥—è—Ç
- –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞"""
    },

    "dimensions_extraction": {
        "name": "–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≥–∞–±–∞—Ä–∏—Ç–æ–≤",
        "description": "–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ —Ç–æ–≤–∞—Ä–∞ (–¥–ª–∏–Ω–∞, —à–∏—Ä–∏–Ω–∞, –≤—ã—Å–æ—Ç–∞, –≤–µ—Å)",
        "template": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—é —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ Wildberries.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –Ω–∞–π—Ç–∏ –∏ –∏–∑–≤–ª–µ—á—å –í–°–ï –≥–∞–±–∞—Ä–∏—Ç—ã —Ç–æ–≤–∞—Ä–∞ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è, –æ–ø–∏—Å–∞–Ω–∏—è –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫.

–ö–ê–ö–ò–ï –†–ê–ó–ú–ï–†–´ –ù–£–ñ–ù–û –ù–ê–ô–¢–ò:
1. –î–ª–∏–Ω–∞ (—Å–º) - –æ–±—â–∞—è –¥–ª–∏–Ω–∞ –∏–∑–¥–µ–ª–∏—è
2. –®–∏—Ä–∏–Ω–∞ (—Å–º) - —à–∏—Ä–∏–Ω–∞ –∏–∑–¥–µ–ª–∏—è
3. –í—ã—Å–æ—Ç–∞ (—Å–º) - –≤—ã—Å–æ—Ç–∞ –∏–∑–¥–µ–ª–∏—è
4. –ì–ª—É–±–∏–Ω–∞ (—Å–º) - –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ
5. –î–∏–∞–º–µ—Ç—Ä (—Å–º) - –¥–ª—è –∫—Ä—É–≥–ª—ã—Ö –∏–∑–¥–µ–ª–∏–π
6. –í–µ—Å (–≥) - –≤–µ—Å —Ç–æ–≤–∞—Ä–∞
7. –û–±—ä–µ–º (–º–ª/–ª) - –¥–ª—è –∂–∏–¥–∫–æ—Å—Ç–µ–π –∏ –µ–º–∫–æ—Å—Ç–µ–π
8. –†–∞–±–æ—á–∞—è –¥–ª–∏–Ω–∞ (—Å–º) - –¥–ª—è –≤–∏–±—Ä–∞—Ç–æ—Ä–æ–≤ –∏ –ø–æ–¥–æ–±–Ω—ã—Ö –∏–∑–¥–µ–ª–∏–π
9. –†–∞–∑–º–µ—Ä—ã —É–ø–∞–∫–æ–≤–∫–∏ (–¥–ª–∏–Ω–∞ x —à–∏—Ä–∏–Ω–∞ x –≤—ã—Å–æ—Ç–∞)

–ü–†–ê–í–ò–õ–ê:
1. –ü—Ä–µ–æ–±—Ä–∞–∑—É–π –≤—Å–µ –µ–¥–∏–Ω–∏—Ü—ã –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ (—Å–º, –≥, –º–ª)
2. –ß–∏—Å–ª–∞ —Å –∑–∞–ø—è—Ç–æ–π –ø—Ä–µ–æ–±—Ä–∞–∑—É–π –≤ —Ç–æ—á–∫—É (7,5 ‚Üí 7.5)
3. –ï—Å–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω (15-20 —Å–º) - —É–∫–∞–∂–∏ –∫–∞–∫ "15-20" –∏–ª–∏ —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
4. –†–∞–∑–ª–∏—á–∞–π —Ä–∞–∑–º–µ—Ä—ã —Ç–æ–≤–∞—Ä–∞ –∏ —Ä–∞–∑–º–µ—Ä—ã —É–ø–∞–∫–æ–≤–∫–∏!
5. –î–ª—è –æ–¥–µ–∂–¥—ã: –æ–±—Ö–≤–∞—Ç –≥—Ä—É–¥–∏, —Ç–∞–ª–∏–∏, –±–µ–¥–µ—Ä –≤ —Å–º

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û JSON):
{
    "dimensions": {
        "length_cm": <—á–∏—Å–ª–æ –∏–ª–∏ null>,
        "width_cm": <—á–∏—Å–ª–æ –∏–ª–∏ null>,
        "height_cm": <—á–∏—Å–ª–æ –∏–ª–∏ null>,
        "depth_cm": <—á–∏—Å–ª–æ –∏–ª–∏ null>,
        "diameter_cm": <—á–∏—Å–ª–æ –∏–ª–∏ null>,
        "weight_g": <—á–∏—Å–ª–æ –∏–ª–∏ null>,
        "volume_ml": <—á–∏—Å–ª–æ –∏–ª–∏ null>,
        "working_length_cm": <—á–∏—Å–ª–æ –∏–ª–∏ null>
    },
    "package_dimensions": {
        "length_cm": <—á–∏—Å–ª–æ –∏–ª–∏ null>,
        "width_cm": <—á–∏—Å–ª–æ –∏–ª–∏ null>,
        "height_cm": <—á–∏—Å–ª–æ –∏–ª–∏ null>,
        "weight_g": <—á–∏—Å–ª–æ –∏–ª–∏ null>
    },
    "raw_text": "<–∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç —Å —Ä–∞–∑–º–µ—Ä–∞–º–∏>",
    "confidence": <—á–∏—Å–ª–æ –æ—Ç 0.0 –¥–æ 1.0>
}

–í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON."""
    },

    "clothing_sizes": {
        "name": "–ü–∞—Ä—Å–∏–Ω–≥ —Ä–∞–∑–º–µ—Ä–æ–≤ —Ç–æ–≤–∞—Ä–∞",
        "description": "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –æ–¥–µ–∂–¥—ã –∏–ª–∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –≥–∞–±–∞—Ä–∏—Ç–æ–≤",
        "template": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ Wildberries.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø —Ä–∞–∑–º–µ—Ä–æ–≤ –∏ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∏—Ö:

–¢–ò–ü 1: –†–ê–ó–ú–ï–†–´ –û–î–ï–ñ–î–´ (S/M/L/42/44/46)
- –ë—É–∫–≤–µ–Ω–Ω—ã–µ: XXS, XS, S, M, L, XL, XXL, XXXL
- –†–æ—Å—Å–∏–π—Å–∫–∏–µ: 40, 42, 44, 46, 48, 50, 52, 54, 56
- –ë–µ–ª—å—ë: 70A, 75B, 80C
- –û–±—É–≤—å: 35-45

–¢–ò–ü 2: –§–ò–ó–ò–ß–ï–°–ö–ò–ï –ì–ê–ë–ê–†–ò–¢–´ (—Å–º, –º–º, –≥)
- –î–ª–∏–Ω–∞, —à–∏—Ä–∏–Ω–∞, –≤—ã—Å–æ—Ç–∞, –≥–ª—É–±–∏–Ω–∞
- –î–∏–∞–º–µ—Ç—Ä, —Ç–æ–ª—â–∏–Ω–∞
- –í–µ—Å, –æ–±—ä—ë–º
- –†–∞–±–æ—á–∞—è –¥–ª–∏–Ω–∞

–ü–†–ê–í–ò–õ–ê:
1. –°–ù–ê–ß–ê–õ–ê –æ–ø—Ä–µ–¥–µ–ª–∏ - —ç—Ç–æ —Ä–∞–∑–º–µ—Ä—ã –æ–¥–µ–∂–¥—ã –∏–ª–∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –≥–∞–±–∞—Ä–∏—Ç—ã
2. –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å "—Å–º", "–º–º", "–¥–ª–∏–Ω–∞", "–¥–∏–∞–º–µ—Ç—Ä", "–≤–µ—Å" - —ç—Ç–æ –§–ò–ó–ò–ß–ï–°–ö–ò–ï –ì–ê–ë–ê–†–ò–¢–´
3. –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ S/M/L –∏–ª–∏ 42/44/46 –±–µ–∑ –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è - —ç—Ç–æ –û–î–ï–ñ–î–ê
4. –í—Å–µ —á–∏—Å–ª–∞ –≤–æ–∑–≤—Ä–∞—â–∞–π –Ω–∞ –†–£–°–°–ö–û–ú —è–∑—ã–∫–µ

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û JSON):
{
    "product_type": "clothing/physical/unknown",
    "size_type": "letter/numeric/combined/one_size/dimensions",
    "sizes": [
        {
            "original": "<–∏—Å—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ>",
            "standardized": "<—Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ>",
            "ru_size": "<—Ä–æ—Å—Å–∏–π—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä –µ—Å–ª–∏ –æ–¥–µ–∂–¥–∞>",
            "international": "<–º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π –µ—Å–ª–∏ –æ–¥–µ–∂–¥–∞>"
        }
    ],
    "dimensions": {
        "length_cm": "<–¥–ª–∏–Ω–∞ –≤ —Å–º>",
        "width_cm": "<—à–∏—Ä–∏–Ω–∞ –≤ —Å–º>",
        "height_cm": "<–≤—ã—Å–æ—Ç–∞ –≤ —Å–º>",
        "diameter_cm": "<–¥–∏–∞–º–µ—Ç—Ä –≤ —Å–º>",
        "working_length_cm": "<—Ä–∞–±–æ—á–∞—è –¥–ª–∏–Ω–∞ –≤ —Å–º>",
        "weight_g": "<–≤–µ—Å –≤ –≥—Ä–∞–º–º–∞—Ö>",
        "volume_ml": "<–æ–±—ä—ë–º –≤ –º–ª>"
    },
    "size_range": {
        "min": "<–º–∏–Ω–∏–º—É–º>",
        "max": "<–º–∞–∫—Å–∏–º—É–º>"
    },
    "body_measurements": {
        "chest_cm": "<–æ–±—Ö–≤–∞—Ç –≥—Ä—É–¥–∏>",
        "waist_cm": "<–æ–±—Ö–≤–∞—Ç —Ç–∞–ª–∏–∏>",
        "hips_cm": "<–æ–±—Ö–≤–∞—Ç –±–µ–¥–µ—Ä>"
    },
    "fit_type": "tight/regular/loose/oversized",
    "raw_text": "<–∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç —Å —Ä–∞–∑–º–µ—Ä–∞–º–∏>",
    "confidence": <—á–∏—Å–ª–æ –æ—Ç 0.0 –¥–æ 1.0>
}

–í–ê–ñ–ù–û:
- –ï—Å–ª–∏ —ç—Ç–æ –§–ò–ó–ò–ß–ï–°–ö–ò–ï –ì–ê–ë–ê–†–ò–¢–´ (product_type="physical"):
  - –ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª–µ "dimensions"
  - –ú–∞—Å—Å–∏–≤ "sizes" –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–£–°–¢–´–ú []
  - size_type –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å "dimensions"
- –ï—Å–ª–∏ —ç—Ç–æ –û–î–ï–ñ–î–ê (product_type="clothing"):
  - –ó–∞–ø–æ–ª–Ω–∏ –º–∞—Å—Å–∏–≤ "sizes"
  - –ü–æ–ª–µ "dimensions" –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º {}
- –ù–ï —Å–º–µ—à–∏–≤–∞–π —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –≥–∞–±–∞—Ä–∏—Ç—ã –∏ —Ä–∞–∑–º–µ—Ä—ã –æ–¥–µ–∂–¥—ã!
- –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON
- –í—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ –†–£–°–°–ö–û–ú"""
    },

    "brand_detection": {
        "name": "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±—Ä–µ–Ω–¥–∞",
        "description": "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±—Ä–µ–Ω–¥–∞ —Ç–æ–≤–∞—Ä–∞",
        "template": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –±—Ä–µ–Ω–¥–∞–º —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ Wildberries.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –±—Ä–µ–Ω–¥ —Ç–æ–≤–∞—Ä–∞ –∏–∑ –µ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è, –æ–ø–∏—Å–∞–Ω–∏—è –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫.

–ü–†–ê–í–ò–õ–ê –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –ë–†–ï–ù–î–ê:
1. –ë—Ä–µ–Ω–¥ –æ–±—ã—á–Ω–æ —É–∫–∞–∑–∞–Ω –≤ –Ω–∞—á–∞–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∏–ª–∏ –≤ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞—Ö
2. –û—Ç–ª–∏—á–∞–π –±—Ä–µ–Ω–¥ –æ—Ç —Ç–∏–ø–∞ —Ç–æ–≤–∞—Ä–∞ (Nike - –±—Ä–µ–Ω–¥, –ö—Ä–æ—Å—Å–æ–≤–∫–∏ - —Ç–∏–ø)
3. –ï—Å–ª–∏ –±—Ä–µ–Ω–¥ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω - –ø–æ–ø—Ä–æ–±—É–π –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ:
   - –£–ø–æ–º–∏–Ω–∞–Ω–∏—é –≤ –æ–ø–∏—Å–∞–Ω–∏–∏
   - –•–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–º –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è–º –ø—Ä–æ–¥—É–∫—Ü–∏–∏
   - –°—Ç–∏–ª—é –Ω–∞–∑–≤–∞–Ω–∏—è
4. –î–ª—è –∫–∏—Ç–∞–π—Å–∫–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ –±–µ–∑ —è–≤–Ω–æ–≥–æ –±—Ä–µ–Ω–¥–∞ - —É–∫–∞–∑—ã–≤–∞–π "No brand" –∏–ª–∏ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π
5. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –±—Ä–µ–Ω–¥—ã –∏–º–µ—é—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–∞–ø–∏—Å–∞–Ω–∏–π - –≤—ã–±–∏—Ä–∞–π –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ

–ü–û–ü–£–õ–Ø–†–ù–´–ï –ë–†–ï–ù–î–´ –ü–û –ö–ê–¢–ï–ì–û–†–ò–Ø–ú:
- –û–¥–µ–∂–¥–∞: Zara, H&M, Nike, Adidas, Puma, Reebok, Calvin Klein
- –ö–æ—Å–º–µ—Ç–∏–∫–∞: L'Oreal, Maybelline, MAC, NYX, Garnier
- –≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞: Samsung, Apple, Xiaomi, Huawei, JBL
- –ò–Ω—Ç–∏–º-—Ç–æ–≤–∞—Ä—ã: Lola Games, Bior toys, Sexus, Lovetoy, Pipedream

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û JSON):
{
    "brand": "<–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –±—Ä–µ–Ω–¥>",
    "brand_normalized": "<–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è WB>",
    "brand_type": "known/generic/no_brand/unknown",
    "brand_origin": "–Ω–∞–∑–≤–∞–Ω–∏–µ/–æ–ø–∏—Å–∞–Ω–∏–µ/—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏/–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ_–ø–æ_–∫–æ–Ω—Ç–µ–∫—Å—Ç—É",
    "alternative_names": ["–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ 1", "–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ 2"],
    "is_official": true/false,
    "confidence": <—á–∏—Å–ª–æ –æ—Ç 0.0 –¥–æ 1.0>,
    "reasoning": "<–ø–æ—á–µ–º—É –≤—ã–±—Ä–∞–Ω —ç—Ç–æ—Ç –±—Ä–µ–Ω–¥>"
}

–í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON."""
    },

    "material_detection": {
        "name": "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤",
        "description": "–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö –∏ —Å–æ—Å—Ç–∞–≤–µ —Ç–æ–≤–∞—Ä–∞",
        "template": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º –∏ —Å–æ—Å—Ç–∞–≤—É —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ Wildberries.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ —Å–æ—Å—Ç–∞–≤ —Ç–æ–≤–∞—Ä–∞ –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫.

–¢–ò–ü–´ –ú–ê–¢–ï–†–ò–ê–õ–û–í:

1. –¢–ö–ê–ù–ò:
   - –ù–∞—Ç—É—Ä–∞–ª—å–Ω—ã–µ: —Ö–ª–æ–ø–æ–∫, –ª–µ–Ω, —à–µ–ª–∫, —à–µ—Ä—Å—Ç—å, –∫–∞—à–µ–º–∏—Ä, –≤–∏—Å–∫–æ–∑–∞
   - –°–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–µ: –ø–æ–ª–∏—ç—Å—Ç–µ—Ä, –Ω–µ–π–ª–æ–Ω, –∞–∫—Ä–∏–ª, —ç–ª–∞—Å—Ç–∞–Ω, —Å–ø–∞–Ω–¥–µ–∫—Å
   - –°–º–µ—à–∞–Ω–Ω—ã–µ: —Ö–ª–æ–ø–æ–∫ 95% + —ç–ª–∞—Å—Ç–∞–Ω 5%

2. –ú–ê–¢–ï–†–ò–ê–õ–´ –ò–ù–¢–ò–ú-–¢–û–í–ê–†–û–í:
   - –°–∏–ª–∏–∫–æ–Ω (–º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π, –ø–∏—â–µ–≤–æ–π)
   - TPE/TPR (—Ç–µ—Ä–º–æ–ø–ª–∞—Å—Ç–∏—á–Ω—ã–π —ç–ª–∞—Å—Ç–æ–º–µ—Ä)
   - ABS-–ø–ª–∞—Å—Ç–∏–∫
   - –ö–∏–±–µ—Ä-–∫–æ–∂–∞ (CyberSkin)
   - –ü–í–•
   - –õ–∞—Ç–µ–∫—Å
   - –ú–µ—Ç–∞–ª–ª (–Ω–µ—Ä–∂–∞–≤–µ—é—â–∞—è —Å—Ç–∞–ª—å)

3. –î–†–£–ì–ò–ï:
   - –ö–æ–∂–∞ (–Ω–∞—Ç—É—Ä–∞–ª—å–Ω–∞—è, –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–∞—è, —ç–∫–æ–∫–æ–∂–∞)
   - –ü–ª–∞—Å—Ç–∏–∫, –º–µ—Ç–∞–ª–ª, —Å—Ç–µ–∫–ª–æ, –¥–µ—Ä–µ–≤–æ

–ü–†–ê–í–ò–õ–ê:
1. –ò–∑–≤–ª–µ–∫–∏ –í–°–ï —É–ø–æ–º—è–Ω—É—Ç—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
2. –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω —Å–æ—Å—Ç–∞–≤ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö - —Å–æ—Ö—Ä–∞–Ω–∏ –ø—Ä–æ—Ü–µ–Ω—Ç—ã
3. –û–ø—Ä–µ–¥–µ–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª (–¥–æ–º–∏–Ω–∏—Ä—É—é—â–∏–π)
4. –î–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —É–∫–∞–∂–∏ –≥–∏–ø–æ–∞–ª–ª–µ—Ä–≥–µ–Ω–Ω–æ—Å—Ç—å

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û JSON):
{
    "materials": [
        {
            "name": "<–Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞>",
            "name_ru": "<–Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º>",
            "percentage": <–ø—Ä–æ—Ü–µ–Ω—Ç –∏–ª–∏ null>,
            "is_primary": true/false
        }
    ],
    "composition_text": "<–ø–æ–ª–Ω—ã–π —Å–æ—Å—Ç–∞–≤ –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞>",
    "material_type": "natural/synthetic/mixed/unknown",
    "care_instructions": ["—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1", "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2"],
    "properties": {
        "hypoallergenic": true/false/null,
        "waterproof": true/false/null,
        "body_safe": true/false/null,
        "phthalate_free": true/false/null
    },
    "confidence": <—á–∏—Å–ª–æ –æ—Ç 0.0 –¥–æ 1.0>
}

–í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON."""
    },

    "color_detection": {
        "name": "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞",
        "description": "–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ü–≤–µ—Ç–µ —Ç–æ–≤–∞—Ä–∞",
        "template": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ü–≤–µ—Ç–∞–º —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ Wildberries.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ü–≤–µ—Ç —Ç–æ–≤–∞—Ä–∞ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è, –æ–ø–∏—Å–∞–Ω–∏—è –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫.

–°–¢–ê–ù–î–ê–†–¢–ù–´–ï –¶–í–ï–¢–ê WB:
- –ë–∞–∑–æ–≤—ã–µ: —á–µ—Ä–Ω—ã–π, –±–µ–ª—ã–π, —Å–µ—Ä—ã–π, –±–µ–∂–µ–≤—ã–π, –∫–æ—Ä–∏—á–Ω–µ–≤—ã–π
- –Ø—Ä–∫–∏–µ: –∫—Ä–∞—Å–Ω—ã–π, —Å–∏–Ω–∏–π, –∑–µ–ª–µ–Ω—ã–π, –∂–µ–ª—Ç—ã–π, –æ—Ä–∞–Ω–∂–µ–≤—ã–π, —Ä–æ–∑–æ–≤—ã–π, —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π
- –û—Ç—Ç–µ–Ω–∫–∏: –≥–æ–ª—É–±–æ–π, –±–∏—Ä—é–∑–æ–≤—ã–π, –±–æ—Ä–¥–æ–≤—ã–π, –º—è—Ç–Ω—ã–π, –∫–æ—Ä–∞–ª–ª–æ–≤—ã–π, –ø–µ—Ä—Å–∏–∫–æ–≤—ã–π
- –ú–µ—Ç–∞–ª–ª–∏–∫: –∑–æ–ª–æ—Ç–æ–π, —Å–µ—Ä–µ–±—Ä—è–Ω—ã–π, –±—Ä–æ–Ω–∑–æ–≤—ã–π
- –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π, –º—É–ª—å—Ç–∏–∫–æ–ª–æ—Ä

–ü–†–ê–í–ò–õ–ê:
1. –û–ø—Ä–µ–¥–µ–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç —Ç–æ–≤–∞—Ä–∞
2. –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä –º–Ω–æ–≥–æ—Ü–≤–µ—Ç–Ω—ã–π - —É–∫–∞–∂–∏ –≤—Å–µ —Ü–≤–µ—Ç–∞
3. –ù–æ—Ä–º–∞–ª–∏–∑—É–π –Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–∞ –¥–ª—è WB (–º–æ–ª–æ—á–Ω—ã–π ‚Üí –±–µ–ª—ã–π/–±–µ–∂–µ–≤—ã–π)
4. –†–∞–∑–ª–∏—á–∞–π —Ü–≤–µ—Ç —Ç–æ–≤–∞—Ä–∞ –∏ —Ü–≤–µ—Ç —É–ø–∞–∫–æ–≤–∫–∏

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û JSON):
{
    "primary_color": "<–æ—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç>",
    "primary_color_wb": "<—Ü–≤–µ—Ç –¥–ª—è WB>",
    "secondary_colors": ["–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ü–≤–µ—Ç 1", "–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ü–≤–µ—Ç 2"],
    "color_description": "<–æ–ø–∏—Å–∞–Ω–∏–µ —Ü–≤–µ—Ç–∞ –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞>",
    "is_multicolor": true/false,
    "is_transparent": true/false,
    "hex_code": "<#RRGGBB –∏–ª–∏ null>",
    "color_family": "neutral/warm/cool/bright/dark",
    "confidence": <—á–∏—Å–ª–æ –æ—Ç 0.0 –¥–æ 1.0>
}

–í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON."""
    },

    "product_attributes": {
        "name": "–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∞—Ç—Ä–∏–±—É—Ç–æ–≤",
        "description": "–ü–æ–ª–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ —Ç–æ–≤–∞—Ä–∞ –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å",
        "template": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ Wildberries.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –∏–∑–≤–ª–µ—á—å –í–°–ï –≤–æ–∑–º–æ–∂–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã —Ç–æ–≤–∞—Ä–∞ –∑–∞ –æ–¥–∏–Ω –ø—Ä–æ—Ö–æ–¥.

–ê–¢–†–ò–ë–£–¢–´ –î–õ–Ø –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø:

1. –ë–†–ï–ù–î - –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è/–±—Ä–µ–Ω–¥–∞

2. –¶–í–ï–¢ - –æ—Å–Ω–æ–≤–Ω–æ–π –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ü–≤–µ—Ç–∞

3. –ú–ê–¢–ï–†–ò–ê–õ - —Å–æ—Å—Ç–∞–≤ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è

4. –†–ê–ó–ú–ï–†–´:
   - –§–∏–∑–∏—á–µ—Å–∫–∏–µ –≥–∞–±–∞—Ä–∏—Ç—ã (–¥–ª–∏–Ω–∞, —à–∏—Ä–∏–Ω–∞, –≤—ã—Å–æ—Ç–∞, –≤–µ—Å)
   - –†–∞–∑–º–µ—Ä—ã –æ–¥–µ–∂–¥—ã (S, M, L –∏–ª–∏ 42, 44, 46)
   - –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã (–¥–∏–∞–º–µ—Ç—Ä, –æ–±—ä–µ–º)

5. –ü–û–õ - –º—É–∂—Å–∫–æ–π/–∂–µ–Ω—Å–∫–∏–π/—É–Ω–∏—Å–µ–∫—Å

6. –í–û–ó–†–ê–°–¢ - –≤–∑—Ä–æ—Å–ª—ã–π/–¥–µ—Ç—Å–∫–∏–π/–ø–æ–¥—Ä–æ—Å—Ç–∫–æ–≤—ã–π + –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω

7. –°–ï–ó–û–ù - –≤—Å–µ—Å–µ–∑–æ–Ω–Ω—ã–π/–ª–µ—Ç–æ/–∑–∏–º–∞/–¥–µ–º–∏—Å–µ–∑–æ–Ω

8. –°–¢–†–ê–ù–ê - —Å—Ç—Ä–∞–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞

9. –ö–û–ú–ü–õ–ï–ö–¢–ê–¶–ò–Ø - —á—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ –Ω–∞–±–æ—Ä

10. –û–°–û–ë–ï–ù–ù–û–°–¢–ò - —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ç–æ–≤–∞—Ä–∞

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û JSON):
{
    "brand": {
        "name": "<–±—Ä–µ–Ω–¥>",
        "normalized": "<–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ>",
        "confidence": <0.0-1.0>
    },
    "colors": {
        "primary": "<–æ—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç>",
        "secondary": ["–¥–æ–ø. —Ü–≤–µ—Ç"],
        "wb_color": "<—Ü–≤–µ—Ç –¥–ª—è WB>"
    },
    "materials": {
        "primary": "<–æ—Å–Ω–æ–≤–Ω–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª>",
        "composition": "<–ø–æ–ª–Ω—ã–π —Å–æ—Å—Ç–∞–≤>",
        "properties": ["—Å–≤–æ–π—Å—Ç–≤–æ1", "—Å–≤–æ–π—Å—Ç–≤–æ2"]
    },
    "dimensions": {
        "length_cm": <—á–∏—Å–ª–æ –∏–ª–∏ null>,
        "width_cm": <—á–∏—Å–ª–æ –∏–ª–∏ null>,
        "height_cm": <—á–∏—Å–ª–æ –∏–ª–∏ null>,
        "diameter_cm": <—á–∏—Å–ª–æ –∏–ª–∏ null>,
        "weight_g": <—á–∏—Å–ª–æ –∏–ª–∏ null>,
        "volume_ml": <—á–∏—Å–ª–æ –∏–ª–∏ null>
    },
    "clothing_size": {
        "type": "letter/numeric/one_size/null",
        "sizes": ["S", "M", "L"],
        "ru_sizes": ["42", "44", "46"]
    },
    "gender": "male/female/unisex/null",
    "age_group": "adult/teen/child/baby/null",
    "age_range": "<–≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω –∏–ª–∏ null>",
    "season": "all_season/summer/winter/demi/null",
    "country": "<—Å—Ç—Ä–∞–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –∏–ª–∏ null>",
    "package_contents": ["—ç–ª–µ–º–µ–Ω—Ç 1", "—ç–ª–µ–º–µ–Ω—Ç 2"],
    "special_features": ["–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å 1", "–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å 2"],
    "overall_confidence": <—á–∏—Å–ª–æ –æ—Ç 0.0 –¥–æ 1.0>
}

–í–ê–ñ–ù–û: –ó–∞–ø–æ–ª–Ω—è–π –í–°–ï –ø–æ–ª—è —á—Ç–æ –º–æ–∂–µ—à—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å. –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON."""
    }
}


@dataclass
class AIConfig:
    """–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞"""
    provider: AIProvider
    api_key: str = ""  # API –∫–ª—é—á (Bearer token) –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
    api_base_url: str = "https://foundation-models.api.cloud.ru/v1"
    model: str = "openai/gpt-oss-120b"
    temperature: float = 0.3
    max_tokens: int = 2000
    timeout: int = 60
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    top_p: float = 0.95
    presence_penalty: float = 0.0
    frequency_penalty: float = 0.0
    # –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–π AI —Ñ—É–Ω–∫—Ü–∏–∏
    custom_category_instruction: str = ""
    custom_size_instruction: str = ""
    custom_seo_title_instruction: str = ""
    custom_keywords_instruction: str = ""
    custom_bullets_instruction: str = ""
    custom_description_instruction: str = ""
    custom_rich_content_instruction: str = ""
    custom_analysis_instruction: str = ""
    # –ù–æ–≤—ã–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
    custom_dimensions_instruction: str = ""
    custom_clothing_sizes_instruction: str = ""
    custom_brand_instruction: str = ""
    custom_material_instruction: str = ""
    custom_color_instruction: str = ""
    custom_attributes_instruction: str = ""
    # –î–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    seller_id: int = 0

    @classmethod
    def from_settings(cls, settings) -> Optional['AIConfig']:
        """–°–æ–∑–¥–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞–≤—Ç–æ–∏–º–ø–æ—Ä—Ç–∞"""
        if not hasattr(settings, 'ai_enabled') or not settings.ai_enabled:
            return None

        provider = AIProvider(settings.ai_provider or 'cloudru')

        # –í—Å–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç API –∫–ª—é—á (Bearer token)
        if not settings.ai_api_key:
            logger.warning("AI –≤–∫–ª—é—á–µ–Ω, –Ω–æ API –∫–ª—é—á –Ω–µ —É–∫–∞–∑–∞–Ω")
            return None

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–π URL –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
        if provider == AIProvider.CLOUDRU:
            api_base = settings.ai_api_base_url or "https://foundation-models.api.cloud.ru/v1"
            default_model = "openai/gpt-oss-120b"
        elif provider == AIProvider.CUSTOM:
            api_base = settings.ai_api_base_url or "https://api.openai.com/v1"
            default_model = "gpt-4o-mini"
        else:  # OpenAI
            api_base = "https://api.openai.com/v1"
            default_model = "gpt-4o-mini"

        return cls(
            provider=provider,
            api_key=settings.ai_api_key,
            api_base_url=api_base,
            model=settings.ai_model or default_model,
            temperature=getattr(settings, 'ai_temperature', 0.3) or 0.3,
            max_tokens=getattr(settings, 'ai_max_tokens', 2000) or 2000,
            timeout=getattr(settings, 'ai_timeout', 60) or 60,
            top_p=getattr(settings, 'ai_top_p', 0.95) or 0.95,
            presence_penalty=getattr(settings, 'ai_presence_penalty', 0.0) or 0.0,
            frequency_penalty=getattr(settings, 'ai_frequency_penalty', 0.0) or 0.0,
            custom_category_instruction=getattr(settings, 'ai_category_instruction', '') or '',
            custom_size_instruction=getattr(settings, 'ai_size_instruction', '') or '',
            custom_seo_title_instruction=getattr(settings, 'ai_seo_title_instruction', '') or '',
            custom_keywords_instruction=getattr(settings, 'ai_keywords_instruction', '') or '',
            custom_bullets_instruction=getattr(settings, 'ai_bullets_instruction', '') or '',
            custom_description_instruction=getattr(settings, 'ai_description_instruction', '') or '',
            custom_rich_content_instruction=getattr(settings, 'ai_rich_content_instruction', '') or '',
            custom_analysis_instruction=getattr(settings, 'ai_analysis_instruction', '') or '',
            # –ù–æ–≤—ã–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
            custom_dimensions_instruction=getattr(settings, 'ai_dimensions_instruction', '') or '',
            custom_clothing_sizes_instruction=getattr(settings, 'ai_clothing_sizes_instruction', '') or '',
            custom_brand_instruction=getattr(settings, 'ai_brand_instruction', '') or '',
            custom_material_instruction=getattr(settings, 'ai_material_instruction', '') or '',
            custom_color_instruction=getattr(settings, 'ai_color_instruction', '') or '',
            custom_attributes_instruction=getattr(settings, 'ai_attributes_instruction', '') or '',
            seller_id=getattr(settings, 'seller_id', 0) or 0
        )


class AIClient:
    """
    –ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å AI API
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ API (Cloud.ru, OpenAI, Custom)
    """

    def __init__(self, config: AIConfig):
        self.config = config
        self._session = requests.Session()
        self._session.headers.update({
            'Content-Type': 'application/json'
        })

        # –î–ª—è Cloud.ru –∏—Å–ø–æ–ª—å–∑—É–µ–º TokenManager (–Ω—É–∂–µ–Ω token exchange)
        self._token_manager: Optional[CloudRuTokenManager] = None
        if config.provider == AIProvider.CLOUDRU:
            self._token_manager = get_cloudru_token_manager(config.api_key)
        else:
            # –î–ª—è OpenAI/Custom –∏—Å–ø–æ–ª—å–∑—É–µ–º API key –Ω–∞–ø—Ä—è–º—É—é
            self._session.headers['Authorization'] = f'Bearer {config.api_key}'

    def _get_auth_header(self) -> Optional[str]:
        """–ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π Authorization header"""
        if self._token_manager:
            # Cloud.ru - –ø–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–π access token
            token = self._token_manager.get_access_token()
            if token:
                auth_header = f'Bearer {token}'
                logger.info(f"üîê Auth header: Bearer {token[:20]}... (–¥–ª–∏–Ω–∞ —Ç–æ–∫–µ–Ω–∞: {len(token)})")
                return auth_header
            return None
        else:
            # OpenAI/Custom - API key —É–∂–µ –≤ —Å–µ—Å—Å–∏–∏
            return self._session.headers.get('Authorization')

    def chat_completion(
        self,
        messages: List[Dict[str, str]],
        temperature: Optional[float] = None,
        max_tokens: Optional[int] = None,
        response_format: Optional[Dict] = None
    ) -> Optional[str]:
        """
        –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ chat completion

        Args:
            messages: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π [{role: "system/user/assistant", content: "..."}]
            temperature: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –∏–Ω–∞—á–µ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞)
            max_tokens: –ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            response_format: –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ ({"type": "json_object"} –¥–ª—è JSON)

        Returns:
            –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
        """
        url = f"{self.config.api_base_url}/chat/completions"

        payload = {
            "model": self.config.model,
            "messages": messages,
            "temperature": temperature if temperature is not None else self.config.temperature,
            "max_tokens": max_tokens or self.config.max_tokens,
            "top_p": self.config.top_p,
            "presence_penalty": self.config.presence_penalty,
            "frequency_penalty": self.config.frequency_penalty
        }

        # response_format –Ω–µ –≤—Å–µ –º–æ–¥–µ–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
        if response_format and self.config.provider != AIProvider.CLOUDRU:
            payload["response_format"] = response_format

        try:
            logger.info(f"ü§ñ AI –∑–∞–ø—Ä–æ—Å –∫ {self.config.provider.value}: –º–æ–¥–µ–ª—å={self.config.model}")
            logger.info(f"üìç URL: {url}")
            logger.debug(f"Messages: {messages}")
            logger.debug(f"Payload: {json.dumps(payload, ensure_ascii=False)[:500]}")

            # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π Authorization header
            auth_header = self._get_auth_header()
            if not auth_header:
                logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å Authorization header")
                return None

            # –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            logger.info(f"üì§ Request: POST {url}")
            logger.info(f"üì§ Authorization: {auth_header[:30]}... (full length: {len(auth_header)})")

            headers = {'Authorization': auth_header}

            response = self._session.post(
                url,
                json=payload,
                headers=headers,
                timeout=self.config.timeout
            )

            # –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            if response.status_code != 200:
                logger.error(f"‚ùå AI HTTP {response.status_code}: {response.text[:500]}")

            response.raise_for_status()

            data = response.json()
            content = data.get('choices', [{}])[0].get('message', {}).get('content')

            if content is None:
                logger.error(f"‚ùå AI –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç: {data}")
                return None

            logger.info(f"‚úÖ AI –æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω ({len(content)} —Å–∏–º–≤–æ–ª–æ–≤)")
            logger.debug(f"Response: {content[:500]}...")

            return content

        except requests.exceptions.Timeout:
            logger.error(f"‚è±Ô∏è AI –∑–∞–ø—Ä–æ—Å –ø—Ä–µ–≤—ã—Å–∏–ª —Ç–∞–π–º–∞—É—Ç ({self.config.timeout}—Å)")
            return None
        except requests.exceptions.HTTPError as e:
            logger.error(f"‚ùå AI HTTP –æ—à–∏–±–∫–∞: {e.response.status_code} - {e.response.text[:500]}")
            return None
        except Exception as e:
            logger.error(f"‚ùå AI –æ—à–∏–±–∫–∞: {e}")
            import traceback
            logger.error(traceback.format_exc())
            return None

    def close(self):
        """–ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–µ—Å—Å–∏—é"""
        self._session.close()


class AITask(ABC):
    """–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è AI –∑–∞–¥–∞—á"""

    def __init__(self, client: AIClient, custom_instruction: str = ""):
        self.client = client
        self.custom_instruction = custom_instruction

    @abstractmethod
    def get_system_prompt(self) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∑–∞–¥–∞—á–∏"""
        pass

    @abstractmethod
    def build_user_prompt(self, **kwargs) -> str:
        """–°—Ç—Ä–æ–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç"""
        pass

    @abstractmethod
    def parse_response(self, response: str) -> Any:
        """–ü–∞—Ä—Å–∏—Ç –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç AI"""
        pass

    def execute(self, **kwargs) -> Tuple[bool, Any, Optional[str]]:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç AI –∑–∞–¥–∞—á—É

        Returns:
            Tuple[success, result, error_message]
        """
        try:
            system_prompt = self.custom_instruction if self.custom_instruction else self.get_system_prompt()

            messages = [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": self.build_user_prompt(**kwargs)}
            ]

            response = self.client.chat_completion(messages)

            if not response:
                return False, None, "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI"

            result = self.parse_response(response)
            if result is None:
                return False, None, f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –æ—Ç–≤–µ—Ç AI: {response[:200]}"

            return True, result, None

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è AI –∑–∞–¥–∞—á–∏: {e}")
            import traceback
            logger.error(traceback.format_exc())
            return False, None, str(e)


class CategoryDetectionTask(AITask):
    """
    –ó–∞–¥–∞—á–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–∞ —Å –ø–æ–º–æ—â—å—é AI
    """

    def __init__(self, client: AIClient, categories: Dict[int, str], custom_instruction: str = ""):
        """
        Args:
            client: AI –∫–ª–∏–µ–Ω—Ç
            categories: –°–ª–æ–≤–∞—Ä—å {subject_id: category_name} –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π WB
            custom_instruction: –ö–∞—Å—Ç–æ–º–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–µ—Å–ª–∏ –ø—É—Å—Ç–æ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω–∞—è)
        """
        super().__init__(client, custom_instruction)
        self.categories = categories

    def get_system_prompt(self) -> str:
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        categories_list = "\n".join([
            f"- ID: {cat_id}, –ù–∞–∑–≤–∞–Ω–∏–µ: {cat_name}"
            for cat_id, cat_name in sorted(self.categories.items(), key=lambda x: x[1])
        ])

        template = DEFAULT_INSTRUCTIONS["category_detection"]["template"]
        return template.format(categories_list=categories_list)

    def build_user_prompt(self, **kwargs) -> str:
        product_title = kwargs.get('product_title', '')
        source_category = kwargs.get('source_category', '')
        all_categories = kwargs.get('all_categories', [])
        brand = kwargs.get('brand', '')
        description = kwargs.get('description', '')

        prompt = f"""–û–ø—Ä–µ–¥–µ–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é WB –¥–ª—è —Ç–æ–≤–∞—Ä–∞:

–ù–ê–ó–í–ê–ù–ò–ï –¢–û–í–ê–†–ê: {product_title}
–ö–ê–¢–ï–ì–û–†–ò–Ø –ò–ó –ò–°–¢–û–ß–ù–ò–ö–ê: {source_category}
–í–°–ï –ö–ê–¢–ï–ì–û–†–ò–ò: {' > '.join(all_categories) if all_categories else '–ù–µ —É–∫–∞–∑–∞–Ω—ã'}
–ë–†–ï–ù–î: {brand or '–ù–µ —É–∫–∞–∑–∞–Ω'}
"""
        if description:
            prompt += f"–û–ü–ò–°–ê–ù–ò–ï: {description[:500]}\n"

        return prompt

    def parse_response(self, response: str) -> Optional[Dict]:
        """
        –ü–∞—Ä—Å–∏—Ç –æ—Ç–≤–µ—Ç AI –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç

        Returns:
            {
                'category_id': int,
                'category_name': str,
                'confidence': float,
                'reasoning': str
            }
            –∏–ª–∏ None –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–µ–Ω
        """
        try:
            # –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            json_str = response.strip()

            # –£–±–∏—Ä–∞–µ–º markdown code blocks –µ—Å–ª–∏ –µ—Å—Ç—å
            if json_str.startswith("```"):
                json_str = re.sub(r'^```(?:json)?\n?', '', json_str)
                json_str = re.sub(r'\n?```$', '', json_str)

            # –ò—â–µ–º JSON –æ–±—ä–µ–∫—Ç –≤ —Ç–µ–∫—Å—Ç–µ
            json_match = re.search(r'\{[^{}]*"category_id"[^{}]*\}', json_str, re.DOTALL)
            if json_match:
                json_str = json_match.group()

            data = json.loads(json_str)

            category_id = data.get('category_id')
            category_name = data.get('category_name')
            confidence = data.get('confidence', 0.5)
            reasoning = data.get('reasoning', '')

            # –í–∞–ª–∏–¥–∞—Ü–∏—è
            if not category_id:
                logger.warning(f"AI –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π category_id")
                return None

            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ int –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞
            if isinstance(category_id, str):
                category_id = int(category_id)

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if category_id not in self.categories:
                logger.warning(f"AI –≤–µ—Ä–Ω—É–ª –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é: {category_id}")
                # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
                for cid, cname in self.categories.items():
                    if cname.lower() == str(category_name).lower():
                        category_id = cid
                        break
                else:
                    return None

            # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º confidence
            confidence = max(0.0, min(1.0, float(confidence)))

            return {
                'category_id': category_id,
                'category_name': self.categories.get(category_id, category_name),
                'confidence': confidence,
                'reasoning': str(reasoning)
            }

        except json.JSONDecodeError as e:
            logger.error(f"AI –≤–µ—Ä–Ω—É–ª –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON: {e}")
            logger.error(f"Response: {response[:500]}")
            return None
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞ AI: {e}")
            return None


class SizeParsingTask(AITask):
    """
    –ó–∞–¥–∞—á–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ —Ç–æ–≤–∞—Ä–∞ —Å –ø–æ–º–æ—â—å—é AI
    """

    def __init__(self, client: AIClient, category_characteristics: Optional[List[str]] = None,
                 custom_instruction: str = ""):
        """
        Args:
            client: AI –∫–ª–∏–µ–Ω—Ç
            category_characteristics: –°–ø–∏—Å–æ–∫ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            custom_instruction: –ö–∞—Å—Ç–æ–º–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
        """
        super().__init__(client, custom_instruction)
        self.category_characteristics = category_characteristics or []

    def get_system_prompt(self) -> str:
        characteristics = self.category_characteristics or [
            "–î–ª–∏–Ω–∞ (—Å–º)", "–î–∏–∞–º–µ—Ç—Ä (—Å–º)", "–®–∏—Ä–∏–Ω–∞ (—Å–º)", "–ì–ª—É–±–∏–Ω–∞ (—Å–º)",
            "–í–µ—Å (–≥)", "–û–±—ä–µ–º (–º–ª)", "–†–∞–∑–º–µ—Ä (S/M/L/XL)", "–†–∞–∑–º–µ—Ä (—á–∏—Å–ª–æ–≤–æ–π)"
        ]

        chars_list = "\n".join([f"- {c}" for c in characteristics])
        template = DEFAULT_INSTRUCTIONS["size_parsing"]["template"]
        return template.format(characteristics_list=chars_list)

    def build_user_prompt(self, **kwargs) -> str:
        sizes_text = kwargs.get('sizes_text', '')
        product_title = kwargs.get('product_title', '')
        description = kwargs.get('description', '')

        prompt = f"""–ò–∑–≤–ª–µ–∫–∏ —Ä–∞–∑–º–µ—Ä—ã –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞:

–ù–ê–ó–í–ê–ù–ò–ï: {product_title}
–°–¢–†–û–ö–ê –†–ê–ó–ú–ï–†–û–í: {sizes_text or '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}
"""
        if description:
            prompt += f"–û–ü–ò–°–ê–ù–ò–ï: {description[:300]}\n"

        return prompt

    def parse_response(self, response: str) -> Optional[Dict]:
        """
        –ü–∞—Ä—Å–∏—Ç –æ—Ç–≤–µ—Ç AI

        Returns:
            {
                'characteristics': {'name': 'value', ...},
                'raw_sizes': ['...'],
                'has_clothing_sizes': bool,
                'confidence': float
            }
        """
        try:
            json_str = response.strip()

            # –£–±–∏—Ä–∞–µ–º markdown code blocks
            if json_str.startswith("```"):
                json_str = re.sub(r'^```(?:json)?\n?', '', json_str)
                json_str = re.sub(r'\n?```$', '', json_str)

            # –ò—â–µ–º JSON –æ–±—ä–µ–∫—Ç
            json_match = re.search(r'\{[^{}]*"characteristics"[^{}]*\}', json_str, re.DOTALL)
            if json_match:
                json_str = json_match.group()

            data = json.loads(json_str)

            characteristics = data.get('characteristics', {})
            raw_sizes = data.get('raw_sizes', [])
            has_clothing = data.get('has_clothing_sizes', False)
            confidence = max(0.0, min(1.0, float(data.get('confidence', 0.5))))

            return {
                'characteristics': characteristics,
                'raw_sizes': raw_sizes if isinstance(raw_sizes, list) else [raw_sizes],
                'has_clothing_sizes': bool(has_clothing),
                'confidence': confidence
            }

        except json.JSONDecodeError:
            logger.error(f"AI –≤–µ—Ä–Ω—É–ª –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON –¥–ª—è —Ä–∞–∑–º–µ—Ä–æ–≤: {response[:500]}")
            return None
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞ AI (—Ä–∞–∑–º–µ—Ä—ã): {e}")
            return None


class SEOTitleTask(AITask):
    """–ó–∞–¥–∞—á–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SEO-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞"""

    def get_system_prompt(self) -> str:
        if self.custom_instruction:
            return self.custom_instruction
        return DEFAULT_INSTRUCTIONS["seo_title"]["template"]

    def build_user_prompt(self, **kwargs) -> str:
        title = kwargs.get('title', '')
        category = kwargs.get('category', '')
        brand = kwargs.get('brand', '')
        description = kwargs.get('description', '')

        return f"""–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–æ–≤–∞—Ä–∞:

–¢–ï–ö–£–©–ò–ô –ó–ê–ì–û–õ–û–í–û–ö: {title}
–ö–ê–¢–ï–ì–û–†–ò–Ø: {category or '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}
–ë–†–ï–ù–î: {brand or '–ù–µ —É–∫–∞–∑–∞–Ω'}
–û–ü–ò–°–ê–ù–ò–ï: {description[:300] if description else '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}"""

    def parse_response(self, response: str) -> Optional[Dict]:
        try:
            json_str = self._extract_json(response)
            data = json.loads(json_str)
            return {
                'title': data.get('title', ''),
                'keywords_used': data.get('keywords_used', []),
                'improvements': data.get('improvements', [])
            }
        except:
            return None

    def _extract_json(self, text: str) -> str:
        text = text.strip()
        if text.startswith("```"):
            text = re.sub(r'^```(?:json)?\n?', '', text)
            text = re.sub(r'\n?```$', '', text)
        match = re.search(r'\{.*\}', text, re.DOTALL)
        return match.group() if match else text


class KeywordsTask(AITask):
    """–ó–∞–¥–∞—á–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤"""

    def get_system_prompt(self) -> str:
        if self.custom_instruction:
            return self.custom_instruction
        return DEFAULT_INSTRUCTIONS["keywords"]["template"]

    def build_user_prompt(self, **kwargs) -> str:
        title = kwargs.get('title', '')
        category = kwargs.get('category', '')
        description = kwargs.get('description', '')

        return f"""–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —Ç–æ–≤–∞—Ä–∞:

–ù–ê–ó–í–ê–ù–ò–ï: {title}
–ö–ê–¢–ï–ì–û–†–ò–Ø: {category or '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}
–û–ü–ò–°–ê–ù–ò–ï: {description[:500] if description else '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}"""

    def parse_response(self, response: str) -> Optional[Dict]:
        try:
            json_str = self._extract_json(response)
            data = json.loads(json_str)
            return {
                'keywords': data.get('keywords', []),
                'search_queries': data.get('search_queries', [])
            }
        except:
            return None

    def _extract_json(self, text: str) -> str:
        text = text.strip()
        if text.startswith("```"):
            text = re.sub(r'^```(?:json)?\n?', '', text)
            text = re.sub(r'\n?```$', '', text)
        match = re.search(r'\{.*\}', text, re.DOTALL)
        return match.group() if match else text


class BulletPointsTask(AITask):
    """–ó–∞–¥–∞—á–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ bullet points"""

    def get_system_prompt(self) -> str:
        if self.custom_instruction:
            return self.custom_instruction
        return DEFAULT_INSTRUCTIONS["bullet_points"]["template"]

    def build_user_prompt(self, **kwargs) -> str:
        title = kwargs.get('title', '')
        description = kwargs.get('description', '')
        characteristics = kwargs.get('characteristics', {})

        chars_str = ""
        if characteristics:
            chars_str = "\n".join([f"- {k}: {v}" for k, v in characteristics.items()])

        return f"""–°–æ–∑–¥–∞–π –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞:

–ù–ê–ó–í–ê–ù–ò–ï: {title}
–û–ü–ò–°–ê–ù–ò–ï: {description[:500] if description else '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
–•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò:
{chars_str or '–ù–µ —É–∫–∞–∑–∞–Ω—ã'}"""

    def parse_response(self, response: str) -> Optional[Dict]:
        try:
            json_str = self._extract_json(response)
            data = json.loads(json_str)
            return {
                'bullet_points': data.get('bullet_points', []),
                'target_audience': data.get('target_audience', '')
            }
        except:
            return None

    def _extract_json(self, text: str) -> str:
        text = text.strip()
        if text.startswith("```"):
            text = re.sub(r'^```(?:json)?\n?', '', text)
            text = re.sub(r'\n?```$', '', text)
        match = re.search(r'\{.*\}', text, re.DOTALL)
        return match.group() if match else text


class DescriptionEnhanceTask(AITask):
    """–ó–∞–¥–∞—á–∞ —É–ª—É—á—à–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è"""

    def get_system_prompt(self) -> str:
        if self.custom_instruction:
            return self.custom_instruction
        return DEFAULT_INSTRUCTIONS["description_enhance"]["template"]

    def build_user_prompt(self, **kwargs) -> str:
        title = kwargs.get('title', '')
        description = kwargs.get('description', '')
        category = kwargs.get('category', '')

        return f"""–£–ª—É—á—à–∏ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:

–ù–ê–ó–í–ê–ù–ò–ï: {title}
–ö–ê–¢–ï–ì–û–†–ò–Ø: {category or '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}
–¢–ï–ö–£–©–ï–ï –û–ü–ò–°–ê–ù–ò–ï:
{description or '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}"""

    def parse_response(self, response: str) -> Optional[Dict]:
        try:
            json_str = self._extract_json(response)
            data = json.loads(json_str)
            return {
                'description': data.get('description', ''),
                'structure': data.get('structure', {})
            }
        except:
            return None

    def _extract_json(self, text: str) -> str:
        text = text.strip()
        if text.startswith("```"):
            text = re.sub(r'^```(?:json)?\n?', '', text)
            text = re.sub(r'\n?```$', '', text)
        match = re.search(r'\{.*\}', text, re.DOTALL)
        return match.group() if match else text


class RichContentTask(AITask):
    """–ó–∞–¥–∞—á–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ rich –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏"""

    def get_system_prompt(self) -> str:
        if self.custom_instruction:
            return self.custom_instruction
        return DEFAULT_INSTRUCTIONS["rich_content"]["template"]

    def build_user_prompt(self, **kwargs) -> str:
        title = kwargs.get('title', '')
        description = kwargs.get('description', '')
        category = kwargs.get('category', '')
        brand = kwargs.get('brand', '')
        characteristics = kwargs.get('characteristics', {})
        price = kwargs.get('price', 0)

        chars_str = ""
        if characteristics:
            # –§–∏–ª—å—Ç—Ä—É–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –ø–æ–ª—è
            chars_str = "\n".join([
                f"- {k}: {v}" for k, v in characteristics.items()
                if not k.startswith('_')
            ])

        return f"""–°–æ–∑–¥–∞–π –ø—Ä–æ–¥–∞—é—â–∏–π rich –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Ç–æ–≤–∞—Ä–∞:

–ù–ê–ó–í–ê–ù–ò–ï: {title}
–ë–†–ï–ù–î: {brand or '–ù–µ —É–∫–∞–∑–∞–Ω'}
–ö–ê–¢–ï–ì–û–†–ò–Ø: {category or '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}
–¶–ï–ù–ê: {price} —Ä—É–±.

–û–ü–ò–°–ê–ù–ò–ï:
{description[:800] if description else '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}

–•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò:
{chars_str or '–ù–µ —É–∫–∞–∑–∞–Ω—ã'}

–°–æ–∑–¥–∞–π –º–æ—â–Ω—ã–π –ø—Ä–æ–¥–∞—é—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç!"""

    def parse_response(self, response: str) -> Optional[Dict]:
        try:
            json_str = self._extract_json(response)
            data = json.loads(json_str)

            # –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ —Å–ª–∞–π–¥–∞–º–∏
            result = {
                'slides': data.get('slides', []),
                'design_recommendations': data.get('design_recommendations', {}),
                'total_slides': data.get('total_slides', len(data.get('slides', []))),
                'main_usp': data.get('main_usp', ''),
                'target_audience': data.get('target_audience', ''),
                # –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º
                'blocks': data.get('blocks', []),
                'main_message': data.get('main_message', '')
            }

            # –ï—Å–ª–∏ —Å–ª–∞–π–¥—ã –ø—É—Å—Ç—ã–µ, –Ω–æ –µ—Å—Ç—å –±–ª–æ–∫–∏ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–ª–æ–∫–∏
            if not result['slides'] and result['blocks']:
                result['slides'] = result['blocks']
                result['total_slides'] = len(result['blocks'])

            return result
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ Rich content: {e}")
            return None

    def _extract_json(self, text: str) -> str:
        text = text.strip()
        if text.startswith("```"):
            text = re.sub(r'^```(?:json)?\n?', '', text)
            text = re.sub(r'\n?```$', '', text)
        match = re.search(r'\{.*\}', text, re.DOTALL)
        return match.group() if match else text


class CardAnalysisTask(AITask):
    """–ó–∞–¥–∞—á–∞ –∞–Ω–∞–ª–∏–∑–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞"""

    def get_system_prompt(self) -> str:
        if self.custom_instruction:
            return self.custom_instruction
        return DEFAULT_INSTRUCTIONS["card_analysis"]["template"]

    def build_user_prompt(self, **kwargs) -> str:
        title = kwargs.get('title', '')
        description = kwargs.get('description', '')
        category = kwargs.get('category', '')
        characteristics = kwargs.get('characteristics', {})
        photos_count = kwargs.get('photos_count', 0)
        price = kwargs.get('price', 0)

        chars_str = ""
        if characteristics:
            chars_str = "\n".join([f"- {k}: {v}" for k, v in characteristics.items()])

        return f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–∞—Ä—Ç–æ—á–∫—É —Ç–æ–≤–∞—Ä–∞:

–ó–ê–ì–û–õ–û–í–û–ö: {title}
–ö–ê–¢–ï–ì–û–†–ò–Ø: {category or '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}
–û–ü–ò–°–ê–ù–ò–ï: {description[:800] if description else '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}
–•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò:
{chars_str or '–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã'}
–§–û–¢–û: {photos_count} —à—Ç.
–¶–ï–ù–ê: {price} —Ä—É–±."""

    def parse_response(self, response: str) -> Optional[Dict]:
        try:
            json_str = self._extract_json(response)
            data = json.loads(json_str)
            return {
                'score': data.get('score', 0),
                'issues': data.get('issues', []),
                'recommendations': data.get('recommendations', []),
                'strengths': data.get('strengths', [])
            }
        except:
            return None

    def _extract_json(self, text: str) -> str:
        text = text.strip()
        if text.startswith("```"):
            text = re.sub(r'^```(?:json)?\n?', '', text)
            text = re.sub(r'\n?```$', '', text)
        match = re.search(r'\{.*\}', text, re.DOTALL)
        return match.group() if match else text


# ============================================================================
# –ù–û–í–´–ï AI –ó–ê–î–ê–ß–ò –î–õ–Ø –†–ê–°–®–ò–†–ï–ù–ù–û–ì–û –ê–ù–ê–õ–ò–ó–ê –¢–û–í–ê–†–û–í
# ============================================================================

class DimensionsExtractionTask(AITask):
    """–ó–∞–¥–∞—á–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –≥–∞–±–∞—Ä–∏—Ç–æ–≤ —Ç–æ–≤–∞—Ä–∞"""

    def get_system_prompt(self) -> str:
        if self.custom_instruction:
            return self.custom_instruction
        return DEFAULT_INSTRUCTIONS["dimensions_extraction"]["template"]

    def build_user_prompt(self, **kwargs) -> str:
        title = kwargs.get('title', '')
        description = kwargs.get('description', '')
        characteristics = kwargs.get('characteristics', {})
        sizes_text = kwargs.get('sizes_text', '')

        chars_str = ""
        if characteristics:
            chars_str = "\n".join([f"- {k}: {v}" for k, v in characteristics.items()])

        return f"""–ò–∑–≤–ª–µ–∫–∏ –≥–∞–±–∞—Ä–∏—Ç—ã —Ç–æ–≤–∞—Ä–∞:

–ù–ê–ó–í–ê–ù–ò–ï: {title}
–û–ü–ò–°–ê–ù–ò–ï: {description[:800] if description else '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
–•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò:
{chars_str or '–ù–µ —É–∫–∞–∑–∞–Ω—ã'}
–°–¢–†–û–ö–ê –†–ê–ó–ú–ï–†–û–í: {sizes_text or '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}"""

    def parse_response(self, response: str) -> Optional[Dict]:
        try:
            json_str = self._extract_json(response)
            data = json.loads(json_str)
            return {
                'dimensions': data.get('dimensions', {}),
                'package_dimensions': data.get('package_dimensions', {}),
                'raw_text': data.get('raw_text', ''),
                'confidence': max(0.0, min(1.0, float(data.get('confidence', 0.5))))
            }
        except:
            return None

    def _extract_json(self, text: str) -> str:
        text = text.strip()
        if text.startswith("```"):
            text = re.sub(r'^```(?:json)?\n?', '', text)
            text = re.sub(r'\n?```$', '', text)
        match = re.search(r'\{.*\}', text, re.DOTALL)
        return match.group() if match else text


class CategoryDimensionsTask(AITask):
    """–ó–∞–¥–∞—á–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ø–∏—Å–∫–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ WB"""

    def __init__(self, client: 'AIClient', custom_instruction: str = '', category_characteristics: List[str] = None):
        super().__init__(client, custom_instruction)
        self.category_characteristics = category_characteristics or []

    def get_system_prompt(self) -> str:
        if self.custom_instruction:
            return self.custom_instruction

        chars_list = "\n".join(self.category_characteristics) if self.category_characteristics else "–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã"

        return f"""–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ Wildberries.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –∏–∑–≤–ª–µ—á—å –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ö–û–ù–ö–†–ï–¢–ù–´–• —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Ç–æ–≤–∞—Ä–∞.

–•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò –ö–ê–¢–ï–ì–û–†–ò–ò –î–õ–Ø –ó–ê–ü–û–õ–ù–ï–ù–ò–Ø:
{chars_list}

–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
1. –ó–∞–ø–æ–ª–Ω—è–π –¢–û–õ–¨–ö–û —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ
2. –ï—Å–ª–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –ø–æ–º–µ—á–µ–Ω–∞ [–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û] - –ø–æ—Å—Ç–∞—Ä–∞–π—Å—è –Ω–∞–π—Ç–∏ –∏–ª–∏ –≤—ã—á–∏—Å–ª–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ
3. –î–ª—è –≤–µ—Å–∞ (–≥, –∫–≥) - –í–°–ï–ì–î–ê —É–∫–∞–∑—ã–≤–∞–π –≤ –≥—Ä–∞–º–º–∞—Ö
4. –î–ª—è –¥–ª–∏–Ω—ã/—à–∏—Ä–∏–Ω—ã/–≤—ã—Å–æ—Ç—ã - —É–∫–∞–∑—ã–≤–∞–π –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö
5. –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ - –Ω–µ –≤–∫–ª—é—á–∞–π –µ–≥–æ –≤ –æ—Ç–≤–µ—Ç
6. –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ö–æ–∂–∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ (–î–ª–∏–Ω–∞, –î–ª–∏–Ω–∞ –∏–∑–¥–µ–ª–∏—è, –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞) - –∑–∞–ø–æ–ª–Ω–∏ –í–°–ï –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –æ–¥–Ω–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
7. –ß–∏—Å–ª–∞ —Å –∑–∞–ø—è—Ç–æ–π (7,5) –ø—Ä–µ–æ–±—Ä–∞–∑—É–π –≤ —Ñ–æ—Ä–º–∞—Ç —Å —Ç–æ—á–∫–æ–π (7.5)
8. –î–ª—è –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ (15-20 —Å–º) –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ª–∏–±–æ –¥–∏–∞–ø–∞–∑–æ–Ω, –ª–∏–±–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

–ü–†–ò–ú–ï–†–´:
- "–¥–ª–∏–Ω–∞ 7,5 —Å–º, –¥–∏–∞–º–µ—Ç—Ä 2 —Å–º, –≤–µ—Å 50 –≥"
  –ó–∞–ø–æ–ª–Ω–∏: –î–ª–∏–Ω–∞ = 7.5, –î–∏–∞–º–µ—Ç—Ä = 2, –í–µ—Å = 50

- "—Ä–∞–∑–º–µ—Ä M (44-46), —Ä–æ—Å—Ç 170-176"
  –ó–∞–ø–æ–ª–Ω–∏: –†–∞–∑–º–µ—Ä = M, –†–æ—Å—Å–∏–π—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä = 44-46

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û JSON):
{{
    "extracted_values": {{
        "–ù–∞–∑–≤–∞–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏": "–∑–Ω–∞—á–µ–Ω–∏–µ",
        ...
    }},
    "missing_required": ["—Å–ø–∏—Å–æ–∫ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏"],
    "suggestions": {{
        "–ù–∞–∑–≤–∞–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏": "–ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º"
    }},
    "raw_found": ["–Ω–∞–π–¥–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ —Ä–∞–∑–º–µ—Ä—ã/–≤–µ—Å–∞"],
    "confidence": <—á–∏—Å–ª–æ –æ—Ç 0.0 –¥–æ 1.0>
}}

–í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON."""

    def build_user_prompt(self, **kwargs) -> str:
        title = kwargs.get('title', '')
        description = kwargs.get('description', '')
        characteristics = kwargs.get('characteristics', {})
        sizes_text = kwargs.get('sizes_text', '')

        chars_str = ""
        if characteristics:
            chars_str = "\n".join([f"- {k}: {v}" for k, v in characteristics.items()])

        return f"""–ò–∑–≤–ª–µ–∫–∏ –∑–Ω–∞—á–µ–Ω–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∏–∑ –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞:

–ù–ê–ó–í–ê–ù–ò–ï: {title}
–°–¢–†–û–ö–ê –†–ê–ó–ú–ï–†–û–í: {sizes_text or '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}
–°–£–©–ï–°–¢–í–£–Æ–©–ò–ï –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò:
{chars_str or '–ù–µ —É–∫–∞–∑–∞–Ω—ã'}
–û–ü–ò–°–ê–ù–ò–ï: {description[:1000] if description else '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}"""

    def parse_response(self, response: str) -> Optional[Dict]:
        try:
            json_str = self._extract_json(response)
            data = json.loads(json_str)
            return {
                'extracted_values': data.get('extracted_values', {}),
                'missing_required': data.get('missing_required', []),
                'suggestions': data.get('suggestions', {}),
                'raw_found': data.get('raw_found', []),
                'confidence': max(0.0, min(1.0, float(data.get('confidence', 0.5))))
            }
        except:
            return None

    def _extract_json(self, text: str) -> str:
        text = text.strip()
        if text.startswith("```"):
            text = re.sub(r'^```(?:json)?\n?', '', text)
            text = re.sub(r'\n?```$', '', text)
        match = re.search(r'\{.*\}', text, re.DOTALL)
        return match.group() if match else text


class ClothingSizesTask(AITask):
    """–ó–∞–¥–∞—á–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä–æ–≤ –æ–¥–µ–∂–¥—ã"""

    def get_system_prompt(self) -> str:
        if self.custom_instruction:
            return self.custom_instruction
        return DEFAULT_INSTRUCTIONS["clothing_sizes"]["template"]

    def build_user_prompt(self, **kwargs) -> str:
        title = kwargs.get('title', '')
        description = kwargs.get('description', '')
        sizes_text = kwargs.get('sizes_text', '')
        category = kwargs.get('category', '')

        return f"""–û–ø—Ä–µ–¥–µ–ª–∏ —Ä–∞–∑–º–µ—Ä—ã –æ–¥–µ–∂–¥—ã:

–ù–ê–ó–í–ê–ù–ò–ï: {title}
–ö–ê–¢–ï–ì–û–†–ò–Ø: {category or '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}
–°–¢–†–û–ö–ê –†–ê–ó–ú–ï–†–û–í: {sizes_text or '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}
–û–ü–ò–°–ê–ù–ò–ï: {description[:500] if description else '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}"""

    def parse_response(self, response: str) -> Optional[Dict]:
        try:
            json_str = self._extract_json(response)
            data = json.loads(json_str)
            return {
                'product_type': data.get('product_type', 'unknown'),
                'size_type': data.get('size_type', 'unknown'),
                'sizes': data.get('sizes', []),
                'dimensions': data.get('dimensions', {}),
                'size_range': data.get('size_range', {}),
                'body_measurements': data.get('body_measurements', {}),
                'fit_type': data.get('fit_type'),
                'raw_text': data.get('raw_text', ''),
                'confidence': max(0.0, min(1.0, float(data.get('confidence', 0.5))))
            }
        except:
            return None

    def _extract_json(self, text: str) -> str:
        text = text.strip()
        if text.startswith("```"):
            text = re.sub(r'^```(?:json)?\n?', '', text)
            text = re.sub(r'\n?```$', '', text)
        match = re.search(r'\{.*\}', text, re.DOTALL)
        return match.group() if match else text


class BrandDetectionTask(AITask):
    """–ó–∞–¥–∞—á–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±—Ä–µ–Ω–¥–∞ —Ç–æ–≤–∞—Ä–∞"""

    def get_system_prompt(self) -> str:
        if self.custom_instruction:
            return self.custom_instruction
        return DEFAULT_INSTRUCTIONS["brand_detection"]["template"]

    def build_user_prompt(self, **kwargs) -> str:
        title = kwargs.get('title', '')
        description = kwargs.get('description', '')
        characteristics = kwargs.get('characteristics', {})
        category = kwargs.get('category', '')

        chars_str = ""
        if characteristics:
            chars_str = "\n".join([f"- {k}: {v}" for k, v in characteristics.items()])

        return f"""–û–ø—Ä–µ–¥–µ–ª–∏ –±—Ä–µ–Ω–¥ —Ç–æ–≤–∞—Ä–∞:

–ù–ê–ó–í–ê–ù–ò–ï: {title}
–ö–ê–¢–ï–ì–û–†–ò–Ø: {category or '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}
–•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò:
{chars_str or '–ù–µ —É–∫–∞–∑–∞–Ω—ã'}
–û–ü–ò–°–ê–ù–ò–ï: {description[:500] if description else '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}"""

    def parse_response(self, response: str) -> Optional[Dict]:
        try:
            json_str = self._extract_json(response)
            data = json.loads(json_str)
            return {
                'brand': data.get('brand', ''),
                'brand_normalized': data.get('brand_normalized', ''),
                'brand_type': data.get('brand_type', 'unknown'),
                'brand_origin': data.get('brand_origin', ''),
                'alternative_names': data.get('alternative_names', []),
                'is_official': data.get('is_official', False),
                'confidence': max(0.0, min(1.0, float(data.get('confidence', 0.5)))),
                'reasoning': data.get('reasoning', '')
            }
        except:
            return None

    def _extract_json(self, text: str) -> str:
        text = text.strip()
        if text.startswith("```"):
            text = re.sub(r'^```(?:json)?\n?', '', text)
            text = re.sub(r'\n?```$', '', text)
        match = re.search(r'\{.*\}', text, re.DOTALL)
        return match.group() if match else text


class MaterialDetectionTask(AITask):
    """–ó–∞–¥–∞—á–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏ —Å–æ—Å—Ç–∞–≤–∞ —Ç–æ–≤–∞—Ä–∞"""

    def get_system_prompt(self) -> str:
        if self.custom_instruction:
            return self.custom_instruction
        return DEFAULT_INSTRUCTIONS["material_detection"]["template"]

    def build_user_prompt(self, **kwargs) -> str:
        title = kwargs.get('title', '')
        description = kwargs.get('description', '')
        characteristics = kwargs.get('characteristics', {})
        category = kwargs.get('category', '')

        chars_str = ""
        if characteristics:
            chars_str = "\n".join([f"- {k}: {v}" for k, v in characteristics.items()])

        return f"""–û–ø—Ä–µ–¥–µ–ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Ç–æ–≤–∞—Ä–∞:

–ù–ê–ó–í–ê–ù–ò–ï: {title}
–ö–ê–¢–ï–ì–û–†–ò–Ø: {category or '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}
–•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò:
{chars_str or '–ù–µ —É–∫–∞–∑–∞–Ω—ã'}
–û–ü–ò–°–ê–ù–ò–ï: {description[:800] if description else '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}"""

    def parse_response(self, response: str) -> Optional[Dict]:
        try:
            json_str = self._extract_json(response)
            data = json.loads(json_str)
            return {
                'materials': data.get('materials', []),
                'composition_text': data.get('composition_text', ''),
                'material_type': data.get('material_type', 'unknown'),
                'care_instructions': data.get('care_instructions', []),
                'properties': data.get('properties', {}),
                'confidence': max(0.0, min(1.0, float(data.get('confidence', 0.5))))
            }
        except:
            return None

    def _extract_json(self, text: str) -> str:
        text = text.strip()
        if text.startswith("```"):
            text = re.sub(r'^```(?:json)?\n?', '', text)
            text = re.sub(r'\n?```$', '', text)
        match = re.search(r'\{.*\}', text, re.DOTALL)
        return match.group() if match else text


class ColorDetectionTask(AITask):
    """–ó–∞–¥–∞—á–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ —Ç–æ–≤–∞—Ä–∞"""

    def get_system_prompt(self) -> str:
        if self.custom_instruction:
            return self.custom_instruction
        return DEFAULT_INSTRUCTIONS["color_detection"]["template"]

    def build_user_prompt(self, **kwargs) -> str:
        title = kwargs.get('title', '')
        description = kwargs.get('description', '')
        characteristics = kwargs.get('characteristics', {})

        chars_str = ""
        if characteristics:
            chars_str = "\n".join([f"- {k}: {v}" for k, v in characteristics.items()])

        return f"""–û–ø—Ä–µ–¥–µ–ª–∏ —Ü–≤–µ—Ç —Ç–æ–≤–∞—Ä–∞:

–ù–ê–ó–í–ê–ù–ò–ï: {title}
–•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò:
{chars_str or '–ù–µ —É–∫–∞–∑–∞–Ω—ã'}
–û–ü–ò–°–ê–ù–ò–ï: {description[:500] if description else '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}"""

    def parse_response(self, response: str) -> Optional[Dict]:
        try:
            json_str = self._extract_json(response)
            data = json.loads(json_str)
            return {
                'primary_color': data.get('primary_color', ''),
                'primary_color_wb': data.get('primary_color_wb', ''),
                'secondary_colors': data.get('secondary_colors', []),
                'color_description': data.get('color_description', ''),
                'is_multicolor': data.get('is_multicolor', False),
                'is_transparent': data.get('is_transparent', False),
                'hex_code': data.get('hex_code'),
                'color_family': data.get('color_family', ''),
                'confidence': max(0.0, min(1.0, float(data.get('confidence', 0.5))))
            }
        except:
            return None

    def _extract_json(self, text: str) -> str:
        text = text.strip()
        if text.startswith("```"):
            text = re.sub(r'^```(?:json)?\n?', '', text)
            text = re.sub(r'\n?```$', '', text)
        match = re.search(r'\{.*\}', text, re.DOTALL)
        return match.group() if match else text


class ProductAttributesTask(AITask):
    """–ó–∞–¥–∞—á–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –≤—Å–µ—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ —Ç–æ–≤–∞—Ä–∞ –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å"""

    def get_system_prompt(self) -> str:
        if self.custom_instruction:
            return self.custom_instruction
        return DEFAULT_INSTRUCTIONS["product_attributes"]["template"]

    def build_user_prompt(self, **kwargs) -> str:
        title = kwargs.get('title', '')
        description = kwargs.get('description', '')
        characteristics = kwargs.get('characteristics', {})
        category = kwargs.get('category', '')
        sizes_text = kwargs.get('sizes_text', '')

        chars_str = ""
        if characteristics:
            chars_str = "\n".join([f"- {k}: {v}" for k, v in characteristics.items()])

        return f"""–ò–∑–≤–ª–µ–∫–∏ –≤—Å–µ –∞—Ç—Ä–∏–±—É—Ç—ã —Ç–æ–≤–∞—Ä–∞:

–ù–ê–ó–í–ê–ù–ò–ï: {title}
–ö–ê–¢–ï–ì–û–†–ò–Ø: {category or '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}
–•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò:
{chars_str or '–ù–µ —É–∫–∞–∑–∞–Ω—ã'}
–†–ê–ó–ú–ï–†–´: {sizes_text or '–ù–µ —É–∫–∞–∑–∞–Ω—ã'}
–û–ü–ò–°–ê–ù–ò–ï: {description[:1000] if description else '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}"""

    def parse_response(self, response: str) -> Optional[Dict]:
        try:
            json_str = self._extract_json(response)
            data = json.loads(json_str)
            return {
                'brand': data.get('brand', {}),
                'colors': data.get('colors', {}),
                'materials': data.get('materials', {}),
                'dimensions': data.get('dimensions', {}),
                'clothing_size': data.get('clothing_size', {}),
                'gender': data.get('gender'),
                'age_group': data.get('age_group'),
                'age_range': data.get('age_range'),
                'season': data.get('season'),
                'country': data.get('country'),
                'package_contents': data.get('package_contents', []),
                'special_features': data.get('special_features', []),
                'overall_confidence': max(0.0, min(1.0, float(data.get('overall_confidence', 0.5))))
            }
        except:
            return None

    def _extract_json(self, text: str) -> str:
        text = text.strip()
        if text.startswith("```"):
            text = re.sub(r'^```(?:json)?\n?', '', text)
            text = re.sub(r'\n?```$', '', text)
        match = re.search(r'\{.*\}', text, re.DOTALL)
        return match.group() if match else text


class AIService:
    """
    –ì–ª–∞–≤–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å AI
    –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å–µ AI –∑–∞–¥–∞—á–∏
    """

    def __init__(self, config: AIConfig):
        self.config = config
        self.client = AIClient(config)
        self._categories: Dict[int, str] = {}

    def set_categories(self, categories: Dict[int, str]):
        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è"""
        self._categories = categories

    def detect_category(
        self,
        product_title: str,
        source_category: str,
        all_categories: Optional[List[str]] = None,
        brand: str = '',
        description: str = ''
    ) -> Tuple[Optional[int], Optional[str], float, str]:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–∞ —Å –ø–æ–º–æ—â—å—é AI

        Returns:
            Tuple[category_id, category_name, confidence, reasoning]
        """
        if not self._categories:
            logger.warning("–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è AI —Å–µ—Ä–≤–∏—Å–∞")
            return None, None, 0.0, "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"

        task = CategoryDetectionTask(
            self.client,
            self._categories,
            custom_instruction=self.config.custom_category_instruction
        )
        success, result, error = task.execute(
            product_title=product_title,
            source_category=source_category,
            all_categories=all_categories or [],
            brand=brand,
            description=description
        )

        if success and result:
            return (
                result['category_id'],
                result['category_name'],
                result['confidence'],
                result['reasoning']
            )

        return None, None, 0.0, error or "–û—à–∏–±–∫–∞ AI"

    def parse_sizes(
        self,
        sizes_text: str,
        product_title: str = '',
        description: str = '',
        category_characteristics: Optional[List[str]] = None
    ) -> Tuple[bool, Dict, str]:
        """
        –ü–∞—Ä—Å–∏—Ç —Ä–∞–∑–º–µ—Ä—ã —Ç–æ–≤–∞—Ä–∞ —Å –ø–æ–º–æ—â—å—é AI

        Returns:
            Tuple[success, parsed_data, error_message]
        """
        task = SizeParsingTask(
            self.client,
            category_characteristics,
            custom_instruction=self.config.custom_size_instruction
        )
        success, result, error = task.execute(
            sizes_text=sizes_text,
            product_title=product_title,
            description=description
        )

        if success and result:
            return True, result, ""

        return False, {}, error or "–û—à–∏–±–∫–∞ AI"

    def generate_seo_title(
        self,
        title: str,
        category: str = '',
        brand: str = '',
        description: str = ''
    ) -> Tuple[bool, Dict, str]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SEO-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫

        Returns:
            Tuple[success, {title, keywords_used, improvements}, error]
        """
        task = SEOTitleTask(self.client, self.config.custom_seo_title_instruction)
        success, result, error = task.execute(
            title=title,
            category=category,
            brand=brand,
            description=description
        )
        if success and result:
            # –û—á–∏—â–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç HTML —Ç–µ–≥–æ–≤
            if result.get('title'):
                result['title'] = strip_html_tags(result['title'])
            return True, result, ""
        return False, {}, error or "–û—à–∏–±–∫–∞ AI"

    def generate_keywords(
        self,
        title: str,
        category: str = '',
        description: str = ''
    ) -> Tuple[bool, Dict, str]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —Ç–æ–≤–∞—Ä–∞

        Returns:
            Tuple[success, {keywords, search_queries}, error]
        """
        task = KeywordsTask(self.client, self.config.custom_keywords_instruction)
        success, result, error = task.execute(
            title=title,
            category=category,
            description=description
        )
        if success and result:
            return True, result, ""
        return False, {}, error or "–û—à–∏–±–∫–∞ AI"

    def generate_bullet_points(
        self,
        title: str,
        description: str = '',
        characteristics: Optional[Dict] = None
    ) -> Tuple[bool, Dict, str]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç bullet points (–ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞)

        Returns:
            Tuple[success, {bullet_points, target_audience}, error]
        """
        task = BulletPointsTask(self.client, self.config.custom_bullets_instruction)
        success, result, error = task.execute(
            title=title,
            description=description,
            characteristics=characteristics or {}
        )
        if success and result:
            # –û—á–∏—â–∞–µ–º –∫–∞–∂–¥—ã–π –±—É–ª–ª–µ—Ç –æ—Ç HTML
            if result.get('bullet_points'):
                result['bullet_points'] = [strip_html_tags(b) for b in result['bullet_points']]
            return True, result, ""
        return False, {}, error or "–û—à–∏–±–∫–∞ AI"

    def enhance_description(
        self,
        title: str,
        description: str,
        category: str = ''
    ) -> Tuple[bool, Dict, str]:
        """
        –£–ª—É—á—à–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞

        Returns:
            Tuple[success, {description, structure}, error]
        """
        task = DescriptionEnhanceTask(self.client, self.config.custom_description_instruction)
        success, result, error = task.execute(
            title=title,
            description=description,
            category=category
        )
        if success and result:
            # –û—á–∏—â–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –æ—Ç HTML —Ç–µ–≥–æ–≤
            if result.get('description'):
                result['description'] = strip_html_tags(result['description'])
            return True, result, ""
        return False, {}, error or "–û—à–∏–±–∫–∞ AI"

    def analyze_card(
        self,
        title: str,
        description: str = '',
        category: str = '',
        characteristics: Optional[Dict] = None,
        photos_count: int = 0,
        price: float = 0
    ) -> Tuple[bool, Dict, str]:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É –∏ –¥–∞–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

        Returns:
            Tuple[success, {score, issues, recommendations, strengths}, error]
        """
        task = CardAnalysisTask(self.client, self.config.custom_analysis_instruction)
        success, result, error = task.execute(
            title=title,
            description=description,
            category=category,
            characteristics=characteristics or {},
            photos_count=photos_count,
            price=price
        )
        if success and result:
            return True, result, ""
        return False, {}, error or "–û—à–∏–±–∫–∞ AI"

    def generate_rich_content(
        self,
        title: str,
        description: str = '',
        category: str = '',
        brand: str = '',
        characteristics: Optional[Dict] = None,
        price: float = 0
    ) -> Tuple[bool, Dict, str]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–¥–∞—é—â–∏–π rich –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏

        Returns:
            Tuple[success, {hook, pain_points, benefits, features, social_proof, cta, full_description, infographic_texts}, error]
        """
        task = RichContentTask(self.client, self.config.custom_rich_content_instruction)
        success, result, error = task.execute(
            title=title,
            description=description,
            category=category,
            brand=brand,
            characteristics=characteristics or {},
            price=price
        )
        if success and result:
            return True, result, ""
        return False, {}, error or "–û—à–∏–±–∫–∞ AI"

    # =========================================================================
    # –ù–û–í–´–ï AI –ú–ï–¢–û–î–´ –î–õ–Ø –†–ê–°–®–ò–†–ï–ù–ù–û–ì–û –ê–ù–ê–õ–ò–ó–ê
    # =========================================================================

    def extract_dimensions(
        self,
        title: str,
        description: str = '',
        characteristics: Optional[Dict] = None,
        sizes_text: str = ''
    ) -> Tuple[bool, Dict, str]:
        """
        –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –≥–∞–±–∞—Ä–∏—Ç—ã —Ç–æ–≤–∞—Ä–∞

        Returns:
            Tuple[success, {dimensions, package_dimensions, raw_text, confidence}, error]
        """
        task = DimensionsExtractionTask(self.client, self.config.custom_dimensions_instruction)
        success, result, error = task.execute(
            title=title,
            description=description,
            characteristics=characteristics or {},
            sizes_text=sizes_text
        )
        if success and result:
            return True, result, ""
        return False, {}, error or "–û—à–∏–±–∫–∞ AI"

    def extract_category_dimensions(
        self,
        title: str,
        description: str = '',
        characteristics: Optional[Dict] = None,
        sizes_text: str = '',
        category_characteristics: Optional[List[str]] = None
    ) -> Tuple[bool, Dict, str]:
        """
        –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ø–∏—Å–∫–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ WB

        Args:
            title: –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
            description: –û–ø–∏—Å–∞–Ω–∏–µ
            characteristics: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ç–æ–≤–∞—Ä–∞
            sizes_text: –°—Ç—Ä–æ–∫–∞ —Å —Ä–∞–∑–º–µ—Ä–∞–º–∏
            category_characteristics: –°–ø–∏—Å–æ–∫ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∏–∑ WB API –¥–ª—è –¥–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

        Returns:
            Tuple[success, {extracted_values, missing_required, confidence}, error]
        """
        task = CategoryDimensionsTask(
            self.client,
            self.config.custom_dimensions_instruction,
            category_characteristics or []
        )
        success, result, error = task.execute(
            title=title,
            description=description,
            characteristics=characteristics or {},
            sizes_text=sizes_text
        )
        if success and result:
            return True, result, ""
        return False, {}, error or "–û—à–∏–±–∫–∞ AI"

    def parse_clothing_sizes(
        self,
        title: str,
        sizes_text: str = '',
        description: str = '',
        category: str = ''
    ) -> Tuple[bool, Dict, str]:
        """
        –ü–∞—Ä—Å–∏—Ç –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä—É–µ—Ç —Ä–∞–∑–º–µ—Ä—ã –æ–¥–µ–∂–¥—ã

        Returns:
            Tuple[success, {size_type, sizes, size_range, body_measurements, fit_type, confidence}, error]
        """
        task = ClothingSizesTask(self.client, self.config.custom_clothing_sizes_instruction)
        success, result, error = task.execute(
            title=title,
            sizes_text=sizes_text,
            description=description,
            category=category
        )
        if success and result:
            return True, result, ""
        return False, {}, error or "–û—à–∏–±–∫–∞ AI"

    def detect_brand(
        self,
        title: str,
        description: str = '',
        characteristics: Optional[Dict] = None,
        category: str = ''
    ) -> Tuple[bool, Dict, str]:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –±—Ä–µ–Ω–¥ —Ç–æ–≤–∞—Ä–∞

        Returns:
            Tuple[success, {brand, brand_normalized, brand_type, confidence, reasoning}, error]
        """
        task = BrandDetectionTask(self.client, self.config.custom_brand_instruction)
        success, result, error = task.execute(
            title=title,
            description=description,
            characteristics=characteristics or {},
            category=category
        )
        if success and result:
            return True, result, ""
        return False, {}, error or "–û—à–∏–±–∫–∞ AI"

    def detect_materials(
        self,
        title: str,
        description: str = '',
        characteristics: Optional[Dict] = None,
        category: str = ''
    ) -> Tuple[bool, Dict, str]:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ —Å–æ—Å—Ç–∞–≤ —Ç–æ–≤–∞—Ä–∞

        Returns:
            Tuple[success, {materials, composition_text, material_type, properties, confidence}, error]
        """
        task = MaterialDetectionTask(self.client, self.config.custom_material_instruction)
        success, result, error = task.execute(
            title=title,
            description=description,
            characteristics=characteristics or {},
            category=category
        )
        if success and result:
            return True, result, ""
        return False, {}, error or "–û—à–∏–±–∫–∞ AI"

    def detect_color(
        self,
        title: str,
        description: str = '',
        characteristics: Optional[Dict] = None
    ) -> Tuple[bool, Dict, str]:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ü–≤–µ—Ç —Ç–æ–≤–∞—Ä–∞

        Returns:
            Tuple[success, {primary_color, primary_color_wb, secondary_colors, confidence}, error]
        """
        task = ColorDetectionTask(self.client, self.config.custom_color_instruction)
        success, result, error = task.execute(
            title=title,
            description=description,
            characteristics=characteristics or {}
        )
        if success and result:
            return True, result, ""
        return False, {}, error or "–û—à–∏–±–∫–∞ AI"

    def extract_all_attributes(
        self,
        title: str,
        description: str = '',
        characteristics: Optional[Dict] = None,
        category: str = '',
        sizes_text: str = ''
    ) -> Tuple[bool, Dict, str]:
        """
        –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ —Ç–æ–≤–∞—Ä–∞ –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å

        Returns:
            Tuple[success, {brand, colors, materials, dimensions, clothing_size, gender, age_group, season, country, ...}, error]
        """
        task = ProductAttributesTask(self.client, self.config.custom_attributes_instruction)
        success, result, error = task.execute(
            title=title,
            description=description,
            characteristics=characteristics or {},
            category=category,
            sizes_text=sizes_text
        )
        if success and result:
            return True, result, ""
        return False, {}, error or "–û—à–∏–±–∫–∞ AI"

    def full_optimize(
        self,
        title: str,
        description: str = '',
        category: str = '',
        brand: str = '',
        characteristics: Optional[Dict] = None,
        photos_count: int = 0,
        price: float = 0
    ) -> Dict:
        """
        –ü–æ–ª–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ - –≤—Å–µ AI —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞ –æ–¥–∏–Ω –≤—ã–∑–æ–≤

        Returns:
            Dict —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≤—Å–µ—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
        """
        results = {
            'seo_title': None,
            'keywords': None,
            'bullet_points': None,
            'enhanced_description': None,
            'analysis': None,
            'errors': []
        }

        # SEO –∑–∞–≥–æ–ª–æ–≤–æ–∫
        success, data, error = self.generate_seo_title(title, category, brand, description)
        if success:
            results['seo_title'] = data
        else:
            results['errors'].append(f"SEO –∑–∞–≥–æ–ª–æ–≤–æ–∫: {error}")

        # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
        success, data, error = self.generate_keywords(title, category, description)
        if success:
            results['keywords'] = data
        else:
            results['errors'].append(f"–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: {error}")

        # Bullet points
        success, data, error = self.generate_bullet_points(title, description, characteristics)
        if success:
            results['bullet_points'] = data
        else:
            results['errors'].append(f"–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞: {error}")

        # –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
        if description:
            success, data, error = self.enhance_description(title, description, category)
            if success:
                results['enhanced_description'] = data
            else:
                results['errors'].append(f"–û–ø–∏—Å–∞–Ω–∏–µ: {error}")

        # –ê–Ω–∞–ª–∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏
        success, data, error = self.analyze_card(
            title, description, category, characteristics, photos_count, price
        )
        if success:
            results['analysis'] = data
        else:
            results['errors'].append(f"–ê–Ω–∞–ª–∏–∑: {error}")

        return results

    def test_connection(self) -> Tuple[bool, str]:
        """
        –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ AI API

        Returns:
            Tuple[success, message]
        """
        try:
            messages = [
                {"role": "user", "content": "–û—Ç–≤–µ—Ç—å –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º: —Ä–∞–±–æ—Ç–∞–µ—Ç"}
            ]
            response = self.client.chat_completion(messages, max_tokens=50)
            if response:
                return True, f"–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ. –ú–æ–¥–µ–ª—å: {self.config.model}"
            return False, "–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç API"
        except Exception as e:
            return False, str(e)

    def close(self):
        """–ó–∞–∫—Ä—ã–≤–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç"""
        self.client.close()


# –°–∏–Ω–≥–ª—Ç–æ–Ω –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
_ai_service_instance: Optional[AIService] = None


def get_ai_service(settings=None) -> Optional[AIService]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä AI —Å–µ—Ä–≤–∏—Å–∞

    Args:
        settings: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–∏–º–ø–æ—Ä—Ç–∞ (AutoImportSettings)

    Returns:
        AIService –∏–ª–∏ None –µ—Å–ª–∏ AI –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
    """
    global _ai_service_instance

    if settings is None:
        return _ai_service_instance

    config = AIConfig.from_settings(settings)
    if config is None:
        _ai_service_instance = None
        return None

    if _ai_service_instance is None:
        _ai_service_instance = AIService(config)
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ WB
        try:
            from wb_categories_mapping import WB_ADULT_CATEGORIES
            _ai_service_instance.set_categories(WB_ADULT_CATEGORIES)
        except ImportError:
            logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å WB_ADULT_CATEGORIES")

    return _ai_service_instance


def reset_ai_service():
    """–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç AI —Å–µ—Ä–≤–∏—Å (–ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫)"""
    global _ai_service_instance
    if _ai_service_instance:
        _ai_service_instance.close()
    _ai_service_instance = None
    # –¢–∞–∫–∂–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ token managers
    reset_cloudru_token_managers()


def get_available_models(provider: str) -> Dict[str, Dict]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

    Args:
        provider: –ü—Ä–æ–≤–∞–π–¥–µ—Ä (cloudru, openai, custom)

    Returns:
        –°–ª–æ–≤–∞—Ä—å –º–æ–¥–µ–ª–µ–π {model_id: {name, description, recommended}}
    """
    if provider == 'cloudru':
        return CLOUDRU_MODELS
    elif provider == 'openai':
        return OPENAI_MODELS
    else:
        # –î–ª—è custom –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
        return {**CLOUDRU_MODELS, **OPENAI_MODELS}


def get_default_instructions() -> Dict[str, Dict]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    return DEFAULT_INSTRUCTIONS
