{% extends "base.html" %}

{% block title %}–í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π - –ê–≤—Ç–æ–∏–º–ø–æ—Ä—Ç{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between mb-6">
        <div class="flex-1 min-w-0">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            </h2>
            <p class="mt-1 text-sm text-gray-500">
                –¢–æ–≤–∞—Ä—ã —Å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ < {{ (min_confidence * 100)|round|int }}%
            </p>
        </div>
        <div class="mt-4 flex gap-3 md:mt-0 md:ml-4">
            <button id="recalculateBtn" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                üîÑ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            </button>
            <a href="{{ url_for('auto_import_products') }}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                ‚Üê –í—Å–µ —Ç–æ–≤–∞—Ä—ã
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-4 mb-6">
        <form method="GET" action="{{ url_for('auto_import_validate') }}" class="grid grid-cols-1 gap-4 sm:grid-cols-4">
            <div>
                <label for="min_confidence" class="block text-sm font-medium text-gray-700 mb-1">
                    –ú–∏–Ω. —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
                </label>
                <select id="min_confidence" name="min_confidence" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <option value="0.5" {{ 'selected' if min_confidence == 0.5 else '' }}>50%</option>
                    <option value="0.7" {{ 'selected' if min_confidence == 0.7 else '' }}>70%</option>
                    <option value="0.85" {{ 'selected' if min_confidence == 0.85 else '' }}>85%</option>
                    <option value="0.9" {{ 'selected' if min_confidence == 0.9 else '' }}>90%</option>
                    <option value="0.95" {{ 'selected' if min_confidence == 0.95 else '' }}>95%</option>
                </select>
            </div>
            <div>
                <label for="per_page" class="block text-sm font-medium text-gray-700 mb-1">
                    –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                </label>
                <select id="per_page" name="per_page" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <option value="10" {{ 'selected' if per_page == 10 else '' }}>10</option>
                    <option value="20" {{ 'selected' if per_page == 20 else '' }}>20</option>
                    <option value="50" {{ 'selected' if per_page == 50 else '' }}>50</option>
                    <option value="100" {{ 'selected' if per_page == 100 else '' }}>100</option>
                </select>
            </div>
            <div>
                <label for="category" class="block text-sm font-medium text-gray-700 mb-1">
                    –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                </label>
                <input type="text" id="category" name="category" value="{{ category_filter }}" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ"
                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>
            <div class="flex items-end">
                <button type="submit" class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                </button>
            </div>
        </form>
    </div>

    <!-- Stats -->
    <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6 mb-6">
        <div class="grid grid-cols-1 gap-5 sm:grid-cols-3">
            <div>
                <div class="text-sm font-medium text-gray-500">–í—Å–µ–≥–æ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
                <div class="mt-1 text-3xl font-semibold text-gray-900">{{ total_count }}</div>
            </div>
            <div>
                <div class="text-sm font-medium text-gray-500">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</div>
                <div class="mt-1 text-3xl font-semibold text-gray-900">{{ (min_confidence * 100)|round|int }}%</div>
            </div>
            <div>
                <div class="text-sm font-medium text-gray-500">–°—Ç–∞—Ç—É—Å</div>
                <div class="mt-1">
                    {% if total_count > 0 %}
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                        –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                    </span>
                    {% else %}
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                        –í—Å–µ —Ö–æ—Ä–æ—à–æ
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Products list -->
    {% if total_count > 0 %}
    <div class="bg-white shadow-sm rounded-lg border border-gray-200">
        <div class="px-4 py-5 sm:p-6">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                –¢–æ–≤–∞—Ä
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                –ö–∞—Ç–µ–≥–æ—Ä–∏—è CSV
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                –ö–∞—Ç–µ–≥–æ—Ä–∏—è WB
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                –î–µ–π—Å—Ç–≤–∏—è
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for product in products %}
                        <tr class="hover:bg-gray-50" id="product-row-{{ product.id }}">
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">
                                            {{ product.title[:60] }}{% if product.title|length > 60 %}...{% endif %}
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            ID: {{ product.external_id }} | {{ product.brand or '‚Äî' }}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm text-gray-900">{{ product.category }}</div>
                                {% if product.all_categories_list and product.all_categories_list|length > 1 %}
                                <div class="text-xs text-gray-500 mt-1">
                                    {{ ' > '.join(product.all_categories_list) }}
                                </div>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm text-gray-900" id="category-name-{{ product.id }}">
                                    {{ product.mapped_wb_category or '‚Äî' }}
                                </div>
                                <div class="text-xs text-gray-500" id="category-id-{{ product.id }}">
                                    ID: {{ product.wb_subject_id or '‚Äî' }}
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span id="confidence-badge-{{ product.id }}" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if product.category_confidence >= 0.7 %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-red-100 text-red-800{% endif %}">
                                    {{ (product.category_confidence * 100)|round|int }}%
                                </span>
                            </td>
                            <td class="px-6 py-4 text-sm">
                                <div class="flex items-center space-x-2">
                                    <button onclick="confirmCategory({{ product.id }}, {{ product.wb_subject_id or 'null' }}, '{{ product.mapped_wb_category }}')"
                                            class="text-green-600 hover:text-green-900 font-medium">
                                        ‚úì –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                                    </button>
                                    <span class="text-gray-300">|</span>
                                    <button onclick="editCategory({{ product.id }}, '{{ product.mapped_wb_category }}', {{ product.wb_subject_id or 'null' }})"
                                            class="text-indigo-600 hover:text-indigo-900 font-medium">
                                        –ò–∑–º–µ–Ω–∏—Ç—å
                                    </button>
                                    <span class="text-gray-300">|</span>
                                    <a href="{{ url_for('auto_import_product_detail', product_id=product.id) }}"
                                       class="text-gray-600 hover:text-gray-900 font-medium">
                                        –î–µ—Ç–∞–ª–∏
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if pagination.pages > 1 %}
            <div class="bg-white px-4 py-3 border-t border-gray-200 sm:px-6">
                <div class="flex items-center justify-between">
                    <div class="flex-1 flex justify-between sm:hidden">
                        {% if pagination.has_prev %}
                        <a href="{{ url_for('auto_import_validate', page=pagination.prev_num, per_page=per_page, min_confidence=min_confidence, category=category_filter) }}"
                           class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            –ü—Ä–µ–¥—ã–¥—É—â–∞—è
                        </a>
                        {% endif %}
                        {% if pagination.has_next %}
                        <a href="{{ url_for('auto_import_validate', page=pagination.next_num, per_page=per_page, min_confidence=min_confidence, category=category_filter) }}"
                           class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            –°–ª–µ–¥—É—é—â–∞—è
                        </a>
                        {% endif %}
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                –ü–æ–∫–∞–∑–∞–Ω—ã
                                <span class="font-medium">{{ ((page - 1) * per_page + 1) }}</span>
                                -
                                <span class="font-medium">{{ min((page * per_page), total_count) }}</span>
                                –∏–∑
                                <span class="font-medium">{{ total_count }}</span>
                                —Ç–æ–≤–∞—Ä–æ–≤
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                {% if pagination.has_prev %}
                                <a href="{{ url_for('auto_import_validate', page=pagination.prev_num, per_page=per_page, min_confidence=min_confidence, category=category_filter) }}"
                                   class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    ‚Üê
                                </a>
                                {% endif %}

                                {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                                    {% if p %}
                                        {% if p == page %}
                                        <span class="relative inline-flex items-center px-4 py-2 border border-indigo-500 bg-indigo-50 text-sm font-medium text-indigo-600">
                                            {{ p }}
                                        </span>
                                        {% else %}
                                        <a href="{{ url_for('auto_import_validate', page=p, per_page=per_page, min_confidence=min_confidence, category=category_filter) }}"
                                           class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                            {{ p }}
                                        </a>
                                        {% endif %}
                                    {% else %}
                                    <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                        ...
                                    </span>
                                    {% endif %}
                                {% endfor %}

                                {% if pagination.has_next %}
                                <a href="{{ url_for('auto_import_validate', page=pagination.next_num, per_page=per_page, min_confidence=min_confidence, category=category_filter) }}"
                                   class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    ‚Üí
                                </a>
                                {% endif %}
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-12 text-center">
        <svg class="mx-auto h-12 w-12 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h3 class="mt-2 text-lg font-medium text-gray-900">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ —Ç—Ä–µ–±—É—é—â–∏—Ö –ø—Ä–æ–≤–µ—Ä–∫–∏</h3>
        <p class="mt-1 text-sm text-gray-500">
            –í—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–º–µ—é—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ >= {{ (min_confidence * 100)|round|int }}%
        </p>
    </div>
    {% endif %}
</div>

<!-- Modal for editing category -->
<div id="editCategoryModal" class="hidden fixed z-10 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
            <div>
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                    –ò–∑–º–µ–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                </h3>
                <div class="mt-4">
                    <label for="modalCategorySelect" class="block text-sm font-medium text-gray-700">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é WB</label>
                    <select id="modalCategorySelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>
                    </select>
                </div>
            </div>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                <button type="button" id="modalSaveBtn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:col-start-2 sm:text-sm">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button type="button" id="modalCancelBtn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:col-start-1 sm:text-sm">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const wbCategories = {{ wb_categories|tojson }};
let currentEditingProductId = null;

// Populate modal select
const modalSelect = document.getElementById('modalCategorySelect');
if (modalSelect && wbCategories) {
    const sortedCategories = Object.entries(wbCategories).sort((a, b) => a[1].localeCompare(b[1]));
    sortedCategories.forEach(([id, name]) => {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = `${name} (ID: ${id})`;
        modalSelect.appendChild(option);
    });
}

function confirmCategory(productId, categoryId, categoryName) {
    if (!confirm(`–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ç–µ–∫—É—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${categoryName}"?`)) {
        return;
    }

    fetch(`/auto-import/product/${productId}/correct-category`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            wb_subject_id: parseInt(categoryId)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update table row
            const confidenceBadge = document.getElementById(`confidence-badge-${productId}`);

            if (confidenceBadge) {
                confidenceBadge.textContent = '100%';
                confidenceBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
            }

            // Highlight row and remove after animation
            const row = document.getElementById(`product-row-${productId}`);
            if (row) {
                row.style.backgroundColor = '#d1fae5';
                setTimeout(() => {
                    row.remove();
                    // Reload if no more products
                    const tbody = document.querySelector('tbody');
                    if (tbody && tbody.children.length === 0) {
                        location.reload();
                    }
                }, 1000);
            }
        } else {
            alert('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: ' + error);
    });
}

function editCategory(productId, currentCategory, currentId) {
    currentEditingProductId = productId;
    const modal = document.getElementById('editCategoryModal');
    const select = document.getElementById('modalCategorySelect');

    // Set current selection
    if (currentId) {
        select.value = currentId;
    }

    // Show modal
    modal.classList.remove('hidden');
}

document.getElementById('modalCancelBtn').addEventListener('click', function() {
    document.getElementById('editCategoryModal').classList.add('hidden');
    currentEditingProductId = null;
});

document.getElementById('modalSaveBtn').addEventListener('click', function() {
    const selectedCategoryId = document.getElementById('modalCategorySelect').value;

    if (!selectedCategoryId) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
        return;
    }

    if (!currentEditingProductId) {
        alert('–û—à–∏–±–∫–∞: —Ç–æ–≤–∞—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω');
        return;
    }

    const saveBtn = document.getElementById('modalSaveBtn');
    saveBtn.disabled = true;
    saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

    fetch(`/auto-import/product/${currentEditingProductId}/correct-category`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            wb_subject_id: parseInt(selectedCategoryId)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update table row
            const categoryName = document.getElementById(`category-name-${currentEditingProductId}`);
            const categoryId = document.getElementById(`category-id-${currentEditingProductId}`);
            const confidenceBadge = document.getElementById(`confidence-badge-${currentEditingProductId}`);

            if (categoryName) categoryName.textContent = data.new_category_name;
            if (categoryId) categoryId.textContent = `ID: ${data.new_category_id}`;
            if (confidenceBadge) {
                confidenceBadge.textContent = '100%';
                confidenceBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
            }

            // Remove row from validation list if confidence is now 100%
            const row = document.getElementById(`product-row-${currentEditingProductId}`);
            if (row) {
                row.style.backgroundColor = '#d1fae5';
                setTimeout(() => {
                    row.remove();
                    // Reload if no more products
                    const tbody = document.querySelector('tbody');
                    if (tbody && tbody.children.length === 0) {
                        location.reload();
                    }
                }, 1000);
            }

            // Close modal
            document.getElementById('editCategoryModal').classList.add('hidden');
            currentEditingProductId = null;

            saveBtn.disabled = false;
            saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        } else {
            alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            saveBtn.disabled = false;
            saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: ' + error);
        saveBtn.disabled = false;
        saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    });
});

// Recalculate categories button
const recalculateBtn = document.getElementById('recalculateBtn');
if (recalculateBtn) {
    recalculateBtn.addEventListener('click', function() {
        if (!confirm('–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ —Å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é < 95%?\n\n–°–∏—Å—Ç–µ–º–∞ –ø—Ä–∏–º–µ–Ω–∏—Ç –≤—Å–µ –≤–∞—à–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫ –æ—Å—Ç–∞–ª—å–Ω—ã–º —Ç–æ–≤–∞—Ä–∞–º. –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.')) {
            return;
        }

        recalculateBtn.disabled = true;
        recalculateBtn.innerHTML = '‚è≥ –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º...';

        fetch('/auto-import/recalculate-categories', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`‚úÖ –ü–µ—Ä–µ—Å—á–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!\n\n–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: ${data.total_checked} —Ç–æ–≤–∞—Ä–æ–≤\n–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${data.updated_count} —Ç–æ–≤–∞—Ä–æ–≤\n–£–ª—É—á—à–µ–Ω–æ: ${data.improved_count} —Ç–æ–≤–∞—Ä–æ–≤`);
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                recalculateBtn.disabled = false;
                recalculateBtn.innerHTML = 'üîÑ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
            }
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: ' + error);
            recalculateBtn.disabled = false;
            recalculateBtn.innerHTML = 'üîÑ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
        });
    });
}
</script>
{% endblock %}
