{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8" x-data="mergeApp()">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="mb-6 flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">
                –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤
            </h1>
            <p class="text-gray-600 mt-1">
                –û–±—ä–µ–¥–∏–Ω–∏—Ç–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π –ø–æ–¥ –æ–¥–Ω–∏–º imtID
            </p>
        </div>
        <div class="flex gap-3">
            <a href="{{ url_for('products_merge_recommendations') }}"
               class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:from-purple-700 hover:to-indigo-700 transition shadow-lg group relative">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
                –£–º–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                <!-- Tooltip -->
                <span class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 text-xs text-white bg-gray-900 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-50">
                    –ò–ò –Ω–∞–π–¥–µ—Ç –ø–æ—Ö–æ–∂–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è
                </span>
            </a>
            <a href="{{ url_for('products_merge_history_list') }}"
               class="inline-flex items-center px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                –ò—Å—Ç–æ—Ä–∏—è
            </a>
        </div>
    </div>

    <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å tooltips -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-5 mb-6">
        <div class="flex items-start gap-4">
            <div class="flex-shrink-0 w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <div class="flex-1">
                <h3 class="font-semibold text-gray-900 mb-2">–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div class="flex items-start gap-2">
                        <span class="flex-shrink-0 w-6 h-6 bg-indigo-600 text-white rounded-full flex items-center justify-center text-xs font-bold">1</span>
                        <div>
                            <span class="font-medium text-gray-900">–í—ã–±–µ—Ä–∏—Ç–µ –≥–ª–∞–≤–Ω—É—é</span>
                            <p class="text-gray-600">–ù–∞–∂–º–∏—Ç–µ ‚óã —É –∫–∞—Ä—Ç–æ—á–∫–∏, –∫–æ—Ç–æ—Ä–∞—è —Å—Ç–∞–Ω–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="flex-shrink-0 w-6 h-6 bg-indigo-600 text-white rounded-full flex items-center justify-center text-xs font-bold">2</span>
                        <div>
                            <span class="font-medium text-gray-900">–û—Ç–º–µ—Ç—å—Ç–µ –¥–ª—è —Å–ª–∏—è–Ω–∏—è</span>
                            <p class="text-gray-600">–ü–æ—Å—Ç–∞–≤—å—Ç–µ ‚òë —É –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="flex-shrink-0 w-6 h-6 bg-indigo-600 text-white rounded-full flex items-center justify-center text-xs font-bold">3</span>
                        <div>
                            <span class="font-medium text-gray-900">–û–±—ä–µ–¥–∏–Ω–∏—Ç–µ</span>
                            <p class="text-gray-600">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã</p>
                        </div>
                    </div>
                </div>
                <div class="mt-3 flex flex-wrap gap-2 text-xs">
                    <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded">‚ö†Ô∏è –¢–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded">üì¶ –ú–∞–∫—Å. 30 –∫–∞—Ä—Ç–æ—á–µ–∫</span>
                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded">‚úÖ –í—ã–±–æ—Ä —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏</span>
                </div>
            </div>
        </div>
    </div>

    <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
    <div class="mb-6 bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                </svg>
                –§–∏–ª—å—Ç—Ä—ã
            </h3>
            <!-- –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä -->
            <div class="flex gap-2" x-show="Object.keys(selectedCards).length > 0">
                <span class="text-sm text-gray-500">–í—ã–±—Ä–∞–Ω–æ: <strong x-text="Object.keys(selectedCards).length"></strong></span>
                <button type="button" @click="clearAllSelection()" class="text-sm text-red-600 hover:text-red-800">
                    –û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä
                </button>
            </div>
        </div>

        <form method="GET" action="{{ url_for('products_merge') }}" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- –ü–æ–∏—Å–∫ -->
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">–ü–æ–∏—Å–∫</label>
                <div class="relative">
                    <input type="text" name="search" value="{{ search_query or '' }}"
                           placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, –∞—Ä—Ç–∏–∫—É–ª –∏–ª–∏ –±—Ä–µ–Ω–¥..."
                           class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <svg class="absolute left-3 top-3 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>

            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select name="subject_id" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    {% for subject in subjects %}
                    <option value="{{ subject.id }}" {% if selected_subject == subject.id %}selected{% endif %}>
                        {{ subject.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- –ë—Ä–µ–Ω–¥ -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">–ë—Ä–µ–Ω–¥</label>
                <select name="brand" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <option value="">–í—Å–µ –±—Ä–µ–Ω–¥—ã</option>
                    {% for brand in brands %}
                    <option value="{{ brand }}" {% if selected_brand == brand %}selected{% endif %}>{{ brand }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞ -->
            <div class="md:col-span-4 flex gap-3">
                <button type="submit" class="inline-flex items-center px-5 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    –ù–∞–π—Ç–∏
                </button>
                <a href="{{ url_for('products_merge') }}" class="inline-flex items-center px-5 py-2.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium">
                    –°–±—Ä–æ—Å–∏—Ç—å
                </a>
            </div>
        </form>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="mt-4 pt-4 border-t border-gray-200 flex flex-wrap gap-4 text-sm text-gray-600">
            <span class="flex items-center"><strong class="text-indigo-600 mr-1">{{ total_groups }}</strong> –≥—Ä—É–ø–ø</span>
            <span class="flex items-center"><strong class="text-purple-600 mr-1">{{ total_cards }}</strong> –∫–∞—Ä—Ç–æ—á–µ–∫</span>
            {% if total_pages > 1 %}
            <span class="flex items-center">–°—Ç—Ä–∞–Ω–∏—Ü–∞ <strong class="mx-1">{{ page }}</strong> –∏–∑ <strong class="ml-1">{{ total_pages }}</strong></span>
            {% endif %}
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø -->
    {% if imt_groups %}
    <div class="space-y-4 mb-6">
        {% for group in imt_groups %}
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä—É–ø–ø—ã -->
            <div class="bg-gradient-to-r from-slate-700 to-slate-800 px-6 py-3">
                <div class="flex items-center justify-between text-white">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                        </svg>
                        <span class="font-medium">{{ group.subject_name }}</span>
                        {% if group.brand %}
                        <span class="text-slate-400">‚Ä¢</span>
                        <span class="text-slate-300">{{ group.brand }}</span>
                        {% endif %}
                    </div>
                    <div class="flex items-center gap-2">
                        {% if group.imt_id %}
                        <span class="px-2.5 py-1 text-xs bg-white/10 rounded-full">imtID: {{ group.imt_id }}</span>
                        {% if group.cards|length > 1 %}
                        <span class="px-2.5 py-1 text-xs bg-green-500/80 rounded-full">‚úì –û–±—ä–µ–¥–∏–Ω–µ–Ω–æ</span>
                        <!-- –ö–Ω–æ–ø–∫–∞ —Ä–∞–∑—ä–µ–¥–∏–Ω–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã -->
                        <button type="button"
                                @click="unmergeGroup({{ group.imt_id }}, {{ group.cards|length }})"
                                class="px-2.5 py-1 text-xs bg-amber-500 hover:bg-amber-600 rounded-full transition flex items-center gap-1 group relative">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                            </svg>
                            –†–∞–∑—ä–µ–¥–∏–Ω–∏—Ç—å –≤—Å—ë
                        </button>
                        <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –µ—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ —É–∂–µ —Ä–∞–∑—ä–µ–¥–∏–Ω–µ–Ω—ã –Ω–∞ WB -->
                        <button type="button"
                                @click="forceUnmerge({{ group.imt_id }}, {{ group.cards|length }})"
                                title="–ö–∞—Ä—Ç–æ—á–∫–∏ —É–∂–µ —Ä–∞–∑—ä–µ–¥–∏–Ω–µ–Ω—ã –Ω–∞ WB, –Ω–æ –≤ –Ω–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ –µ—â—ë —á–∏—Å–ª—è—Ç—Å—è –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–º–∏? –ù–∞–∂–º–∏—Ç–µ –∑–¥–µ—Å—å."
                                class="px-2.5 py-1 text-xs bg-gray-500 hover:bg-gray-600 rounded-full transition flex items-center gap-1 group relative">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            –£–∂–µ –Ω–∞ WB
                        </button>
                        {% endif %}
                        {% else %}
                        <span class="px-2.5 py-1 text-xs bg-white/10 rounded-full">–ù–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã</span>
                        {% endif %}
                        <span class="px-2.5 py-1 text-xs bg-white/20 rounded-full">{{ group.cards|length }} —à—Ç.</span>
                    </div>
                </div>
            </div>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –≥—Ä—É–ø–ø—ã -->
            <div class="divide-y divide-gray-100">
                {% for card in group.cards %}
                <div class="flex items-center gap-4 p-4 hover:bg-gray-50 transition"
                     :class="{'bg-indigo-50 border-l-4 border-indigo-500': selectedTarget == '{{ card.nm_id }}', 'bg-purple-50': selectedCards['{{ card.nm_id }}'] && selectedTarget != '{{ card.nm_id }}'}"
                     data-nm-id="{{ card.nm_id }}"
                     data-subject-id="{{ card.subject_id }}">

                    <!-- Radio: –ì–ª–∞–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
                    <div class="relative group/radio">
                        <input type="radio"
                               name="target_nm_id"
                               value="{{ card.nm_id }}"
                               id="target_{{ card.nm_id }}"
                               class="w-5 h-5 text-indigo-600 focus:ring-indigo-500 cursor-pointer"
                               data-subject="{{ card.subject_id }}"
                               data-title="{{ card.title }}"
                               data-vendor="{{ card.vendor_code }}"
                               @change="setTarget('{{ card.nm_id }}', '{{ card.subject_id }}', '{{ card.vendor_code }}', '{{ card.title|e }}')"
                               :checked="selectedTarget == '{{ card.nm_id }}'">
                        <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 px-2 py-1 text-xs text-white bg-gray-900 rounded opacity-0 group-hover/radio:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-10">
                            –°–¥–µ–ª–∞—Ç—å –≥–ª–∞–≤–Ω–æ–π
                        </span>
                    </div>

                    <!-- Checkbox: –î–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è -->
                    <div class="relative group/check">
                        <input type="checkbox"
                               name="merge_checkbox"
                               value="{{ card.nm_id }}"
                               id="merge_{{ card.nm_id }}"
                               class="w-5 h-5 text-purple-600 focus:ring-purple-500 cursor-pointer rounded"
                               data-subject="{{ card.subject_id }}"
                               data-title="{{ card.title }}"
                               data-vendor="{{ card.vendor_code }}"
                               @change="toggleCard('{{ card.nm_id }}', '{{ card.subject_id }}', '{{ card.vendor_code }}', '{{ card.title|e }}')"
                               :checked="selectedCards['{{ card.nm_id }}']">
                        <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 px-2 py-1 text-xs text-white bg-gray-900 rounded opacity-0 group-hover/check:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-10">
                            –í—ã–±—Ä–∞—Ç—å –¥–ª—è —Å–ª–∏—è–Ω–∏—è
                        </span>
                    </div>

                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞—Ä—Ç–æ—á–∫–µ -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-semibold text-gray-900">{{ card.vendor_code }}</span>
                            <span class="text-xs px-2 py-0.5 bg-gray-100 text-gray-600 rounded">nmID: {{ card.nm_id }}</span>
                            {% if card.imt_id %}
                            <span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-700 rounded">imtID: {{ card.imt_id }}</span>
                            {% endif %}
                        </div>
                        <p class="text-sm text-gray-600 truncate">{{ card.title }}</p>
                    </div>

                    <!-- –î–µ–π—Å—Ç–≤–∏–µ: –û—Ç—Å–æ–µ–¥–∏–Ω–∏—Ç—å —ç—Ç—É –∫–∞—Ä—Ç–æ—á–∫—É -->
                    {% if group.cards|length > 1 and group.imt_id %}
                    <button type="button"
                            @click="unmergeCard({{ card.nm_id }}, '{{ card.vendor_code }}')"
                            class="px-3 py-1.5 text-xs bg-gray-100 hover:bg-amber-100 text-gray-600 hover:text-amber-700 rounded-lg transition group relative">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                        <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 px-2 py-1 text-xs text-white bg-gray-900 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-10">
                            –û—Ç—Å–æ–µ–¥–∏–Ω–∏—Ç—å —ç—Ç—É –∫–∞—Ä—Ç–æ—á–∫—É
                        </span>
                    </button>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- –ü–ª–∞–≤–∞—é—â–∞—è –ø–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ -->
    <div x-show="selectedTarget || Object.keys(selectedCards).length > 0"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-4"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         class="fixed bottom-6 left-1/2 transform -translate-x-1/2 w-full max-w-3xl px-4 z-40">
        <div class="bg-white rounded-2xl shadow-2xl border border-gray-200 p-4">
            <div class="flex items-center justify-between gap-4">
                <div class="flex-1">
                    <div class="flex items-center gap-4 text-sm">
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-indigo-500 rounded-full"></span>
                            <span class="text-gray-600">–ì–ª–∞–≤–Ω–∞—è:</span>
                            <strong x-text="selectedTarget ? 'nmID ' + selectedTarget : '–Ω–µ –≤—ã–±—Ä–∞–Ω–∞'" class="text-gray-900"></strong>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-purple-500 rounded-full"></span>
                            <span class="text-gray-600">–î–ª—è —Å–ª–∏—è–Ω–∏—è:</span>
                            <strong x-text="Object.keys(selectedCards).length" class="text-gray-900"></strong>
                        </div>
                    </div>
                    <p x-show="!canMerge()" class="text-xs text-red-500 mt-1" x-text="getMergeError()"></p>
                </div>
                <div class="flex gap-2">
                    <button type="button" @click="clearAllSelection()"
                            class="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition">
                        –û—á–∏—Å—Ç–∏—Ç—å
                    </button>
                    <button type="button" @click="executeMerge()"
                            :disabled="!canMerge()"
                            :class="canMerge() ? 'bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700' : 'bg-gray-300 cursor-not-allowed'"
                            class="px-6 py-2 text-sm text-white rounded-lg transition font-medium flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        –û–±—ä–µ–¥–∏–Ω–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if total_pages > 1 %}
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
        <div class="flex items-center justify-between">
            <div class="text-sm text-gray-600">
                –ü–æ–∫–∞–∑–∞–Ω–æ {{ ((page - 1) * per_page + 1) }} - {{ [page * per_page, total_groups]|min }} –∏–∑ {{ total_groups }} –≥—Ä—É–ø–ø
            </div>
            <div class="flex gap-1">
                {% if page > 1 %}
                <a href="{{ url_for('products_merge', page=1, subject_id=selected_subject, brand=selected_brand, search=search_query) }}"
                   class="px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">¬´</a>
                <a href="{{ url_for('products_merge', page=page-1, subject_id=selected_subject, brand=selected_brand, search=search_query) }}"
                   class="px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">‚Äπ</a>
                {% endif %}

                {% for p in range([1, page - 2]|max, [total_pages, page + 2]|min + 1) %}
                    {% if p == page %}
                    <span class="px-3 py-2 text-sm bg-indigo-600 text-white rounded-lg font-medium">{{ p }}</span>
                    {% else %}
                    <a href="{{ url_for('products_merge', page=p, subject_id=selected_subject, brand=selected_brand, search=search_query) }}"
                       class="px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">{{ p }}</a>
                    {% endif %}
                {% endfor %}

                {% if page < total_pages %}
                <a href="{{ url_for('products_merge', page=page+1, subject_id=selected_subject, brand=selected_brand, search=search_query) }}"
                   class="px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">‚Ä∫</a>
                <a href="{{ url_for('products_merge', page=total_pages, subject_id=selected_subject, brand=selected_brand, search=search_query) }}"
                   class="px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">¬ª</a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
        <svg class="mx-auto h-16 w-16 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
        </svg>
        <h3 class="mt-4 text-lg font-medium text-gray-900">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</h3>
        <p class="mt-2 text-gray-500">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π—Ç–µ —Ç–æ–≤–∞—Ä—ã —Å Wildberries –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</p>
        <a href="{{ url_for('product_sync_status_page') }}" class="mt-4 inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
        </a>
    </div>
    {% endif %}

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
    <div x-show="showConfirmModal" x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6" @click.away="showConfirmModal = false">
            <div class="text-center">
                <div class="w-16 h-16 mx-auto bg-indigo-100 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ</h3>
                <p class="text-gray-600 mb-4">
                    –í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å <strong x-text="Object.keys(selectedCards).length"></strong> –∫–∞—Ä—Ç–æ—á–µ–∫
                    —Å –≥–ª–∞–≤–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–æ–π <strong x-text="'nmID ' + selectedTarget"></strong>.
                </p>
                <p class="text-sm text-gray-500 mb-6">
                    –í—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–ª—É—á–∞—Ç imtID –≥–ª–∞–≤–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏.
                </p>
                <div class="flex gap-3">
                    <button @click="showConfirmModal = false"
                            class="flex-1 px-4 py-2.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button @click="submitMerge()"
                            class="flex-1 px-4 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium">
                        –û–±—ä–µ–¥–∏–Ω–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –°–∫—Ä—ã—Ç–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
<form id="mergeForm" method="POST" action="{{ url_for('products_merge_execute') }}" style="display: none;">
    <input type="hidden" name="target_nm_id" id="form_target_nm_id">
    <input type="hidden" name="nm_ids" id="form_nm_ids">
</form>

<!-- –°–∫—Ä—ã—Ç–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è —Ä–∞–∑—ä–µ–¥–∏–Ω–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã -->
<form id="unmergeGroupForm" method="POST" style="display: none;">
</form>

<!-- –°–∫—Ä—ã—Ç–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î -->
<form id="forceUnmergeForm" method="POST" style="display: none;">
</form>

<!-- –°–∫—Ä—ã—Ç–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è —Ä–∞–∑—ä–µ–¥–∏–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ (action —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS) -->
<form id="unmergeCardForm" method="POST" action="#" style="display: none;">
    <input type="hidden" name="nm_id" id="form_unmerge_nm_id">
</form>

<script>
function mergeApp() {
    return {
        selectedTarget: null,
        selectedTargetSubject: null,
        selectedCards: {},
        showConfirmModal: false,

        init() {
            this.loadFromStorage();
            this.restoreUIState();
            this.handleAutoSelect();
        },

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage
        loadFromStorage() {
            try {
                const stored = localStorage.getItem('merge_selection_v2');
                if (stored) {
                    const data = JSON.parse(stored);
                    this.selectedTarget = data.target || null;
                    this.selectedTargetSubject = data.targetSubject || null;
                    this.selectedCards = data.cards || {};
                }
            } catch (e) {
                console.error('Error loading selection:', e);
            }
        },

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
        saveToStorage() {
            const data = {
                target: this.selectedTarget,
                targetSubject: this.selectedTargetSubject,
                cards: this.selectedCards
            };
            localStorage.setItem('merge_selection_v2', JSON.stringify(data));
        },

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è UI
        restoreUIState() {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º radio
            if (this.selectedTarget) {
                const radio = document.querySelector(`input[name="target_nm_id"][value="${this.selectedTarget}"]`);
                if (radio) radio.checked = true;
            }
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º checkboxes
            Object.keys(this.selectedCards).forEach(nmId => {
                const checkbox = document.querySelector(`input[name="merge_checkbox"][value="${nmId}"]`);
                if (checkbox) checkbox.checked = true;
            });
        },

        // –ê–≤—Ç–æ–≤—ã–±–æ—Ä –∏–∑ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        handleAutoSelect() {
            const urlParams = new URLSearchParams(window.location.search);
            const autoNmIds = urlParams.get('auto_select_nm_ids');
            const autoTarget = urlParams.get('auto_target_nm_id');

            if (autoNmIds && autoTarget) {
                // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –≤—ã–±–æ—Ä
                this.clearAllSelection();

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º target
                const targetRadio = document.querySelector(`input[name="target_nm_id"][value="${autoTarget}"]`);
                if (targetRadio) {
                    targetRadio.checked = true;
                    this.selectedTarget = autoTarget;
                    this.selectedTargetSubject = targetRadio.dataset.subject;
                }

                // –í—ã–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
                autoNmIds.split(',').forEach(nmId => {
                    nmId = nmId.trim();
                    if (nmId && nmId !== autoTarget) {
                        const checkbox = document.querySelector(`input[name="merge_checkbox"][value="${nmId}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                            this.selectedCards[nmId] = {
                                subject: checkbox.dataset.subject,
                                vendor: checkbox.dataset.vendor,
                                title: checkbox.dataset.title
                            };
                        }
                    }
                });

                this.saveToStorage();

                // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                this.showNotification('–ö–∞—Ä—Ç–æ—á–∫–∏ –∏–∑ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤—ã–±—Ä–∞–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏', 'success');
            }
        },

        // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–ª–∞–≤–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
        setTarget(nmId, subjectId, vendor, title) {
            this.selectedTarget = nmId;
            this.selectedTargetSubject = subjectId;
            this.saveToStorage();
        },

        // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤—ã–±–æ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏
        toggleCard(nmId, subjectId, vendor, title) {
            if (this.selectedCards[nmId]) {
                delete this.selectedCards[nmId];
            } else {
                this.selectedCards[nmId] = { subject: subjectId, vendor, title };
            }
            this.saveToStorage();
        },

        // –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –≤—ã–±–æ—Ä
        clearAllSelection() {
            this.selectedTarget = null;
            this.selectedTargetSubject = null;
            this.selectedCards = {};

            document.querySelectorAll('input[name="target_nm_id"]').forEach(r => r.checked = false);
            document.querySelectorAll('input[name="merge_checkbox"]').forEach(c => c.checked = false);

            localStorage.removeItem('merge_selection_v2');
        },

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è
        canMerge() {
            if (!this.selectedTarget) return false;
            if (Object.keys(this.selectedCards).length === 0) return false;
            if (Object.keys(this.selectedCards).length > 30) return false;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            const targetSubject = this.selectedTargetSubject;
            for (const nmId in this.selectedCards) {
                if (this.selectedCards[nmId].subject !== targetSubject) {
                    return false;
                }
            }
            return true;
        },

        // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
        getMergeError() {
            if (!this.selectedTarget) return '–í—ã–±–µ—Ä–∏—Ç–µ –≥–ª–∞–≤–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É';
            if (Object.keys(this.selectedCards).length === 0) return '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è —Å–ª–∏—è–Ω–∏—è';
            if (Object.keys(this.selectedCards).length > 30) return '–ú–∞–∫—Å–∏–º—É–º 30 –∫–∞—Ä—Ç–æ—á–µ–∫ –∑–∞ —Ä–∞–∑';

            const targetSubject = this.selectedTargetSubject;
            for (const nmId in this.selectedCards) {
                if (this.selectedCards[nmId].subject !== targetSubject) {
                    return '–í—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–¥–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
                }
            }
            return '';
        },

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        executeMerge() {
            if (this.canMerge()) {
                this.showConfirmModal = true;
            }
        },

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É
        submitMerge() {
            document.getElementById('form_target_nm_id').value = this.selectedTarget;
            document.getElementById('form_nm_ids').value = Object.keys(this.selectedCards).join(',');
            document.getElementById('mergeForm').submit();
        },

        // –†–∞–∑—ä–µ–¥–∏–Ω–∏—Ç—å –≥—Ä—É–ø–ø—É (—á–µ—Ä–µ–∑ WB API)
        unmergeGroup(imtId, cardCount) {
            if (confirm(`–†–∞–∑—ä–µ–¥–∏–Ω–∏—Ç—å –≤—Å–µ ${cardCount} –∫–∞—Ä—Ç–æ—á–µ–∫ –∏–∑ –≥—Ä—É–ø–ø—ã imtID=${imtId}?\n\n–ö–∞–∂–¥–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–ª—É—á–∏—Ç –Ω–æ–≤—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π imtID.`)) {
                const form = document.getElementById('unmergeGroupForm');
                form.action = `/products/merge/unmerge/${imtId}`;
                form.submit();
            }
        },

        // –°–±—Ä–æ—Å–∏—Ç—å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ (–µ—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ —É–∂–µ —Ä–∞–∑—ä–µ–¥–∏–Ω–µ–Ω—ã –Ω–∞ WB)
        forceUnmerge(imtId, cardCount) {
            if (confirm(`–ö–∞—Ä—Ç–æ—á–∫–∏ —É–∂–µ —Ä–∞–∑—ä–µ–¥–∏–Ω–µ–Ω—ã –Ω–∞ Wildberries?\n\n–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–∏—Ç –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ WB API).\n–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å WB —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ imtID.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`)) {
                const form = document.getElementById('forceUnmergeForm');
                form.action = `/products/merge/force-unmerge/${imtId}`;
                form.submit();
            }
        },

        // –†–∞–∑—ä–µ–¥–∏–Ω–∏—Ç—å –æ–¥–Ω—É –∫–∞—Ä—Ç–æ—á–∫—É
        unmergeCard(nmId, vendorCode) {
            if (confirm(`–û—Ç—Å–æ–µ–¥–∏–Ω–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É ${vendorCode} (nmID: ${nmId}) –æ—Ç –≥—Ä—É–ø–ø—ã?\n\n–û–Ω–∞ –ø–æ–ª—É—á–∏—Ç –Ω–æ–≤—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π imtID.`)) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º API –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ä–æ—É—Ç
                window.location.href = `/products/merge/unmerge-single/${nmId}`;
            }
        },

        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };

            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center`;
            notification.innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                ${message}
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.transition = 'opacity 0.5s';
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
    };
}
</script>
{% endblock %}
