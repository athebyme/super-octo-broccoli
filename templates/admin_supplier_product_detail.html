{% extends "base.html" %}

{% block title %}{{ product.title or 'Товар' }} — {{ supplier.name }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <nav class="mb-4 text-sm text-gray-500">
        <a href="{{ url_for('admin_suppliers') }}" class="hover:text-indigo-600">Поставщики</a>
        <span class="mx-2">/</span>
        <a href="{{ url_for('admin_supplier_products', supplier_id=supplier.id) }}" class="hover:text-indigo-600">{{
            supplier.name }}</a>
        <span class="mx-2">/</span>
        <span class="text-gray-900">{{ (product.title or 'Товар')[:50] }}</span>
    </nav>

    <div class="flex gap-8">
        <!-- Основной контент -->
        <div class="flex-1">
            <form method="POST">
                <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-start justify-between">
                            <h1 class="text-xl font-bold text-gray-900">{{ product.title or 'Без названия' }}</h1>
                            {% set status_colors = {'draft': 'bg-gray-100 text-gray-700', 'validated': 'bg-blue-100
                            text-blue-700', 'ready': 'bg-green-100 text-green-700', 'archived': 'bg-yellow-100
                            text-yellow-700'} %}
                            <span
                                class="px-3 py-1 rounded-full text-xs font-medium {{ status_colors.get(product.status, 'bg-gray-100 text-gray-700') }}">
                                {{ product.status }}
                            </span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">ID: {{ product.external_id }} | Артикул: {{
                            product.vendor_code or '—' }}
                            {% if product.additional_vendor_code %} | Доп: {{ product.additional_vendor_code }}{% endif %}
                        </p>
                    </div>

                    <!-- Фотографии -->
                    {% set photos = product.get_photos() %}
                    {% if photos %}
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-sm font-semibold text-gray-700 mb-3">Фотографии ({{ photos|length }})</h3>
                        <div class="flex gap-3 overflow-x-auto pb-2">
                            {% for photo in photos[:10] %}
                            <img src="{{ url_for('serve_supplier_product_photo', supplier_product_id=product.id, photo_idx=loop.index0) }}"
                                class="w-24 h-24 object-cover rounded-lg flex-shrink-0 border border-gray-200" alt=""
                                onerror="this.style.display='none'">
                            {% endfor %}
                        </div>
                    </div>

                    {% endif %}

                    <!-- Основные поля -->
                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Название</label>
                                <input type="text" name="title" value="{{ product.title or '' }}"
                                    class="w-full rounded-lg border-gray-300 text-sm border px-3 py-2 focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Бренд</label>
                                <input type="text" name="brand" value="{{ product.brand or '' }}"
                                    class="w-full rounded-lg border-gray-300 text-sm border px-3 py-2 focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Описание</label>
                            <textarea name="description" rows="3"
                                class="w-full rounded-lg border-gray-300 text-sm border px-3 py-2 focus:border-indigo-500 focus:ring-indigo-500">{{ product.description or '' }}</textarea>
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Категория</label>
                                <input type="text" name="category" value="{{ product.category or '' }}"
                                    class="w-full rounded-lg border-gray-300 text-sm border px-3 py-2 focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Категория WB</label>
                                <input type="text" name="wb_category_name" value="{{ product.wb_category_name or '' }}"
                                    class="w-full rounded-lg border-gray-300 text-sm border px-3 py-2 focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">WB Subject ID</label>
                                <input type="number" name="wb_subject_id" value="{{ product.wb_subject_id or '' }}"
                                    class="w-full rounded-lg border-gray-300 text-sm border px-3 py-2 focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                        </div>

                        <!-- Цены и остатки -->
                        <hr class="my-4">
                        <h3 class="text-sm font-semibold text-gray-700">Цены и остатки</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Цена поставщика</label>
                                <input type="number" name="supplier_price" step="0.01"
                                    value="{{ product.supplier_price or '' }}"
                                    class="w-full rounded-lg border-gray-300 text-sm border px-3 py-2 focus:border-indigo-500 focus:ring-indigo-500">
                                {% if product.previous_price and product.previous_price != product.supplier_price %}
                                <p class="mt-0.5 text-xs text-gray-400">Была: {{ '%.0f'|format(product.previous_price) }} &#8381;</p>
                                {% endif %}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Остаток</label>
                                <input type="number" name="supplier_quantity"
                                    value="{{ product.supplier_quantity or '' }}"
                                    class="w-full rounded-lg border-gray-300 text-sm border px-3 py-2 focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">РРЦ</label>
                                <div class="w-full rounded-lg bg-gray-50 text-sm border border-gray-200 px-3 py-2 text-gray-700">
                                    {{ '%.0f ₽'|format(product.recommended_retail_price) if product.recommended_retail_price else '—' }}
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Наличие</label>
                                <div class="w-full rounded-lg text-sm border border-gray-200 px-3 py-2 {{ 'bg-green-50 text-green-700' if product.supplier_status == 'in_stock' else 'bg-red-50 text-red-600' if product.supplier_status == 'out_of_stock' else 'bg-gray-50 text-gray-500' }}">
                                    {% if product.supplier_status == 'in_stock' %}
                                    В наличии
                                    {% elif product.supplier_status == 'out_of_stock' %}
                                    Нет в наличии
                                    {% else %}
                                    Не синхронизировано
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Расчёт розничной цены -->
                        {% if price_calc %}
                        <div class="bg-indigo-50 rounded-lg p-4 mt-3">
                            <h4 class="text-sm font-semibold text-indigo-900 mb-2">Расчёт розничной цены (по умолчанию)</h4>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-sm">
                                <div>
                                    <span class="text-indigo-600">Закупочная (P)</span>
                                    <p class="font-bold text-indigo-900">{{ '%.0f'|format(price_calc.P) }} &#8381;</p>
                                </div>
                                <div>
                                    <span class="text-indigo-600">Цена на МП (Z)</span>
                                    <p class="font-bold text-indigo-900">{{ '%.0f'|format(price_calc.Z) }} &#8381;</p>
                                </div>
                                <div>
                                    <span class="text-indigo-600">Со скидкой (X)</span>
                                    <p class="font-bold text-indigo-900">{{ '%.0f'|format(price_calc.X) }} &#8381;</p>
                                </div>
                                <div>
                                    <span class="text-indigo-600">До скидки (Y)</span>
                                    <p class="font-bold text-indigo-900">{{ '%.0f'|format(price_calc.Y) }} &#8381;</p>
                                </div>
                            </div>
                            <p class="text-xs text-indigo-500 mt-2">Прибыль Q: {{ '%.0f'|format(price_calc.Q) }} &#8381; ({{ '%.0f'|format(price_calc.Q / price_calc.P * 100) if price_calc.P else 0 }}%) | Доставка S: {{ '%.0f'|format(price_calc.S) }} &#8381;</p>
                        </div>
                        {% endif %}

                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Пол</label>
                                <input type="text" name="gender" value="{{ product.gender or '' }}"
                                    class="w-full rounded-lg border-gray-300 text-sm border px-3 py-2 focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Страна</label>
                                <input type="text" name="country" value="{{ product.country or '' }}"
                                    class="w-full rounded-lg border-gray-300 text-sm border px-3 py-2 focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Статус</label>
                            <select name="status"
                                class="rounded-lg border-gray-300 text-sm border px-3 py-2 focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="draft" {{ 'selected' if product.status=='draft' }}>Черновик</option>
                                <option value="validated" {{ 'selected' if product.status=='validated' }}>Валидирован
                                </option>
                                <option value="ready" {{ 'selected' if product.status=='ready' }}>Готов</option>
                                <option value="archived" {{ 'selected' if product.status=='archived' }}>Архив</option>
                            </select>
                        </div>

                        <!-- AI данные -->
                        <hr class="my-4">
                        <h3 class="text-sm font-semibold text-gray-700">AI-обогащённые данные</h3>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">SEO заголовок</label>
                            <input type="text" name="ai_seo_title" value="{{ product.ai_seo_title or '' }}"
                                class="w-full rounded-lg border-gray-300 text-sm border px-3 py-2 focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">AI описание</label>
                            <textarea name="ai_description" rows="3"
                                class="w-full rounded-lg border-gray-300 text-sm border px-3 py-2 focus:border-indigo-500 focus:ring-indigo-500">{{ product.ai_description or '' }}</textarea>
                        </div>
                        {% if product.ai_keywords_json %}
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ключевые слова</label>
                            <p class="text-sm text-gray-600 bg-gray-50 rounded-lg px-3 py-2">{{ product.ai_keywords_json
                                }}</p>
                        </div>
                        {% endif %}
                        {% if product.ai_analysis_json %}
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">AI анализ</label>
                            <pre
                                class="text-xs text-gray-600 bg-gray-50 rounded-lg px-3 py-2 overflow-x-auto max-h-48">{{ product.ai_analysis_json }}</pre>
                        </div>
                        {% endif %}

                        <!-- AI Полный парсинг -->
                        {% if product.ai_parsed_data_json %}
                        <hr class="my-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-sm font-semibold text-gray-700">AI Полный парсинг</h3>
                            <div class="flex gap-2 items-center">
                                {% set parsed = product.get_ai_parsed_data() %}
                                {% set pm = parsed.get('parsing_meta', {}) %}
                                <span class="text-xs text-gray-500">
                                    {{ pm.get('total_fields_found', 0) }}/{{ pm.get('total_fields_possible', 0) }} полей
                                    ({{ '%.0f'|format(pm.get('fill_percentage', 0)) }}%)
                                </span>
                                {% if product.ai_parsed_at %}
                                <span class="text-xs text-gray-400">{{ product.ai_parsed_at.strftime('%d.%m.%Y %H:%M') }}</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Маркетплейс данные (компактный вид) -->
                        {% set mp = product.get_ai_marketplace_data() %}
                        {% if mp %}
                        <div class="bg-indigo-50 rounded-lg p-4 mb-3">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-xs font-semibold text-indigo-900">Данные для WB</h4>
                                <button type="button" onclick="copyText(document.getElementById('mpJson').textContent)" class="text-xs text-indigo-600 hover:text-indigo-800">Копировать</button>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-xs mb-2">
                                {% if mp.get('title') %}<div><span class="text-indigo-600">Заголовок:</span> {{ mp.title[:50] }}</div>{% endif %}
                                {% if mp.get('brand') %}<div><span class="text-indigo-600">Бренд:</span> {{ mp.brand }}</div>{% endif %}
                                {% if mp.get('color') %}<div><span class="text-indigo-600">Цвет:</span> {{ mp.color }}</div>{% endif %}
                                {% if mp.get('category') %}<div><span class="text-indigo-600">Категория:</span> {{ mp.category[:30] }}</div>{% endif %}
                            </div>
                            {% if mp.get('characteristics') %}
                            <div class="text-xs text-indigo-700 mb-1"><strong>Характеристики:</strong></div>
                            <div class="grid grid-cols-2 gap-1 text-xs">
                                {% for k, v in mp.characteristics.items() %}
                                <div class="text-indigo-600">{{ k }}: <span class="text-indigo-900">{{ v }}</span></div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <pre id="mpJson" class="hidden">{{ product.ai_marketplace_json }}</pre>
                        </div>
                        {% endif %}

                        <!-- Полный парсинг (свёрнутый) -->
                        <details class="mb-2">
                            <summary class="text-xs font-medium text-gray-600 cursor-pointer hover:text-indigo-600">
                                Полные данные AI парсинга (JSON)
                            </summary>
                            <div class="mt-2 relative">
                                <button type="button" onclick="copyText(document.getElementById('parsedJson').textContent)"
                                        class="absolute top-2 right-2 text-xs text-gray-500 hover:text-indigo-600 bg-white px-2 py-0.5 rounded border">
                                    Копировать
                                </button>
                                <pre id="parsedJson" class="text-xs text-gray-600 bg-gray-50 rounded-lg px-3 py-2 overflow-x-auto max-h-64 border">{{ product.ai_parsed_data_json }}</pre>
                            </div>
                        </details>
                        {% endif %}
                    </div>
                </div>

                <div class="mt-6 flex justify-end gap-3">
                    <a href="{{ url_for('admin_supplier_products', supplier_id=supplier.id) }}"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">Назад</a>
                    <button type="submit"
                        class="px-6 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700">Сохранить</button>
                </div>
            </form>
        </div>

        <!-- Сайдбар -->
        <div class="w-64 flex-shrink-0">
            <div class="bg-white rounded-lg border border-gray-200 p-5 sticky top-8">
                <h3 class="text-sm font-semibold text-gray-900 mb-4">Информация</h3>
                <dl class="space-y-3 text-sm">
                    <div>
                        <dt class="text-gray-500">External ID</dt>
                        <dd class="font-medium text-gray-900 mt-0.5">{{ product.external_id }}</dd>
                    </div>
                    {% if product.barcode %}
                    <div>
                        <dt class="text-gray-500">Штрихкод</dt>
                        <dd class="font-medium text-gray-900 mt-0.5">{{ product.barcode }}</dd>
                    </div>
                    {% endif %}
                    {% if product.additional_vendor_code %}
                    <div>
                        <dt class="text-gray-500">Доп. артикул</dt>
                        <dd class="font-medium text-gray-900 mt-0.5">{{ product.additional_vendor_code }}</dd>
                    </div>
                    {% endif %}
                    <div>
                        <dt class="text-gray-500">AI валидирован</dt>
                        <dd class="mt-0.5">
                            {% if product.ai_validated %}
                            <span class="text-green-600 font-medium">Да</span>
                            {% if product.ai_validation_score %}
                            <span class="text-gray-400">({{ '%.0f'|format(product.ai_validation_score) }}%)</span>
                            {% endif %}
                            {% else %}
                            <span class="text-gray-400">Нет</span>
                            {% endif %}
                        </dd>
                    </div>
                    <div>
                        <dt class="text-gray-500">Импортирован продавцами</dt>
                        <dd class="font-medium text-gray-900 mt-0.5">{{ import_count }}</dd>
                    </div>
                    {% if product.last_price_sync_at %}
                    <div>
                        <dt class="text-gray-500">Синхр. цен</dt>
                        <dd class="text-gray-600 mt-0.5">{{ product.last_price_sync_at.strftime('%d.%m.%Y %H:%M') }}</dd>
                    </div>
                    {% endif %}
                    {% if product.price_changed_at %}
                    <div>
                        <dt class="text-gray-500">Цена менялась</dt>
                        <dd class="text-gray-600 mt-0.5">{{ product.price_changed_at.strftime('%d.%m.%Y %H:%M') }}</dd>
                    </div>
                    {% endif %}
                    <div>
                        <dt class="text-gray-500">Создан</dt>
                        <dd class="text-gray-600 mt-0.5">{{ product.created_at.strftime('%d.%m.%Y %H:%M') if
                            product.created_at else '—' }}</dd>
                    </div>
                    <div>
                        <dt class="text-gray-500">Обновлён</dt>
                        <dd class="text-gray-600 mt-0.5">{{ product.updated_at.strftime('%d.%m.%Y %H:%M') if
                            product.updated_at else '—' }}</dd>
                    </div>
                </dl>
            </div>

            <!-- AI действия -->
            {% if supplier.ai_enabled %}
            <div class="bg-white rounded-lg border border-gray-200 p-5 mt-4">
                <h3 class="text-sm font-semibold text-gray-900 mb-3">AI действия</h3>
                <div class="space-y-2">
                    <form method="POST" action="{{ url_for('admin_supplier_ai_seo', supplier_id=supplier.id) }}">
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <button type="submit"
                            class="w-full text-left px-3 py-2 text-sm rounded-lg bg-blue-50 text-blue-700 hover:bg-blue-100 transition-colors">
                            Сгенерировать SEO заголовок
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('admin_supplier_ai_desc', supplier_id=supplier.id) }}">
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <button type="submit"
                            class="w-full text-left px-3 py-2 text-sm rounded-lg bg-blue-50 text-blue-700 hover:bg-blue-100 transition-colors">
                            Сгенерировать описание
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('admin_supplier_ai_validate', supplier_id=supplier.id) }}">
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <button type="submit"
                            class="w-full text-left px-3 py-2 text-sm rounded-lg bg-green-50 text-green-700 hover:bg-green-100 transition-colors">
                            AI валидация
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('admin_supplier_ai_analyze', supplier_id=supplier.id) }}">
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <button type="submit"
                            class="w-full text-left px-3 py-2 text-sm rounded-lg bg-purple-50 text-purple-700 hover:bg-purple-100 transition-colors">
                            AI анализ карточки
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('admin_supplier_ai_enrich', supplier_id=supplier.id) }}">
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <button type="submit"
                            onclick="return confirm('Запустить полное AI обогащение? Это займёт время.')"
                            class="w-full text-left px-3 py-2 text-sm rounded-lg bg-indigo-50 text-indigo-700 hover:bg-indigo-100 transition-colors font-medium">
                            Полное AI обогащение
                        </button>
                    </form>
                    <hr class="my-2">
                    <form method="POST" action="{{ url_for('admin_supplier_ai_parse', supplier_id=supplier.id) }}">
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <button type="submit"
                            onclick="return confirm('Запустить полный AI парсинг? AI извлечёт все характеристики.')"
                            class="w-full text-left px-3 py-2 text-sm rounded-lg bg-orange-50 text-orange-700 hover:bg-orange-100 transition-colors font-medium">
                            AI Полный парсинг
                        </button>
                    </form>
                    {% if product.ai_parsed_at %}
                    <p class="text-xs text-gray-400 px-3 mt-1">
                        Последний: {{ product.ai_parsed_at.strftime('%d.%m.%Y %H:%M') }}
                    </p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Raw JSON -->
            <div class="bg-white rounded-lg border border-gray-200 p-5 mt-4">
                <h3 class="text-sm font-semibold text-gray-900 mb-3">Аналитика</h3>
                <div class="space-y-2">
                    <a href="{{ url_for('admin_supplier_product_raw_json', supplier_id=supplier.id, product_id=product.id) }}"
                       class="block w-full text-left px-3 py-2 text-sm rounded-lg bg-gray-50 text-gray-700 hover:bg-gray-100 transition-colors">
                        Raw JSON (все данные)
                    </a>
                    {% if supplier.ai_enabled %}
                    <a href="{{ url_for('admin_supplier_ai_parser', supplier_id=supplier.id) }}"
                       class="block w-full text-left px-3 py-2 text-sm rounded-lg bg-gray-50 text-gray-700 hover:bg-gray-100 transition-colors">
                        AI Парсер (массовый)
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
<script>
function copyText(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('Скопировано в буфер обмена');
    });
}
</script>
{% endblock %}
