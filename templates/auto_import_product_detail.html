{% extends "base.html" %}

{% block title %}{{ product.title }} - Автоимпорт - WB Seller Platform{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Навигация -->
    <div class="mb-4">
        <a href="{{ url_for('auto_import_products') }}" class="text-indigo-600 hover:text-indigo-900 text-sm">
            ← Назад к списку товаров
        </a>
    </div>

    <!-- Заголовок -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">{{ product.title }}</h1>
                <p class="mt-2 text-sm text-gray-600">
                    ID: {{ product.external_id }}
                </p>
            </div>
            <div>
                {% if product.import_status == 'imported' %}
                <span class="px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800">
                    ✓ Импортировано
                </span>
                {% elif product.import_status == 'validated' %}
                <span class="px-3 py-1 text-sm font-semibold rounded-full bg-blue-100 text-blue-800">
                    Готово к импорту
                </span>
                {% elif product.import_status == 'failed' %}
                <span class="px-3 py-1 text-sm font-semibold rounded-full bg-red-100 text-red-800">
                    ✗ Ошибка
                </span>
                {% else %}
                <span class="px-3 py-1 text-sm font-semibold rounded-full bg-gray-100 text-gray-800">
                    {{ product.import_status }}
                </span>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Основная информация -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Базовые данные -->
            <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Основная информация</h3>
                <dl class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Артикул поставщика</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ product.external_vendor_code or '—' }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Бренд</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ product.brand or '—' }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Страна производства</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ product.country or '—' }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Пол</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ product.gender or '—' }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Категория источника</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ product.category or '—' }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Категория WB</dt>
                        <dd class="mt-1">
                            <div id="categoryDisplay" class="flex items-center justify-between">
                                <div>
                                    <span class="text-sm text-gray-900">{{ product.mapped_wb_category or '—' }}</span>
                                    {% if product.wb_subject_id %}
                                    <span class="text-xs text-gray-500 ml-1">(ID: {{ product.wb_subject_id }})</span>
                                    {% endif %}
                                    {% if product.category_confidence %}
                                    <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                                        {% if product.category_confidence >= 0.9 %}bg-green-100 text-green-800
                                        {% elif product.category_confidence >= 0.7 %}bg-yellow-100 text-yellow-800
                                        {% else %}bg-red-100 text-red-800{% endif %}">
                                        {{ (product.category_confidence * 100)|round|int }}% уверенность
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="flex items-center gap-3">
                                    {% if product.category_confidence and product.category_confidence < 1.0 %}
                                    <button type="button" id="confirmCategoryBtn" class="text-sm text-green-600 hover:text-green-900 font-medium">
                                        ✓ Подтвердить
                                    </button>
                                    {% endif %}
                                    <button type="button" id="editCategoryBtn" class="text-sm text-indigo-600 hover:text-indigo-900 font-medium">
                                        Изменить
                                    </button>
                                </div>
                            </div>
                            <div id="categoryEditor" class="hidden mt-2">
                                <select id="categorySelect" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    <option value="">Выберите категорию...</option>
                                </select>
                                <div class="mt-2 flex gap-2">
                                    <button type="button" id="saveCategoryBtn" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        Сохранить
                                    </button>
                                    <button type="button" id="cancelCategoryBtn" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        Отмена
                                    </button>
                                </div>
                            </div>
                        </dd>
                    </div>
                </dl>
            </div>

            <!-- Характеристики -->
            <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Характеристики</h3>
                <dl class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Цвета</dt>
                        <dd class="mt-1">
                            {% if product.colors_list %}
                                {% for color in product.colors_list %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 mr-1 mb-1">
                                    {{ color }}
                                </span>
                                {% endfor %}
                            {% else %}
                                <span class="text-sm text-gray-900">—</span>
                            {% endif %}
                        </dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Размеры</dt>
                        <dd class="mt-1">
                            {% if product.sizes_list %}
                                {% if product.sizes_list.raw %}
                                <div class="text-sm text-gray-900 mb-2">{{ product.sizes_list.raw }}</div>
                                {% endif %}

                                {% if product.sizes_list.simple_sizes %}
                                <div class="mb-2">
                                    {% for size in product.sizes_list.simple_sizes %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 mr-1 mb-1">
                                        {{ size }}
                                    </span>
                                    {% endfor %}
                                </div>
                                {% endif %}

                                {% if product.sizes_list.dimensions %}
                                <div class="text-xs text-gray-600 space-y-1">
                                    {% if product.sizes_list.dimensions.length %}
                                    <div><span class="font-medium">Длина:</span> {{ product.sizes_list.dimensions.length|join(', ') }} см</div>
                                    {% endif %}
                                    {% if product.sizes_list.dimensions.diameter %}
                                    <div><span class="font-medium">Диаметр:</span> {{ product.sizes_list.dimensions.diameter|join(', ') }} см</div>
                                    {% endif %}
                                    {% if product.sizes_list.dimensions.width %}
                                    <div><span class="font-medium">Ширина:</span> {{ product.sizes_list.dimensions.width|join(', ') }} см</div>
                                    {% endif %}
                                    {% if product.sizes_list.dimensions.depth %}
                                    <div><span class="font-medium">Глубина:</span> {{ product.sizes_list.dimensions.depth|join(', ') }} см</div>
                                    {% endif %}
                                    {% if product.sizes_list.dimensions.weight %}
                                    <div><span class="font-medium">Вес:</span> {{ product.sizes_list.dimensions.weight|join(', ') }} г</div>
                                    {% endif %}
                                    {% if product.sizes_list.dimensions.volume %}
                                    <div><span class="font-medium">Объём:</span> {{ product.sizes_list.dimensions.volume|join(', ') }} мл</div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            {% else %}
                                <span class="text-sm text-gray-900">—</span>
                            {% endif %}
                        </dd>
                    </div>
                    <div class="sm:col-span-2">
                        <dt class="text-sm font-medium text-gray-500">Материалы</dt>
                        <dd class="mt-1">
                            {% if product.materials_list %}
                                {% for material in product.materials_list %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 mr-1 mb-1">
                                    {{ material }}
                                </span>
                                {% endfor %}
                            {% else %}
                                <span class="text-sm text-gray-900">—</span>
                            {% endif %}
                        </dd>
                    </div>
                </dl>
            </div>

            <!-- Описание -->
            {% if product.description %}
            <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Описание</h3>
                <div class="text-sm text-gray-700 whitespace-pre-line">{{ product.description }}</div>
            </div>
            {% endif %}

            <!-- Ошибки валидации -->
            {% if product.validation_errors_list %}
            <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-red-900">Ошибки валидации</h3>
                    <button type="button" id="showFixFormBtn" class="text-sm text-indigo-600 hover:text-indigo-900 font-medium">
                        Исправить ошибки
                    </button>
                </div>
                <ul class="list-disc list-inside space-y-1 mb-4">
                    {% for error in product.validation_errors_list %}
                    <li class="text-sm text-red-700">{{ error }}</li>
                    {% endfor %}
                </ul>

                <!-- Форма исправления ошибок -->
                <div id="fixForm" class="hidden mt-4 pt-4 border-t border-red-200">
                    <form id="fixErrorsForm">
                        <!-- Баркоды -->
                        {% if 'баркод' in (product.validation_errors_list|join(' '))|lower %}
                        <div class="mb-4">
                            <label for="fix_barcodes" class="block text-sm font-medium text-gray-700 mb-1">
                                Баркоды (через запятую)
                            </label>
                            <input type="text" id="fix_barcodes" name="barcodes"
                                   value="{{ product.barcodes_list|join(', ') if product.barcodes_list else '' }}"
                                   class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                   placeholder="1234567890123, 1234567890124">
                            <p class="mt-1 text-xs text-gray-500">
                                EAN-13 или другой штрихкод. Можно указать несколько через запятую.
                            </p>
                        </div>
                        {% endif %}

                        <!-- Бренд -->
                        {% if 'бренд' in (product.validation_errors_list|join(' '))|lower %}
                        <div class="mb-4">
                            <label for="fix_brand" class="block text-sm font-medium text-gray-700 mb-1">
                                Бренд
                            </label>
                            <input type="text" id="fix_brand" name="brand"
                                   value="{{ product.brand or '' }}"
                                   class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                   placeholder="Название бренда">
                        </div>
                        {% endif %}

                        <!-- Название -->
                        {% if 'название' in (product.validation_errors_list|join(' '))|lower %}
                        <div class="mb-4">
                            <label for="fix_title" class="block text-sm font-medium text-gray-700 mb-1">
                                Название товара
                            </label>
                            <input type="text" id="fix_title" name="title"
                                   value="{{ product.title or '' }}"
                                   class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                   placeholder="Название товара">
                        </div>
                        {% endif %}

                        <!-- Категория WB -->
                        {% if 'категория' in (product.validation_errors_list|join(' '))|lower %}
                        <div class="mb-4">
                            <label for="fix_category" class="block text-sm font-medium text-gray-700 mb-1">
                                Категория WB
                            </label>
                            <select id="fix_category" name="wb_subject_id"
                                    class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                                <option value="">Выберите категорию...</option>
                            </select>
                        </div>
                        {% endif %}

                        <div class="flex gap-2">
                            <button type="submit" id="saveFixBtn"
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                                Сохранить и проверить
                            </button>
                            <button type="button" id="cancelFixBtn"
                                    class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Отмена
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Боковая панель -->
        <div class="space-y-6">
            <!-- Фотографии -->
            {% if product.photo_urls_list %}
            <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Фотографии ({{ product.photo_urls_list|length }})</h3>
                    <div class="flex items-center gap-3">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="togglePadding" class="sr-only peer" checked>
                            <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                            <span class="ms-2 text-sm font-medium text-gray-700">Padding</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="toggleCensorship" class="sr-only peer">
                            <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                            <span class="ms-2 text-sm font-medium text-gray-700">Цензура</span>
                        </label>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    {% for photo in product.photo_urls_list[:6] %}
                    <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden relative group">
                        <img data-src="/auto-import/photo/padded?url={{ (photo.sexoptovik or '')|urlencode }}"
                             src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect fill='%23f3f4f6' width='200' height='200'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%239ca3af' font-size='12'%3EЗагрузка...%3C/text%3E%3C/svg%3E"
                             data-blur="{{ photo.blur or '' }}"
                             data-original="{{ photo.original or '' }}"
                             data-sexoptovik="{{ photo.sexoptovik or '' }}"
                             alt="Фото товара"
                             loading="lazy"
                             class="lazy-photo product-photo w-full h-full object-cover transition-opacity duration-200"
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Crect fill=\'%23f3f4f6\' width=\'100\' height=\'100\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%239ca3af\' font-size=\'14\'%3EНет фото%3C/text%3E%3C/svg%3E'">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all duration-200 pointer-events-none"></div>
                    </div>
                    {% endfor %}
                </div>
                {% if product.photo_urls_list|length > 6 %}
                <p class="mt-2 text-xs text-gray-500 text-center">
                    +{{ product.photo_urls_list|length - 6 }} еще
                </p>
                {% endif %}
            </div>
            {% endif %}

            <!-- Баркоды -->
            {% if product.barcodes_list %}
            <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Баркоды</h3>
                <ul class="space-y-2">
                    {% for barcode in product.barcodes_list %}
                    <li class="text-sm font-mono bg-gray-50 px-3 py-2 rounded border border-gray-200">
                        {{ barcode }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Метаданные -->
            <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Информация об импорте</h3>
                <dl class="space-y-3">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Источник</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ product.source_type }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Дата создания</dt>
                        <dd class="mt-1 text-sm text-gray-900">
                            {{ product.created_at.strftime('%d.%m.%Y %H:%M') if product.created_at else '—' }}
                        </dd>
                    </div>
                    {% if product.imported_at %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Дата импорта</dt>
                        <dd class="mt-1 text-sm text-gray-900">
                            {{ product.imported_at.strftime('%d.%m.%Y %H:%M') }}
                        </dd>
                    </div>
                    {% endif %}
                    {% if product.import_error %}
                    <div>
                        <dt class="text-sm font-medium text-red-500">Ошибка импорта</dt>
                        <dd class="mt-1 text-sm text-red-700">{{ product.import_error }}</dd>
                    </div>
                    {% endif %}
                </dl>
            </div>

            <!-- AI Оптимизация -->
            <div class="bg-gradient-to-br from-purple-50 to-indigo-50 shadow-sm rounded-lg border border-purple-200 p-6">
                <h3 class="text-lg font-medium text-purple-900 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    AI Оптимизация
                </h3>
                <div class="space-y-2">
                    <button id="aiRichContentBtn" class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-gradient-to-r from-pink-500 to-orange-500 hover:from-pink-600 hover:to-orange-600 disabled:opacity-50">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                        </svg>
                        Rich Контент
                    </button>
                    <button id="aiFullOptimizeBtn" class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 disabled:opacity-50">
                        Полная AI-оптимизация
                    </button>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="aiSeoTitleBtn" class="inline-flex justify-center items-center px-3 py-1.5 border border-purple-300 text-xs font-medium rounded-md text-purple-700 bg-white hover:bg-purple-50 disabled:opacity-50">
                            SEO заголовок
                        </button>
                        <button id="aiKeywordsBtn" class="inline-flex justify-center items-center px-3 py-1.5 border border-purple-300 text-xs font-medium rounded-md text-purple-700 bg-white hover:bg-purple-50 disabled:opacity-50">
                            Ключевые слова
                        </button>
                        <button id="aiBulletPointsBtn" class="inline-flex justify-center items-center px-3 py-1.5 border border-purple-300 text-xs font-medium rounded-md text-purple-700 bg-white hover:bg-purple-50 disabled:opacity-50">
                            Преимущества
                        </button>
                        <button id="aiAnalyzeBtn" class="inline-flex justify-center items-center px-3 py-1.5 border border-purple-300 text-xs font-medium rounded-md text-purple-700 bg-white hover:bg-purple-50 disabled:opacity-50">
                            Анализ карточки
                        </button>
                    </div>
                </div>
            </div>

            <!-- Сохраненные AI-результаты -->
            {% if product.ai_keywords or product.ai_bullets or product.ai_rich_content or product.ai_analysis %}
            <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">AI-контент</h3>
                    {% if product.ai_analysis_at %}
                    <span class="text-xs text-gray-500" id="aiAnalysisDate">
                        Обновлено: {{ product.ai_analysis_at.strftime('%d.%m.%Y %H:%M') }}
                    </span>
                    {% endif %}
                </div>

                <!-- Предупреждение об изменениях -->
                <div id="contentChangedWarning" class="hidden mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <div class="flex items-center text-yellow-800">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <span class="text-sm font-medium">Карточка была изменена. AI-анализ может быть неактуален.</span>
                    </div>
                </div>

                <div class="space-y-4">
                    <!-- SEO заголовок -->
                    {% if product.ai_seo_title %}
                    <div class="p-3 bg-blue-50 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-blue-900">SEO заголовок</span>
                            <button onclick="copyToClipboard('{{ product.ai_seo_title|e }}')" class="text-xs text-blue-600 hover:text-blue-800">Копировать</button>
                        </div>
                        <p class="text-sm text-blue-800">{{ product.ai_seo_title }}</p>
                    </div>
                    {% endif %}

                    <!-- Ключевые слова -->
                    {% if product.ai_keywords %}
                    <div class="p-3 bg-green-50 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-green-900">Ключевые слова</span>
                            <button onclick="toggleSection('keywordsSection')" class="text-xs text-green-600 hover:text-green-800">Показать/Скрыть</button>
                        </div>
                        <div id="keywordsSection" class="hidden">
                            <div class="flex flex-wrap gap-1" id="keywordsList">
                                <!-- Keywords will be populated by JS -->
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Преимущества (Bullets) -->
                    {% if product.ai_bullets %}
                    <div class="p-3 bg-purple-50 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-purple-900">Преимущества</span>
                            <button onclick="toggleSection('bulletsSection')" class="text-xs text-purple-600 hover:text-purple-800">Показать/Скрыть</button>
                        </div>
                        <div id="bulletsSection" class="hidden">
                            <ul class="list-disc list-inside text-sm text-purple-800 space-y-1" id="bulletsList">
                                <!-- Bullets will be populated by JS -->
                            </ul>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Rich контент -->
                    {% if product.ai_rich_content %}
                    <div class="p-3 bg-orange-50 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-orange-900">Rich-контент (блоки для WB)</span>
                            <button onclick="toggleSection('richSection')" class="text-xs text-orange-600 hover:text-orange-800">Показать/Скрыть</button>
                        </div>
                        <div id="richSection" class="hidden space-y-3" id="richBlocksList">
                            <!-- Rich blocks will be populated by JS -->
                        </div>
                    </div>
                    {% endif %}

                    <!-- Анализ карточки -->
                    {% if product.ai_analysis %}
                    <div class="p-3 bg-indigo-50 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-indigo-900">Анализ карточки</span>
                            <button onclick="toggleSection('analysisSection')" class="text-xs text-indigo-600 hover:text-indigo-800">Показать/Скрыть</button>
                        </div>
                        <div id="analysisSection">
                            <div id="analysisContent">
                                <!-- Analysis will be populated by JS -->
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <!-- Предложение сделать анализ -->
            <div class="bg-gray-50 shadow-sm rounded-lg border border-gray-200 p-6">
                <div class="text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">AI-контент не сгенерирован</h3>
                    <p class="mt-1 text-sm text-gray-500">Используйте кнопки выше для генерации SEO-контента, ключевых слов и Rich-контента</p>
                </div>
            </div>
            {% endif %}

            <!-- Действия -->
            <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Действия</h3>
                {% if product.import_status == 'validated' %}
                <button id="importSingleBtn" class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed mb-3">
                    Импортировать в WB
                </button>
                <p class="mb-3 text-xs text-gray-500 text-center">
                    Товар готов к импорту в Wildberries
                </p>
                {% endif %}
                <button id="deleteSingleBtn" class="w-full inline-flex justify-center items-center px-4 py-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50">
                    Удалить товар
                </button>
            </div>
        </div>
    </div>
</div>

<!-- AI Results Modal -->
<div id="aiResultsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-3xl shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 id="aiModalTitle" class="text-xl font-bold text-gray-900">AI Результаты</h3>
            <button id="closeAiModal" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div id="aiModalContent" class="max-h-96 overflow-y-auto">
            <!-- Content will be inserted here -->
        </div>
        <div id="aiModalActions" class="mt-4 flex gap-2 hidden">
            <button id="applyAiChanges" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                Применить изменения
            </button>
            <button id="cancelAiChanges" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Отмена
            </button>
        </div>
    </div>
</div>

<script>
// Helper functions
function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) {
        section.classList.toggle('hidden');
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('Скопировано в буфер обмена!');
    }).catch(err => {
        console.error('Ошибка копирования:', err);
    });
}

// Populate saved AI data
function populateSavedAIData() {
    // Keywords
    {% if product.ai_keywords %}
    try {
        const keywordsData = {{ product.ai_keywords|safe }};
        const keywordsList = document.getElementById('keywordsList');
        if (keywordsList && keywordsData.keywords) {
            keywordsList.innerHTML = keywordsData.keywords.map(kw =>
                `<span class="inline-block px-2 py-1 text-xs bg-green-100 text-green-800 rounded">${kw}</span>`
            ).join('');
        }
    } catch(e) { console.error('Keywords parse error:', e); }
    {% endif %}

    // Bullets
    {% if product.ai_bullets %}
    try {
        const bulletsData = {{ product.ai_bullets|safe }};
        const bulletsList = document.getElementById('bulletsList');
        if (bulletsList && bulletsData.bullet_points) {
            bulletsList.innerHTML = bulletsData.bullet_points.map(bp =>
                `<li>${bp}</li>`
            ).join('');
        }
    } catch(e) { console.error('Bullets parse error:', e); }
    {% endif %}

    // Rich content
    {% if product.ai_rich_content %}
    try {
        const richData = {{ product.ai_rich_content|safe }};
        const richSection = document.getElementById('richSection');
        // Support both old format (blocks) and new format (slides)
        const slides = richData.slides || richData.blocks || [];
        if (richSection && slides.length > 0) {
            let html = '';

            // Design recommendations if available
            if (richData.design_recommendations) {
                const dr = richData.design_recommendations;
                html += `<div class="mb-4 p-3 bg-gradient-to-r from-orange-100 to-pink-100 rounded-lg">
                    <p class="text-xs font-bold text-orange-800 mb-2">Рекомендации по дизайну:</p>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        ${dr.color_palette ? `<div><span class="text-gray-600">Палитра:</span> <span class="font-mono">${dr.color_palette.join(', ')}</span></div>` : ''}
                        ${dr.font_style ? `<div><span class="text-gray-600">Стиль:</span> ${dr.font_style}</div>` : ''}
                        ${dr.overall_mood ? `<div class="col-span-2"><span class="text-gray-600">Настроение:</span> ${dr.overall_mood}</div>` : ''}
                    </div>
                </div>`;
            }

            // Slides/blocks
            html += slides.map((slide, i) => {
                const imgConcept = slide.image_concept || {};
                const textLayout = slide.text_layout || {};
                const bullets = slide.bullets ? `<ul class="mt-1 text-xs text-gray-600 list-disc list-inside">${slide.bullets.map(b => `<li>${b}</li>`).join('')}</ul>` : '';

                return `<div class="p-3 bg-white rounded-lg border border-orange-200 shadow-sm">
                    <div class="flex items-center justify-between mb-2">
                        <span class="px-2 py-1 text-xs font-bold text-white bg-gradient-to-r from-orange-500 to-pink-500 rounded">
                            Слайд ${slide.number || i+1}: ${slide.type || ''}
                        </span>
                        <span class="text-xs text-gray-400">1440x810px</span>
                    </div>
                    <p class="text-sm font-bold text-gray-900 uppercase">${slide.title}</p>
                    ${slide.subtitle ? `<p class="text-xs text-gray-700 mt-1">${slide.subtitle}</p>` : ''}
                    ${bullets}
                    ${imgConcept.main_object ? `
                    <div class="mt-2 p-2 bg-gray-50 rounded text-xs">
                        <p class="font-medium text-gray-700 mb-1">Концепция изображения:</p>
                        <p class="text-gray-600"><span class="font-medium">Объект:</span> ${imgConcept.main_object}</p>
                        ${imgConcept.background ? `<p class="text-gray-600"><span class="font-medium">Фон:</span> ${imgConcept.background}</p>` : ''}
                        ${imgConcept.composition ? `<p class="text-gray-600"><span class="font-medium">Композиция:</span> ${imgConcept.composition}</p>` : ''}
                        ${imgConcept.mood ? `<p class="text-gray-600"><span class="font-medium">Настроение:</span> ${imgConcept.mood}</p>` : ''}
                    </div>` : ''}
                    ${textLayout.title_position ? `
                    <div class="mt-2 p-2 bg-blue-50 rounded text-xs">
                        <p class="font-medium text-blue-700 mb-1">Расположение текста:</p>
                        <p class="text-blue-600"><span class="font-medium">Заголовок:</span> ${textLayout.title_position} | ${textLayout.title_color || ''}</p>
                        ${textLayout.text_background ? `<p class="text-blue-600"><span class="font-medium">Подложка:</span> ${textLayout.text_background}</p>` : ''}
                    </div>` : ''}
                    ${slide.image_idea ? `<p class="text-xs text-gray-400 mt-2 italic">Идея: ${slide.image_idea}</p>` : ''}
                </div>`;
            }).join('');

            // Main USP and target audience
            if (richData.main_usp || richData.main_message) {
                html += `<div class="mt-3 p-3 bg-orange-50 rounded-lg">
                    <p class="text-sm text-orange-800"><strong>УТП:</strong> ${richData.main_usp || richData.main_message}</p>
                    ${richData.target_audience ? `<p class="text-xs text-orange-600 mt-1"><strong>Целевая аудитория:</strong> ${richData.target_audience}</p>` : ''}
                </div>`;
            }

            richSection.innerHTML = html;
        }
    } catch(e) { console.error('Rich content parse error:', e); }
    {% endif %}

    // Analysis
    {% if product.ai_analysis %}
    try {
        const analysisData = {{ product.ai_analysis|safe }};
        const analysisContent = document.getElementById('analysisContent');
        if (analysisContent) {
            let html = '';
            if (analysisData.score !== undefined) {
                const scoreColor = analysisData.score >= 80 ? 'green' : analysisData.score >= 60 ? 'yellow' : 'red';
                html += `<div class="mb-3"><span class="text-2xl font-bold text-${scoreColor}-600">${analysisData.score}</span><span class="text-sm text-gray-500">/100</span></div>`;
            }
            if (analysisData.issues && analysisData.issues.length > 0) {
                html += '<div class="mb-2"><span class="text-sm font-medium">Проблемы:</span><ul class="list-disc list-inside text-xs text-gray-700 mt-1">';
                analysisData.issues.forEach(issue => {
                    const color = issue.priority === 'high' ? 'red' : issue.priority === 'medium' ? 'yellow' : 'gray';
                    html += `<li><span class="text-${color}-600">[${issue.priority}]</span> ${issue.issue}</li>`;
                });
                html += '</ul></div>';
            }
            if (analysisData.recommendations && analysisData.recommendations.length > 0) {
                html += '<div><span class="text-sm font-medium">Рекомендации:</span><ul class="list-disc list-inside text-xs text-gray-700 mt-1">';
                analysisData.recommendations.forEach(rec => {
                    html += `<li>${rec}</li>`;
                });
                html += '</ul></div>';
            }
            analysisContent.innerHTML = html;
        }
    } catch(e) { console.error('Analysis parse error:', e); }
    {% endif %}

    // Check content hash for changes
    {% if product.content_hash %}
    const currentHash = computeContentHash();
    const savedHash = '{{ product.content_hash }}';
    if (currentHash !== savedHash) {
        const warning = document.getElementById('contentChangedWarning');
        if (warning) warning.classList.remove('hidden');
    }
    {% endif %}
}

function computeContentHash() {
    // Simple hash based on title and description
    const content = '{{ (product.title or "")|e }}' + '{{ (product.description or "")|e }}';
    let hash = 0;
    for (let i = 0; i < content.length; i++) {
        const char = content.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return hash.toString(16);
}

document.addEventListener('DOMContentLoaded', function() {
    // Populate saved AI data
    populateSavedAIData();

    const importBtn = document.getElementById('importSingleBtn');
    const deleteBtn = document.getElementById('deleteSingleBtn');

    if (importBtn) {
        importBtn.addEventListener('click', function() {
            if (!confirm('Импортировать этот товар в Wildberries?')) {
                return;
            }

            // Disable button during import
            importBtn.disabled = true;
            importBtn.textContent = 'Импортирую...';

            // Send request
            fetch('{{ url_for("auto_import_single_to_wb", product_id=product.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Товар успешно импортирован в Wildberries!');
                    window.location.href = '{{ url_for("auto_import_products") }}';
                } else {
                    alert('Ошибка импорта: ' + (data.error || 'Неизвестная ошибка'));
                    importBtn.disabled = false;
                    importBtn.textContent = 'Импортировать в WB';
                }
            })
            .catch(error => {
                alert('Ошибка при выполнении запроса: ' + error);
                importBtn.disabled = false;
                importBtn.textContent = 'Импортировать в WB';
            });
        });
    }

    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            if (!confirm('Удалить этот товар?\n\nЭто действие нельзя отменить!')) {
                return;
            }

            // Disable button during deletion
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'Удаление...';

            // Send request
            fetch('{{ url_for("auto_import_delete_product", product_id=product.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Товар удален');
                    window.location.href = '{{ url_for("auto_import_products") }}';
                } else {
                    alert('Ошибка удаления: ' + (data.error || 'Неизвестная ошибка'));
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = 'Удалить товар';
                }
            })
            .catch(error => {
                alert('Ошибка при выполнении запроса: ' + error);
                deleteBtn.disabled = false;
                deleteBtn.textContent = 'Удалить товар';
            });
        });
    }

    // Category editing functionality
    const editCategoryBtn = document.getElementById('editCategoryBtn');
    const confirmCategoryBtn = document.getElementById('confirmCategoryBtn');
    const categoryDisplay = document.getElementById('categoryDisplay');
    const categoryEditor = document.getElementById('categoryEditor');
    const categorySelect = document.getElementById('categorySelect');
    const saveCategoryBtn = document.getElementById('saveCategoryBtn');
    const cancelCategoryBtn = document.getElementById('cancelCategoryBtn');

    // WB adult categories from mapping
    const wbCategories = {{ wb_categories|tojson }};

    // Populate select with categories
    if (categorySelect && wbCategories) {
        // Sort categories by name
        const sortedCategories = Object.entries(wbCategories).sort((a, b) => a[1].localeCompare(b[1]));

        sortedCategories.forEach(([id, name]) => {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = `${name} (ID: ${id})`;
            if (parseInt(id) === {{ product.wb_subject_id or 'null' }}) {
                option.selected = true;
            }
            categorySelect.appendChild(option);
        });
    }

    if (editCategoryBtn) {
        editCategoryBtn.addEventListener('click', function() {
            categoryDisplay.classList.add('hidden');
            categoryEditor.classList.remove('hidden');
        });
    }

    if (cancelCategoryBtn) {
        cancelCategoryBtn.addEventListener('click', function() {
            categoryEditor.classList.add('hidden');
            categoryDisplay.classList.remove('hidden');
        });
    }

    // Confirm category button - confirms current category without changing it
    if (confirmCategoryBtn) {
        confirmCategoryBtn.addEventListener('click', function() {
            if (!confirm('Подтвердить текущую категорию "{{ product.mapped_wb_category }}"?')) {
                return;
            }

            confirmCategoryBtn.disabled = true;
            const originalText = confirmCategoryBtn.textContent;
            confirmCategoryBtn.textContent = 'Подтверждение...';

            fetch('{{ url_for("auto_import_correct_category", product_id=product.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    wb_subject_id: {{ product.wb_subject_id or 'null' }}
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Категория подтверждена! Уверенность установлена в 100%');
                    window.location.reload();
                } else {
                    alert('Ошибка подтверждения: ' + (data.error || 'Неизвестная ошибка'));
                    confirmCategoryBtn.disabled = false;
                    confirmCategoryBtn.textContent = originalText;
                }
            })
            .catch(error => {
                alert('Ошибка при выполнении запроса: ' + error);
                confirmCategoryBtn.disabled = false;
                confirmCategoryBtn.textContent = originalText;
            });
        });
    }

    if (saveCategoryBtn) {
        saveCategoryBtn.addEventListener('click', function() {
            const selectedCategoryId = categorySelect.value;

            if (!selectedCategoryId) {
                alert('Пожалуйста, выберите категорию');
                return;
            }

            saveCategoryBtn.disabled = true;
            saveCategoryBtn.textContent = 'Сохранение...';

            fetch('{{ url_for("auto_import_correct_category", product_id=product.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    wb_subject_id: parseInt(selectedCategoryId)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Категория успешно обновлена!');
                    window.location.reload();
                } else {
                    alert('Ошибка обновления: ' + (data.error || 'Неизвестная ошибка'));
                    saveCategoryBtn.disabled = false;
                    saveCategoryBtn.textContent = 'Сохранить';
                }
            })
            .catch(error => {
                alert('Ошибка при выполнении запроса: ' + error);
                saveCategoryBtn.disabled = false;
                saveCategoryBtn.textContent = 'Сохранить';
            });
        });
    }

    // Photo censorship toggle
    const toggleCensorship = document.getElementById('toggleCensorship');
    const togglePadding = document.getElementById('togglePadding');

    function updatePhotoUrls() {
        const photos = document.querySelectorAll('.product-photo');
        const useCensorship = toggleCensorship ? toggleCensorship.checked : false;
        const usePadding = togglePadding ? togglePadding.checked : true;

        photos.forEach(photo => {
            const blurUrl = photo.dataset.blur;
            const sexoptovikUrl = photo.dataset.sexoptovik;

            // Определяем базовый URL в зависимости от цензуры
            let baseUrl;
            if (useCensorship) {
                // С цензурой: пытаемся blur, если нет - sexoptovik
                baseUrl = blurUrl || sexoptovikUrl;
            } else {
                // Без цензуры: всегда sexoptovik (x-story original недоступен)
                baseUrl = sexoptovikUrl;
            }

            // Применяем padding если нужно
            if (usePadding && baseUrl) {
                // Используем endpoint для получения padded версии
                photo.src = `/auto-import/photo/padded?url=${encodeURIComponent(baseUrl)}`;
            } else {
                photo.src = baseUrl;
            }

            // Добавляем анимацию смены
            photo.style.opacity = '0.5';
            setTimeout(() => {
                photo.style.opacity = '1';
            }, 150);
        });
    }

    if (toggleCensorship) {
        toggleCensorship.addEventListener('change', updatePhotoUrls);
    }

    if (togglePadding) {
        togglePadding.addEventListener('change', updatePhotoUrls);
    }

    // Fix errors form functionality
    const showFixFormBtn = document.getElementById('showFixFormBtn');
    const fixForm = document.getElementById('fixForm');
    const cancelFixBtn = document.getElementById('cancelFixBtn');
    const fixErrorsForm = document.getElementById('fixErrorsForm');
    const fixCategorySelect = document.getElementById('fix_category');

    // Populate category select for fix form
    if (fixCategorySelect && wbCategories) {
        const sortedCategories = Object.entries(wbCategories).sort((a, b) => a[1].localeCompare(b[1]));
        sortedCategories.forEach(([id, name]) => {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = `${name} (ID: ${id})`;
            fixCategorySelect.appendChild(option);
        });
    }

    if (showFixFormBtn && fixForm) {
        showFixFormBtn.addEventListener('click', function() {
            fixForm.classList.remove('hidden');
            showFixFormBtn.classList.add('hidden');
        });
    }

    if (cancelFixBtn && fixForm && showFixFormBtn) {
        cancelFixBtn.addEventListener('click', function() {
            fixForm.classList.add('hidden');
            showFixFormBtn.classList.remove('hidden');
        });
    }

    if (fixErrorsForm) {
        fixErrorsForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(fixErrorsForm);
            const data = {};

            // Собираем данные из формы
            for (let [key, value] of formData.entries()) {
                if (value.trim()) {
                    data[key] = value.trim();
                }
            }

            // Обрабатываем баркоды
            if (data.barcodes) {
                data.barcodes = data.barcodes.split(',').map(b => b.trim()).filter(b => b);
            }

            // Преобразуем wb_subject_id в число
            if (data.wb_subject_id) {
                data.wb_subject_id = parseInt(data.wb_subject_id);
            }

            const saveBtn = document.getElementById('saveFixBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Сохранение...';

            fetch('{{ url_for("auto_import_update_product", product_id=product.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Данные сохранены и товар повторно проверен!');
                    window.location.reload();
                } else {
                    alert('Ошибка: ' + (result.error || 'Неизвестная ошибка'));
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Сохранить и проверить';
                }
            })
            .catch(error => {
                alert('Ошибка запроса: ' + error);
                saveBtn.disabled = false;
                saveBtn.textContent = 'Сохранить и проверить';
            });
        });
    }
});

// Lazy loading для фото
document.addEventListener('DOMContentLoaded', function() {
    const lazyPhotos = document.querySelectorAll('.lazy-photo');

    if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src) {
                        img.src = img.dataset.src;
                        img.classList.remove('lazy-photo');
                        observer.unobserve(img);
                    }
                }
            });
        }, { rootMargin: '50px' });

        lazyPhotos.forEach(img => observer.observe(img));
    } else {
        // Fallback для старых браузеров
        lazyPhotos.forEach(img => {
            if (img.dataset.src) {
                img.src = img.dataset.src;
            }
        });
    }
});

// AI Optimization Functions
(function() {
    console.log('AI Optimization script starting...');
    const productId = {{ product.id }};
    console.log('Product ID:', productId);
    const modal = document.getElementById('aiResultsModal');
    const modalTitle = document.getElementById('aiModalTitle');
    const modalContent = document.getElementById('aiModalContent');
    const modalActions = document.getElementById('aiModalActions');
    const closeModalBtn = document.getElementById('closeAiModal');
    const applyBtn = document.getElementById('applyAiChanges');
    const cancelBtn = document.getElementById('cancelAiChanges');

    let currentAiData = null;

    function showModal(title, content, showActions = false) {
        modalTitle.textContent = title;
        modalContent.innerHTML = content;
        modalActions.classList.toggle('hidden', !showActions);
        modal.classList.remove('hidden');
    }

    function hideModal() {
        modal.classList.add('hidden');
        currentAiData = null;
    }

    function showLoading(btn, text = 'Загрузка...') {
        btn.disabled = true;
        btn.dataset.originalText = btn.textContent;
        btn.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>${text}`;
    }

    function hideLoading(btn) {
        btn.disabled = false;
        btn.textContent = btn.dataset.originalText || btn.textContent;
    }

    async function callAiEndpoint(endpoint, btn) {
        showLoading(btn);
        try {
            console.log('Calling AI endpoint:', endpoint, 'with product_id:', productId);
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_id: productId })
            });
            const result = await response.json();
            console.log('AI endpoint response:', result);
            return result;
        } catch (error) {
            console.error('AI endpoint error:', error);
            alert('Ошибка запроса: ' + error.message);
            return { success: false, error: error.message };
        } finally {
            hideLoading(btn);
        }
    }

    console.log('AI buttons initializing for product:', productId);

    // SEO Title
    document.getElementById('aiSeoTitleBtn')?.addEventListener('click', async function() {
        console.log('SEO Title button clicked');
        const result = await callAiEndpoint('/auto-import/ai/seo-title', this);
        if (result.success) {
            currentAiData = { title: result.data.title };
            const content = `
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-medium text-gray-700 mb-2">Текущий заголовок:</h4>
                        <p class="text-gray-600">${result.original_title || '—'}</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-medium text-green-700 mb-2">SEO-оптимизированный заголовок:</h4>
                        <p class="text-green-800 font-medium">${result.data.title}</p>
                    </div>
                    ${result.data.keywords_used?.length ? `
                    <div>
                        <h4 class="font-medium text-gray-700 mb-2">Использованные ключевые слова:</h4>
                        <div class="flex flex-wrap gap-1">
                            ${result.data.keywords_used.map(k => `<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">${k}</span>`).join('')}
                        </div>
                    </div>` : ''}
                    ${result.data.improvements?.length ? `
                    <div>
                        <h4 class="font-medium text-gray-700 mb-2">Улучшения:</h4>
                        <ul class="list-disc list-inside text-sm text-gray-600">
                            ${result.data.improvements.map(i => `<li>${i}</li>`).join('')}
                        </ul>
                    </div>` : ''}
                </div>
            `;
            showModal('SEO-оптимизация заголовка', content, true);
        } else {
            showModal('Ошибка', `<p class="text-red-600">${result.error}</p>`);
        }
    });

    // Keywords
    document.getElementById('aiKeywordsBtn')?.addEventListener('click', async function() {
        console.log('Keywords button clicked');
        const result = await callAiEndpoint('/auto-import/ai/keywords', this);
        if (result.success) {
            currentAiData = { keywords: result.data.keywords };
            const content = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-medium text-gray-700 mb-2">Ключевые слова (${result.data.keywords?.length || 0}):</h4>
                        <div class="flex flex-wrap gap-1 max-h-40 overflow-y-auto">
                            ${(result.data.keywords || []).map(k => `<span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full">${k}</span>`).join('')}
                        </div>
                    </div>
                    ${result.data.search_queries?.length ? `
                    <div>
                        <h4 class="font-medium text-gray-700 mb-2">Популярные поисковые запросы:</h4>
                        <ul class="list-disc list-inside text-sm text-gray-600">
                            ${result.data.search_queries.map(q => `<li>${q}</li>`).join('')}
                        </ul>
                    </div>` : ''}
                </div>
            `;
            showModal('Ключевые слова', content, true);
        } else {
            showModal('Ошибка', `<p class="text-red-600">${result.error}</p>`);
        }
    });

    // Bullet Points
    document.getElementById('aiBulletPointsBtn')?.addEventListener('click', async function() {
        const result = await callAiEndpoint('/auto-import/ai/bullet-points', this);
        if (result.success) {
            currentAiData = { bullet_points: result.data.bullet_points };
            const content = `
                <div class="space-y-4">
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-medium text-green-700 mb-2">Преимущества товара:</h4>
                        <ul class="space-y-2">
                            ${(result.data.bullet_points || []).map(bp => `<li class="flex items-start"><span class="text-green-600 mr-2">✓</span><span>${bp.replace(/^[✓✔] ?/, '')}</span></li>`).join('')}
                        </ul>
                    </div>
                    ${result.data.target_audience ? `
                    <div>
                        <h4 class="font-medium text-gray-700 mb-2">Целевая аудитория:</h4>
                        <p class="text-gray-600">${result.data.target_audience}</p>
                    </div>` : ''}
                </div>
            `;
            showModal('Преимущества товара', content, true);
        } else {
            showModal('Ошибка', `<p class="text-red-600">${result.error}</p>`);
        }
    });

    // Card Analysis
    document.getElementById('aiAnalyzeBtn')?.addEventListener('click', async function() {
        const result = await callAiEndpoint('/auto-import/ai/analyze', this);
        if (result.success) {
            const score = result.data.score || 0;
            const scoreColor = score >= 80 ? 'green' : score >= 60 ? 'yellow' : 'red';
            const content = `
                <div class="space-y-4">
                    <div class="text-center">
                        <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-${scoreColor}-100 text-${scoreColor}-800 text-2xl font-bold">
                            ${score}
                        </div>
                        <p class="mt-2 text-sm text-gray-600">Оценка карточки</p>
                    </div>
                    ${result.data.issues?.length ? `
                    <div>
                        <h4 class="font-medium text-red-700 mb-2">Проблемы:</h4>
                        <ul class="space-y-2">
                            ${result.data.issues.map(issue => `
                                <li class="bg-red-50 p-2 rounded">
                                    <span class="inline-block px-1.5 py-0.5 text-xs rounded ${issue.priority === 'high' ? 'bg-red-200 text-red-800' : issue.priority === 'medium' ? 'bg-yellow-200 text-yellow-800' : 'bg-gray-200 text-gray-800'}">${issue.priority}</span>
                                    <span class="ml-2 font-medium">${issue.issue}</span>
                                    <p class="text-sm text-gray-600 mt-1">Решение: ${issue.fix}</p>
                                </li>
                            `).join('')}
                        </ul>
                    </div>` : ''}
                    ${result.data.recommendations?.length ? `
                    <div>
                        <h4 class="font-medium text-blue-700 mb-2">Рекомендации:</h4>
                        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                            ${result.data.recommendations.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>` : ''}
                    ${result.data.strengths?.length ? `
                    <div>
                        <h4 class="font-medium text-green-700 mb-2">Сильные стороны:</h4>
                        <ul class="list-disc list-inside text-sm text-green-600 space-y-1">
                            ${result.data.strengths.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>` : ''}
                </div>
            `;
            showModal('Анализ карточки', content, false);
        } else {
            showModal('Ошибка', `<p class="text-red-600">${result.error}</p>`);
        }
    });

    // Rich Content
    document.getElementById('aiRichContentBtn')?.addEventListener('click', async function() {
        console.log('Rich Content button clicked');
        const result = await callAiEndpoint('/auto-import/ai/rich-content', this);
        if (result.success) {
            currentAiData = { rich_content: result.data };
            const data = result.data;

            let content = '<div class="space-y-4">';

            // Header with specs
            content += `
                <div class="bg-gradient-to-r from-orange-500 to-pink-500 text-white p-4 rounded-lg">
                    <h4 class="font-bold text-lg">Rich-контент для Wildberries</h4>
                    <p class="text-sm opacity-90">Макеты слайдов инфографики 1440x810px</p>
                    ${data.total_slides ? `<p class="text-xs mt-1">Всего слайдов: ${data.total_slides}</p>` : ''}
                </div>
            `;

            // Design recommendations
            if (data.design_recommendations) {
                const dr = data.design_recommendations;
                content += `
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <h4 class="font-bold text-purple-800 mb-2">Рекомендации по дизайну</h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            ${dr.color_palette ? `
                                <div>
                                    <span class="text-gray-600">Палитра:</span>
                                    <div class="flex gap-1 mt-1">
                                        ${dr.color_palette.map(c => `<span class="inline-block w-6 h-6 rounded border" style="background:${c}" title="${c}"></span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            ${dr.font_style ? `<div><span class="text-gray-600">Стиль шрифта:</span> <span class="font-medium">${dr.font_style}</span></div>` : ''}
                            ${dr.overall_mood ? `<div class="col-span-2"><span class="text-gray-600">Настроение:</span> <span class="font-medium">${dr.overall_mood}</span></div>` : ''}
                            ${dr.key_visual_elements?.length ? `<div class="col-span-2"><span class="text-gray-600">Ключевые элементы:</span> ${dr.key_visual_elements.join(', ')}</div>` : ''}
                        </div>
                    </div>
                `;
            }

            // Slides (new format) or blocks (old format)
            const slides = data.slides || data.blocks || [];
            if (slides.length > 0) {
                content += `<div class="space-y-3">`;
                slides.forEach((slide, i) => {
                    const imgConcept = slide.image_concept || {};
                    const textLayout = slide.text_layout || {};
                    const bullets = slide.bullets && slide.bullets.length > 0 ? slide.bullets : null;

                    content += `
                        <div class="bg-white border-2 border-orange-200 rounded-lg overflow-hidden">
                            <div class="bg-gradient-to-r from-orange-500 to-pink-500 text-white px-4 py-2 flex justify-between items-center">
                                <span class="font-bold">Слайд ${slide.number || i+1}: ${slide.type || ''}</span>
                                <span class="text-xs opacity-75">1440x810px</span>
                            </div>
                            <div class="p-4">
                                <p class="text-lg font-bold text-gray-900 uppercase">${slide.title}</p>
                                ${slide.subtitle ? `<p class="text-gray-700 mt-1">${slide.subtitle}</p>` : ''}
                                ${bullets ? `
                                    <ul class="mt-2 space-y-1 text-sm text-gray-600">
                                        ${bullets.map(b => `<li class="flex items-start"><span class="mr-2 text-orange-500">•</span>${b}</li>`).join('')}
                                    </ul>
                                ` : ''}

                                ${imgConcept.main_object ? `
                                    <div class="mt-3 p-3 bg-gray-50 rounded-lg">
                                        <p class="text-xs font-bold text-gray-700 mb-2">КОНЦЕПЦИЯ ИЗОБРАЖЕНИЯ:</p>
                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                            <div><span class="text-gray-500">Объект:</span> <span class="text-gray-800">${imgConcept.main_object}</span></div>
                                            ${imgConcept.background ? `<div><span class="text-gray-500">Фон:</span> <span class="text-gray-800">${imgConcept.background}</span></div>` : ''}
                                            ${imgConcept.composition ? `<div><span class="text-gray-500">Композиция:</span> <span class="text-gray-800">${imgConcept.composition}</span></div>` : ''}
                                            ${imgConcept.mood ? `<div><span class="text-gray-500">Настроение:</span> <span class="text-gray-800">${imgConcept.mood}</span></div>` : ''}
                                        </div>
                                    </div>
                                ` : ''}

                                ${textLayout.title_position ? `
                                    <div class="mt-2 p-3 bg-blue-50 rounded-lg">
                                        <p class="text-xs font-bold text-blue-700 mb-2">РАСПОЛОЖЕНИЕ ТЕКСТА:</p>
                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                            <div><span class="text-blue-600">Позиция:</span> <span class="text-blue-800">${textLayout.title_position}</span></div>
                                            ${textLayout.title_color ? `<div><span class="text-blue-600">Цвет:</span> <span class="text-blue-800">${textLayout.title_color}</span></div>` : ''}
                                            ${textLayout.text_background ? `<div class="col-span-2"><span class="text-blue-600">Подложка:</span> <span class="text-blue-800">${textLayout.text_background}</span></div>` : ''}
                                        </div>
                                    </div>
                                ` : ''}

                                ${slide.image_idea ? `<p class="mt-2 text-xs text-gray-400 italic">Идея: ${slide.image_idea}</p>` : ''}
                            </div>
                        </div>
                    `;
                });
                content += `</div>`;
            }

            // USP and target audience
            if (data.main_usp || data.main_message || data.target_audience) {
                content += `
                    <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                        ${data.main_usp || data.main_message ? `<p class="font-medium text-orange-800"><span class="font-bold">УТП:</span> ${data.main_usp || data.main_message}</p>` : ''}
                        ${data.target_audience ? `<p class="text-sm text-orange-700 mt-1"><span class="font-bold">Целевая аудитория:</span> ${data.target_audience}</p>` : ''}
                    </div>
                `;
            }

            content += '</div>';
            showModal('Rich Контент для WB', content, false);
        } else {
            showModal('Ошибка', `<p class="text-red-600">${result.error}</p>`);
        }
    });

    // Full Optimize
    document.getElementById('aiFullOptimizeBtn')?.addEventListener('click', async function() {
        const result = await callAiEndpoint('/auto-import/ai/full-optimize', this);
        if (result.success) {
            const data = result.data;
            currentAiData = {
                title: data.seo_title?.title,
                keywords: data.keywords?.keywords,
                bullet_points: data.bullet_points?.bullet_points,
                description: data.enhanced_description?.description
            };

            let content = '<div class="space-y-4">';

            // Score
            if (data.analysis) {
                const score = data.analysis.score || 0;
                content += `
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <div class="text-3xl font-bold ${score >= 80 ? 'text-green-600' : score >= 60 ? 'text-yellow-600' : 'text-red-600'}">${score}/100</div>
                        <p class="text-sm text-gray-600">Оценка карточки</p>
                    </div>
                `;
            }

            // SEO Title
            if (data.seo_title?.title) {
                content += `
                    <div class="bg-green-50 p-3 rounded-lg">
                        <h4 class="font-medium text-green-700 text-sm mb-1">SEO заголовок:</h4>
                        <p class="text-green-800">${data.seo_title.title}</p>
                    </div>
                `;
            }

            // Keywords
            if (data.keywords?.keywords?.length) {
                content += `
                    <div>
                        <h4 class="font-medium text-gray-700 text-sm mb-1">Ключевые слова:</h4>
                        <div class="flex flex-wrap gap-1 max-h-24 overflow-y-auto">
                            ${data.keywords.keywords.slice(0, 20).map(k => `<span class="px-2 py-0.5 bg-purple-100 text-purple-800 text-xs rounded-full">${k}</span>`).join('')}
                            ${data.keywords.keywords.length > 20 ? `<span class="px-2 py-0.5 text-gray-500 text-xs">+${data.keywords.keywords.length - 20} еще</span>` : ''}
                        </div>
                    </div>
                `;
            }

            // Bullet points
            if (data.bullet_points?.bullet_points?.length) {
                content += `
                    <div>
                        <h4 class="font-medium text-gray-700 text-sm mb-1">Преимущества:</h4>
                        <ul class="text-sm text-gray-600 space-y-1">
                            ${data.bullet_points.bullet_points.map(bp => `<li class="flex items-start"><span class="text-green-600 mr-1">✓</span>${bp.replace(/^[✓✔] ?/, '')}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Issues
            if (data.analysis?.issues?.length) {
                content += `
                    <div>
                        <h4 class="font-medium text-red-700 text-sm mb-1">Проблемы:</h4>
                        <ul class="text-sm space-y-1">
                            ${data.analysis.issues.slice(0, 3).map(i => `<li class="text-red-600">• ${i.issue}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Errors
            if (data.errors?.length) {
                content += `
                    <div class="bg-yellow-50 p-3 rounded-lg">
                        <h4 class="font-medium text-yellow-700 text-sm mb-1">Предупреждения:</h4>
                        <ul class="text-xs text-yellow-600">
                            ${data.errors.map(e => `<li>• ${e}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            content += '</div>';
            showModal('Полная AI-оптимизация', content, true);
        } else {
            showModal('Ошибка', `<p class="text-red-600">${result.error}</p>`);
        }
    });

    // Apply changes
    applyBtn?.addEventListener('click', async function() {
        if (!currentAiData) return;

        showLoading(applyBtn, 'Применение...');
        try {
            const response = await fetch('/auto-import/ai/apply', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    product_id: productId,
                    updates: currentAiData
                })
            });
            const result = await response.json();
            if (result.success) {
                alert(result.message || 'Изменения применены!');
                window.location.reload();
            } else {
                alert('Ошибка: ' + result.error);
            }
        } finally {
            hideLoading(applyBtn);
        }
    });

    // Close modal handlers
    closeModalBtn?.addEventListener('click', hideModal);
    cancelBtn?.addEventListener('click', hideModal);
    modal?.addEventListener('click', function(e) {
        if (e.target === modal) hideModal();
    });
})();
</script>
{% endblock %}
