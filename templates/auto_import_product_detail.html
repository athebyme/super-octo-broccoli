{% extends "base.html" %}

{% block title %}{{ product.title }} - –ê–≤—Ç–æ–∏–º–ø–æ—Ä—Ç - WB Seller Platform{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="mb-4">
        <a href="{{ url_for('auto_import_products') }}" class="text-indigo-600 hover:text-indigo-900 text-sm">
            ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É —Ç–æ–≤–∞—Ä–æ–≤
        </a>
    </div>

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">{{ product.title }}</h1>
                <p class="mt-2 text-sm text-gray-600">
                    ID: {{ product.external_id }}
                </p>
            </div>
            <div>
                {% if product.import_status == 'imported' %}
                <span class="px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800">
                    ‚úì –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ
                </span>
                {% elif product.import_status == 'validated' %}
                <span class="px-3 py-1 text-sm font-semibold rounded-full bg-blue-100 text-blue-800">
                    –ì–æ—Ç–æ–≤–æ –∫ –∏–º–ø–æ—Ä—Ç—É
                </span>
                {% elif product.import_status == 'failed' %}
                <span class="px-3 py-1 text-sm font-semibold rounded-full bg-red-100 text-red-800">
                    ‚úó –û—à–∏–±–∫–∞
                </span>
                {% else %}
                <span class="px-3 py-1 text-sm font-semibold rounded-full bg-gray-100 text-gray-800">
                    {{ product.import_status }}
                </span>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="lg:col-span-2 space-y-6">
            <!-- –ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ -->
            <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                <dl class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–ê—Ä—Ç–∏–∫—É–ª –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ product.external_vendor_code or '‚Äî' }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–ë—Ä–µ–Ω–¥</dt>
                        <dd class="mt-1">
                            <div id="brandDisplay" class="flex items-center justify-between">
                                <span id="brandValue" class="text-sm text-gray-900">{{ product.brand or '‚Äî' }}</span>
                                <div class="flex items-center gap-3">
                                    <button type="button" id="validateBrandBtn" class="text-sm text-blue-600 hover:text-blue-900 font-medium" title="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ WB">
                                        üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                                    </button>
                                    <button type="button" id="editBrandBtn" class="text-sm text-indigo-600 hover:text-indigo-900 font-medium">
                                        –ò–∑–º–µ–Ω–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                            <div id="brandEditor" class="hidden mt-2">
                                <div class="flex gap-2">
                                    <input type="text" id="brandInput"
                                           value="{{ product.brand or '' }}"
                                           class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                                           placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞">
                                    <button type="button" id="searchBrandBtn" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                        üîç
                                    </button>
                                </div>
                                <div id="brandSuggestions" class="hidden mt-2 border border-gray-200 rounded-md max-h-40 overflow-y-auto bg-white shadow-sm"></div>
                                <div id="brandValidation" class="hidden mt-2 text-sm"></div>
                                <div class="mt-2 flex gap-2">
                                    <button type="button" id="saveBrandBtn" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                    </button>
                                    <button type="button" id="cancelBrandBtn" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                        –û—Ç–º–µ–Ω–∞
                                    </button>
                                </div>
                            </div>
                        </dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–°—Ç—Ä–∞–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ product.country or '‚Äî' }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–ü–æ–ª</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ product.gender or '‚Äî' }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ product.category or '‚Äî' }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–ö–∞—Ç–µ–≥–æ—Ä–∏—è WB</dt>
                        <dd class="mt-1">
                            <div id="categoryDisplay" class="flex items-center justify-between">
                                <div>
                                    <span class="text-sm text-gray-900">{{ product.mapped_wb_category or '‚Äî' }}</span>
                                    {% if product.wb_subject_id %}
                                    <span class="text-xs text-gray-500 ml-1">(ID: {{ product.wb_subject_id }})</span>
                                    {% endif %}
                                    {% if product.category_confidence %}
                                    <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                                        {% if product.category_confidence >= 0.9 %}bg-green-100 text-green-800
                                        {% elif product.category_confidence >= 0.7 %}bg-yellow-100 text-yellow-800
                                        {% else %}bg-red-100 text-red-800{% endif %}">
                                        {{ (product.category_confidence * 100)|round|int }}% —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="flex items-center gap-3">
                                    {% if product.category_confidence and product.category_confidence < 1.0 %}
                                    <button type="button" id="confirmCategoryBtn" class="text-sm text-green-600 hover:text-green-900 font-medium">
                                        ‚úì –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                                    </button>
                                    {% endif %}
                                    <button type="button" id="editCategoryBtn" class="text-sm text-indigo-600 hover:text-indigo-900 font-medium">
                                        –ò–∑–º–µ–Ω–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                            <div id="categoryEditor" class="hidden mt-2">
                                <select id="categorySelect" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>
                                </select>
                                <div class="mt-2 flex gap-2">
                                    <button type="button" id="saveCategoryBtn" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                    </button>
                                    <button type="button" id="cancelCategoryBtn" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        –û—Ç–º–µ–Ω–∞
                                    </button>
                                </div>
                            </div>
                        </dd>
                    </div>
                </dl>
            </div>

            <!-- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
            <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h3>
                <dl class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–¶–≤–µ—Ç–∞</dt>
                        <dd class="mt-1">
                            {% if product.colors_list %}
                                {% for color in product.colors_list %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 mr-1 mb-1">
                                    {{ color }}
                                </span>
                                {% endfor %}
                            {% else %}
                                <span class="text-sm text-gray-900">‚Äî</span>
                            {% endif %}
                        </dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–†–∞–∑–º–µ—Ä—ã</dt>
                        <dd class="mt-1">
                            {% if product.sizes_list %}
                                {% if product.sizes_list.raw %}
                                <div class="text-sm text-gray-900 mb-2">{{ product.sizes_list.raw }}</div>
                                {% endif %}

                                {% if product.sizes_list.simple_sizes %}
                                <div class="mb-2">
                                    {% for size in product.sizes_list.simple_sizes %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 mr-1 mb-1">
                                        {{ size }}
                                    </span>
                                    {% endfor %}
                                </div>
                                {% endif %}

                                {% if product.sizes_list.dimensions %}
                                <div class="text-xs text-gray-600 space-y-1">
                                    {% if product.sizes_list.dimensions.length %}
                                    <div><span class="font-medium">–î–ª–∏–Ω–∞:</span> {{ product.sizes_list.dimensions.length|join(', ') }} —Å–º</div>
                                    {% endif %}
                                    {% if product.sizes_list.dimensions.diameter %}
                                    <div><span class="font-medium">–î–∏–∞–º–µ—Ç—Ä:</span> {{ product.sizes_list.dimensions.diameter|join(', ') }} —Å–º</div>
                                    {% endif %}
                                    {% if product.sizes_list.dimensions.width %}
                                    <div><span class="font-medium">–®–∏—Ä–∏–Ω–∞:</span> {{ product.sizes_list.dimensions.width|join(', ') }} —Å–º</div>
                                    {% endif %}
                                    {% if product.sizes_list.dimensions.depth %}
                                    <div><span class="font-medium">–ì–ª—É–±–∏–Ω–∞:</span> {{ product.sizes_list.dimensions.depth|join(', ') }} —Å–º</div>
                                    {% endif %}
                                    {% if product.sizes_list.dimensions.weight %}
                                    <div><span class="font-medium">–í–µ—Å:</span> {{ product.sizes_list.dimensions.weight|join(', ') }} –≥</div>
                                    {% endif %}
                                    {% if product.sizes_list.dimensions.volume %}
                                    <div><span class="font-medium">–û–±—ä—ë–º:</span> {{ product.sizes_list.dimensions.volume|join(', ') }} –º–ª</div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            {% else %}
                                <span class="text-sm text-gray-900">‚Äî</span>
                            {% endif %}
                        </dd>
                    </div>
                    <div class="sm:col-span-2">
                        <dt class="text-sm font-medium text-gray-500">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</dt>
                        <dd class="mt-1">
                            {% if product.materials_list %}
                                {% for material in product.materials_list %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 mr-1 mb-1">
                                    {{ material }}
                                </span>
                                {% endfor %}
                            {% else %}
                                <span class="text-sm text-gray-900">‚Äî</span>
                            {% endif %}
                        </dd>
                    </div>

                    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–û–±—ä–µ–º, –í–µ—Å –∏ —Ç.–¥.) -->
                    {% if product.characteristics_dict %}
                    <div class="sm:col-span-2">
                        <dt class="text-sm font-medium text-gray-500 mb-2">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</dt>
                        <dd class="mt-1">
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                {% for key, value in product.characteristics_dict.items() %}
                                <div class="bg-gray-50 rounded-lg p-2">
                                    <div class="text-xs text-gray-500">{{ key }}</div>
                                    <div class="font-medium text-gray-900">{{ value }}</div>
                                </div>
                                {% endfor %}
                            </div>
                        </dd>
                    </div>
                    {% endif %}
                </dl>
            </div>

            <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
            {% if product.description %}
            <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">–û–ø–∏—Å–∞–Ω–∏–µ</h3>
                <div class="text-sm text-gray-700 whitespace-pre-line">{{ product.description }}</div>
            </div>
            {% endif %}

            <!-- –û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ -->
            {% if product.validation_errors_list %}
            <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-red-900">–û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏</h3>
                    <button type="button" id="showFixFormBtn" class="text-sm text-indigo-600 hover:text-indigo-900 font-medium">
                        –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏
                    </button>
                </div>
                <ul class="list-disc list-inside space-y-1 mb-4">
                    {% for error in product.validation_errors_list %}
                    <li class="text-sm text-red-700">{{ error }}</li>
                    {% endfor %}
                </ul>

                <!-- –§–æ—Ä–º–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫ -->
                <div id="fixForm" class="hidden mt-4 pt-4 border-t border-red-200">
                    <form id="fixErrorsForm">
                        <!-- –ë–∞—Ä–∫–æ–¥—ã -->
                        {% if '–±–∞—Ä–∫–æ–¥' in (product.validation_errors_list|join(' '))|lower %}
                        <div class="mb-4">
                            <label for="fix_barcodes" class="block text-sm font-medium text-gray-700 mb-1">
                                –ë–∞—Ä–∫–æ–¥—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
                            </label>
                            <input type="text" id="fix_barcodes" name="barcodes"
                                   value="{{ product.barcodes_list|join(', ') if product.barcodes_list else '' }}"
                                   class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                   placeholder="1234567890123, 1234567890124">
                            <p class="mt-1 text-xs text-gray-500">
                                EAN-13 –∏–ª–∏ –¥—Ä—É–≥–æ–π —à—Ç—Ä–∏—Ö–∫–æ–¥. –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é.
                            </p>
                        </div>
                        {% endif %}

                        <!-- –ë—Ä–µ–Ω–¥ -->
                        {% if '–±—Ä–µ–Ω–¥' in (product.validation_errors_list|join(' '))|lower %}
                        <div class="mb-4">
                            <label for="fix_brand" class="block text-sm font-medium text-gray-700 mb-1">
                                –ë—Ä–µ–Ω–¥
                            </label>
                            <input type="text" id="fix_brand" name="brand"
                                   value="{{ product.brand or '' }}"
                                   class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                   placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞">
                        </div>
                        {% endif %}

                        <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
                        {% if '–Ω–∞–∑–≤–∞–Ω–∏–µ' in (product.validation_errors_list|join(' '))|lower %}
                        <div class="mb-4">
                            <label for="fix_title" class="block text-sm font-medium text-gray-700 mb-1">
                                –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
                            </label>
                            <input type="text" id="fix_title" name="title"
                                   value="{{ product.title or '' }}"
                                   class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                   placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
                        </div>
                        {% endif %}

                        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è WB -->
                        {% if '–∫–∞—Ç–µ–≥–æ—Ä–∏—è' in (product.validation_errors_list|join(' '))|lower %}
                        <div class="mb-4">
                            <label for="fix_category" class="block text-sm font-medium text-gray-700 mb-1">
                                –ö–∞—Ç–µ–≥–æ—Ä–∏—è WB
                            </label>
                            <select id="fix_category" name="wb_subject_id"
                                    class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>
                            </select>
                        </div>
                        {% endif %}

                        <div class="flex gap-2">
                            <button type="submit" id="saveFixBtn"
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
                            </button>
                            <button type="button" id="cancelFixBtn"
                                    class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="space-y-6">
            <!-- –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ -->
            {% if product.photo_urls_list %}
            <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ ({{ product.photo_urls_list|length }})</h3>
                    <div class="flex items-center gap-3">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="togglePadding" class="sr-only peer" checked>
                            <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                            <span class="ms-2 text-sm font-medium text-gray-700">Padding</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="toggleCensorship" class="sr-only peer">
                            <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                            <span class="ms-2 text-sm font-medium text-gray-700">–¶–µ–Ω–∑—É—Ä–∞</span>
                        </label>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    {% for photo in product.photo_urls_list[:6] %}
                    <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden relative group">
                        <img data-src="/auto-import/photo/padded?url={{ (photo.sexoptovik or '')|urlencode }}"
                             src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect fill='%23f3f4f6' width='200' height='200'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%239ca3af' font-size='12'%3E–ó–∞–≥—Ä—É–∑–∫–∞...%3C/text%3E%3C/svg%3E"
                             data-blur="{{ photo.blur or '' }}"
                             data-original="{{ photo.original or '' }}"
                             data-sexoptovik="{{ photo.sexoptovik or '' }}"
                             alt="–§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞"
                             loading="lazy"
                             class="lazy-photo product-photo w-full h-full object-cover transition-opacity duration-200"
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Crect fill=\'%23f3f4f6\' width=\'100\' height=\'100\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%239ca3af\' font-size=\'14\'%3E–ù–µ—Ç —Ñ–æ—Ç–æ%3C/text%3E%3C/svg%3E'">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all duration-200 pointer-events-none"></div>
                    </div>
                    {% endfor %}
                </div>
                {% if product.photo_urls_list|length > 6 %}
                <p class="mt-2 text-xs text-gray-500 text-center">
                    +{{ product.photo_urls_list|length - 6 }} –µ—â–µ
                </p>
                {% endif %}
            </div>
            {% endif %}

            <!-- –ë–∞—Ä–∫–æ–¥—ã -->
            {% if product.barcodes_list %}
            <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">–ë–∞—Ä–∫–æ–¥—ã</h3>
                <ul class="space-y-2">
                    {% for barcode in product.barcodes_list %}
                    <li class="text-sm font-mono bg-gray-50 px-3 py-2 rounded border border-gray-200">
                        {{ barcode }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ -->
            <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–º–ø–æ—Ä—Ç–µ</h3>
                <dl class="space-y-3">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–ò—Å—Ç–æ—á–Ω–∏–∫</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ product.source_type }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</dt>
                        <dd class="mt-1 text-sm text-gray-900">
                            {{ product.created_at.strftime('%d.%m.%Y %H:%M') if product.created_at else '‚Äî' }}
                        </dd>
                    </div>
                    {% if product.imported_at %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–î–∞—Ç–∞ –∏–º–ø–æ—Ä—Ç–∞</dt>
                        <dd class="mt-1 text-sm text-gray-900">
                            {{ product.imported_at.strftime('%d.%m.%Y %H:%M') }}
                        </dd>
                    </div>
                    {% endif %}
                    {% if product.import_error %}
                    <div>
                        <dt class="text-sm font-medium text-red-500">–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞</dt>
                        <dd class="mt-1 text-sm text-red-700">{{ product.import_error }}</dd>
                    </div>
                    {% endif %}
                </dl>
            </div>

            <!-- AI –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏) -->
            <div class="bg-gradient-to-br from-purple-50 to-indigo-50 shadow-sm rounded-lg border border-purple-200 p-6">
                <h3 class="text-lg font-medium text-purple-900 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    AI –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
                </h3>

                <!-- –ü–æ–ª–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è -->
                <div class="space-y-3">
                    <button id="aiFullOptimizeBtn" class="w-full inline-flex justify-center items-center px-4 py-2.5 border border-transparent text-sm font-medium rounded-md text-white bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 disabled:opacity-50 shadow-md">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        –ü–æ–ª–Ω–∞—è AI-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
                    </button>

                    <button id="aiRichContentBtn" class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-gradient-to-r from-pink-500 to-orange-500 hover:from-pink-600 hover:to-orange-600 disabled:opacity-50">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        Rich –ö–æ–Ω—Ç–µ–Ω—Ç (–∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∞)
                    </button>
                </div>

                <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å -->
                <div class="my-4 border-t border-purple-200"></div>

                <!-- –û—Ç–¥–µ–ª—å–Ω—ã–µ AI —Ñ—É–Ω–∫—Ü–∏–∏ -->
                <div class="space-y-2">
                    <p class="text-xs text-purple-600 font-medium mb-2">–û—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:</p>

                    <div class="grid grid-cols-2 gap-2">
                        <button id="aiSeoTitleBtn" class="inline-flex justify-center items-center px-3 py-2 border border-purple-300 text-xs font-medium rounded-md text-purple-700 bg-white hover:bg-purple-50 disabled:opacity-50">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                            </svg>
                            SEO –∑–∞–≥–æ–ª–æ–≤–æ–∫
                        </button>
                        <button id="aiKeywordsBtn" class="inline-flex justify-center items-center px-3 py-2 border border-purple-300 text-xs font-medium rounded-md text-purple-700 bg-white hover:bg-purple-50 disabled:opacity-50">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/>
                            </svg>
                            –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
                        </button>
                        <button id="aiBulletPointsBtn" class="inline-flex justify-center items-center px-3 py-2 border border-purple-300 text-xs font-medium rounded-md text-purple-700 bg-white hover:bg-purple-50 disabled:opacity-50">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                            –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
                        </button>
                        <button id="aiDescriptionBtn" class="inline-flex justify-center items-center px-3 py-2 border border-purple-300 text-xs font-medium rounded-md text-purple-700 bg-white hover:bg-purple-50 disabled:opacity-50">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
                            </svg>
                            –û–ø–∏—Å–∞–Ω–∏–µ
                        </button>
                        <button id="aiCategoryBtn" class="inline-flex justify-center items-center px-3 py-2 border border-blue-300 text-xs font-medium rounded-md text-blue-700 bg-white hover:bg-blue-50 disabled:opacity-50">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                            </svg>
                            –ö–∞—Ç–µ–≥–æ—Ä–∏—è
                        </button>
                        <button id="aiSizesBtn" class="inline-flex justify-center items-center px-3 py-2 border border-blue-300 text-xs font-medium rounded-md text-blue-700 bg-white hover:bg-blue-50 disabled:opacity-50">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/>
                            </svg>
                            –†–∞–∑–º–µ—Ä—ã
                        </button>
                        <button id="aiWbCharsBtn" class="inline-flex justify-center items-center px-3 py-2 border border-orange-300 text-xs font-medium rounded-md text-orange-700 bg-white hover:bg-orange-50 disabled:opacity-50" title="–ò–∑–≤–ª–µ—á—å —Ä–∞–∑–º–µ—Ä–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                            </svg>
                            –†–∞–∑–º–µ—Ä—ã WB
                        </button>
                        <button id="aiAllCharsBtn" class="inline-flex justify-center items-center px-3 py-2 border border-emerald-400 text-xs font-medium rounded-md text-white bg-emerald-500 hover:bg-emerald-600 disabled:opacity-50" title="–ò–∑–≤–ª–µ—á—å –í–°–ï —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ WB">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            –í–°–ï —Ö–∞—Ä-–∫–∏
                        </button>
                        <button id="aiAnalyzeBtn" class="col-span-2 inline-flex justify-center items-center px-3 py-2 border border-green-300 text-xs font-medium rounded-md text-green-700 bg-white hover:bg-green-50 disabled:opacity-50">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            –ê–Ω–∞–ª–∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏
                        </button>
                    </div>
                </div>

                <!-- –ü—Ä–∏–º–µ–Ω–∏—Ç—å AI –¥–∞–Ω–Ω—ã–µ -->
                {% if product.has_ai_data %}
                <div class="mt-4 pt-4 border-t border-purple-200">
                    <button id="applyAiDataBtn" class="w-full inline-flex justify-center items-center px-4 py-2 border border-green-500 text-sm font-medium rounded-md text-green-700 bg-green-50 hover:bg-green-100 disabled:opacity-50">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        –ü—Ä–∏–º–µ–Ω–∏—Ç—å AI –¥–∞–Ω–Ω—ã–µ –∫ –∫–∞—Ä—Ç–æ—á–∫–µ
                    </button>
                    <p class="text-xs text-gray-500 mt-1 text-center">–ó–∞–º–µ–Ω–∏—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ AI-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</p>
                </div>
                {% endif %}
            </div>

            <!-- AI-–∫–æ–Ω—Ç–µ–Ω—Ç -->
            {% if product.has_ai_data %}
            <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ AI-—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                </h3>
                <div class="space-y-4">
                    <!-- SEO –∑–∞–≥–æ–ª–æ–≤–æ–∫ -->
                    {% if product.ai_seo_title %}
                    <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                        <h4 class="text-sm font-medium text-green-700 mb-1">SEO –∑–∞–≥–æ–ª–æ–≤–æ–∫</h4>
                        <p class="text-green-800">{{ product.ai_seo_title }}</p>
                    </div>
                    {% endif %}

                    <!-- –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ -->
                    {% if product.ai_keywords_list and product.ai_keywords_list.keywords %}
                    {% set keywords = product.ai_keywords_list.keywords %}
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ ({{ keywords|length }})</h4>
                        <div class="flex flex-wrap gap-1 max-h-24 overflow-y-auto">
                            {% for keyword in keywords[:20] %}
                            <span class="px-2 py-0.5 bg-purple-100 text-purple-800 text-xs rounded-full">{{ keyword }}</span>
                            {% endfor %}
                            {% if keywords|length > 20 %}
                            <span class="px-2 py-0.5 text-gray-500 text-xs">+{{ keywords|length - 20 }} –µ—â—ë</span>
                            {% endif %}
                        </div>
                        {% if product.ai_keywords_list.search_queries %}
                        <div class="mt-2">
                            <span class="text-xs text-gray-500">–ü–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã:</span>
                            <div class="flex flex-wrap gap-1 mt-1">
                                {% for query in product.ai_keywords_list.search_queries[:5] %}
                                <span class="px-2 py-0.5 bg-blue-100 text-blue-800 text-xs rounded">{{ query }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ -->
                    {% if product.ai_bullets_list and product.ai_bullets_list.bullet_points %}
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞</h4>
                        <ul class="text-sm text-gray-600 space-y-1">
                            {% for bullet in product.ai_bullets_list.bullet_points %}
                            <li class="flex items-start">
                                <span class="text-green-600 mr-1 flex-shrink-0">‚úì</span>
                                <span>{{ bullet }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                        {% if product.ai_bullets_list.target_audience %}
                        <p class="text-xs text-gray-400 mt-2">–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: {{ product.ai_bullets_list.target_audience }}</p>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- –ê–Ω–∞–ª–∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
                    {% if product.ai_analysis_data %}
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-sm font-medium text-gray-700">–ê–Ω–∞–ª–∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏</h4>
                            {% if product.ai_analysis_data.score %}
                            <span class="px-2 py-1 rounded-full text-sm font-bold
                                {% if product.ai_analysis_data.score >= 80 %}bg-green-100 text-green-800
                                {% elif product.ai_analysis_data.score >= 60 %}bg-yellow-100 text-yellow-800
                                {% else %}bg-red-100 text-red-800{% endif %}">
                                {{ product.ai_analysis_data.score }}/100
                            </span>
                            {% endif %}
                        </div>
                        {% if product.ai_analysis_data.issues %}
                        <div class="text-xs text-gray-600">
                            <span class="font-medium">–ü—Ä–æ–±–ª–µ–º—ã:</span> {{ product.ai_analysis_data.issues|length }}
                        </div>
                        {% endif %}
                        {% if product.ai_analysis_data.recommendations %}
                        <div class="text-xs text-gray-600">
                            <span class="font-medium">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</span> {{ product.ai_analysis_data.recommendations|length }}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Rich –∫–æ–Ω—Ç–µ–Ω—Ç -->
                    {% if product.ai_rich_content_data %}
                    <div class="bg-gradient-to-r from-orange-50 to-pink-50 p-3 rounded-lg border border-orange-200">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="text-sm font-medium text-orange-700">Rich-–∫–æ–Ω—Ç–µ–Ω—Ç</h4>
                            <button onclick="viewRichContentSlides()" class="text-xs text-orange-600 hover:text-orange-800 underline">
                                –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ª–∞–π–¥–æ–≤
                            </button>
                        </div>
                        {% if product.ai_rich_content_data.slides %}
                        <p class="text-xs text-orange-600">{{ product.ai_rich_content_data.slides|length }} —Å–ª–∞–π–¥–æ–≤ –≥–æ—Ç–æ–≤–æ</p>
                        <!-- –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
                        <button id="generateSlideImagesBtn"
                            onclick="generateSlideImages()"
                            class="mt-2 w-full inline-flex justify-center items-center px-3 py-1.5 border border-orange-300 text-xs font-medium rounded-md text-orange-700 bg-white hover:bg-orange-50">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (AI)
                        </button>
                        {% elif product.ai_rich_content_data.blocks %}
                        <p class="text-xs text-orange-600">{{ product.ai_rich_content_data.blocks|length }} –±–ª–æ–∫–æ–≤</p>
                        {% endif %}
                        {% if product.ai_rich_content_data.main_usp %}
                        <p class="text-xs text-gray-600 mt-1">–£–¢–ü: {{ product.ai_rich_content_data.main_usp }}</p>
                        {% endif %}
                        {% if product.ai_rich_content_data.target_audience %}
                        <p class="text-xs text-gray-500">–ê—É–¥–∏—Ç–æ—Ä–∏—è: {{ product.ai_rich_content_data.target_audience }}</p>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- –í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞ -->
                    {% if product.ai_analysis_at %}
                    <div class="text-xs text-gray-400 text-right">
                        –û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ product.ai_analysis_at.strftime('%d.%m.%Y %H:%M') }}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="bg-gray-50 shadow-sm rounded-lg border border-gray-200 p-6">
                <div class="text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">AI-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è</h3>
                    <p class="mt-1 text-sm text-gray-500">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –≤—ã—à–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SEO-–∫–æ–Ω—Ç–µ–Ω—Ç–∞, –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –∏ Rich-–∫–æ–Ω—Ç–µ–Ω—Ç–∞</p>
                </div>
            </div>
            {% endif %}

            <!-- –î–µ–π—Å—Ç–≤–∏—è -->
            <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">–î–µ–π—Å—Ç–≤–∏—è</h3>
                {% if product.import_status == 'validated' %}
                <button id="importSingleBtn" class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed mb-3">
                    –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ WB
                </button>
                <p class="mb-3 text-xs text-gray-500 text-center">
                    –¢–æ–≤–∞—Ä –≥–æ—Ç–æ–≤ –∫ –∏–º–ø–æ—Ä—Ç—É –≤ Wildberries
                </p>
                {% endif %}
                <button id="deleteSingleBtn" class="w-full inline-flex justify-center items-center px-4 py-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50">
                    –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä
                </button>
            </div>
        </div>
    </div>
</div>

<!-- AI Results Modal -->
<div id="aiResultsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-3xl shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 id="aiModalTitle" class="text-xl font-bold text-gray-900">AI –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
            <button id="closeAiModal" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div id="aiModalContent" class="max-h-96 overflow-y-auto">
            <!-- Content will be inserted here -->
        </div>
        <div id="aiModalActions" class="mt-4 flex gap-2 hidden">
            <button id="applyAiChanges" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
            </button>
            <button id="cancelAiChanges" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                –û—Ç–º–µ–Ω–∞
            </button>
        </div>
    </div>
</div>

<script>
console.log('Script tag loaded');

// Helper functions
function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) {
        section.classList.toggle('hidden');
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
    }).catch(err => {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
    });
}

// Populate saved AI data - simplified version
function populateSavedAIData() {
    console.log('populateSavedAIData called');
    // AI data will be populated after migration is run
    // For now, this function is a no-op
}

function computeContentHash() {
    // Simple hash based on title and description
    // Using tojson filter to properly escape for JavaScript
    const content = {{ (product.title or "")|tojson }} + {{ (product.description or "")|tojson }};
    let hash = 0;
    for (let i = 0; i < content.length; i++) {
        const char = content.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return hash.toString(16);
}

document.addEventListener('DOMContentLoaded', function() {
    // Populate saved AI data
    populateSavedAIData();

    const importBtn = document.getElementById('importSingleBtn');
    const deleteBtn = document.getElementById('deleteSingleBtn');

    if (importBtn) {
        importBtn.addEventListener('click', function() {
            if (!confirm('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –≤ Wildberries?')) {
                return;
            }

            // Disable button during import
            importBtn.disabled = true;
            importBtn.textContent = '–ò–º–ø–æ—Ä—Ç–∏—Ä—É—é...';

            // Send request
            fetch('{{ url_for("auto_import_single_to_wb", product_id=product.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ Wildberries!');
                    window.location.href = '{{ url_for("auto_import_products") }}';
                } else {
                    alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    importBtn.disabled = false;
                    importBtn.textContent = '–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ WB';
                }
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: ' + error);
                importBtn.disabled = false;
                importBtn.textContent = '–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ WB';
            });
        });
    }

    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
                return;
            }

            // Disable button during deletion
            deleteBtn.disabled = true;
            deleteBtn.textContent = '–£–¥–∞–ª–µ–Ω–∏–µ...';

            // Send request
            fetch('{{ url_for("auto_import_delete_product", product_id=product.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω');
                    window.location.href = '{{ url_for("auto_import_products") }}';
                } else {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = '–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä';
                }
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: ' + error);
                deleteBtn.disabled = false;
                deleteBtn.textContent = '–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä';
            });
        });
    }

    // Category editing functionality
    const editCategoryBtn = document.getElementById('editCategoryBtn');
    const confirmCategoryBtn = document.getElementById('confirmCategoryBtn');
    const categoryDisplay = document.getElementById('categoryDisplay');
    const categoryEditor = document.getElementById('categoryEditor');
    const categorySelect = document.getElementById('categorySelect');
    const saveCategoryBtn = document.getElementById('saveCategoryBtn');
    const cancelCategoryBtn = document.getElementById('cancelCategoryBtn');

    // WB adult categories from mapping
    const wbCategories = {{ wb_categories|tojson }};

    // Populate select with categories
    if (categorySelect && wbCategories) {
        // Sort categories by name
        const sortedCategories = Object.entries(wbCategories).sort((a, b) => a[1].localeCompare(b[1]));

        sortedCategories.forEach(([id, name]) => {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = `${name} (ID: ${id})`;
            if (parseInt(id) === {{ product.wb_subject_id or 'null' }}) {
                option.selected = true;
            }
            categorySelect.appendChild(option);
        });
    }

    if (editCategoryBtn) {
        editCategoryBtn.addEventListener('click', function() {
            categoryDisplay.classList.add('hidden');
            categoryEditor.classList.remove('hidden');
        });
    }

    if (cancelCategoryBtn) {
        cancelCategoryBtn.addEventListener('click', function() {
            categoryEditor.classList.add('hidden');
            categoryDisplay.classList.remove('hidden');
        });
    }

    // Confirm category button - confirms current category without changing it
    if (confirmCategoryBtn) {
        confirmCategoryBtn.addEventListener('click', function() {
            if (!confirm('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ç–µ–∫—É—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é "{{ product.mapped_wb_category }}"?')) {
                return;
            }

            confirmCategoryBtn.disabled = true;
            const originalText = confirmCategoryBtn.textContent;
            confirmCategoryBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ...';

            fetch('{{ url_for("auto_import_correct_category", product_id=product.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    wb_subject_id: {{ product.wb_subject_id or 'null' }}
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ 100%');
                    window.location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    confirmCategoryBtn.disabled = false;
                    confirmCategoryBtn.textContent = originalText;
                }
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: ' + error);
                confirmCategoryBtn.disabled = false;
                confirmCategoryBtn.textContent = originalText;
            });
        });
    }

    if (saveCategoryBtn) {
        saveCategoryBtn.addEventListener('click', function() {
            const selectedCategoryId = categorySelect.value;

            if (!selectedCategoryId) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
                return;
            }

            saveCategoryBtn.disabled = true;
            saveCategoryBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

            fetch('{{ url_for("auto_import_correct_category", product_id=product.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    wb_subject_id: parseInt(selectedCategoryId)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
                    window.location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    saveCategoryBtn.disabled = false;
                    saveCategoryBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                }
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: ' + error);
                saveCategoryBtn.disabled = false;
                saveCategoryBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            });
        });
    }

    // === BRAND MANAGEMENT ===
    const brandDisplay = document.getElementById('brandDisplay');
    const brandEditor = document.getElementById('brandEditor');
    const brandInput = document.getElementById('brandInput');
    const brandValue = document.getElementById('brandValue');
    const brandSuggestions = document.getElementById('brandSuggestions');
    const brandValidation = document.getElementById('brandValidation');
    const editBrandBtn = document.getElementById('editBrandBtn');
    const validateBrandBtn = document.getElementById('validateBrandBtn');
    const searchBrandBtn = document.getElementById('searchBrandBtn');
    const saveBrandBtn = document.getElementById('saveBrandBtn');
    const cancelBrandBtn = document.getElementById('cancelBrandBtn');

    if (editBrandBtn) {
        editBrandBtn.addEventListener('click', function() {
            brandDisplay.classList.add('hidden');
            brandEditor.classList.remove('hidden');
        });
    }

    if (cancelBrandBtn) {
        cancelBrandBtn.addEventListener('click', function() {
            brandEditor.classList.add('hidden');
            brandDisplay.classList.remove('hidden');
            brandSuggestions.classList.add('hidden');
            brandValidation.classList.add('hidden');
        });
    }

    // Validate brand in WB
    async function validateBrand(brandName) {
        if (!brandName || brandName.length < 2) {
            brandValidation.innerHTML = '<span class="text-yellow-600">–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞</span>';
            brandValidation.classList.remove('hidden');
            return;
        }

        brandValidation.innerHTML = '<span class="text-gray-500">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>';
        brandValidation.classList.remove('hidden');

        try {
            const response = await fetch('/auto-import/validate-brand', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ brand: brandName })
            });
            const data = await response.json();

            if (data.success) {
                if (data.valid) {
                    brandValidation.innerHTML = '<span class="text-green-600">‚úì –ë—Ä–µ–Ω–¥ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ WB: <strong>' + data.exact_match.name + '</strong></span>';
                    brandInput.value = data.exact_match.name;
                } else {
                    let html = '<span class="text-yellow-600">‚ö† –ë—Ä–µ–Ω–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ WB</span>';
                    if (data.suggestions && data.suggestions.length > 0) {
                        html += '<div class="mt-1 text-xs text-gray-500">–ü–æ—Ö–æ–∂–∏–µ –±—Ä–µ–Ω–¥—ã:</div>';
                    }
                    brandValidation.innerHTML = html;

                    // Show suggestions
                    if (data.suggestions && data.suggestions.length > 0) {
                        let suggestionsHtml = '';
                        data.suggestions.forEach(brand => {
                            suggestionsHtml += '<div class="px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 text-sm" data-brand="' + brand.name + '">' + brand.name + '</div>';
                        });
                        brandSuggestions.innerHTML = suggestionsHtml;
                        brandSuggestions.classList.remove('hidden');

                        // Click handler for suggestions
                        brandSuggestions.querySelectorAll('[data-brand]').forEach(el => {
                            el.addEventListener('click', function() {
                                brandInput.value = this.dataset.brand;
                                brandSuggestions.classList.add('hidden');
                                brandValidation.innerHTML = '<span class="text-green-600">‚úì –í—ã–±—Ä–∞–Ω –±—Ä–µ–Ω–¥: <strong>' + this.dataset.brand + '</strong></span>';
                            });
                        });
                    }
                }
            } else {
                brandValidation.innerHTML = '<span class="text-red-600">–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</span>';
            }
        } catch (error) {
            brandValidation.innerHTML = '<span class="text-red-600">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</span>';
        }
    }

    if (validateBrandBtn) {
        validateBrandBtn.addEventListener('click', function() {
            const currentBrand = brandValue.textContent.trim();
            if (currentBrand && currentBrand !== '‚Äî') {
                brandDisplay.classList.add('hidden');
                brandEditor.classList.remove('hidden');
                brandInput.value = currentBrand;
                validateBrand(currentBrand);
            } else {
                brandDisplay.classList.add('hidden');
                brandEditor.classList.remove('hidden');
            }
        });
    }

    if (searchBrandBtn) {
        searchBrandBtn.addEventListener('click', function() {
            validateBrand(brandInput.value);
        });
    }

    // Search on Enter key
    if (brandInput) {
        brandInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                validateBrand(brandInput.value);
            }
        });
    }

    if (saveBrandBtn) {
        saveBrandBtn.addEventListener('click', function() {
            const newBrand = brandInput.value.trim();

            if (!newBrand) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞');
                return;
            }

            saveBrandBtn.disabled = true;
            saveBrandBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

            fetch('{{ url_for("auto_import_update_product", product_id=product.id) }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ brand: newBrand })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    brandValue.textContent = newBrand;
                    brandEditor.classList.add('hidden');
                    brandDisplay.classList.remove('hidden');
                    brandSuggestions.classList.add('hidden');
                    brandValidation.classList.add('hidden');
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
                saveBrandBtn.disabled = false;
                saveBrandBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞: ' + error);
                saveBrandBtn.disabled = false;
                saveBrandBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            });
        });
    }

    // Photo censorship toggle
    const toggleCensorship = document.getElementById('toggleCensorship');
    const togglePadding = document.getElementById('togglePadding');

    function updatePhotoUrls() {
        const photos = document.querySelectorAll('.product-photo');
        const useCensorship = toggleCensorship ? toggleCensorship.checked : false;
        const usePadding = togglePadding ? togglePadding.checked : true;

        photos.forEach(photo => {
            const blurUrl = photo.dataset.blur;
            const sexoptovikUrl = photo.dataset.sexoptovik;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–π URL –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ü–µ–Ω–∑—É—Ä—ã
            let baseUrl;
            if (useCensorship) {
                // –° —Ü–µ–Ω–∑—É—Ä–æ–π: –ø—ã—Ç–∞–µ–º—Å—è blur, –µ—Å–ª–∏ –Ω–µ—Ç - sexoptovik
                baseUrl = blurUrl || sexoptovikUrl;
            } else {
                // –ë–µ–∑ —Ü–µ–Ω–∑—É—Ä—ã: –≤—Å–µ–≥–¥–∞ sexoptovik (x-story original –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
                baseUrl = sexoptovikUrl;
            }

            // –ü—Ä–∏–º–µ–Ω—è–µ–º padding –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (usePadding && baseUrl) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è padded –≤–µ—Ä—Å–∏–∏
                photo.src = `/auto-import/photo/padded?url=${encodeURIComponent(baseUrl)}`;
            } else {
                photo.src = baseUrl;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —Å–º–µ–Ω—ã
            photo.style.opacity = '0.5';
            setTimeout(() => {
                photo.style.opacity = '1';
            }, 150);
        });
    }

    if (toggleCensorship) {
        toggleCensorship.addEventListener('change', updatePhotoUrls);
    }

    if (togglePadding) {
        togglePadding.addEventListener('change', updatePhotoUrls);
    }

    // Fix errors form functionality
    const showFixFormBtn = document.getElementById('showFixFormBtn');
    const fixForm = document.getElementById('fixForm');
    const cancelFixBtn = document.getElementById('cancelFixBtn');
    const fixErrorsForm = document.getElementById('fixErrorsForm');
    const fixCategorySelect = document.getElementById('fix_category');

    // Populate category select for fix form
    if (fixCategorySelect && wbCategories) {
        const sortedCategories = Object.entries(wbCategories).sort((a, b) => a[1].localeCompare(b[1]));
        sortedCategories.forEach(([id, name]) => {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = `${name} (ID: ${id})`;
            fixCategorySelect.appendChild(option);
        });
    }

    if (showFixFormBtn && fixForm) {
        showFixFormBtn.addEventListener('click', function() {
            fixForm.classList.remove('hidden');
            showFixFormBtn.classList.add('hidden');
        });
    }

    if (cancelFixBtn && fixForm && showFixFormBtn) {
        cancelFixBtn.addEventListener('click', function() {
            fixForm.classList.add('hidden');
            showFixFormBtn.classList.remove('hidden');
        });
    }

    if (fixErrorsForm) {
        fixErrorsForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(fixErrorsForm);
            const data = {};

            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
            for (let [key, value] of formData.entries()) {
                if (value.trim()) {
                    data[key] = value.trim();
                }
            }

            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±–∞—Ä–∫–æ–¥—ã
            if (data.barcodes) {
                data.barcodes = data.barcodes.split(',').map(b => b.trim()).filter(b => b);
            }

            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º wb_subject_id –≤ —á–∏—Å–ª–æ
            if (data.wb_subject_id) {
                data.wb_subject_id = parseInt(data.wb_subject_id);
            }

            const saveBtn = document.getElementById('saveFixBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

            fetch('{{ url_for("auto_import_update_product", product_id=product.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏ —Ç–æ–≤–∞—Ä –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω!');
                    window.location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    saveBtn.disabled = false;
                    saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å';
                }
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ' + error);
                saveBtn.disabled = false;
                saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å';
            });
        });
    }
});

// Lazy loading –¥–ª—è —Ñ–æ—Ç–æ
document.addEventListener('DOMContentLoaded', function() {
    const lazyPhotos = document.querySelectorAll('.lazy-photo');

    if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src) {
                        img.src = img.dataset.src;
                        img.classList.remove('lazy-photo');
                        observer.unobserve(img);
                    }
                }
            });
        }, { rootMargin: '50px' });

        lazyPhotos.forEach(img => observer.observe(img));
    } else {
        // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        lazyPhotos.forEach(img => {
            if (img.dataset.src) {
                img.src = img.dataset.src;
            }
        });
    }
});

// AI Optimization Functions
(function() {
    console.log('AI Optimization script starting...');
    const productId = {{ product.id }};
    console.log('Product ID:', productId);
    const modal = document.getElementById('aiResultsModal');
    const modalTitle = document.getElementById('aiModalTitle');
    const modalContent = document.getElementById('aiModalContent');
    const modalActions = document.getElementById('aiModalActions');
    const closeModalBtn = document.getElementById('closeAiModal');
    const applyBtn = document.getElementById('applyAiChanges');
    const cancelBtn = document.getElementById('cancelAiChanges');

    let currentAiData = null;

    function showModal(title, content, showActions = false) {
        modalTitle.textContent = title;
        modalContent.innerHTML = content;
        modalActions.classList.toggle('hidden', !showActions);
        modal.classList.remove('hidden');
    }

    function hideModal() {
        modal.classList.add('hidden');
        currentAiData = null;
    }

    function showLoading(btn, text = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
        btn.disabled = true;
        btn.dataset.originalText = btn.textContent;
        btn.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>${text}`;
    }

    function hideLoading(btn) {
        btn.disabled = false;
        btn.textContent = btn.dataset.originalText || btn.textContent;
    }

    async function callAiEndpoint(endpoint, btn) {
        showLoading(btn);
        try {
            console.log('Calling AI endpoint:', endpoint, 'with product_id:', productId);
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_id: productId })
            });
            const result = await response.json();
            console.log('AI endpoint response:', result);
            return result;
        } catch (error) {
            console.error('AI endpoint error:', error);
            alert('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ' + error.message);
            return { success: false, error: error.message };
        } finally {
            hideLoading(btn);
        }
    }

    console.log('AI buttons initializing for product:', productId);

    // SEO Title
    document.getElementById('aiSeoTitleBtn')?.addEventListener('click', async function() {
        console.log('SEO Title button clicked');
        const result = await callAiEndpoint('/auto-import/ai/seo-title', this);
        if (result.success) {
            currentAiData = { title: result.data.title };
            const content = `
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-medium text-gray-700 mb-2">–¢–µ–∫—É—â–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫:</h4>
                        <p class="text-gray-600">${result.original_title || '‚Äî'}</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-medium text-green-700 mb-2">SEO-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫:</h4>
                        <p class="text-green-800 font-medium">${result.data.title}</p>
                    </div>
                    ${result.data.keywords_used?.length ? `
                    <div>
                        <h4 class="font-medium text-gray-700 mb-2">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:</h4>
                        <div class="flex flex-wrap gap-1">
                            ${result.data.keywords_used.map(k => `<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">${k}</span>`).join('')}
                        </div>
                    </div>` : ''}
                    ${result.data.improvements?.length ? `
                    <div>
                        <h4 class="font-medium text-gray-700 mb-2">–£–ª—É—á—à–µ–Ω–∏—è:</h4>
                        <ul class="list-disc list-inside text-sm text-gray-600">
                            ${result.data.improvements.map(i => `<li>${i}</li>`).join('')}
                        </ul>
                    </div>` : ''}
                </div>
            `;
            showModal('SEO-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞', content, true);
        } else {
            showModal('–û—à–∏–±–∫–∞', `<p class="text-red-600">${result.error}</p>`);
        }
    });

    // Keywords
    document.getElementById('aiKeywordsBtn')?.addEventListener('click', async function() {
        console.log('Keywords button clicked');
        const result = await callAiEndpoint('/auto-import/ai/keywords', this);
        if (result.success) {
            currentAiData = { keywords: result.data.keywords };
            const content = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-medium text-gray-700 mb-2">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (${result.data.keywords?.length || 0}):</h4>
                        <div class="flex flex-wrap gap-1 max-h-40 overflow-y-auto">
                            ${(result.data.keywords || []).map(k => `<span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full">${k}</span>`).join('')}
                        </div>
                    </div>
                    ${result.data.search_queries?.length ? `
                    <div>
                        <h4 class="font-medium text-gray-700 mb-2">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã:</h4>
                        <ul class="list-disc list-inside text-sm text-gray-600">
                            ${result.data.search_queries.map(q => `<li>${q}</li>`).join('')}
                        </ul>
                    </div>` : ''}
                </div>
            `;
            showModal('–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞', content, true);
        } else {
            showModal('–û—à–∏–±–∫–∞', `<p class="text-red-600">${result.error}</p>`);
        }
    });

    // Bullet Points
    document.getElementById('aiBulletPointsBtn')?.addEventListener('click', async function() {
        const result = await callAiEndpoint('/auto-import/ai/bullet-points', this);
        if (result.success) {
            currentAiData = { bullet_points: result.data.bullet_points };
            const content = `
                <div class="space-y-4">
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-medium text-green-700 mb-2">–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞:</h4>
                        <ul class="space-y-2">
                            ${(result.data.bullet_points || []).map(bp => `<li class="flex items-start"><span class="text-green-600 mr-2">‚úì</span><span>${bp.replace(/^[‚úì‚úî] ?/, '')}</span></li>`).join('')}
                        </ul>
                    </div>
                    ${result.data.target_audience ? `
                    <div>
                        <h4 class="font-medium text-gray-700 mb-2">–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è:</h4>
                        <p class="text-gray-600">${result.data.target_audience}</p>
                    </div>` : ''}
                </div>
            `;
            showModal('–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞', content, true);
        } else {
            showModal('–û—à–∏–±–∫–∞', `<p class="text-red-600">${result.error}</p>`);
        }
    });

    // Card Analysis
    document.getElementById('aiAnalyzeBtn')?.addEventListener('click', async function() {
        const result = await callAiEndpoint('/auto-import/ai/analyze', this);
        if (result.success) {
            const score = result.data.score || 0;
            const scoreColor = score >= 80 ? 'green' : score >= 60 ? 'yellow' : 'red';
            const content = `
                <div class="space-y-4">
                    <div class="text-center">
                        <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-${scoreColor}-100 text-${scoreColor}-800 text-2xl font-bold">
                            ${score}
                        </div>
                        <p class="mt-2 text-sm text-gray-600">–û—Ü–µ–Ω–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏</p>
                    </div>
                    ${result.data.issues?.length ? `
                    <div>
                        <h4 class="font-medium text-red-700 mb-2">–ü—Ä–æ–±–ª–µ–º—ã:</h4>
                        <ul class="space-y-2">
                            ${result.data.issues.map(issue => `
                                <li class="bg-red-50 p-2 rounded">
                                    <span class="inline-block px-1.5 py-0.5 text-xs rounded ${issue.priority === 'high' ? 'bg-red-200 text-red-800' : issue.priority === 'medium' ? 'bg-yellow-200 text-yellow-800' : 'bg-gray-200 text-gray-800'}">${issue.priority}</span>
                                    <span class="ml-2 font-medium">${issue.issue}</span>
                                    <p class="text-sm text-gray-600 mt-1">–†–µ—à–µ–Ω–∏–µ: ${issue.fix}</p>
                                </li>
                            `).join('')}
                        </ul>
                    </div>` : ''}
                    ${result.data.recommendations?.length ? `
                    <div>
                        <h4 class="font-medium text-blue-700 mb-2">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</h4>
                        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                            ${result.data.recommendations.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>` : ''}
                    ${result.data.strengths?.length ? `
                    <div>
                        <h4 class="font-medium text-green-700 mb-2">–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:</h4>
                        <ul class="list-disc list-inside text-sm text-green-600 space-y-1">
                            ${result.data.strengths.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>` : ''}
                </div>
            `;
            showModal('–ê–Ω–∞–ª–∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏', content, false);
        } else {
            showModal('–û—à–∏–±–∫–∞', `<p class="text-red-600">${result.error}</p>`);
        }
    });

    // Rich Content
    document.getElementById('aiRichContentBtn')?.addEventListener('click', async function() {
        console.log('Rich Content button clicked');
        const result = await callAiEndpoint('/auto-import/ai/rich-content', this);
        if (result.success) {
            currentAiData = { rich_content: result.data };
            const data = result.data;

            let content = '<div class="space-y-4">';

            // Header with specs
            content += `
                <div class="bg-gradient-to-r from-orange-500 to-pink-500 text-white p-4 rounded-lg">
                    <h4 class="font-bold text-lg">Rich-–∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è Wildberries</h4>
                    <p class="text-sm opacity-90">–ú–∞–∫–µ—Ç—ã —Å–ª–∞–π–¥–æ–≤ –∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∏ 1440x810px</p>
                    ${data.total_slides ? `<p class="text-xs mt-1">–í—Å–µ–≥–æ —Å–ª–∞–π–¥–æ–≤: ${data.total_slides}</p>` : ''}
                </div>
            `;

            // Design recommendations
            if (data.design_recommendations) {
                const dr = data.design_recommendations;
                content += `
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <h4 class="font-bold text-purple-800 mb-2">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∏–∑–∞–π–Ω—É</h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            ${dr.color_palette ? `
                                <div>
                                    <span class="text-gray-600">–ü–∞–ª–∏—Ç—Ä–∞:</span>
                                    <div class="flex gap-1 mt-1">
                                        ${dr.color_palette.map(c => `<span class="inline-block w-6 h-6 rounded border" style="background:${c}" title="${c}"></span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            ${dr.font_style ? `<div><span class="text-gray-600">–°—Ç–∏–ª—å —à—Ä–∏—Ñ—Ç–∞:</span> <span class="font-medium">${dr.font_style}</span></div>` : ''}
                            ${dr.overall_mood ? `<div class="col-span-2"><span class="text-gray-600">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ:</span> <span class="font-medium">${dr.overall_mood}</span></div>` : ''}
                            ${dr.key_visual_elements?.length ? `<div class="col-span-2"><span class="text-gray-600">–ö–ª—é—á–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã:</span> ${dr.key_visual_elements.join(', ')}</div>` : ''}
                        </div>
                    </div>
                `;
            }

            // Slides (new format) or blocks (old format)
            const slides = data.slides || data.blocks || [];
            if (slides.length > 0) {
                content += `<div class="space-y-3">`;
                slides.forEach((slide, i) => {
                    const imgConcept = slide.image_concept || {};
                    const textLayout = slide.text_layout || {};
                    const bullets = slide.bullets && slide.bullets.length > 0 ? slide.bullets : null;

                    content += `
                        <div class="bg-white border-2 border-orange-200 rounded-lg overflow-hidden">
                            <div class="bg-gradient-to-r from-orange-500 to-pink-500 text-white px-4 py-2 flex justify-between items-center">
                                <span class="font-bold">–°–ª–∞–π–¥ ${slide.number || i+1}: ${slide.type || ''}</span>
                                <span class="text-xs opacity-75">1440x810px</span>
                            </div>
                            <div class="p-4">
                                <p class="text-lg font-bold text-gray-900 uppercase">${slide.title}</p>
                                ${slide.subtitle ? `<p class="text-gray-700 mt-1">${slide.subtitle}</p>` : ''}
                                ${bullets ? `
                                    <ul class="mt-2 space-y-1 text-sm text-gray-600">
                                        ${bullets.map(b => `<li class="flex items-start"><span class="mr-2 text-orange-500">‚Ä¢</span>${b}</li>`).join('')}
                                    </ul>
                                ` : ''}

                                ${imgConcept.main_object ? `
                                    <div class="mt-3 p-3 bg-gray-50 rounded-lg">
                                        <p class="text-xs font-bold text-gray-700 mb-2">–ö–û–ù–¶–ï–ü–¶–ò–Ø –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø:</p>
                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                            <div><span class="text-gray-500">–û–±—ä–µ–∫—Ç:</span> <span class="text-gray-800">${imgConcept.main_object}</span></div>
                                            ${imgConcept.background ? `<div><span class="text-gray-500">–§–æ–Ω:</span> <span class="text-gray-800">${imgConcept.background}</span></div>` : ''}
                                            ${imgConcept.composition ? `<div><span class="text-gray-500">–ö–æ–º–ø–æ–∑–∏—Ü–∏—è:</span> <span class="text-gray-800">${imgConcept.composition}</span></div>` : ''}
                                            ${imgConcept.mood ? `<div><span class="text-gray-500">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ:</span> <span class="text-gray-800">${imgConcept.mood}</span></div>` : ''}
                                        </div>
                                    </div>
                                ` : ''}

                                ${textLayout.title_position ? `
                                    <div class="mt-2 p-3 bg-blue-50 rounded-lg">
                                        <p class="text-xs font-bold text-blue-700 mb-2">–†–ê–°–ü–û–õ–û–ñ–ï–ù–ò–ï –¢–ï–ö–°–¢–ê:</p>
                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                            <div><span class="text-blue-600">–ü–æ–∑–∏—Ü–∏—è:</span> <span class="text-blue-800">${textLayout.title_position}</span></div>
                                            ${textLayout.title_color ? `<div><span class="text-blue-600">–¶–≤–µ—Ç:</span> <span class="text-blue-800">${textLayout.title_color}</span></div>` : ''}
                                            ${textLayout.text_background ? `<div class="col-span-2"><span class="text-blue-600">–ü–æ–¥–ª–æ–∂–∫–∞:</span> <span class="text-blue-800">${textLayout.text_background}</span></div>` : ''}
                                        </div>
                                    </div>
                                ` : ''}

                                ${slide.image_idea ? `<p class="mt-2 text-xs text-gray-400 italic">–ò–¥–µ—è: ${slide.image_idea}</p>` : ''}
                            </div>
                        </div>
                    `;
                });
                content += `</div>`;
            }

            // USP and target audience
            if (data.main_usp || data.main_message || data.target_audience) {
                content += `
                    <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                        ${data.main_usp || data.main_message ? `<p class="font-medium text-orange-800"><span class="font-bold">–£–¢–ü:</span> ${data.main_usp || data.main_message}</p>` : ''}
                        ${data.target_audience ? `<p class="text-sm text-orange-700 mt-1"><span class="font-bold">–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è:</span> ${data.target_audience}</p>` : ''}
                    </div>
                `;
            }

            content += '</div>';
            showModal('Rich –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è WB', content, false);
        } else {
            showModal('–û—à–∏–±–∫–∞', `<p class="text-red-600">${result.error}</p>`);
        }
    });

    // Full Optimize
    document.getElementById('aiFullOptimizeBtn')?.addEventListener('click', async function() {
        const result = await callAiEndpoint('/auto-import/ai/full-optimize', this);
        if (result.success) {
            const data = result.data;
            currentAiData = {
                title: data.seo_title?.title,
                keywords: data.keywords?.keywords,
                bullet_points: data.bullet_points?.bullet_points,
                description: data.enhanced_description?.description
            };

            let content = '<div class="space-y-4">';

            // Score
            if (data.analysis) {
                const score = data.analysis.score || 0;
                content += `
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <div class="text-3xl font-bold ${score >= 80 ? 'text-green-600' : score >= 60 ? 'text-yellow-600' : 'text-red-600'}">${score}/100</div>
                        <p class="text-sm text-gray-600">–û—Ü–µ–Ω–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏</p>
                    </div>
                `;
            }

            // SEO Title
            if (data.seo_title?.title) {
                content += `
                    <div class="bg-green-50 p-3 rounded-lg">
                        <h4 class="font-medium text-green-700 text-sm mb-1">SEO –∑–∞–≥–æ–ª–æ–≤–æ–∫:</h4>
                        <p class="text-green-800">${data.seo_title.title}</p>
                    </div>
                `;
            }

            // Keywords
            if (data.keywords?.keywords?.length) {
                content += `
                    <div>
                        <h4 class="font-medium text-gray-700 text-sm mb-1">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:</h4>
                        <div class="flex flex-wrap gap-1 max-h-24 overflow-y-auto">
                            ${data.keywords.keywords.slice(0, 20).map(k => `<span class="px-2 py-0.5 bg-purple-100 text-purple-800 text-xs rounded-full">${k}</span>`).join('')}
                            ${data.keywords.keywords.length > 20 ? `<span class="px-2 py-0.5 text-gray-500 text-xs">+${data.keywords.keywords.length - 20} –µ—â–µ</span>` : ''}
                        </div>
                    </div>
                `;
            }

            // Bullet points
            if (data.bullet_points?.bullet_points?.length) {
                content += `
                    <div>
                        <h4 class="font-medium text-gray-700 text-sm mb-1">–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:</h4>
                        <ul class="text-sm text-gray-600 space-y-1">
                            ${data.bullet_points.bullet_points.map(bp => `<li class="flex items-start"><span class="text-green-600 mr-1">‚úì</span>${bp.replace(/^[‚úì‚úî] ?/, '')}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Issues
            if (data.analysis?.issues?.length) {
                content += `
                    <div>
                        <h4 class="font-medium text-red-700 text-sm mb-1">–ü—Ä–æ–±–ª–µ–º—ã:</h4>
                        <ul class="text-sm space-y-1">
                            ${data.analysis.issues.slice(0, 3).map(i => `<li class="text-red-600">‚Ä¢ ${i.issue}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Errors
            if (data.errors?.length) {
                content += `
                    <div class="bg-yellow-50 p-3 rounded-lg">
                        <h4 class="font-medium text-yellow-700 text-sm mb-1">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:</h4>
                        <ul class="text-xs text-yellow-600">
                            ${data.errors.map(e => `<li>‚Ä¢ ${e}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            content += '</div>';
            showModal('–ü–æ–ª–Ω–∞—è AI-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è', content, true);
        } else {
            showModal('–û—à–∏–±–∫–∞', `<p class="text-red-600">${result.error}</p>`);
        }
    });

    // Apply changes
    applyBtn?.addEventListener('click', async function() {
        if (!currentAiData) return;

        showLoading(applyBtn, '–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ...');
        try {
            const response = await fetch('/auto-import/ai/apply', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    product_id: productId,
                    updates: currentAiData
                })
            });
            const result = await response.json();
            if (result.success) {
                alert(result.message || '–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!');
                window.location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + result.error);
            }
        } finally {
            hideLoading(applyBtn);
        }
    });

    // Close modal handlers
    closeModalBtn?.addEventListener('click', hideModal);
    cancelBtn?.addEventListener('click', hideModal);
    modal?.addEventListener('click', function(e) {
        if (e.target === modal) hideModal();
    });

    // Category Detection (aiCategoryBtn)
    document.getElementById('aiCategoryBtn')?.addEventListener('click', async function() {
        console.log('Category button clicked');
        const result = await callAiEndpoint('/auto-import/ai/detect-category', this);
        if (result.success) {
            currentAiData = { category: result.data.category_name, category_id: result.data.category_id };
            const confidencePercent = Math.round((result.data.confidence || 0) * 100);
            const confidenceColor = confidencePercent >= 80 ? 'green' : confidencePercent >= 60 ? 'yellow' : 'red';
            const content = `
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-medium text-gray-700 mb-2">–ò—Å—Ö–æ–¥–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è:</h4>
                        <p class="text-gray-600">${result.data.original_category || '‚Äî'}</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-medium text-green-700 mb-2">–û–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è WB:</h4>
                        <p class="text-green-800 font-medium">${result.data.category_name || '‚Äî'}</p>
                        <p class="text-xs text-gray-500 mt-1">ID: ${result.data.category_id || '‚Äî'}</p>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-${confidenceColor}-50 rounded-lg">
                        <span class="text-sm text-gray-700">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å AI:</span>
                        <div class="flex items-center gap-2">
                            <div class="w-24 bg-gray-200 rounded-full h-2">
                                <div class="bg-${confidenceColor}-500 h-2 rounded-full" style="width: ${confidencePercent}%"></div>
                            </div>
                            <span class="font-medium text-${confidenceColor}-700">${confidencePercent}%</span>
                        </div>
                    </div>
                    ${result.data.reasoning ? `
                    <div>
                        <h4 class="font-medium text-gray-700 mb-2">–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:</h4>
                        <p class="text-sm text-gray-600">${result.data.reasoning}</p>
                    </div>` : ''}
                    ${result.data.current_wb_category && result.data.current_wb_category !== result.data.category_name ? `
                    <div class="bg-yellow-50 p-3 rounded-lg">
                        <p class="text-sm text-yellow-700">–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ –±—ã–ª–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ —Ç–æ–≤–∞—Ä—É</p>
                    </div>` : ''}
                </div>
            `;
            showModal('–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ WB', content, false);
        } else {
            showModal('–û—à–∏–±–∫–∞', `<p class="text-red-600">${result.error}</p>`);
        }
    });

    // Sizes Parsing (aiSizesBtn)
    document.getElementById('aiSizesBtn')?.addEventListener('click', async function() {
        console.log('Sizes button clicked');
        const result = await callAiEndpoint('/auto-import/ai/parse-clothing-sizes', this);
        if (result.success) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
            currentAiData = {
                sizes: result.data,
                dimensions: result.data.dimensions,
                sizes_text: result.data.raw_text
            };
            let content = '<div class="space-y-4">';
            const data = result.data;

            // –¢–∏–ø —Ç–æ–≤–∞—Ä–∞
            const productTypeLabels = {
                'clothing': '–û–¥–µ–∂–¥–∞/–ë–µ–ª—å—ë',
                'physical': '–§–∏–∑–∏—á–µ—Å–∫–∏–π —Ç–æ–≤–∞—Ä',
                'unknown': '–ù–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω'
            };

            // –¢–∏–ø —Ä–∞–∑–º–µ—Ä–æ–≤ —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º
            const sizeTypeLabels = {
                'letter': '–ë—É–∫–≤–µ–Ω–Ω—ã–µ (S/M/L)',
                'numeric': '–ß–∏—Å–ª–æ–≤—ã–µ (42/44/46)',
                'combined': '–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ',
                'one_size': '–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä',
                'dimensions': '–§–∏–∑–∏—á–µ—Å–∫–∏–µ –≥–∞–±–∞—Ä–∏—Ç—ã'
            };

            const productType = data.product_type || 'unknown';
            const sizeTypeLabel = sizeTypeLabels[data.size_type] || data.size_type;

            content += `
                <div class="bg-blue-50 p-3 rounded-lg">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm text-gray-700">–¢–∏–ø —Ç–æ–≤–∞—Ä–∞:</span>
                        <span class="font-medium text-blue-700">${productTypeLabels[productType] || productType}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-700">–¢–∏–ø —Ä–∞–∑–º–µ—Ä–æ–≤:</span>
                        <span class="font-medium text-blue-700">${sizeTypeLabel}</span>
                    </div>
                </div>
            `;

            // –§–ò–ó–ò–ß–ï–°–ö–ò–ï –ì–ê–ë–ê–†–ò–¢–´
            const dims = data.dimensions;
            if (dims && (dims.length_cm || dims.width_cm || dims.height_cm || dims.diameter_cm || dims.working_length_cm || dims.weight_g || dims.volume_ml)) {
                content += `
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <h4 class="font-medium text-orange-700 mb-3">–§–∏–∑–∏—á–µ—Å–∫–∏–µ –≥–∞–±–∞—Ä–∏—Ç—ã:</h4>
                        <div class="grid grid-cols-2 gap-3">
                `;

                if (dims.length_cm) content += `<div class="bg-white p-2 rounded border"><span class="text-xs text-gray-500">–î–ª–∏–Ω–∞:</span><div class="font-medium">${dims.length_cm} —Å–º</div></div>`;
                if (dims.working_length_cm) content += `<div class="bg-white p-2 rounded border"><span class="text-xs text-gray-500">–†–∞–±–æ—á–∞—è –¥–ª–∏–Ω–∞:</span><div class="font-medium">${dims.working_length_cm} —Å–º</div></div>`;
                if (dims.width_cm) content += `<div class="bg-white p-2 rounded border"><span class="text-xs text-gray-500">–®–∏—Ä–∏–Ω–∞:</span><div class="font-medium">${dims.width_cm} —Å–º</div></div>`;
                if (dims.height_cm) content += `<div class="bg-white p-2 rounded border"><span class="text-xs text-gray-500">–í—ã—Å–æ—Ç–∞:</span><div class="font-medium">${dims.height_cm} —Å–º</div></div>`;
                if (dims.diameter_cm) content += `<div class="bg-white p-2 rounded border"><span class="text-xs text-gray-500">–î–∏–∞–º–µ—Ç—Ä:</span><div class="font-medium">${dims.diameter_cm} —Å–º</div></div>`;
                if (dims.weight_g) content += `<div class="bg-white p-2 rounded border"><span class="text-xs text-gray-500">–í–µ—Å:</span><div class="font-medium">${dims.weight_g} –≥</div></div>`;
                if (dims.volume_ml) content += `<div class="bg-white p-2 rounded border"><span class="text-xs text-gray-500">–û–±—ä—ë–º:</span><div class="font-medium">${dims.volume_ml} –º–ª</div></div>`;

                content += `
                        </div>
                    </div>
                `;
            }

            // –†–∞–∑–º–µ—Ä—ã –∏–∑ –º–∞—Å—Å–∏–≤–∞ sizes (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–¥–µ–∂–¥—ã, –Ω–µ –¥–ª—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤)
            if (data.sizes?.length > 0 && data.product_type !== 'physical') {
                content += `
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-medium text-green-700 mb-3">–†–∞–∑–º–µ—Ä—ã –æ–¥–µ–∂–¥—ã:</h4>
                        <div class="space-y-2">
                `;

                data.sizes.forEach(size => {
                    content += `
                        <div class="flex items-center justify-between bg-white p-2 rounded border border-green-200">
                            <div class="flex gap-3">
                                <span class="px-3 py-1 bg-green-200 text-green-800 rounded-full font-medium">${size.standardized || size.original}</span>
                                ${size.ru_size ? `<span class="px-2 py-1 bg-purple-100 text-purple-700 text-sm rounded">RU: ${size.ru_size}</span>` : ''}
                                ${size.international ? `<span class="px-2 py-1 bg-blue-100 text-blue-700 text-sm rounded">–ú–µ–∂–¥—É–Ω–∞—Ä: ${size.international}</span>` : ''}
                            </div>
                            ${size.original !== size.standardized ? `<span class="text-xs text-gray-400">–∏–∑: ${size.original}</span>` : ''}
                        </div>
                    `;
                });

                content += `
                        </div>
                    </div>
                `;
            }

            // –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
            if (data.raw_text) {
                content += `
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <h4 class="font-medium text-gray-700 mb-2">–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</h4>
                        <p class="text-sm text-gray-600">${data.raw_text}</p>
                    </div>
                `;
            }

            // –ú–µ—Ä–∫–∏ —Ç–µ–ª–∞ (–¥–ª—è –æ–¥–µ–∂–¥—ã)
            const measurements = data.body_measurements;
            if (measurements && (measurements.chest_cm || measurements.waist_cm || measurements.hips_cm)) {
                content += `
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h4 class="font-medium text-purple-700 mb-2">–†–∞–∑–º–µ—Ä—ã —Ç–µ–ª–∞ (—Å–º):</h4>
                        <div class="grid grid-cols-3 gap-2 text-sm">
                            ${measurements.chest_cm ? `<div class="text-center"><div class="text-xs text-gray-500">–ì—Ä—É–¥—å</div><div class="font-medium">${measurements.chest_cm}</div></div>` : ''}
                            ${measurements.waist_cm ? `<div class="text-center"><div class="text-xs text-gray-500">–¢–∞–ª–∏—è</div><div class="font-medium">${measurements.waist_cm}</div></div>` : ''}
                            ${measurements.hips_cm ? `<div class="text-center"><div class="text-xs text-gray-500">–ë—ë–¥—Ä–∞</div><div class="font-medium">${measurements.hips_cm}</div></div>` : ''}
                        </div>
                    </div>
                `;
            }

            // –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
            if (data.confidence) {
                const confPercent = Math.round(data.confidence * 100);
                content += `
                    <div class="flex items-center gap-2 text-xs text-gray-500 pt-2 border-t">
                        <span>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å AI:</span>
                        <div class="w-20 bg-gray-200 rounded-full h-1.5">
                            <div class="bg-green-500 h-1.5 rounded-full" style="width: ${confPercent}%"></div>
                        </div>
                        <span>${confPercent}%</span>
                    </div>
                `;
            }

            content += '</div>';
            showModal('–†–∞–∑–º–µ—Ä—ã —Ç–æ–≤–∞—Ä–∞', content, true);
        } else {
            showModal('–û—à–∏–±–∫–∞', `<p class="text-red-600">${result.error}</p>`);
        }
    });

    // Description Enhancement (aiDescriptionBtn)
    document.getElementById('aiDescriptionBtn')?.addEventListener('click', async function() {
        console.log('Description button clicked');
        const result = await callAiEndpoint('/auto-import/ai/enhance-description', this);
        if (result.success) {
            currentAiData = { description: result.data.description };
            const content = `
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-medium text-gray-700 mb-2">–¢–µ–∫—É—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</h4>
                        <p class="text-gray-600 text-sm max-h-32 overflow-y-auto">${result.original_description || '‚Äî'}</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-medium text-green-700 mb-2">–£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</h4>
                        <p class="text-green-800 whitespace-pre-line">${result.data.description || '‚Äî'}</p>
                    </div>
                    ${result.data.key_features?.length ? `
                    <div>
                        <h4 class="font-medium text-gray-700 mb-2">–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:</h4>
                        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                            ${result.data.key_features.map(f => `<li>${f}</li>`).join('')}
                        </ul>
                    </div>` : ''}
                    ${result.data.seo_keywords?.length ? `
                    <div>
                        <h4 class="font-medium text-gray-700 mb-2">SEO –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:</h4>
                        <div class="flex flex-wrap gap-1">
                            ${result.data.seo_keywords.map(k => `<span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full">${k}</span>`).join('')}
                        </div>
                    </div>` : ''}
                </div>
            `;
            showModal('–£–ª—É—á—à–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è', content, true);
        } else {
            showModal('–û—à–∏–±–∫–∞', `<p class="text-red-600">${result.error}</p>`);
        }
    });

    // WB Category Characteristics (aiWbCharsBtn)
    document.getElementById('aiWbCharsBtn')?.addEventListener('click', async function() {
        console.log('WB Characteristics button clicked');
        const result = await callAiEndpoint('/auto-import/ai/wb-category-characteristics', this);
        if (result.success) {
            const data = result.data;
            const wbChars = result.wb_characteristics || [];

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
            currentAiData = {
                dimensions: data.extracted_values,
                wb_characteristics: data.extracted_values
            };

            let content = '<div class="space-y-4">';

            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            content += `
                <div class="bg-orange-50 p-3 rounded-lg flex items-center justify-between">
                    <span class="text-sm text-gray-700">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–∑ WB API:</span>
                    <span class="font-medium text-orange-700">${wbChars.length} –Ω–∞–π–¥–µ–Ω–æ</span>
                </div>
            `;

            // –°–ø–∏—Å–æ–∫ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            if (wbChars.length > 0) {
                content += `
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-medium text-gray-700 mb-2">–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:</h4>
                        <div class="flex flex-wrap gap-1 max-h-32 overflow-y-auto">
                            ${wbChars.map(c => `
                                <span class="px-2 py-1 text-xs rounded ${c.required ? 'bg-red-100 text-red-700' : 'bg-gray-200 text-gray-700'}">
                                    ${c.name}${c.unit ? ` (${c.unit})` : ''}${c.required ? ' *' : ''}
                                </span>
                            `).join('')}
                        </div>
                        <p class="text-xs text-gray-500 mt-2">* –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</p>
                    </div>
                `;
            }

            // –ò–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            if (data.extracted_values && Object.keys(data.extracted_values).length > 0) {
                content += `
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-medium text-green-700 mb-3">–ò–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:</h4>
                        <div class="space-y-2">
                `;
                for (const [key, value] of Object.entries(data.extracted_values)) {
                    const isWeight = key.toLowerCase().includes('–≤–µ—Å') || key.toLowerCase().includes('–º–∞—Å—Å–∞');
                    content += `
                        <div class="flex items-center justify-between bg-white p-2 rounded border border-green-200">
                            <span class="text-sm text-gray-700">${key}</span>
                            <span class="font-medium ${isWeight ? 'text-orange-600' : 'text-green-700'}">${value}</span>
                        </div>
                    `;
                }
                content += `
                        </div>
                    </div>
                `;
            }

            // –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
            if (data.missing_required?.length > 0) {
                content += `
                    <div class="bg-red-50 p-4 rounded-lg">
                        <h4 class="font-medium text-red-700 mb-2">–ù–µ –Ω–∞–π–¥–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ:</h4>
                        <ul class="list-disc list-inside text-sm text-red-600">
                            ${data.missing_required.map(m => `<li>${m}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // –ü—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è AI
            if (data.suggestions && Object.keys(data.suggestions).length > 0) {
                content += `
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h4 class="font-medium text-yellow-700 mb-2">–ü—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è AI:</h4>
                        <div class="space-y-1 text-sm">
                `;
                for (const [key, value] of Object.entries(data.suggestions)) {
                    content += `<p><span class="font-medium">${key}:</span> ${value}</p>`;
                }
                content += `
                        </div>
                    </div>
                `;
            }

            // –ù–∞–π–¥–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ
            if (data.raw_found?.length > 0) {
                content += `
                    <div class="text-xs text-gray-500">
                        <span class="font-medium">–ù–∞–π–¥–µ–Ω–æ –≤ —Ç–µ–∫—Å—Ç–µ:</span> ${data.raw_found.join(', ')}
                    </div>
                `;
            }

            // –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∏ –∑–∞–ø–∞—Å –≤–µ—Å–∞
            content += `
                <div class="flex items-center justify-between text-xs text-gray-500 pt-2 border-t">
                    <span>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${Math.round((data.confidence || 0) * 100)}%</span>
                    <span>–ó–∞–ø–∞—Å –≤–µ—Å–∞: +${data.weight_margin_percent || 10}%</span>
                </div>
            `;

            content += '</div>';
            showModal('–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ WB', content, true);
        } else {
            showModal('–û—à–∏–±–∫–∞', `<p class="text-red-600">${result.error}</p>`);
        }
    });

    // Extract ALL Characteristics (aiAllCharsBtn)
    document.getElementById('aiAllCharsBtn')?.addEventListener('click', async function() {
        console.log('Extract ALL Characteristics button clicked');
        const result = await callAiEndpoint('/auto-import/ai/extract-all-characteristics', this);
        if (result.success) {
            const data = result.data;
            const stats = data.statistics || {};
            const reqChars = result.required_characteristics || [];
            const optChars = result.optional_characteristics || [];

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
            currentAiData = {
                all_characteristics: data.extracted_values,
                wb_characteristics: data.extracted_values
            };

            let content = '<div class="space-y-4">';

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
            const fillRate = stats.fill_rate || 0;
            const fillColor = fillRate >= 70 ? 'text-green-600' : fillRate >= 40 ? 'text-yellow-600' : 'text-red-600';
            content += `
                <div class="bg-gradient-to-r from-emerald-50 to-green-50 p-4 rounded-lg">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏:</span>
                        <span class="text-lg font-bold ${fillColor}">${fillRate}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-emerald-500 h-2 rounded-full" style="width: ${fillRate}%"></div>
                    </div>
                    <div class="mt-2 grid grid-cols-3 gap-2 text-xs text-gray-600">
                        <div class="text-center">
                            <div class="font-medium">${stats.extracted_count || 0}</div>
                            <div>–ó–∞–ø–æ–ª–Ω–µ–Ω–æ</div>
                        </div>
                        <div class="text-center">
                            <div class="font-medium text-red-600">${stats.required_count || 0}</div>
                            <div>–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö</div>
                        </div>
                        <div class="text-center">
                            <div class="font-medium">${stats.total_characteristics || 0}</div>
                            <div>–í—Å–µ–≥–æ</div>
                        </div>
                    </div>
                </div>
            `;

            // –ò–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            if (data.extracted_values && Object.keys(data.extracted_values).length > 0) {
                content += `
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-medium text-green-700 mb-3">–ò–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (${Object.keys(data.extracted_values).length}):</h4>
                        <div class="space-y-1 max-h-64 overflow-y-auto">
                `;
                for (const [key, value] of Object.entries(data.extracted_values)) {
                    const isRequired = reqChars.some(c => c.name === key);
                    content += `
                        <div class="flex items-center justify-between bg-white p-2 rounded border ${isRequired ? 'border-red-200' : 'border-green-200'}">
                            <span class="text-sm text-gray-700">${key}${isRequired ? ' *' : ''}</span>
                            <span class="font-medium text-green-700 text-right max-w-[50%] truncate" title="${value}">${value}</span>
                        </div>
                    `;
                }
                content += `
                        </div>
                        <p class="text-xs text-gray-500 mt-2">* –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</p>
                    </div>
                `;
            }

            // –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
            if (data.missing_required?.length > 0) {
                content += `
                    <div class="bg-red-50 p-4 rounded-lg">
                        <h4 class="font-medium text-red-700 mb-2">–ù–µ –Ω–∞–π–¥–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ (${data.missing_required.length}):</h4>
                        <ul class="list-disc list-inside text-sm text-red-600 max-h-24 overflow-y-auto">
                            ${data.missing_required.map(m => `<li>${m}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
            content += `
                <div class="flex items-center justify-between text-xs text-gray-500 pt-2 border-t">
                    <span>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å AI: ${Math.round((data.confidence || 0) * 100)}%</span>
                    <span>–ó–∞–ø–∞—Å –≤–µ—Å–∞: +${data.weight_margin_percent || 10}%</span>
                </div>
            `;

            content += '</div>';
            showModal('–í—Å–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ WB', content, true);
        } else {
            showModal('–û—à–∏–±–∫–∞', `<p class="text-red-600">${result.error}</p>`);
        }
    });

    // Apply AI Data to product (applyAiDataBtn)
    document.getElementById('applyAiDataBtn')?.addEventListener('click', async function() {
        console.log('Apply AI Data button clicked');

        if (!confirm('–ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ AI-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫ –∫–∞—Ä—Ç–æ—á–∫–µ —Ç–æ–≤–∞—Ä–∞? –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã.')) {
            return;
        }

        showLoading(this, '–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ...');

        try {
            // –°–Ω–∞—á–∞–ª–∞ –¥–µ–ª–∞–µ–º –ø–æ–ª–Ω—É—é –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é
            const optimizeResponse = await fetch('/auto-import/ai/full-optimize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_id: productId })
            });
            const optimizeResult = await optimizeResponse.json();

            if (!optimizeResult.success) {
                showModal('–û—à–∏–±–∫–∞', `<p class="text-red-600">${optimizeResult.error}</p>`);
                return;
            }

            const data = optimizeResult.data;
            const updates = {
                title: data.seo_title?.title,
                keywords: data.keywords?.keywords,
                bullet_points: data.bullet_points?.bullet_points,
                description: data.enhanced_description?.description
            };

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            const applyResponse = await fetch('/auto-import/ai/apply', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    product_id: productId,
                    updates: updates
                })
            });
            const applyResult = await applyResponse.json();

            if (applyResult.success) {
                alert('AI –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫ –∫–∞—Ä—Ç–æ—á–∫–µ!');
                window.location.reload();
            } else {
                showModal('–û—à–∏–±–∫–∞', `<p class="text-red-600">${applyResult.error}</p>`);
            }
        } catch (error) {
            console.error('Apply AI data error:', error);
            showModal('–û—à–∏–±–∫–∞', `<p class="text-red-600">${error.message}</p>`);
        } finally {
            hideLoading(this);
        }
    });

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è —Å–ª–∞–π–¥–æ–≤
    window.generateSlideImages = async function() {
        const btn = document.getElementById('generateSlideImagesBtn');
        if (!btn) return;

        const originalText = btn.innerHTML;
        btn.innerHTML = `
            <svg class="animate-spin w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            –ì–µ–Ω–µ—Ä–∞—Ü–∏—è... (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 1-2 –º–∏–Ω)
        `;
        btn.disabled = true;

        try {
            const response = await fetch('/auto-import/ai/generate-all-slide-images', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_id: productId })
            });
            const result = await response.json();

            if (result.success) {
                let content = `
                    <div class="mb-4 p-3 bg-green-50 rounded-lg">
                        <p class="text-green-700 font-medium">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ${result.successful} –∏–∑ ${result.total_slides} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</p>
                        <p class="text-xs text-gray-500 mt-1">–ü—Ä–æ–≤–∞–π–¥–µ—Ä: ${result.provider}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4 max-h-96 overflow-y-auto">
                `;

                result.results.forEach(r => {
                    if (r.success && r.image_base64) {
                        content += `
                            <div class="border rounded-lg overflow-hidden">
                                <img src="data:image/png;base64,${r.image_base64}" alt="–°–ª–∞–π–¥ ${r.slide_number}" class="w-full">
                                <div class="p-2 bg-gray-50 text-xs">
                                    <span class="font-medium">–°–ª–∞–π–¥ ${r.slide_number}</span>
                                    <span class="text-gray-500 ml-2">${r.slide_type}</span>
                                </div>
                            </div>
                        `;
                    } else {
                        content += `
                            <div class="border border-red-200 rounded-lg p-4 bg-red-50">
                                <p class="text-red-600 text-sm">–°–ª–∞–π–¥ ${r.slide_number}: ${r.error || '–û—à–∏–±–∫–∞'}</p>
                            </div>
                        `;
                    }
                });

                content += '</div>';
                showModal('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', content, false);
            } else {
                showModal('–û—à–∏–±–∫–∞', `<p class="text-red-600">${result.error}</p>`);
            }
        } catch (e) {
            showModal('–û—à–∏–±–∫–∞', `<p class="text-red-600">${e.message}</p>`);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    };

    // –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ª–∞–π–¥–æ–≤ Rich-–∫–æ–Ω—Ç–µ–Ω—Ç–∞
    window.viewRichContentSlides = function() {
        {% if product.ai_rich_content_data and product.ai_rich_content_data.slides %}
        const slides = {{ product.ai_rich_content_data.slides|tojson }};
        let content = '<div class="space-y-4">';

        slides.forEach((slide, i) => {
            const imgConcept = slide.image_concept || {};
            const textLayout = slide.text_layout || {};
            content += `
                <div class="border-2 border-orange-200 rounded-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-orange-500 to-pink-500 text-white px-4 py-2">
                        <span class="font-bold">–°–ª–∞–π–¥ ${slide.number || i+1}: ${slide.type || ''}</span>
                    </div>
                    <div class="p-4">
                        <p class="text-lg font-bold uppercase">${slide.title || ''}</p>
                        ${slide.subtitle ? `<p class="text-gray-600 mt-1">${slide.subtitle}</p>` : ''}
                        ${slide.bullets ? `<ul class="mt-2 text-sm">${slide.bullets.map(b => `<li>‚Ä¢ ${b}</li>`).join('')}</ul>` : ''}
                        ${imgConcept.main_object ? `
                            <div class="mt-3 p-3 bg-gray-50 rounded text-xs">
                                <p><strong>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</strong> ${imgConcept.main_object}</p>
                                ${imgConcept.background ? `<p><strong>–§–æ–Ω:</strong> ${imgConcept.background}</p>` : ''}
                                ${imgConcept.mood ? `<p><strong>–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ:</strong> ${imgConcept.mood}</p>` : ''}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        });

        content += '</div>';
        showModal('–°–ª–∞–π–¥—ã Rich-–∫–æ–Ω—Ç–µ–Ω—Ç–∞', content, false);
        {% else %}
        alert('–ù–µ—Ç —Å–ª–∞–π–¥–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
        {% endif %}
    };
})();
</script>
{% endblock %}
