{% extends "base.html" %}

{% block title %}Обогащение карточки — {{ product.title or product.vendor_code }}{% endblock %}

{% block content %}

{# ============================================================
   РЕЖИМ: нет данных поставщика — показываем форму ручного поиска
   ============================================================ #}
{% if not imported_product %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
<div x-data="supplierSearchApp({{ suggested_ext_id or 'null' }}, {{ product.id }})" class="max-w-2xl mx-auto">
  <div class="flex items-center gap-3 mb-6">
    <a href="{{ url_for('product_detail', product_id=product.id) }}"
       class="text-gray-400 hover:text-gray-600 transition-colors">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
      </svg>
    </a>
    <div>
      <h1 class="text-xl font-bold text-gray-900">Обогащение от поставщика</h1>
      <p class="text-sm text-gray-500">Артикул <span class="font-mono font-medium text-gray-700">{{ product.vendor_code }}</span></p>
    </div>
  </div>

  <!-- Блок "не найдено" -->
  <div class="bg-amber-50 border border-amber-200 rounded-xl p-6 mb-6">
    <div class="flex gap-3">
      <svg class="w-6 h-6 text-amber-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <div>
        <p class="font-semibold text-amber-800 text-sm">Данные поставщика не найдены автоматически</p>
        <p class="text-amber-700 text-xs mt-1">
          Эта карточка WB была создана без автоимпорта, или запись поставщика удалена.
          {% if suggested_ext_id %}
            Предполагаемый артикул поставщика: <span class="font-mono font-semibold">{{ suggested_ext_id }}</span>.
          {% endif %}
          Введите артикул ниже чтобы найти и привязать данные поставщика вручную.
        </p>
      </div>
    </div>
  </div>

  <!-- Форма поиска -->
  <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
    <h2 class="font-semibold text-gray-900 text-base mb-4">Найти товар поставщика</h2>
    <div class="flex gap-3 mb-4">
      <input x-model="searchQuery"
             @keydown.enter="search()"
             type="text"
             placeholder="Артикул поставщика или название (например: 25268)"
             class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
      <button @click="search()" :disabled="loading"
              class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 transition-colors flex items-center gap-2 disabled:opacity-50">
        <svg x-show="loading" class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"/>
        </svg>
        <svg x-show="!loading" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        Найти
      </button>
    </div>

    <!-- Результаты поиска -->
    <div x-show="searched && results.length === 0" class="text-center py-8 text-gray-400 text-sm">
      Ничего не найдено. Попробуйте другой артикул или сначала импортируйте товар через автоимпорт.
    </div>
    <div x-show="results.length > 0" class="space-y-2 max-h-96 overflow-y-auto">
      <template x-for="r in results" :key="r.id">
        <div class="flex items-center justify-between p-3 rounded-lg border border-gray-200 hover:border-indigo-300 hover:bg-indigo-50/40 transition-colors cursor-pointer"
             @click="linkSupplier(r.id)">
          <div class="min-w-0 flex-1">
            <div class="flex items-center gap-2 mb-0.5">
              <span class="font-mono text-xs text-gray-500" x-text="r.external_id"></span>
              <span x-show="r.source_type" class="text-xs bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded" x-text="r.source_type"></span>
              <span x-show="r.already_linked" class="text-xs bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded">привязан</span>
              <span x-show="!r.has_data" class="text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded">мало данных</span>
            </div>
            <p class="text-sm font-medium text-gray-900 truncate" x-text="r.title"></p>
            <p class="text-xs text-gray-500 mt-0.5">
              <span x-show="r.brand" x-text="r.brand + ' · '"></span>
              <span x-text="r.photo_count + ' фото'"></span>
            </p>
          </div>
          <button @click.stop="linkSupplier(r.id)"
                  class="ml-3 px-3 py-1.5 text-xs font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors flex-shrink-0">
            Использовать
          </button>
        </div>
      </template>
    </div>
  </div>
</div>
</div>

<script>
function supplierSearchApp(suggestedId, productId) {
    return {
        searchQuery: suggestedId ? String(suggestedId) : '',
        loading: false,
        searched: false,
        results: [],

        async init() {
            if (this.searchQuery) {
                await this.search();
            }
        },

        async search() {
            if (!this.searchQuery.trim()) return;
            this.loading = true;
            this.searched = false;
            try {
                const resp = await fetch(`/api/enrich/search-supplier?q=${encodeURIComponent(this.searchQuery.trim())}`);
                const data = await resp.json();
                this.results = data.results || [];
                this.searched = true;
            } catch(e) {
                this.results = [];
            } finally {
                this.loading = false;
            }
        },

        linkSupplier(supplierId) {
            window.location.href = `/products/${productId}/enrich?supplier_id=${supplierId}`;
        }
    }
}
</script>

{% else %}
{# ============================================================
   РЕЖИМ: данные поставщика найдены — показываем сравнение
   ============================================================ #}
<div x-data="enrichApp()" x-cloak class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

  <!-- ===== ШАПКА ===== -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <div class="flex items-center gap-3">
      <a href="{{ url_for('product_detail', product_id=product.id) }}"
         class="text-gray-400 hover:text-gray-600 transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </svg>
      </a>
      <div>
        <h1 class="text-xl font-bold text-gray-900">Обогащение от поставщика</h1>
        <p class="text-sm text-gray-500 mt-0.5">
          <span class="font-mono font-medium text-gray-700">{{ product.vendor_code }}</span>
          <span class="mx-1.5 text-gray-300">|</span>
          <span class="text-indigo-600 font-medium">{{ imported_product.source_type or 'Поставщик' }}</span>
          <span class="text-gray-400">#{{ imported_product.external_id }}</span>
        </p>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <button @click="selectAllChanged()" type="button"
              class="px-3 py-2 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
        <span x-text="allSelected ? 'Снять всё' : 'Выбрать всё'"></span>
      </button>
      <button @click="applyEnrichment()" :disabled="loading || selectedCount === 0"
              :class="{'opacity-50 cursor-not-allowed': loading || selectedCount === 0}"
              type="button"
              class="px-5 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2 shadow-sm">
        <svg x-show="loading" class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"/>
        </svg>
        <span x-text="loading ? 'Применяю...' : `Применить (${selectedCount})`"></span>
      </button>
    </div>
  </div>

  <!-- ===== TOAST ===== -->
  <div x-show="toast.show" x-transition
       :class="toast.success ? 'bg-green-50 border-green-400 text-green-800' : 'bg-red-50 border-red-400 text-red-800'"
       class="mb-4 px-4 py-3 rounded-lg border flex items-center gap-3">
    <svg x-show="toast.success" class="w-5 h-5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
    <svg x-show="!toast.success" class="w-5 h-5 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
    <span x-text="toast.message" class="text-sm font-medium"></span>
  </div>

  {% if low_data %}
  <div class="mb-4 bg-amber-50 border border-amber-200 rounded-xl px-4 py-3 flex items-start gap-3">
    <svg class="w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
    <div>
      <p class="text-sm font-semibold text-amber-800">Данных от поставщика немного</p>
      <p class="text-xs text-amber-700 mt-0.5">
        Для этого товара есть только базовая информация — фото, описание и характеристики не загружены.
      </p>
    </div>
  </div>
  {% endif %}

  <!-- ===== КАРТОЧКИ ПОЛЕЙ ===== -->
  <div class="space-y-4">

    <!-- ==================== ФОТОГРАФИИ ==================== -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
      <div class="flex items-center justify-between px-5 py-3.5 border-b border-gray-100 bg-gray-50/80">
        <div class="flex items-center gap-3">
          <label class="flex items-center gap-2.5 cursor-pointer">
            <input type="checkbox" x-model="selected.photos"
                   class="w-4 h-4 rounded text-indigo-600 border-gray-300 focus:ring-indigo-500">
            <span class="font-semibold text-gray-800 text-sm">Фотографии</span>
          </label>
          <div class="flex items-center gap-1.5 text-xs text-gray-500">
            <span class="bg-gray-100 px-2 py-0.5 rounded-full">WB: {{ preview.photos.current_count }}</span>
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>
            <span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full">Поставщик: {{ preview.photos.supplier_photos | length }}</span>
          </div>
        </div>
        <div x-show="selected.photos" x-transition class="flex items-center gap-2">
          <span class="text-xs text-gray-500">Стратегия:</span>
          <select x-model="photoStrategy"
                  class="text-xs border border-gray-300 rounded-lg px-2 py-1.5 bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            <option value="replace">Заменить все</option>
            <option value="append">Добавить к текущим</option>
            <option value="only_if_empty">Только если нет фото</option>
          </select>
        </div>
      </div>

      <div class="p-5">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Текущие фото WB -->
          <div>
            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">Текущие фото WB</p>
            <div class="grid grid-cols-4 gap-2">
              {% for i in range(1, 8) %}
                <div class="aspect-square rounded-lg bg-gray-50 border border-gray-200 overflow-hidden flex items-center justify-center relative group">
                  {% if product.nm_id %}
                  <img src="{{ wb_photo_url(product.nm_id, i) }}"
                       onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"
                       class="w-full h-full object-cover"
                       loading="lazy">
                  <div class="w-full h-full hidden items-center justify-center absolute inset-0">
                    <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                  </div>
                  {% else %}
                  <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                  {% endif %}
                  <span class="absolute bottom-0.5 right-0.5 text-[10px] text-gray-400 bg-white/80 px-1 rounded">{{ i }}</span>
                </div>
              {% endfor %}
            </div>
          </div>

          <!-- Фото от поставщика -->
          <div>
            <p class="text-xs font-semibold text-indigo-600 uppercase tracking-wide mb-3">Фото поставщика</p>
            {% if preview.photos.supplier_photos %}
              <div class="grid grid-cols-4 gap-2">
                {% for photo in preview.photos.supplier_photos %}
                  <div class="aspect-square rounded-lg overflow-hidden border border-gray-200 bg-gray-100 relative group cursor-pointer"
                       @click="openLightbox('/api/enrich/photo-proxy/{{ imported_product.id }}/{{ loop.index0 }}')">
                    <img src="/api/enrich/photo-proxy/{{ imported_product.id }}/{{ loop.index0 }}"
                         class="w-full h-full object-cover transition-transform group-hover:scale-105"
                         loading="lazy"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <div class="w-full h-full hidden items-center justify-center absolute inset-0 bg-gray-100">
                      <div class="text-center">
                        <svg class="w-5 h-5 text-gray-300 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span class="text-[10px] text-gray-400 mt-0.5 block">Загрузка...</span>
                      </div>
                    </div>
                    <!-- Оверлей с зумом -->
                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors flex items-center justify-center">
                      <svg class="w-5 h-5 text-white opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
                      </svg>
                    </div>
                    <span class="absolute bottom-0.5 right-0.5 text-[10px] text-white bg-black/50 px-1 rounded">{{ loop.index }}</span>
                    {% if photo.cached %}
                    <span class="absolute top-0.5 left-0.5 w-2 h-2 bg-green-400 rounded-full" title="Закэшировано"></span>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="flex items-center justify-center h-20 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                <p class="text-sm text-gray-400">Нет фото от поставщика</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== ЗАГОЛОВОК ==================== -->
    {% if preview.title.supplier %}
    <div class="bg-white rounded-xl border shadow-sm overflow-hidden
                {{ 'border-indigo-200' if preview.title.has_change else 'border-gray-200' }}">
      <div class="flex items-center justify-between px-5 py-3.5 border-b border-gray-100 bg-gray-50/80">
        <label class="flex items-center gap-2.5 cursor-pointer">
          <input type="checkbox" x-model="selected.title"
                 class="w-4 h-4 rounded text-indigo-600 border-gray-300 focus:ring-indigo-500">
          <span class="font-semibold text-gray-800 text-sm">Заголовок</span>
        </label>
        {% if preview.title.has_change %}
          <span class="text-xs text-indigo-600 bg-indigo-50 px-2.5 py-0.5 rounded-full font-medium">Отличается</span>
        {% else %}
          <span class="text-xs text-gray-400 bg-gray-100 px-2.5 py-0.5 rounded-full">Совпадает</span>
        {% endif %}
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-gray-100 text-sm">
        <div class="p-4">
          <p class="text-xs font-semibold text-gray-400 uppercase mb-2">Текущий WB</p>
          <p class="text-gray-800 leading-relaxed">{{ preview.title.current or '—' }}</p>
          <p class="text-xs text-gray-400 mt-1">{{ (preview.title.current or '') | length }} / 60 символов</p>
        </div>
        <div class="p-4 {{ 'bg-indigo-50/30' if preview.title.has_change }}">
          <p class="text-xs font-semibold text-indigo-500 uppercase mb-2">От поставщика</p>
          <p class="text-gray-900 font-medium leading-relaxed">{{ preview.title.supplier }}</p>
          <p class="text-xs text-gray-400 mt-1">{{ (preview.title.supplier or '') | length }} / 60 символов</p>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- ==================== БРЕНД ==================== -->
    {% if preview.brand.supplier %}
    <div class="bg-white rounded-xl border shadow-sm overflow-hidden
                {{ 'border-indigo-200' if preview.brand.has_change else 'border-gray-200' }}">
      <div class="flex items-center justify-between px-5 py-3.5 border-b border-gray-100 bg-gray-50/80">
        <label class="flex items-center gap-2.5 cursor-pointer">
          <input type="checkbox" x-model="selected.brand"
                 class="w-4 h-4 rounded text-indigo-600 border-gray-300 focus:ring-indigo-500">
          <span class="font-semibold text-gray-800 text-sm">Бренд</span>
        </label>
        {% if preview.brand.has_change %}
          <span class="text-xs text-amber-600 bg-amber-50 px-2.5 py-0.5 rounded-full font-medium">Отличается (осторожно!)</span>
        {% else %}
          <span class="text-xs text-gray-400 bg-gray-100 px-2.5 py-0.5 rounded-full">Совпадает</span>
        {% endif %}
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-gray-100 text-sm">
        <div class="p-4">
          <p class="text-xs font-semibold text-gray-400 uppercase mb-2">Текущий WB</p>
          <p class="text-gray-800">{{ preview.brand.current or '—' }}</p>
        </div>
        <div class="p-4 {{ 'bg-amber-50/30' if preview.brand.has_change }}">
          <p class="text-xs font-semibold text-indigo-500 uppercase mb-2">От поставщика</p>
          <p class="text-gray-900 font-medium">{{ preview.brand.supplier }}</p>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- ==================== ОПИСАНИЕ ==================== -->
    {% if preview.description.supplier %}
    <div class="bg-white rounded-xl border shadow-sm overflow-hidden
                {{ 'border-indigo-200' if preview.description.has_change else 'border-gray-200' }}">
      <div class="flex items-center justify-between px-5 py-3.5 border-b border-gray-100 bg-gray-50/80">
        <label class="flex items-center gap-2.5 cursor-pointer">
          <input type="checkbox" x-model="selected.description"
                 class="w-4 h-4 rounded text-indigo-600 border-gray-300 focus:ring-indigo-500">
          <span class="font-semibold text-gray-800 text-sm">Описание</span>
        </label>
        {% if preview.description.has_change %}
          <span class="text-xs text-indigo-600 bg-indigo-50 px-2.5 py-0.5 rounded-full font-medium">Отличается</span>
        {% endif %}
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-gray-100 text-sm">
        <div class="p-4">
          <p class="text-xs font-semibold text-gray-400 uppercase mb-2">Текущее WB</p>
          <div class="max-h-52 overflow-y-auto">
            <p class="text-gray-700 whitespace-pre-line leading-relaxed text-xs">{{ preview.description.current or '—' }}</p>
          </div>
        </div>
        <div class="p-4 {{ 'bg-indigo-50/30' if preview.description.has_change }}">
          <p class="text-xs font-semibold text-indigo-500 uppercase mb-2">От поставщика</p>
          <div class="max-h-52 overflow-y-auto">
            <p class="text-gray-900 whitespace-pre-line leading-relaxed text-xs">{{ preview.description.supplier }}</p>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- ==================== ХАРАКТЕРИСТИКИ ==================== -->
    {% if preview.characteristics.has_change %}
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
      <div class="flex items-center justify-between px-5 py-3.5 border-b border-gray-100 bg-gray-50/80">
        <label class="flex items-center gap-2.5 cursor-pointer">
          <input type="checkbox" x-model="selected.characteristics"
                 class="w-4 h-4 rounded text-indigo-600 border-gray-300 focus:ring-indigo-500">
          <span class="font-semibold text-gray-800 text-sm">Характеристики</span>
        </label>
        <span class="text-xs text-indigo-600 bg-indigo-50 px-2.5 py-0.5 rounded-full font-medium">
          WB: {{ preview.characteristics.current | length }} · Поставщик: {{ preview.characteristics.supplier_parsed | length }}
        </span>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-gray-100 text-sm">
        <div class="p-4">
          <p class="text-xs font-semibold text-gray-400 uppercase mb-3">Текущие WB</p>
          <div class="max-h-72 overflow-y-auto space-y-0.5">
            {% if preview.characteristics.current %}
              {% for char in preview.characteristics.current %}
                <div class="flex items-start gap-2 py-1.5 border-b border-gray-50 last:border-0">
                  <span class="text-gray-500 text-xs min-w-0 flex-1 break-words">{{ char.get('name', char.get('id', '')) }}</span>
                  <span class="text-gray-800 text-xs text-right flex-shrink-0 max-w-[50%] break-words">{{ char.get('value', '') | format_char_value }}</span>
                </div>
              {% endfor %}
            {% else %}
              <p class="text-gray-400 italic text-xs">Нет характеристик</p>
            {% endif %}
          </div>
        </div>
        <div class="p-4 bg-indigo-50/20">
          <p class="text-xs font-semibold text-indigo-500 uppercase mb-3">От поставщика</p>
          <div class="max-h-72 overflow-y-auto space-y-0.5">
            {% if preview.characteristics.supplier_parsed %}
              {% for char in preview.characteristics.supplier_parsed %}
                <div class="flex items-start gap-2 py-1.5 border-b border-indigo-100/50 last:border-0">
                  <span class="text-indigo-700 text-xs min-w-0 flex-1 break-words font-medium">{{ char.name }}</span>
                  <span class="text-gray-800 text-xs text-right flex-shrink-0 max-w-[50%] break-words">{{ char.value }}</span>
                </div>
              {% endfor %}
            {% else %}
              <p class="text-gray-400 italic text-xs">Данные не распознаны</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- ==================== ГАБАРИТЫ ==================== -->
    {% if preview.dimensions.has_change and preview.dimensions.supplier %}
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
      <div class="flex items-center justify-between px-5 py-3.5 border-b border-gray-100 bg-gray-50/80">
        <label class="flex items-center gap-2.5 cursor-pointer">
          <input type="checkbox" x-model="selected.dimensions"
                 class="w-4 h-4 rounded text-indigo-600 border-gray-300 focus:ring-indigo-500">
          <span class="font-semibold text-gray-800 text-sm">Габариты</span>
        </label>
        <span class="text-xs text-indigo-600 bg-indigo-50 px-2.5 py-0.5 rounded-full">Новые данные</span>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-gray-100 text-sm">
        <div class="p-4">
          <p class="text-xs font-semibold text-gray-400 uppercase mb-2">Текущие WB</p>
          {% if preview.dimensions.current %}
            <div class="space-y-1 text-xs">
              {% for k, v in preview.dimensions.current.items() %}
                <div class="flex justify-between py-0.5">
                  <span class="text-gray-500">{{ k }}</span>
                  <span class="font-medium text-gray-800">{{ v }}</span>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-gray-400 italic text-xs">Нет данных</p>
          {% endif %}
        </div>
        <div class="p-4 bg-indigo-50/20">
          <p class="text-xs font-semibold text-indigo-500 uppercase mb-2">От поставщика</p>
          <div class="space-y-1 text-xs">
            {% for k, v in preview.dimensions.supplier.items() %}
              <div class="flex justify-between py-0.5">
                <span class="text-gray-500">{{ k }}</span>
                <span class="font-semibold text-indigo-700">{{ v }}</span>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    {% endif %}

  </div><!-- end space-y -->

  <!-- ===== НИЖНЯЯ ПАНЕЛЬ ===== -->
  <div class="sticky bottom-0 mt-6 bg-white/95 backdrop-blur-sm border-t border-gray-200 px-6 py-4 flex items-center justify-between shadow-lg rounded-t-xl -mx-4 sm:-mx-6 lg:-mx-8">
    <div class="text-sm text-gray-500">
      Выбрано: <span class="font-semibold text-gray-900" x-text="selectedCount"></span> поля(ей)
      <span x-show="lastResult" class="ml-3 text-green-600 font-medium" x-text="lastResult"></span>
    </div>
    <div class="flex items-center gap-3">
      <a href="{{ url_for('product_detail', product_id=product.id) }}"
         class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
        Отмена
      </a>
      <button @click="applyEnrichment()" :disabled="loading || selectedCount === 0"
              :class="{'opacity-50 cursor-not-allowed': loading || selectedCount === 0}"
              class="px-6 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2 shadow-sm">
        <svg x-show="loading" class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"/>
        </svg>
        <span x-text="loading ? 'Применяю...' : `Применить (${selectedCount})`"></span>
      </button>
    </div>
  </div>

  <!-- ===== LIGHTBOX ===== -->
  <div x-show="lightbox.show" x-transition.opacity
       class="fixed inset-0 z-[100] bg-black/80 flex items-center justify-center p-4"
       @click="lightbox.show = false"
       @keydown.escape.window="lightbox.show = false">
    <div class="relative max-w-4xl max-h-[90vh]" @click.stop>
      <img :src="lightbox.url" class="max-w-full max-h-[85vh] object-contain rounded-lg shadow-2xl">
      <button @click="lightbox.show = false"
              class="absolute -top-3 -right-3 w-8 h-8 bg-white rounded-full shadow-lg flex items-center justify-center text-gray-600 hover:text-gray-900">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
function enrichApp() {
    return {
        loading: false,
        photoStrategy: 'replace',
        selected: {
            photos: {{ 'true' if preview.photos.has_change else 'false' }},
            title: {{ 'true' if preview.title.has_change else 'false' }},
            brand: false,
            description: {{ 'true' if preview.description.has_change else 'false' }},
            characteristics: {{ 'true' if preview.characteristics.has_change else 'false' }},
            dimensions: {{ 'true' if preview.dimensions.has_change else 'false' }},
        },
        toast: { show: false, success: false, message: '' },
        lastResult: '',
        lightbox: { show: false, url: '' },

        get selectedCount() {
            return Object.values(this.selected).filter(Boolean).length;
        },

        get allSelected() {
            return Object.values(this.selected).every(Boolean);
        },

        selectAllChanged() {
            const newVal = !this.allSelected;
            Object.keys(this.selected).forEach(k => this.selected[k] = newVal);
        },

        openLightbox(url) {
            this.lightbox = { show: true, url };
        },

        showToast(success, message) {
            this.toast = { show: true, success, message };
            setTimeout(() => this.toast.show = false, 5000);
        },

        async applyEnrichment() {
            if (this.selectedCount === 0 || this.loading) return;
            this.loading = true;

            const fields = Object.entries(this.selected)
                .filter(([k, v]) => v)
                .map(([k]) => k);

            try {
                const resp = await fetch('/api/products/{{ product.id }}/enrich/apply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fields,
                        photo_strategy: this.photoStrategy,
                        supplier_id: {{ imported_product.id }}
                    })
                });

                const data = await resp.json();

                if (resp.ok && data.success) {
                    const applied = (data.fields_applied || []).join(', ');
                    this.showToast(true, `Обогащение применено: ${applied || 'без изменений'}`);
                    this.lastResult = `Обогащено: ${applied}`;

                    setTimeout(() => {
                        window.location.href = '/products/{{ product.id }}';
                    }, 2000);
                } else {
                    const msg = data.error || 'Неизвестная ошибка';
                    this.showToast(false, `Ошибка: ${msg}`);
                }
            } catch (e) {
                this.showToast(false, `Ошибка сети: ${e.message}`);
            } finally {
                this.loading = false;
            }
        }
    }
}
</script>
{% endif %}
{% endblock %}
