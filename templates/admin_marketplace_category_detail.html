{% extends "base.html" %}

{% block title %}Характеристики: {{ category.subject_name }} - WB Seller Platform{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" x-data="characteristicsEditor()">
    <!-- Header -->
    <div class="mb-6 flex justify-between items-center">
        <div>
            <nav class="flex mb-3" aria-label="Breadcrumb">
                <ol class="flex items-center space-x-2 text-sm text-gray-500">
                    <li><a href="{{ url_for('marketplaces.index') }}" class="hover:text-gray-900">Маркетплейсы</a></li>
                    <li><svg class="h-4 w-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                clip-rule="evenodd" />
                        </svg></li>
                    <li><a href="{{ url_for('marketplaces.categories', marketplace_id=category.marketplace_id) }}"
                            class="hover:text-gray-900">Категории</a></li>
                    <li><svg class="h-4 w-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                clip-rule="evenodd" />
                        </svg></li>
                    <li class="font-medium text-gray-900">{{ category.subject_name }}</li>
                </ol>
            </nav>
            <h1 class="text-3xl font-bold text-gray-900">{{ category.subject_name }}</h1>
            <p class="text-sm text-gray-500 mt-1">Настройка характеристик и генерации AI ({{ characteristics|length }}
                шт.)</p>
        </div>
        <form method="POST" action="{{ url_for('marketplaces.sync_characteristics', category_id=category.id) }}">
            <button type="submit"
                class="inline-flex items-center border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 px-4 py-2">
                <svg class="h-4 w-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Синхронизировать
            </button>
        </form>
    </div>

    <!-- Alert / Toast -->
    <div x-show="toast.show" x-transition x-cloak
        class="mb-4 bg-green-50 border border-green-200 text-green-800 rounded-lg p-4 flex items-center justify-between">
        <span x-text="toast.message"></span>
        <button @click="toast.show = false"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg></button>
    </div>

    <!-- Details Table -->
    <div class="bg-white shadow-sm rounded-lg border border-gray-200">
        <table class="min-w-full divide-y divide-gray-200 table-fixed">
            <thead class="bg-gray-50">
                <tr>
                    <th class="w-12 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Вкл
                    </th>
                    <th class="w-1/4 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Характеристика</th>
                    <th class="w-1/6 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Тип
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AI
                        Инструкция (кастомная)</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for charc in characteristics %}
                <tr class="{% if not charc.is_enabled %}opacity-60 bg-gray-50{% else %}bg-white{% endif %} transition-opacity"
                    :class="{'opacity-60 bg-gray-50': !isEnabled({{ charc.id }})}">
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <input type="checkbox" {% if charc.required %}disabled{% endif %}
                            :checked="isEnabled({{ charc.id }})"
                            @change="toggleEnabled({{ charc.id }}, $event.target.checked)"
                            class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded {% if charc.required %}cursor-not-allowed opacity-50{% endif %}">
                    </td>
                    <td class="px-6 py-4 text-sm whitespace-normal">
                        <div class="font-medium text-gray-900">{{ charc.name }}</div>
                        <div class="mt-1 flex items-center space-x-2">
                            {% if charc.required %}
                            <span
                                class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-red-100 text-red-800">Обяз.</span>
                            {% endif %}
                            {% if charc.unit_name %}
                            <span class="text-xs text-gray-500">({{ charc.unit_name }})</span>
                            {% endif %}
                        </div>
                    </td>
                    <td class="px-6 py-4 text-xs text-gray-500">
                        <div>
                            {% if charc.charc_type == 4 %}
                            Число (Number)
                            {% elif charc.charc_type == 0 and charc.max_count == 1 %}
                            Строка (String)
                            {% else %}
                            Словарь (Макс. {{ charc.max_count }})
                            {% endif %}
                        </div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900 relative group">
                        <!-- AI Instruction Editor -->
                        <textarea x-model="instructions[{{ charc.id }}]" @blur="saveInstruction({{ charc.id }})"
                            rows="1"
                            class="w-full border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 sm:text-xs resize-y"
                            placeholder="По умолчанию (если пусто) будет выведено значение или сгенерирована стандартная инструкция."></textarea>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function characteristicsEditor() {
        return {
            enabledStates: {
            {% for charc in characteristics %}
        "{{ charc.id }}": { { 'true' if charc.is_enabled else 'false' } },
        {% endfor %}
    },
    instructions: {
        {% for charc in characteristics %}
        "{{ charc.id }}": `{{ charc.ai_instruction or '' }}`,
            {% endfor %}
        },
    toast: { show: false, message: '' },

    isEnabled(id) {
        return this.enabledStates[id] || false;
    },
        
        async toggleEnabled(id, state) {
        this.enabledStates[id] = state;
        await this.updateApi(id, { is_enabled: state });
        this.showToast('Статус сохранен');
    },
        
        async saveInstruction(id) {
        await this.updateApi(id, { ai_instruction: this.instructions[id] });
        this.showToast('Инструкция сохранена');
    },
        
        async updateApi(id, payload) {
        try {
            const res = await fetch(`/admin/marketplaces/characteristics/${id}/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('API Error');
        } catch (err) {
            console.error(err);
            alert('Ошибка сохранения');
        }
    },

    showToast(msg) {
        this.toast.message = msg;
        this.toast.show = true;
        setTimeout(() => { this.toast.show = false; }, 3000);
    }
    }
}
</script>
{% endblock %}