{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="mb-6 flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                <svg class="w-8 h-8 inline-block mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
                –£–º–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è
            </h1>
            <p class="text-gray-600 dark:text-gray-400 mt-1">
                –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫–∞—Ä—Ç–æ—á–µ–∫ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ö–æ–∂–µ—Å—Ç–∏
            </p>
        </div>
        <div class="flex gap-3">
            <a href="{{ url_for('products_merge') }}"
               class="inline-flex items-center px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                –ù–∞–∑–∞–¥ –∫ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—é
            </a>
        </div>
    </div>

    <!-- –ò–Ω—Ñ–æ-–ø–∞–Ω–µ–ª—å -->
    <div class="bg-gradient-to-r from-purple-50 to-indigo-50 dark:from-purple-900/30 dark:to-indigo-900/30 border-l-4 border-purple-500 p-6 mb-6 rounded-r-lg">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <svg class="h-6 w-6 text-purple-600 dark:text-purple-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <div class="ml-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
                    –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏?
                </h3>
                <p class="text-sm text-gray-700 dark:text-gray-200 mb-2">
                    –ê–ª–≥–æ—Ä–∏—Ç–º –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–∞—à–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ –Ω–∞—Ö–æ–¥–∏—Ç –ø–æ—Ö–æ–∂–∏–µ —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–æ–∏—Ç –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –ø–æ–¥ –æ–¥–Ω–∏–º imtID. –£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è:
                </p>
                <ul class="text-sm text-gray-700 dark:text-gray-200 space-y-1 ml-4">
                    <li>‚Ä¢ <strong>–ë—Ä–µ–Ω–¥</strong> - –∫–∞—Ä—Ç–æ—á–∫–∏ –æ–¥–Ω–æ–≥–æ –±—Ä–µ–Ω–¥–∞</li>
                    <li>‚Ä¢ <strong>–ù–∞–∑–≤–∞–Ω–∏–µ</strong> - –ø–æ—Ö–æ–∂–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è (–∏–≥–Ω–æ—Ä–∏—Ä—É—è —Ä–∞–∑–º–µ—Ä—ã –∏ —Ü–≤–µ—Ç–∞)</li>
                    <li>‚Ä¢ <strong>–ê—Ä—Ç–∏–∫—É–ª—ã</strong> - –ø–æ—Ö–æ–∂–∏–µ –∏–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –±–∞–∑–æ–≤—ã–µ –∞—Ä—Ç–∏–∫—É–ª—ã</li>
                    <li>‚Ä¢ <strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</strong> - —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</li>
                </ul>
                <p class="text-sm text-gray-800 dark:text-gray-100 mt-3 font-medium">
                    üí° –ß–µ–º –≤—ã—à–µ –æ—Ü–µ–Ω–∫–∞ —Å—Ö–æ–∂–µ—Å—Ç–∏ (score), —Ç–µ–º —É–≤–µ—Ä–µ–Ω–Ω–µ–µ –∞–ª–≥–æ—Ä–∏—Ç–º –≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏!
                </p>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 bg-purple-100 dark:bg-purple-900 rounded-lg">
                    <svg class="w-8 h-8 text-purple-600 dark:text-purple-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-600 dark:text-gray-400">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–∞–π–¥–µ–Ω–æ</p>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ total_recommendations }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 bg-indigo-100 dark:bg-indigo-900 rounded-lg">
                    <svg class="w-8 h-8 text-indigo-600 dark:text-indigo-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-600 dark:text-gray-400">–ö–∞—Ä—Ç–æ—á–µ–∫ –∫ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—é</p>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ total_cards }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 bg-green-100 dark:bg-green-900 rounded-lg">
                    <svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-600 dark:text-gray-400">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞</p>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ (min_score * 100)|int }}%</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞ -->
    <div class="mb-6 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
        <form method="GET" action="{{ url_for('products_merge_recommendations') }}" class="flex flex-wrap gap-4 items-end">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Å—Ö–æ–∂–µ—Å—Ç–∏
                </label>
                <select name="min_score" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                    <option value="0.5" {% if min_score == 0.5 %}selected{% endif %}>50% - –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</option>
                    <option value="0.6" {% if min_score == 0.6 %}selected{% endif %}>60% - –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π</option>
                    <option value="0.7" {% if min_score == 0.7 %}selected{% endif %}>70% - –í—ã—Å–æ–∫–∞—è</option>
                    <option value="0.8" {% if min_score == 0.8 %}selected{% endif %}>80% - –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è</option>
                    <option value="0.9" {% if min_score == 0.9 %}selected{% endif %}>90% - –ü–æ—á—Ç–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–µ</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ø
                </label>
                <select name="show_top" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                    <option value="10" {% if show_top == 10 %}selected{% endif %}>10 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</option>
                    <option value="20" {% if show_top == 20 %}selected{% endif %}>20 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</option>
                    <option value="50" {% if show_top == 50 %}selected{% endif %}>50 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</option>
                </select>
            </div>
            <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                –ü—Ä–∏–º–µ–Ω–∏—Ç—å
            </button>
        </form>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π -->
    {% if recommendations %}
    <div class="space-y-6">
        {% for rec in recommendations %}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden border-l-4
                    {% if rec.score >= 0.9 %}border-green-500{% elif rec.score >= 0.7 %}border-blue-500{% else %}border-yellow-500{% endif %}">
            <div class="p-6">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="p-2 rounded-lg
                                    {% if rec.score >= 0.9 %}bg-green-100 dark:bg-green-900{% elif rec.score >= 0.7 %}bg-blue-100 dark:bg-blue-900{% else %}bg-yellow-100 dark:bg-yellow-900{% endif %}">
                            <svg class="w-6 h-6
                                        {% if rec.score >= 0.9 %}text-green-600 dark:text-green-400{% elif rec.score >= 0.7 %}text-blue-600 dark:text-blue-400{% else %}text-yellow-600 dark:text-yellow-400{% endif %}"
                                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                                –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è #{{ loop.index }}
                            </h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                {{ rec.reason }}
                            </p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-bold
                                    {% if rec.score >= 0.9 %}text-green-600 dark:text-green-400{% elif rec.score >= 0.7 %}text-blue-600 dark:text-blue-400{% else %}text-yellow-600 dark:text-yellow-400{% endif %}">
                            {{ (rec.score * 100)|round|int }}%
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">–æ—Ü–µ–Ω–∫–∞ —Å—Ö–æ–∂–µ—Å—Ç–∏</div>
                    </div>
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–ø–ø–µ -->
                <div class="flex items-center gap-4 mb-4 text-sm text-gray-600 dark:text-gray-400">
                    <span class="flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"></path>
                        </svg>
                        <strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong>&nbsp;{{ rec.cards[0].subject_name or rec.subject_id }}
                    </span>
                    <span class="flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.523-1.943A5.977 5.977 0 0116 10c0 .34-.028.675-.083 1H15a2 2 0 00-2 2v2.197A5.973 5.973 0 0110 16v-2a2 2 0 00-2-2 2 2 0 01-2-2 2 2 0 00-1.668-1.973z" clip-rule="evenodd"></path>
                        </svg>
                        <strong>–ë—Ä–µ–Ω–¥:</strong>&nbsp;{{ rec.brand }}
                    </span>
                    <span class="flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"></path>
                        </svg>
                        <strong>{{ rec.cards|length }}</strong>&nbsp;–∫–∞—Ä—Ç–æ—á–µ–∫
                    </span>
                </div>

                <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è -->
                <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4 mb-4">
                    <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">–ö–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è:</h4>
                    <div class="space-y-2">
                        {% for card in rec.cards %}
                        <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700
                                    {% if loop.first %}ring-2 ring-purple-500{% endif %}">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    {% if loop.first %}
                                    <span class="px-2 py-0.5 text-xs bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 rounded font-semibold">
                                        –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –≥–ª–∞–≤–Ω–∞—è
                                    </span>
                                    {% endif %}
                                    <span class="text-xs px-2 py-0.5 bg-gray-100 dark:bg-gray-700 rounded">
                                        nmID: {{ card.nm_id }}
                                    </span>
                                </div>
                                <div class="font-medium text-gray-900 dark:text-white">{{ card.vendor_code }}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400 truncate">{{ card.title }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- –î–µ–π—Å—Ç–≤–∏–µ -->
                <div class="flex justify-end">
                    {% set nm_ids_list = rec.cards | map(attribute='nm_id') | list %}
                    {% set target_nm_id = rec.suggested_target.nm_id %}
                    <a href="{{ url_for('products_merge', subject_id=rec.subject_id, brand=rec.brand, auto_select_nm_ids=nm_ids_list|join(','), auto_target_nm_id=target_nm_id) }}"
                       class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-medium rounded-lg hover:from-indigo-700 hover:to-purple-700 transition shadow-lg">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—é
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-12 text-center">
        <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h3 class="mt-2 text-lg font-medium text-gray-900 dark:text-white">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
            –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–∏–∑–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –æ—Ü–µ–Ω–∫—É —Å—Ö–æ–∂–µ—Å—Ç–∏ –∏–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π—Ç–µ –±–æ–ª—å—à–µ —Ç–æ–≤–∞—Ä–æ–≤ —Å WB API
        </p>
    </div>
    {% endif %}
</div>
{% endblock %}
