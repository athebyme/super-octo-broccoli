{% extends "base.html" %}

{% block title %}AI Парсер — {{ supplier.name }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <nav class="mb-4 text-sm text-gray-500">
        <a href="{{ url_for('admin_suppliers') }}" class="hover:text-indigo-600">Поставщики</a>
        <span class="mx-2">/</span>
        <a href="{{ url_for('admin_supplier_products', supplier_id=supplier.id) }}" class="hover:text-indigo-600">{{ supplier.name }}</a>
        <span class="mx-2">/</span>
        <span class="text-gray-900">AI Парсер</span>
    </nav>

    <div class="mb-6">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">AI Парсер данных</h1>
                <p class="text-sm text-gray-500 mt-1">
                    Извлечение всех характеристик товаров с помощью AI для маркетплейсов
                </p>
            </div>
            <div class="flex gap-2">
                {% if supplier.description_file_url %}
                <form method="POST" action="{{ url_for('admin_supplier_sync_descriptions', supplier_id=supplier.id) }}" class="inline">
                    <button type="submit" onclick="return confirm('Синхронизировать описания из CSV?')"
                            class="px-4 py-2 bg-amber-600 text-white rounded-lg text-sm font-medium hover:bg-amber-700">
                        Синхр. описания
                    </button>
                </form>
                {% endif %}
                <a href="{{ url_for('admin_supplier_products', supplier_id=supplier.id) }}"
                   class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-50">
                    Назад к товарам
                </a>
            </div>
        </div>
    </div>

    <!-- Статистика -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg border border-gray-200 p-4 text-center">
            <p class="text-xs text-gray-500">Всего товаров</p>
            <p class="text-2xl font-bold text-gray-900">{{ stats.total }}</p>
        </div>
        <div class="bg-white rounded-lg border border-gray-200 p-4 text-center">
            <p class="text-xs text-gray-500">AI спарсено</p>
            <p class="text-2xl font-bold text-indigo-600">{{ parsed_count }}</p>
        </div>
        <div class="bg-white rounded-lg border border-gray-200 p-4 text-center">
            <p class="text-xs text-gray-500">Не спарсено</p>
            <p class="text-2xl font-bold text-orange-500">{{ stats.total - parsed_count }}</p>
        </div>
        <div class="bg-white rounded-lg border border-gray-200 p-4 text-center">
            <p class="text-xs text-gray-500">AI покрытие</p>
            <p class="text-2xl font-bold text-green-600">{{ '%.0f'|format(parsed_count / stats.total * 100) if stats.total > 0 else 0 }}%</p>
        </div>
    </div>

    {% if not supplier.ai_enabled %}
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
        <p class="text-yellow-800 font-medium">AI не активирован для этого поставщика.</p>
        <p class="text-yellow-600 text-sm mt-1">
            Перейдите в <a href="{{ url_for('admin_supplier_edit', supplier_id=supplier.id) }}" class="underline">настройки поставщика</a>
            и включите AI с указанием API ключа.
        </p>
    </div>
    {% else %}

    <!-- Инструкция -->
    <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 mb-6">
        <h3 class="text-indigo-900 font-semibold text-sm mb-2">Как работает AI парсер</h3>
        <ol class="text-indigo-700 text-sm space-y-1 list-decimal list-inside">
            <li>Выберите товары галочками или используйте "Выбрать все на странице"</li>
            <li>Нажмите "AI Парсинг выбранных" для массовой обработки</li>
            <li>AI извлечёт: физические размеры, материалы, цвета, бренд, комплектацию, сезон и 50+ других характеристик</li>
            <li>Результат будет сохранён и доступен в формате для WB/Ozon</li>
            <li>Для одного товара можно использовать кнопку "Парсинг" в строке</li>
        </ol>
    </div>

    <!-- Фильтры и поиск -->
    <form method="GET" class="bg-white rounded-lg border border-gray-200 p-4 mb-6">
        <div class="flex gap-3 items-end">
            <div class="flex-1">
                <input type="text" name="search" value="{{ search }}" placeholder="Поиск по названию, ID, бренду..."
                       class="w-full rounded-lg border-gray-300 text-sm border px-3 py-2 focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            <div>
                <select name="stock_status" class="rounded-lg border-gray-300 text-sm border px-3 py-2">
                    <option value="">Все</option>
                    <option value="in_stock" {{ 'selected' if stock_status == 'in_stock' }}>В наличии</option>
                    <option value="out_of_stock" {{ 'selected' if stock_status == 'out_of_stock' }}>Нет в наличии</option>
                </select>
            </div>
            <button type="submit" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200">
                Найти
            </button>
        </div>
    </form>

    <!-- Массовые действия -->
    <form id="bulkParseForm" method="POST" action="{{ url_for('admin_supplier_ai_parse_bulk', supplier_id=supplier.id) }}">
        <div class="bg-white rounded-lg border border-gray-200 mb-6">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="selectAll" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="text-sm font-medium text-gray-700">Выбрать все на странице</span>
                    </label>
                    <span id="selectedCount" class="text-sm text-gray-500 hidden">
                        Выбрано: <span class="font-bold text-indigo-600">0</span>
                    </span>
                </div>
                <div class="flex gap-2">
                    <button type="submit" id="bulkParseBtn" disabled
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 disabled:opacity-40 disabled:cursor-not-allowed transition-all"
                            onclick="return confirm('Запустить AI парсинг выбранных товаров? Это может занять время.')">
                        AI Парсинг выбранных
                    </button>
                </div>
            </div>

            <!-- Таблица товаров -->
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left w-8"></th>
                            <th class="px-4 py-3 text-left font-medium text-gray-500">Товар</th>
                            <th class="px-4 py-3 text-left font-medium text-gray-500">Бренд</th>
                            <th class="px-4 py-3 text-left font-medium text-gray-500">Категория</th>
                            <th class="px-4 py-3 text-right font-medium text-gray-500">Цена</th>
                            <th class="px-4 py-3 text-center font-medium text-gray-500">Описание</th>
                            <th class="px-4 py-3 text-center font-medium text-gray-500">AI парсинг</th>
                            <th class="px-4 py-3 text-center font-medium text-gray-500">Действия</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for product in pagination.items %}
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-4 py-3">
                                <input type="checkbox" name="product_ids" value="{{ product.id }}"
                                       class="product-checkbox rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            </td>
                            <td class="px-4 py-3">
                                <a href="{{ url_for('admin_supplier_product_detail', supplier_id=supplier.id, product_id=product.id) }}"
                                   class="font-medium text-gray-900 hover:text-indigo-600 line-clamp-1">
                                    {{ product.title or 'Без названия' }}
                                </a>
                                <p class="text-xs text-gray-400 mt-0.5">{{ product.external_id }} | {{ product.vendor_code or '—' }}</p>
                            </td>
                            <td class="px-4 py-3 text-gray-600">{{ product.brand or '—' }}</td>
                            <td class="px-4 py-3 text-gray-600 text-xs">{{ (product.wb_category_name or product.category or '—')[:30] }}</td>
                            <td class="px-4 py-3 text-right text-gray-900 font-medium">
                                {{ '%.0f'|format(product.supplier_price) if product.supplier_price else '—' }}
                            </td>
                            <td class="px-4 py-3 text-center">
                                {% if product.description %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700">
                                    {{ product.description_source or 'есть' }}
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-500">нет</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-center">
                                {% if product.ai_parsed_at %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-700"
                                      title="{{ product.ai_parsed_at.strftime('%d.%m.%Y %H:%M') }}">
                                    {% set pdata = product.get_ai_parsed_data() %}
                                    {{ '%.0f'|format(pdata.get('parsing_meta', {}).get('fill_percentage', 0)) }}%
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-400">—</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-center">
                                <div class="flex justify-center gap-1">
                                    <button type="button" onclick="parseSingle({{ product.id }})"
                                            class="px-2 py-1 text-xs bg-indigo-50 text-indigo-700 rounded hover:bg-indigo-100 transition-colors"
                                            title="AI парсинг">
                                        Парсинг
                                    </button>
                                    <a href="{{ url_for('admin_supplier_product_raw_json', supplier_id=supplier.id, product_id=product.id) }}"
                                       class="px-2 py-1 text-xs bg-gray-50 text-gray-600 rounded hover:bg-gray-100 transition-colors"
                                       title="Просмотр JSON">
                                        JSON
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if pagination.pages > 1 %}
            <div class="p-4 border-t border-gray-200 flex justify-center">
                <nav class="flex gap-1">
                    {% for page_num in pagination.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
                    {% if page_num %}
                    <a href="{{ url_for('admin_supplier_ai_parser', supplier_id=supplier.id, page=page_num, search=search, stock_status=stock_status) }}"
                       class="px-3 py-1 rounded text-sm {{ 'bg-indigo-600 text-white' if page_num == pagination.page else 'text-gray-600 hover:bg-gray-100' }}">
                        {{ page_num }}
                    </a>
                    {% else %}
                    <span class="px-2 py-1 text-gray-400">...</span>
                    {% endif %}
                    {% endfor %}
                </nav>
            </div>
            {% endif %}
        </div>
    </form>

    {% endif %}
</div>

<!-- Модальное окно результата -->
<div id="parseResultModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-bold text-gray-900">Результат AI парсинга</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div id="parseResultContent" class="p-6 overflow-y-auto flex-1">
            <div class="text-center text-gray-500">Загрузка...</div>
        </div>
    </div>
</div>

<script>
// Чекбоксы
const selectAll = document.getElementById('selectAll');
const checkboxes = document.querySelectorAll('.product-checkbox');
const bulkBtn = document.getElementById('bulkParseBtn');
const selectedCount = document.getElementById('selectedCount');

function updateSelection() {
    const checked = document.querySelectorAll('.product-checkbox:checked').length;
    bulkBtn.disabled = checked === 0;
    if (checked > 0) {
        selectedCount.classList.remove('hidden');
        selectedCount.querySelector('span').textContent = checked;
    } else {
        selectedCount.classList.add('hidden');
    }
}

if (selectAll) {
    selectAll.addEventListener('change', function() {
        checkboxes.forEach(cb => cb.checked = this.checked);
        updateSelection();
    });
}
checkboxes.forEach(cb => cb.addEventListener('change', updateSelection));

// Парсинг одного товара
function parseSingle(productId) {
    if (!confirm('Запустить AI парсинг этого товара?')) return;

    const modal = document.getElementById('parseResultModal');
    const content = document.getElementById('parseResultContent');
    modal.classList.remove('hidden');
    content.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-indigo-600 border-t-transparent"></div><p class="mt-3 text-gray-500">AI анализирует товар...</p></div>';

    const form = new FormData();
    form.append('product_id', productId);

    fetch('{{ url_for("admin_supplier_ai_parse", supplier_id=supplier.id) }}', {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: form
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const mp = data.marketplace_data || {};
            const parsed = data.parsed_data || {};
            const meta = parsed.parsing_meta || {};
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-green-50 rounded-lg p-4">
                        <p class="text-green-800 font-semibold">Парсинг завершён</p>
                        <p class="text-green-600 text-sm">Заполнено: ${meta.fill_percentage || 0}% (${meta.total_fields_found || 0} из ${meta.total_fields_possible || 0} полей)</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-2">Данные для маркетплейса (WB)</h4>
                        <pre class="bg-gray-50 rounded-lg p-4 text-xs overflow-x-auto max-h-48 border">${JSON.stringify(mp, null, 2)}</pre>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-2">Полный парсинг (все характеристики)</h4>
                        <pre class="bg-gray-50 rounded-lg p-4 text-xs overflow-x-auto max-h-64 border">${JSON.stringify(parsed, null, 2)}</pre>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="copyToClipboard(JSON.stringify(${JSON.stringify(mp)}, null, 2))" class="px-3 py-1.5 bg-indigo-100 text-indigo-700 rounded text-sm hover:bg-indigo-200">
                            Копировать WB JSON
                        </button>
                        <button onclick="copyToClipboard(JSON.stringify(${JSON.stringify(parsed)}, null, 2))" class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded text-sm hover:bg-gray-200">
                            Копировать полный JSON
                        </button>
                    </div>
                </div>`;
        } else {
            content.innerHTML = `<div class="bg-red-50 rounded-lg p-4"><p class="text-red-800 font-semibold">Ошибка</p><p class="text-red-600 text-sm">${data.error || 'Неизвестная ошибка'}</p></div>`;
        }
    })
    .catch(err => {
        content.innerHTML = `<div class="bg-red-50 rounded-lg p-4"><p class="text-red-800">Ошибка сети: ${err.message}</p></div>`;
    });
}

function closeModal() {
    document.getElementById('parseResultModal').classList.add('hidden');
    location.reload();
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('Скопировано в буфер обмена');
    });
}
</script>
{% endblock %}
