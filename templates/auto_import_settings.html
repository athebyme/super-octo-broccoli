{% extends "base.html" %}

{% block title %}Настройки автоимпорта - WB Seller Platform{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Заголовок -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Настройки автоимпорта</h1>
        <p class="mt-2 text-sm text-gray-600">
            Настройте параметры автоматического импорта товаров из внешних источников
        </p>
    </div>

    <!-- Форма настроек -->
    <form method="POST" action="{{ url_for('auto_import_settings') }}" class="space-y-6">
        <!-- Основные настройки -->
        <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Основные настройки</h3>

            <!-- Включить автоимпорт -->
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" name="is_enabled" {{ 'checked' if settings.is_enabled else '' }}
                           class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">Включить автоимпорт</span>
                </label>
            </div>

            <!-- Код поставщика -->
            <div class="mb-4">
                <label for="supplier_code" class="block text-sm font-medium text-gray-700 mb-1">
                    Код поставщика <span class="text-red-500">*</span>
                </label>
                <input type="text" id="supplier_code" name="supplier_code"
                       value="{{ settings.supplier_code or '' }}"
                       required
                       class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                       placeholder="Например: SP001">
                <p class="mt-1 text-xs text-gray-500">
                    Используется для формирования артикулов товаров
                </p>
            </div>

            <!-- Шаблон артикула -->
            <div class="mb-4">
                <label for="vendor_code_pattern" class="block text-sm font-medium text-gray-700 mb-1">
                    Шаблон артикула
                </label>
                <input type="text" id="vendor_code_pattern" name="vendor_code_pattern"
                       value="{{ settings.vendor_code_pattern or 'id-{product_id}-{supplier_code}' }}"
                       class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                       placeholder="id-{product_id}-{supplier_code}">
                <p class="mt-1 text-xs text-gray-500">
                    Доступные переменные: {product_id}, {supplier_code}
                </p>
            </div>

            <!-- URL источника -->
            <div class="mb-4">
                <label for="csv_source_url" class="block text-sm font-medium text-gray-700 mb-1">
                    URL CSV файла <span class="text-red-500">*</span>
                </label>
                <input type="url" id="csv_source_url" name="csv_source_url"
                       value="{{ settings.csv_source_url or '' }}"
                       required
                       class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                       placeholder="http://example.com/products.csv">
                <p class="mt-1 text-xs text-gray-500">
                    Адрес CSV файла с товарами для импорта
                </p>
            </div>

            <!-- Тип источника -->
            <div class="mb-4">
                <label for="csv_source_type" class="block text-sm font-medium text-gray-700 mb-1">
                    Тип источника
                </label>
                <select id="csv_source_type" name="csv_source_type"
                        class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                    <option value="sexoptovik" {{ 'selected' if settings.csv_source_type == 'sexoptovik' else '' }}>
                        Sexoptovik
                    </option>
                    <option value="fixprice" {{ 'selected' if settings.csv_source_type == 'fixprice' else '' }}>
                        Fix Price
                    </option>
                    <option value="custom" {{ 'selected' if settings.csv_source_type == 'custom' else '' }}>
                        Пользовательский
                    </option>
                </select>
            </div>

            <!-- Разделитель CSV -->
            <div class="mb-4">
                <label for="csv_delimiter" class="block text-sm font-medium text-gray-700 mb-1">
                    Разделитель полей в CSV
                </label>
                <input type="text" id="csv_delimiter" name="csv_delimiter"
                       value="{{ settings.csv_delimiter or ';' }}"
                       maxlength="1"
                       class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                       placeholder=";">
                <p class="mt-1 text-xs text-gray-500">
                    Обычно используется ; (точка с запятой) или , (запятая)
                </p>
            </div>
        </div>

        <!-- Настройки импорта -->
        <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Параметры импорта</h3>

            <!-- Импортировать только новые -->
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" name="import_only_new" {{ 'checked' if settings.import_only_new else '' }}
                           class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">Импортировать только новые товары</span>
                </label>
                <p class="ml-6 mt-1 text-xs text-gray-500">
                    Пропускать товары, которые уже были импортированы ранее
                </p>
            </div>

            <!-- Автоматически активировать -->
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" name="auto_enable_products" {{ 'checked' if settings.auto_enable_products else '' }}
                           class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">Автоматически активировать импортированные товары</span>
                </label>
            </div>

            <!-- Использовать блюр -->
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" name="use_blurred_images" {{ 'checked' if settings.use_blurred_images else '' }}
                           class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">Использовать блюренные фото (если доступно)</span>
                </label>
            </div>

            <!-- Интервал автоимпорта -->
            <div class="mb-4">
                <label for="auto_import_interval_hours" class="block text-sm font-medium text-gray-700 mb-1">
                    Интервал автоимпорта (часы)
                </label>
                <input type="number" id="auto_import_interval_hours" name="auto_import_interval_hours"
                       value="{{ settings.auto_import_interval_hours or 24 }}"
                       min="1" max="168"
                       class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                <p class="mt-1 text-xs text-gray-500">
                    Как часто запускать автоматический импорт (от 1 до 168 часов)
                </p>
            </div>
        </div>

        <!-- Настройки обработки изображений -->
        <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Обработка изображений</h3>

            <!-- Приводить к 1200x1200 -->
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" name="resize_images_to_1200" {{ 'checked' if settings.resize_images_to_1200 else '' }}
                           class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">Приводить изображения к размеру 1200x1200</span>
                </label>
                <p class="ml-6 mt-1 text-xs text-gray-500">
                    Автоматически изменять размер изображений и добавлять паддинг
                </p>
            </div>

            <!-- Цвет фона -->
            <div class="mb-4">
                <label for="image_background_color" class="block text-sm font-medium text-gray-700 mb-1">
                    Цвет фона для паддинга
                </label>
                <select id="image_background_color" name="image_background_color"
                        class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                    <option value="white" {{ 'selected' if settings.image_background_color == 'white' else '' }}>
                        Белый
                    </option>
                    <option value="black" {{ 'selected' if settings.image_background_color == 'black' else '' }}>
                        Черный
                    </option>
                    <option value="gray" {{ 'selected' if settings.image_background_color == 'gray' else '' }}>
                        Серый
                    </option>
                </select>
            </div>
        </div>

        <!-- Авторизация Sexoptovik -->
        <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-2">Авторизация Sexoptovik</h3>
            <p class="text-sm text-gray-600 mb-4">
                Для доступа к фотографиям товаров на sexoptovik.ru требуется авторизация.
                Укажите ваши учетные данные.
            </p>

            <!-- Логин -->
            <div class="mb-4">
                <label for="sexoptovik_login" class="block text-sm font-medium text-gray-700 mb-1">
                    Логин Sexoptovik
                </label>
                <input type="text" id="sexoptovik_login" name="sexoptovik_login"
                       value="{{ settings.sexoptovik_login or '' }}"
                       autocomplete="username"
                       class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                       placeholder="Ваш логин на sexoptovik.ru">
                <p class="mt-1 text-xs text-gray-500">
                    Логин для авторизации на sexoptovik.ru
                </p>
            </div>

            <!-- Пароль -->
            <div class="mb-4">
                <label for="sexoptovik_password" class="block text-sm font-medium text-gray-700 mb-1">
                    Пароль Sexoptovik
                </label>
                <input type="password" id="sexoptovik_password" name="sexoptovik_password"
                       value="{{ settings.sexoptovik_password or '' }}"
                       autocomplete="current-password"
                       class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                       placeholder="Ваш пароль">
                <p class="mt-1 text-xs text-gray-500">
                    Пароль будет сохранен в зашифрованном виде
                </p>
            </div>

            <!-- Статус авторизации -->
            <div class="mt-4 p-3 bg-gray-50 rounded-md border border-gray-200">
                <div class="flex items-start">
                    <svg class="h-5 w-5 text-gray-400 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div class="ml-3">
                        <p class="text-sm text-gray-700">
                            После сохранения учетных данных фотографии товаров будут автоматически загружаться
                            с сервера sexoptovik.ru при просмотре и импорте.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Настройки -->
        <div class="bg-gradient-to-br from-purple-50 to-indigo-50 shadow-sm rounded-lg border border-purple-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <div class="p-2 bg-purple-100 rounded-lg mr-3">
                        <svg class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">AI-помощник</h3>
                        <p class="text-xs text-gray-500">Cloud.ru Foundation Models / OpenAI</p>
                    </div>
                </div>
                <!-- Быстрая ссылка на AI обновление -->
                <a href="{{ url_for('auto_import_ai_update') }}"
                   class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-purple-700 bg-purple-100 rounded-lg hover:bg-purple-200 transition-colors">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    AI Обновление
                </a>
            </div>

            <!-- Включить AI -->
            <div class="mb-4">
                <label class="flex items-center p-3 bg-white rounded-lg border border-purple-200 cursor-pointer hover:bg-purple-50 transition-colors">
                    <input type="checkbox" name="ai_enabled" id="ai_enabled" {{ 'checked' if settings.ai_enabled else '' }}
                           class="h-5 w-5 text-purple-600 focus:ring-purple-500 border-gray-300 rounded"
                           onchange="toggleAISettings()">
                    <span class="ml-3 text-sm font-medium text-gray-900">Включить AI-помощник</span>
                </label>
            </div>

            <div id="ai_settings_block" class="{{ '' if settings.ai_enabled else 'hidden' }}">
                <!-- Провайдер и модель в одной строке -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- Провайдер AI -->
                    <div>
                        <label for="ai_provider" class="block text-sm font-medium text-gray-700 mb-1">
                            Провайдер AI
                        </label>
                        <select id="ai_provider" name="ai_provider"
                                class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                onchange="updateAIProviderSettings()">
                            <option value="cloudru" {{ 'selected' if settings.ai_provider == 'cloudru' else '' }}>
                                Cloud.ru Foundation Models
                            </option>
                            <option value="openai" {{ 'selected' if settings.ai_provider == 'openai' else '' }}>
                                OpenAI
                            </option>
                            <option value="custom" {{ 'selected' if settings.ai_provider == 'custom' else '' }}>
                                Другой (OpenAI-совместимый)
                            </option>
                        </select>
                    </div>

                    <!-- Модель -->
                    <div>
                        <label for="ai_model" class="block text-sm font-medium text-gray-700 mb-1">
                            Модель AI
                        </label>
                        <select id="ai_model" name="ai_model"
                                class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            <option value="{{ settings.ai_model or 'openai/gpt-oss-120b' }}">{{ settings.ai_model or 'openai/gpt-oss-120b' }}</option>
                        </select>
                        <p id="model_description" class="mt-1 text-xs text-gray-500">
                            Загрузка моделей...
                        </p>
                    </div>
                </div>

                <!-- API ключ -->
                <div class="mb-4">
                    <label for="ai_api_key" class="block text-sm font-medium text-gray-700 mb-1">
                        API ключ <span class="text-red-500">*</span>
                    </label>
                    <div class="flex gap-2">
                        <input type="password" id="ai_api_key" name="ai_api_key"
                               value="{{ settings.ai_api_key or '' }}"
                               class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md"
                               placeholder="sk-...">
                        <button type="button" onclick="testAIConnection()"
                                class="inline-flex items-center px-3 py-2 border border-purple-300 shadow-sm text-sm font-medium rounded-md text-purple-700 bg-white hover:bg-purple-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 whitespace-nowrap">
                            <svg id="test_icon" class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Тест
                        </button>
                    </div>
                    <p id="test_result" class="mt-1 text-xs text-gray-500"></p>
                </div>

                <!-- Базовый URL (для custom/cloudru) -->
                <div class="mb-4" id="ai_base_url_block">
                    <label for="ai_api_base_url" class="block text-sm font-medium text-gray-700 mb-1">
                        Базовый URL API
                    </label>
                    <input type="url" id="ai_api_base_url" name="ai_api_base_url"
                           value="{{ settings.ai_api_base_url or 'https://foundation-models.api.cloud.ru/v1' }}"
                           class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md"
                           placeholder="https://foundation-models.api.cloud.ru/v1">
                </div>

                <!-- Опции использования -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="p-3 bg-white rounded-lg border border-gray-200">
                        <label class="flex items-center">
                            <input type="checkbox" name="ai_use_for_categories" {{ 'checked' if settings.ai_use_for_categories else '' }}
                                   class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                            <span class="ml-2 text-sm text-gray-700">Определение категорий</span>
                        </label>
                        <p class="ml-6 mt-1 text-xs text-gray-500">AI определит категорию WB</p>
                    </div>
                    <div class="p-3 bg-white rounded-lg border border-gray-200">
                        <label class="flex items-center">
                            <input type="checkbox" name="ai_use_for_sizes" {{ 'checked' if settings.ai_use_for_sizes else '' }}
                                   class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                            <span class="ml-2 text-sm text-gray-700">Парсинг размеров</span>
                        </label>
                        <p class="ml-6 mt-1 text-xs text-gray-500">Извлечение характеристик</p>
                    </div>
                </div>

                <!-- Порог уверенности -->
                <div class="mb-4">
                    <label for="ai_category_confidence_threshold" class="block text-sm font-medium text-gray-700 mb-1">
                        Порог уверенности для AI ({{ ((settings.ai_category_confidence_threshold or 0.7) * 100)|int }}%)
                    </label>
                    <input type="range" id="ai_category_confidence_threshold" name="ai_category_confidence_threshold"
                           value="{{ settings.ai_category_confidence_threshold or 0.7 }}"
                           min="0" max="1" step="0.05"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600"
                           oninput="this.previousElementSibling.textContent = 'Порог уверенности для AI (' + Math.round(this.value * 100) + '%)'">
                    <p class="mt-1 text-xs text-gray-500">
                        AI используется если уверенность обычного алгоритма ниже этого значения
                    </p>
                </div>

                <!-- Расширенные настройки -->
                <details class="mb-4">
                    <summary class="text-sm font-medium text-purple-700 cursor-pointer hover:text-purple-800 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Расширенные настройки
                    </summary>
                    <div class="mt-3 p-4 bg-white rounded-lg border border-gray-200 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="ai_temperature" class="block text-sm font-medium text-gray-700 mb-1">
                                    Температура
                                </label>
                                <input type="number" id="ai_temperature" name="ai_temperature"
                                       value="{{ settings.ai_temperature or 0.3 }}"
                                       min="0" max="2" step="0.1"
                                       class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="ai_max_tokens" class="block text-sm font-medium text-gray-700 mb-1">
                                    Макс. токенов
                                </label>
                                <input type="number" id="ai_max_tokens" name="ai_max_tokens"
                                       value="{{ settings.ai_max_tokens or 2000 }}"
                                       min="100" max="8000"
                                       class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="ai_timeout" class="block text-sm font-medium text-gray-700 mb-1">
                                    Таймаут (сек)
                                </label>
                                <input type="number" id="ai_timeout" name="ai_timeout"
                                       value="{{ settings.ai_timeout or 60 }}"
                                       min="10" max="300"
                                       class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="ai_top_p" class="block text-sm font-medium text-gray-700 mb-1">
                                    Top P
                                </label>
                                <input type="number" id="ai_top_p" name="ai_top_p"
                                       value="{{ settings.ai_top_p or 0.95 }}"
                                       min="0" max="1" step="0.05"
                                       class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="ai_presence_penalty" class="block text-sm font-medium text-gray-700 mb-1">
                                    Presence Penalty
                                </label>
                                <input type="number" id="ai_presence_penalty" name="ai_presence_penalty"
                                       value="{{ settings.ai_presence_penalty or 0.0 }}"
                                       min="-2" max="2" step="0.1"
                                       class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="ai_frequency_penalty" class="block text-sm font-medium text-gray-700 mb-1">
                                    Frequency Penalty
                                </label>
                                <input type="number" id="ai_frequency_penalty" name="ai_frequency_penalty"
                                       value="{{ settings.ai_frequency_penalty or 0.0 }}"
                                       min="-2" max="2" step="0.1"
                                       class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            </div>
                        </div>
                    </div>
                </details>

                <!-- Кастомные инструкции -->
                <details class="mb-4">
                    <summary class="text-sm font-medium text-purple-700 cursor-pointer hover:text-purple-800 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Кастомные инструкции AI
                    </summary>
                    <div class="mt-3 p-4 bg-white rounded-lg border border-gray-200 space-y-4">
                        <div>
                            <label for="ai_category_instruction" class="block text-sm font-medium text-gray-700 mb-1">
                                Инструкция для категорий
                            </label>
                            <textarea id="ai_category_instruction" name="ai_category_instruction" rows="4"
                                      class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                      placeholder="Оставьте пустым для использования стандартной инструкции">{{ settings.ai_category_instruction or '' }}</textarea>
                            <button type="button" onclick="loadDefaultInstruction('category')"
                                    class="mt-1 text-xs text-purple-600 hover:text-purple-800">
                                Загрузить стандартную инструкцию
                            </button>
                        </div>
                        <div>
                            <label for="ai_size_instruction" class="block text-sm font-medium text-gray-700 mb-1">
                                Инструкция для размеров
                            </label>
                            <textarea id="ai_size_instruction" name="ai_size_instruction" rows="4"
                                      class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                      placeholder="Оставьте пустым для использования стандартной инструкции">{{ settings.ai_size_instruction or '' }}</textarea>
                            <button type="button" onclick="loadDefaultInstruction('size')"
                                    class="mt-1 text-xs text-purple-600 hover:text-purple-800">
                                Загрузить стандартную инструкцию
                            </button>
                        </div>
                    </div>
                </details>
            </div>
        </div>

        <!-- Кнопки -->
        <div class="flex gap-4">
            <button type="submit"
                    class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Сохранить настройки
            </button>
            <a href="{{ url_for('auto_import_dashboard') }}"
               class="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Отмена
            </a>
        </div>
    </form>
</div>

<script>
let modelsCache = {};

function toggleAISettings() {
    const checkbox = document.getElementById('ai_enabled');
    const settingsBlock = document.getElementById('ai_settings_block');
    if (checkbox.checked) {
        settingsBlock.classList.remove('hidden');
        loadModels();
    } else {
        settingsBlock.classList.add('hidden');
    }
}

function updateAIProviderSettings() {
    const provider = document.getElementById('ai_provider').value;
    const baseUrlBlock = document.getElementById('ai_base_url_block');
    const baseUrlInput = document.getElementById('ai_api_base_url');

    // Показываем/скрываем блок базового URL и устанавливаем дефолтные значения
    if (provider === 'openai') {
        baseUrlBlock.classList.add('hidden');
        baseUrlInput.value = '';
    } else {
        baseUrlBlock.classList.remove('hidden');
        if (provider === 'cloudru' && !baseUrlInput.value) {
            baseUrlInput.value = 'https://foundation-models.api.cloud.ru/v1';
        }
    }

    // Загружаем модели для выбранного провайдера
    loadModels();
}

async function loadModels() {
    const provider = document.getElementById('ai_provider').value;
    const modelSelect = document.getElementById('ai_model');
    const modelDescription = document.getElementById('model_description');
    const currentValue = modelSelect.value;

    // Проверяем кэш
    if (modelsCache[provider]) {
        populateModels(modelsCache[provider], currentValue);
        return;
    }

    modelDescription.textContent = 'Загрузка моделей...';

    try {
        const response = await fetch(`{{ url_for('auto_import_ai_models') }}?provider=${provider}`);
        const data = await response.json();

        if (data.success && data.models) {
            modelsCache[provider] = data.models;
            populateModels(data.models, currentValue);
        } else {
            modelDescription.textContent = 'Не удалось загрузить список моделей';
        }
    } catch (e) {
        console.error('Error loading models:', e);
        modelDescription.textContent = 'Ошибка загрузки моделей';
    }
}

function populateModels(models, currentValue) {
    const modelSelect = document.getElementById('ai_model');
    const modelDescription = document.getElementById('model_description');

    modelSelect.innerHTML = '';

    for (const [modelId, modelInfo] of Object.entries(models)) {
        const option = document.createElement('option');
        option.value = modelId;
        option.textContent = modelInfo.name + (modelInfo.recommended ? ' (рекомендуется)' : '');
        option.dataset.description = modelInfo.description || '';

        if (modelId === currentValue || (!currentValue && modelInfo.recommended)) {
            option.selected = true;
            modelDescription.textContent = modelInfo.description || '';
        }

        modelSelect.appendChild(option);
    }

    // Обновляем описание при смене модели
    modelSelect.onchange = function() {
        const selectedOption = this.options[this.selectedIndex];
        modelDescription.textContent = selectedOption.dataset.description || '';
    };
}

async function testAIConnection() {
    const testIcon = document.getElementById('test_icon');
    const testResult = document.getElementById('test_result');

    // Анимация загрузки
    testIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>';
    testIcon.classList.add('animate-spin');
    testResult.textContent = 'Тестирование подключения...';
    testResult.className = 'mt-1 text-xs text-gray-500';

    try {
        const response = await fetch('{{ url_for("auto_import_ai_test") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const data = await response.json();

        testIcon.classList.remove('animate-spin');

        if (data.success) {
            testIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
            testResult.textContent = data.message;
            testResult.className = 'mt-1 text-xs text-green-600';
        } else {
            testIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
            testResult.textContent = data.error || 'Ошибка подключения';
            testResult.className = 'mt-1 text-xs text-red-600';
        }
    } catch (e) {
        testIcon.classList.remove('animate-spin');
        testIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
        testResult.textContent = 'Ошибка сети: ' + e.message;
        testResult.className = 'mt-1 text-xs text-red-600';
    }
}

async function loadDefaultInstruction(type) {
    try {
        const response = await fetch('{{ url_for("auto_import_ai_instructions") }}');
        const data = await response.json();

        if (data.success && data.instructions) {
            if (type === 'category' && data.instructions.category_detection) {
                document.getElementById('ai_category_instruction').value = data.instructions.category_detection.template;
            } else if (type === 'size' && data.instructions.size_parsing) {
                document.getElementById('ai_size_instruction').value = data.instructions.size_parsing.template;
            }
        }
    } catch (e) {
        console.error('Error loading instructions:', e);
        alert('Не удалось загрузить инструкцию');
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    updateAIProviderSettings();
    if (document.getElementById('ai_enabled').checked) {
        loadModels();
    }
});
</script>
{% endblock %}
