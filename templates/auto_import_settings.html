{% extends "base.html" %}

{% block title %}Настройки автоимпорта - WB Seller Platform{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Заголовок -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Настройки автоимпорта</h1>
        <p class="mt-2 text-sm text-gray-600">
            Настройте параметры автоматического импорта товаров из внешних источников
        </p>
    </div>

    <!-- Форма настроек -->
    <form method="POST" action="{{ url_for('auto_import_settings') }}" class="space-y-6">
        <!-- Основные настройки -->
        <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Основные настройки</h3>

            <!-- Включить автоимпорт -->
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" name="is_enabled" {{ 'checked' if settings.is_enabled else '' }}
                           class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">Включить автоимпорт</span>
                </label>
            </div>

            <!-- Код поставщика -->
            <div class="mb-4">
                <label for="supplier_code" class="block text-sm font-medium text-gray-700 mb-1">
                    Код поставщика <span class="text-red-500">*</span>
                </label>
                <input type="text" id="supplier_code" name="supplier_code"
                       value="{{ settings.supplier_code or '' }}"
                       required
                       class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                       placeholder="Например: SP001">
                <p class="mt-1 text-xs text-gray-500">
                    Используется для формирования артикулов товаров
                </p>
            </div>

            <!-- Шаблон артикула -->
            <div class="mb-4">
                <label for="vendor_code_pattern" class="block text-sm font-medium text-gray-700 mb-1">
                    Шаблон артикула
                </label>
                <input type="text" id="vendor_code_pattern" name="vendor_code_pattern"
                       value="{{ settings.vendor_code_pattern or 'id-{product_id}-{supplier_code}' }}"
                       class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                       placeholder="id-{product_id}-{supplier_code}">
                <p class="mt-1 text-xs text-gray-500">
                    Доступные переменные: {product_id}, {supplier_code}
                </p>
            </div>

            <!-- URL источника -->
            <div class="mb-4">
                <label for="csv_source_url" class="block text-sm font-medium text-gray-700 mb-1">
                    URL CSV файла <span class="text-red-500">*</span>
                </label>
                <input type="url" id="csv_source_url" name="csv_source_url"
                       value="{{ settings.csv_source_url or '' }}"
                       required
                       class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                       placeholder="http://example.com/products.csv">
                <p class="mt-1 text-xs text-gray-500">
                    Адрес CSV файла с товарами для импорта
                </p>
            </div>

            <!-- Тип источника -->
            <div class="mb-4">
                <label for="csv_source_type" class="block text-sm font-medium text-gray-700 mb-1">
                    Тип источника
                </label>
                <select id="csv_source_type" name="csv_source_type"
                        class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                    <option value="sexoptovik" {{ 'selected' if settings.csv_source_type == 'sexoptovik' else '' }}>
                        Sexoptovik
                    </option>
                    <option value="fixprice" {{ 'selected' if settings.csv_source_type == 'fixprice' else '' }}>
                        Fix Price
                    </option>
                    <option value="custom" {{ 'selected' if settings.csv_source_type == 'custom' else '' }}>
                        Пользовательский
                    </option>
                </select>
            </div>

            <!-- Разделитель CSV -->
            <div class="mb-4">
                <label for="csv_delimiter" class="block text-sm font-medium text-gray-700 mb-1">
                    Разделитель полей в CSV
                </label>
                <input type="text" id="csv_delimiter" name="csv_delimiter"
                       value="{{ settings.csv_delimiter or ';' }}"
                       maxlength="1"
                       class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                       placeholder=";">
                <p class="mt-1 text-xs text-gray-500">
                    Обычно используется ; (точка с запятой) или , (запятая)
                </p>
            </div>
        </div>

        <!-- Настройки импорта -->
        <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Параметры импорта</h3>

            <!-- Импортировать только новые -->
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" name="import_only_new" {{ 'checked' if settings.import_only_new else '' }}
                           class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">Импортировать только новые товары</span>
                </label>
                <p class="ml-6 mt-1 text-xs text-gray-500">
                    Пропускать товары, которые уже были импортированы ранее
                </p>
            </div>

            <!-- Автоматически активировать -->
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" name="auto_enable_products" {{ 'checked' if settings.auto_enable_products else '' }}
                           class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">Автоматически активировать импортированные товары</span>
                </label>
            </div>

            <!-- Использовать блюр -->
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" name="use_blurred_images" {{ 'checked' if settings.use_blurred_images else '' }}
                           class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">Использовать блюренные фото (если доступно)</span>
                </label>
            </div>

            <!-- Интервал автоимпорта -->
            <div class="mb-4">
                <label for="auto_import_interval_hours" class="block text-sm font-medium text-gray-700 mb-1">
                    Интервал автоимпорта (часы)
                </label>
                <input type="number" id="auto_import_interval_hours" name="auto_import_interval_hours"
                       value="{{ settings.auto_import_interval_hours or 24 }}"
                       min="1" max="168"
                       class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                <p class="mt-1 text-xs text-gray-500">
                    Как часто запускать автоматический импорт (от 1 до 168 часов)
                </p>
            </div>
        </div>

        <!-- Настройки обработки изображений -->
        <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Обработка изображений</h3>

            <!-- Приводить к 1200x1200 -->
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" name="resize_images_to_1200" {{ 'checked' if settings.resize_images_to_1200 else '' }}
                           class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">Приводить изображения к размеру 1200x1200</span>
                </label>
                <p class="ml-6 mt-1 text-xs text-gray-500">
                    Автоматически изменять размер изображений и добавлять паддинг
                </p>
            </div>

            <!-- Цвет фона -->
            <div class="mb-4">
                <label for="image_background_color" class="block text-sm font-medium text-gray-700 mb-1">
                    Цвет фона для паддинга
                </label>
                <select id="image_background_color" name="image_background_color"
                        class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                    <option value="white" {{ 'selected' if settings.image_background_color == 'white' else '' }}>
                        Белый
                    </option>
                    <option value="black" {{ 'selected' if settings.image_background_color == 'black' else '' }}>
                        Черный
                    </option>
                    <option value="gray" {{ 'selected' if settings.image_background_color == 'gray' else '' }}>
                        Серый
                    </option>
                </select>
            </div>
        </div>

        <!-- Авторизация Sexoptovik -->
        <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-2">Авторизация Sexoptovik</h3>
            <p class="text-sm text-gray-600 mb-4">
                Для доступа к фотографиям товаров на sexoptovik.ru требуется авторизация.
                Укажите ваши учетные данные.
            </p>

            <!-- Логин -->
            <div class="mb-4">
                <label for="sexoptovik_login" class="block text-sm font-medium text-gray-700 mb-1">
                    Логин Sexoptovik
                </label>
                <input type="text" id="sexoptovik_login" name="sexoptovik_login"
                       value="{{ settings.sexoptovik_login or '' }}"
                       autocomplete="username"
                       class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                       placeholder="Ваш логин на sexoptovik.ru">
                <p class="mt-1 text-xs text-gray-500">
                    Логин для авторизации на sexoptovik.ru
                </p>
            </div>

            <!-- Пароль -->
            <div class="mb-4">
                <label for="sexoptovik_password" class="block text-sm font-medium text-gray-700 mb-1">
                    Пароль Sexoptovik
                </label>
                <input type="password" id="sexoptovik_password" name="sexoptovik_password"
                       value="{{ settings.sexoptovik_password or '' }}"
                       autocomplete="current-password"
                       class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                       placeholder="Ваш пароль">
                <p class="mt-1 text-xs text-gray-500">
                    Пароль будет сохранен в зашифрованном виде
                </p>
            </div>

            <!-- Статус авторизации -->
            <div class="mt-4 p-3 bg-gray-50 rounded-md border border-gray-200">
                <div class="flex items-start">
                    <svg class="h-5 w-5 text-gray-400 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div class="ml-3">
                        <p class="text-sm text-gray-700">
                            После сохранения учетных данных фотографии товаров будут автоматически загружаться
                            с сервера sexoptovik.ru при просмотре и импорте.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Настройки -->
        <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
            <div class="flex items-center mb-4">
                <svg class="h-6 w-6 text-purple-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                <h3 class="text-lg font-medium text-gray-900">AI-помощник (опционально)</h3>
            </div>
            <p class="text-sm text-gray-600 mb-4">
                Используйте AI для улучшения определения категорий и парсинга размеров товаров.
                Поддерживаются OpenAI-совместимые API (OpenAI, Cloud.ru Foundation Models и др.).
            </p>

            <!-- Включить AI -->
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" name="ai_enabled" id="ai_enabled" {{ 'checked' if settings.ai_enabled else '' }}
                           class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded"
                           onchange="toggleAISettings()">
                    <span class="ml-2 text-sm text-gray-700">Включить AI-помощник</span>
                </label>
            </div>

            <div id="ai_settings_block" class="{{ '' if settings.ai_enabled else 'hidden' }}">
                <!-- Провайдер AI -->
                <div class="mb-4">
                    <label for="ai_provider" class="block text-sm font-medium text-gray-700 mb-1">
                        Провайдер AI
                    </label>
                    <select id="ai_provider" name="ai_provider"
                            class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md"
                            onchange="updateAIProviderSettings()">
                        <option value="openai" {{ 'selected' if settings.ai_provider == 'openai' else '' }}>
                            OpenAI
                        </option>
                        <option value="cloudru" {{ 'selected' if settings.ai_provider == 'cloudru' else '' }}>
                            Cloud.ru Foundation Models
                        </option>
                        <option value="custom" {{ 'selected' if settings.ai_provider == 'custom' else '' }}>
                            Другой (OpenAI-совместимый)
                        </option>
                    </select>
                </div>

                <!-- API ключ -->
                <div class="mb-4">
                    <label for="ai_api_key" class="block text-sm font-medium text-gray-700 mb-1">
                        API ключ <span class="text-red-500">*</span>
                    </label>
                    <input type="password" id="ai_api_key" name="ai_api_key"
                           value="{{ settings.ai_api_key or '' }}"
                           class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md"
                           placeholder="sk-...">
                    <p class="mt-1 text-xs text-gray-500">
                        API ключ для доступа к AI сервису
                    </p>
                </div>

                <!-- Базовый URL (для custom) -->
                <div class="mb-4" id="ai_base_url_block">
                    <label for="ai_api_base_url" class="block text-sm font-medium text-gray-700 mb-1">
                        Базовый URL API
                    </label>
                    <input type="url" id="ai_api_base_url" name="ai_api_base_url"
                           value="{{ settings.ai_api_base_url or '' }}"
                           class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md"
                           placeholder="https://api.openai.com/v1">
                    <p class="mt-1 text-xs text-gray-500">
                        Укажите для custom провайдера или Cloud.ru
                    </p>
                </div>

                <!-- Модель -->
                <div class="mb-4">
                    <label for="ai_model" class="block text-sm font-medium text-gray-700 mb-1">
                        Модель AI
                    </label>
                    <input type="text" id="ai_model" name="ai_model"
                           value="{{ settings.ai_model or 'gpt-4o-mini' }}"
                           class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md"
                           placeholder="gpt-4o-mini">
                    <p class="mt-1 text-xs text-gray-500">
                        Рекомендуется: gpt-4o-mini (баланс цены/качества) или gpt-4o (лучшее качество)
                    </p>
                </div>

                <!-- Использовать для категорий -->
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" name="ai_use_for_categories" {{ 'checked' if settings.ai_use_for_categories else '' }}
                               class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                        <span class="ml-2 text-sm text-gray-700">Использовать AI для определения категорий</span>
                    </label>
                    <p class="ml-6 mt-1 text-xs text-gray-500">
                        AI будет помогать определять категорию WB когда обычный алгоритм не уверен
                    </p>
                </div>

                <!-- Использовать для размеров -->
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" name="ai_use_for_sizes" {{ 'checked' if settings.ai_use_for_sizes else '' }}
                               class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                        <span class="ml-2 text-sm text-gray-700">Использовать AI для парсинга размеров</span>
                    </label>
                    <p class="ml-6 mt-1 text-xs text-gray-500">
                        AI будет извлекать характеристики (длина, диаметр и т.д.) из текстовых описаний
                    </p>
                </div>

                <!-- Порог уверенности для AI категорий -->
                <div class="mb-4">
                    <label for="ai_category_confidence_threshold" class="block text-sm font-medium text-gray-700 mb-1">
                        Порог уверенности для AI (категории)
                    </label>
                    <input type="number" id="ai_category_confidence_threshold" name="ai_category_confidence_threshold"
                           value="{{ settings.ai_category_confidence_threshold or 0.7 }}"
                           min="0" max="1" step="0.05"
                           class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md">
                    <p class="mt-1 text-xs text-gray-500">
                        AI будет использоваться если уверенность обычного алгоритма ниже этого значения (0-1)
                    </p>
                </div>

                <!-- Расширенные настройки (свернутые) -->
                <details class="mb-4">
                    <summary class="text-sm font-medium text-gray-700 cursor-pointer hover:text-purple-600">
                        Расширенные настройки AI
                    </summary>
                    <div class="mt-3 pl-4 border-l-2 border-gray-200 space-y-4">
                        <!-- Температура -->
                        <div>
                            <label for="ai_temperature" class="block text-sm font-medium text-gray-700 mb-1">
                                Температура
                            </label>
                            <input type="number" id="ai_temperature" name="ai_temperature"
                                   value="{{ settings.ai_temperature or 0.3 }}"
                                   min="0" max="2" step="0.1"
                                   class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            <p class="mt-1 text-xs text-gray-500">
                                Низкая (0.1-0.3) = более точные ответы, высокая (0.7-1.0) = более креативные
                            </p>
                        </div>

                        <!-- Макс токенов -->
                        <div>
                            <label for="ai_max_tokens" class="block text-sm font-medium text-gray-700 mb-1">
                                Максимум токенов
                            </label>
                            <input type="number" id="ai_max_tokens" name="ai_max_tokens"
                                   value="{{ settings.ai_max_tokens or 2000 }}"
                                   min="100" max="8000"
                                   class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md">
                        </div>

                        <!-- Таймаут -->
                        <div>
                            <label for="ai_timeout" class="block text-sm font-medium text-gray-700 mb-1">
                                Таймаут запроса (секунды)
                            </label>
                            <input type="number" id="ai_timeout" name="ai_timeout"
                                   value="{{ settings.ai_timeout or 60 }}"
                                   min="10" max="300"
                                   class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md">
                        </div>
                    </div>
                </details>
            </div>
        </div>

        <!-- Кнопки -->
        <div class="flex gap-4">
            <button type="submit"
                    class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Сохранить настройки
            </button>
            <a href="{{ url_for('auto_import_dashboard') }}"
               class="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Отмена
            </a>
        </div>
    </form>
</div>

<script>
function toggleAISettings() {
    const checkbox = document.getElementById('ai_enabled');
    const settingsBlock = document.getElementById('ai_settings_block');
    if (checkbox.checked) {
        settingsBlock.classList.remove('hidden');
    } else {
        settingsBlock.classList.add('hidden');
    }
}

function updateAIProviderSettings() {
    const provider = document.getElementById('ai_provider').value;
    const baseUrlBlock = document.getElementById('ai_base_url_block');
    const baseUrlInput = document.getElementById('ai_api_base_url');
    const modelInput = document.getElementById('ai_model');

    // Показываем/скрываем блок базового URL
    if (provider === 'openai') {
        baseUrlBlock.classList.add('hidden');
        baseUrlInput.value = '';
        if (!modelInput.value || modelInput.value === 'gpt-4o-mini') {
            modelInput.placeholder = 'gpt-4o-mini';
        }
    } else {
        baseUrlBlock.classList.remove('hidden');
        if (provider === 'cloudru') {
            baseUrlInput.placeholder = 'https://api.cloudru.ru/v1';
        } else {
            baseUrlInput.placeholder = 'https://your-api.com/v1';
        }
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    updateAIProviderSettings();
});
</script>
{% endblock %}
