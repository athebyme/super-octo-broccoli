{% extends "base.html" %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–∏–º–ø–æ—Ä—Ç–∞ - WB Seller Platform{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–∏–º–ø–æ—Ä—Ç–∞</h1>
        <p class="mt-2 text-sm text-gray-600">
            –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        </p>
    </div>

    <!-- –§–æ—Ä–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <form method="POST" action="{{ url_for('auto_import_settings') }}" class="space-y-6">
        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>

            <!-- –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–∏–º–ø–æ—Ä—Ç -->
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" name="is_enabled" {{ 'checked' if settings.is_enabled else '' }}
                           class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–∏–º–ø–æ—Ä—Ç</span>
                </label>
            </div>

            <!-- –ö–æ–¥ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ -->
            <div class="mb-4">
                <label for="supplier_code" class="block text-sm font-medium text-gray-700 mb-1">
                    –ö–æ–¥ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ <span class="text-red-500">*</span>
                </label>
                <input type="text" id="supplier_code" name="supplier_code"
                       value="{{ settings.supplier_code or '' }}"
                       required
                       class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: SP001">
                <p class="mt-1 text-xs text-gray-500">
                    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∞—Ä—Ç–∏–∫—É–ª–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤
                </p>
            </div>

            <!-- –®–∞–±–ª–æ–Ω –∞—Ä—Ç–∏–∫—É–ª–∞ -->
            <div class="mb-4">
                <label for="vendor_code_pattern" class="block text-sm font-medium text-gray-700 mb-1">
                    –®–∞–±–ª–æ–Ω –∞—Ä—Ç–∏–∫—É–ª–∞
                </label>
                <input type="text" id="vendor_code_pattern" name="vendor_code_pattern"
                       value="{{ settings.vendor_code_pattern or 'id-{product_id}-{supplier_code}' }}"
                       class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                       placeholder="id-{product_id}-{supplier_code}">
                <p class="mt-1 text-xs text-gray-500">
                    –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: {product_id}, {supplier_code}
                </p>
            </div>

            <!-- URL –∏—Å—Ç–æ—á–Ω–∏–∫–∞ -->
            <div class="mb-4">
                <label for="csv_source_url" class="block text-sm font-medium text-gray-700 mb-1">
                    URL CSV —Ñ–∞–π–ª–∞ <span class="text-red-500">*</span>
                </label>
                <input type="url" id="csv_source_url" name="csv_source_url"
                       value="{{ settings.csv_source_url or '' }}"
                       required
                       class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                       placeholder="http://example.com/products.csv">
                <p class="mt-1 text-xs text-gray-500">
                    –ê–¥—Ä–µ—Å CSV —Ñ–∞–π–ª–∞ —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
                </p>
            </div>

            <!-- –¢–∏–ø –∏—Å—Ç–æ—á–Ω–∏–∫–∞ -->
            <div class="mb-4">
                <label for="csv_source_type" class="block text-sm font-medium text-gray-700 mb-1">
                    –¢–∏–ø –∏—Å—Ç–æ—á–Ω–∏–∫–∞
                </label>
                <select id="csv_source_type" name="csv_source_type"
                        class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                    <option value="sexoptovik" {{ 'selected' if settings.csv_source_type == 'sexoptovik' else '' }}>
                        Sexoptovik
                    </option>
                    <option value="fixprice" {{ 'selected' if settings.csv_source_type == 'fixprice' else '' }}>
                        Fix Price
                    </option>
                    <option value="custom" {{ 'selected' if settings.csv_source_type == 'custom' else '' }}>
                        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π
                    </option>
                </select>
            </div>

            <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å CSV -->
            <div class="mb-4">
                <label for="csv_delimiter" class="block text-sm font-medium text-gray-700 mb-1">
                    –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –ø–æ–ª–µ–π –≤ CSV
                </label>
                <input type="text" id="csv_delimiter" name="csv_delimiter"
                       value="{{ settings.csv_delimiter or ';' }}"
                       maxlength="1"
                       class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                       placeholder=";">
                <p class="mt-1 text-xs text-gray-500">
                    –û–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ; (—Ç–æ—á–∫–∞ —Å –∑–∞–ø—è—Ç–æ–π) –∏–ª–∏ , (–∑–∞–ø—è—Ç–∞—è)
                </p>
            </div>
        </div>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ -->
        <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–º–ø–æ—Ä—Ç–∞</h3>

            <!-- –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ -->
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" name="import_only_new" {{ 'checked' if settings.import_only_new else '' }}
                           class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã</span>
                </label>
                <p class="ml-6 mt-1 text-xs text-gray-500">
                    –ü—Ä–æ–ø—É—Å–∫–∞—Ç—å —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –±—ã–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã —Ä–∞–Ω–µ–µ
                </p>
            </div>

            <!-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å -->
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" name="auto_enable_products" {{ 'checked' if settings.auto_enable_products else '' }}
                           class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã</span>
                </label>
            </div>

            <!-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–ª—é—Ä -->
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" name="use_blurred_images" {{ 'checked' if settings.use_blurred_images else '' }}
                           class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–ª—é—Ä–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)</span>
                </label>
            </div>

            <!-- –ò–Ω—Ç–µ—Ä–≤–∞–ª –∞–≤—Ç–æ–∏–º–ø–æ—Ä—Ç–∞ -->
            <div class="mb-4">
                <label for="auto_import_interval_hours" class="block text-sm font-medium text-gray-700 mb-1">
                    –ò–Ω—Ç–µ—Ä–≤–∞–ª –∞–≤—Ç–æ–∏–º–ø–æ—Ä—Ç–∞ (—á–∞—Å—ã)
                </label>
                <input type="number" id="auto_import_interval_hours" name="auto_import_interval_hours"
                       value="{{ settings.auto_import_interval_hours or 24 }}"
                       min="1" max="168"
                       class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                <p class="mt-1 text-xs text-gray-500">
                    –ö–∞–∫ —á–∞—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç (–æ—Ç 1 –¥–æ 168 —á–∞—Å–æ–≤)
                </p>
            </div>
        </div>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
        <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h3>

            <!-- –ü—Ä–∏–≤–æ–¥–∏—Ç—å –∫ 1200x1200 -->
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" name="resize_images_to_1200" {{ 'checked' if settings.resize_images_to_1200 else '' }}
                           class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">–ü—Ä–∏–≤–æ–¥–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫ —Ä–∞–∑–º–µ—Ä—É 1200x1200</span>
                </label>
                <p class="ml-6 mt-1 text-xs text-gray-500">
                    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–º–µ–Ω—è—Ç—å —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –¥–æ–±–∞–≤–ª—è—Ç—å –ø–∞–¥–¥–∏–Ω–≥
                </p>
            </div>

            <!-- –¶–≤–µ—Ç —Ñ–æ–Ω–∞ -->
            <div class="mb-4">
                <label for="image_background_color" class="block text-sm font-medium text-gray-700 mb-1">
                    –¶–≤–µ—Ç —Ñ–æ–Ω–∞ –¥–ª—è –ø–∞–¥–¥–∏–Ω–≥–∞
                </label>
                <select id="image_background_color" name="image_background_color"
                        class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                    <option value="white" {{ 'selected' if settings.image_background_color == 'white' else '' }}>
                        –ë–µ–ª—ã–π
                    </option>
                    <option value="black" {{ 'selected' if settings.image_background_color == 'black' else '' }}>
                        –ß–µ—Ä–Ω—ã–π
                    </option>
                    <option value="gray" {{ 'selected' if settings.image_background_color == 'gray' else '' }}>
                        –°–µ—Ä—ã–π
                    </option>
                </select>
            </div>
        </div>

        <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Sexoptovik -->
        <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-2">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Sexoptovik</h3>
            <p class="text-sm text-gray-600 mb-4">
                –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ sexoptovik.ru —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è.
                –£–∫–∞–∂–∏—Ç–µ –≤–∞—à–∏ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
            </p>

            <!-- –õ–æ–≥–∏–Ω -->
            <div class="mb-4">
                <label for="sexoptovik_login" class="block text-sm font-medium text-gray-700 mb-1">
                    –õ–æ–≥–∏–Ω Sexoptovik
                </label>
                <input type="text" id="sexoptovik_login" name="sexoptovik_login"
                       value="{{ settings.sexoptovik_login or '' }}"
                       autocomplete="username"
                       class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                       placeholder="–í–∞—à –ª–æ–≥–∏–Ω –Ω–∞ sexoptovik.ru">
                <p class="mt-1 text-xs text-gray-500">
                    –õ–æ–≥–∏–Ω –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ sexoptovik.ru
                </p>
            </div>

            <!-- –ü–∞—Ä–æ–ª—å -->
            <div class="mb-4">
                <label for="sexoptovik_password" class="block text-sm font-medium text-gray-700 mb-1">
                    –ü–∞—Ä–æ–ª—å Sexoptovik
                </label>
                <input type="password" id="sexoptovik_password" name="sexoptovik_password"
                       value="{{ settings.sexoptovik_password or '' }}"
                       autocomplete="current-password"
                       class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                       placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å">
                <p class="mt-1 text-xs text-gray-500">
                    –ü–∞—Ä–æ–ª—å –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ
                </p>
            </div>

            <!-- –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
            <div class="mt-4 p-3 bg-gray-50 rounded-md border border-gray-200">
                <div class="flex items-start">
                    <svg class="h-5 w-5 text-gray-400 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div class="ml-3">
                        <p class="text-sm text-gray-700">
                            –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è
                            —Å —Å–µ—Ä–≤–µ—Ä–∞ sexoptovik.ru –ø—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ –∏ –∏–º–ø–æ—Ä—Ç–µ.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div class="bg-gradient-to-br from-purple-50 to-indigo-50 shadow-sm rounded-lg border border-purple-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <div class="p-2 bg-purple-100 rounded-lg mr-3">
                        <svg class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">AI-–ø–æ–º–æ—â–Ω–∏–∫</h3>
                        <p class="text-xs text-gray-500">Cloud.ru Foundation Models / OpenAI</p>
                    </div>
                </div>
                <!-- –ë—ã—Å—Ç—Ä–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ AI –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ -->
                <a href="{{ url_for('auto_import_ai_update') }}"
                   class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-purple-700 bg-purple-100 rounded-lg hover:bg-purple-200 transition-colors">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    AI –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                </a>
            </div>

            <!-- –í–∫–ª—é—á–∏—Ç—å AI -->
            <div class="mb-4">
                <label class="flex items-center p-3 bg-white rounded-lg border border-purple-200 cursor-pointer hover:bg-purple-50 transition-colors">
                    <input type="checkbox" name="ai_enabled" id="ai_enabled" {{ 'checked' if settings.ai_enabled else '' }}
                           class="h-5 w-5 text-purple-600 focus:ring-purple-500 border-gray-300 rounded"
                           onchange="toggleAISettings()">
                    <span class="ml-3 text-sm font-medium text-gray-900">–í–∫–ª—é—á–∏—Ç—å AI-–ø–æ–º–æ—â–Ω–∏–∫</span>
                </label>
            </div>

            <div id="ai_settings_block" class="{{ '' if settings.ai_enabled else 'hidden' }}">
                <!-- –ü—Ä–æ–≤–∞–π–¥–µ—Ä –∏ –º–æ–¥–µ–ª—å –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- –ü—Ä–æ–≤–∞–π–¥–µ—Ä AI -->
                    <div>
                        <label for="ai_provider" class="block text-sm font-medium text-gray-700 mb-1">
                            –ü—Ä–æ–≤–∞–π–¥–µ—Ä AI
                        </label>
                        <select id="ai_provider" name="ai_provider"
                                class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                onchange="updateAIProviderSettings()">
                            <option value="cloudru" {{ 'selected' if settings.ai_provider == 'cloudru' else '' }}>
                                Cloud.ru Foundation Models
                            </option>
                            <option value="openai" {{ 'selected' if settings.ai_provider == 'openai' else '' }}>
                                OpenAI
                            </option>
                            <option value="custom" {{ 'selected' if settings.ai_provider == 'custom' else '' }}>
                                –î—Ä—É–≥–æ–π (OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π)
                            </option>
                        </select>
                    </div>

                    <!-- –ú–æ–¥–µ–ª—å -->
                    <div>
                        <label for="ai_model" class="block text-sm font-medium text-gray-700 mb-1">
                            –ú–æ–¥–µ–ª—å AI
                        </label>
                        <select id="ai_model" name="ai_model"
                                class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            <option value="{{ settings.ai_model or 'openai/gpt-oss-120b' }}">{{ settings.ai_model or 'openai/gpt-oss-120b' }}</option>
                        </select>
                        <p id="model_description" class="mt-1 text-xs text-gray-500">
                            –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π...
                        </p>
                    </div>
                </div>

                <!-- API –∫–ª—é—á (–¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤) -->
                <div id="api_key_block" class="mb-4">
                    <div id="cloudru_hint" class="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-3">
                        <div class="flex items-start">
                            <svg class="w-5 h-5 text-blue-500 mt-0.5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="text-sm text-blue-700">
                                <strong>Cloud.ru API –∫–ª—é—á</strong><br>
                                1. –°–æ–∑–¥–∞–π—Ç–µ —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –≤ <a href="https://console.cloud.ru" target="_blank" class="underline">–∫–æ–Ω—Å–æ–ª–∏ Cloud.ru</a><br>
                                2. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ API –∫–ª—é—á —Å —Ä–æ–ª—å—é <code>ml_inference_ai_marketplace</code><br>
                                3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ Key Secret —Å—Ä–∞–∑—É - –æ–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
                            </div>
                        </div>
                    </div>
                    <label for="ai_api_key" class="block text-sm font-medium text-gray-700 mb-1">
                        API –∫–ª—é—á <span class="text-red-500">*</span>
                    </label>
                    <input type="password" id="ai_api_key" name="ai_api_key"
                           value="{{ settings.ai_api_key or '' }}"
                           class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md"
                           placeholder="sk-...">
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                <div class="mb-4">
                    <button type="button" onclick="testAIConnection()"
                            class="inline-flex items-center px-4 py-2 border border-purple-300 shadow-sm text-sm font-medium rounded-md text-purple-700 bg-white hover:bg-purple-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        <svg id="test_icon" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                    </button>
                    <p id="test_result" class="mt-2 text-sm"></p>
                </div>

                <!-- –ë–∞–∑–æ–≤—ã–π URL (–¥–ª—è custom/cloudru) -->
                <div class="mb-4" id="ai_base_url_block">
                    <label for="ai_api_base_url" class="block text-sm font-medium text-gray-700 mb-1">
                        –ë–∞–∑–æ–≤—ã–π URL API
                    </label>
                    <input type="url" id="ai_api_base_url" name="ai_api_base_url"
                           value="{{ settings.ai_api_base_url or 'https://foundation-models.api.cloud.ru/v1' }}"
                           class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md"
                           placeholder="https://foundation-models.api.cloud.ru/v1">
                </div>

                <!-- –û–ø—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="p-3 bg-white rounded-lg border border-gray-200">
                        <label class="flex items-center">
                            <input type="checkbox" name="ai_use_for_categories" {{ 'checked' if settings.ai_use_for_categories else '' }}
                                   class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                            <span class="ml-2 text-sm text-gray-700">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</span>
                        </label>
                        <p class="ml-6 mt-1 text-xs text-gray-500">AI –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é WB</p>
                    </div>
                    <div class="p-3 bg-white rounded-lg border border-gray-200">
                        <label class="flex items-center">
                            <input type="checkbox" name="ai_use_for_sizes" {{ 'checked' if settings.ai_use_for_sizes else '' }}
                                   class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                            <span class="ml-2 text-sm text-gray-700">–ü–∞—Ä—Å–∏–Ω–≥ —Ä–∞–∑–º–µ—Ä–æ–≤</span>
                        </label>
                        <p class="ml-6 mt-1 text-xs text-gray-500">–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫</p>
                    </div>
                </div>

                <!-- –ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ -->
                <div class="mb-4">
                    <label for="ai_category_confidence_threshold" class="block text-sm font-medium text-gray-700 mb-1">
                        –ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è AI ({{ ((settings.ai_category_confidence_threshold or 0.7) * 100)|int }}%)
                    </label>
                    <input type="range" id="ai_category_confidence_threshold" name="ai_category_confidence_threshold"
                           value="{{ settings.ai_category_confidence_threshold or 0.7 }}"
                           min="0" max="1" step="0.05"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600"
                           oninput="this.previousElementSibling.textContent = '–ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è AI (' + Math.round(this.value * 100) + '%)'">
                    <p class="mt-1 text-xs text-gray-500">
                        AI –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –µ—Å–ª–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –æ–±—ã—á–Ω–æ–≥–æ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –Ω–∏–∂–µ —ç—Ç–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
                    </p>
                </div>

                <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                <details class="mb-4">
                    <summary class="text-sm font-medium text-purple-700 cursor-pointer hover:text-purple-800 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    </summary>
                    <div class="mt-3 p-4 bg-white rounded-lg border border-gray-200 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="ai_temperature" class="block text-sm font-medium text-gray-700 mb-1">
                                    –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
                                </label>
                                <input type="number" id="ai_temperature" name="ai_temperature"
                                       value="{{ settings.ai_temperature or 0.3 }}"
                                       min="0" max="2" step="0.1"
                                       class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="ai_max_tokens" class="block text-sm font-medium text-gray-700 mb-1">
                                    –ú–∞–∫—Å. —Ç–æ–∫–µ–Ω–æ–≤
                                </label>
                                <input type="number" id="ai_max_tokens" name="ai_max_tokens"
                                       value="{{ settings.ai_max_tokens or 2000 }}"
                                       min="100" max="8000"
                                       class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="ai_timeout" class="block text-sm font-medium text-gray-700 mb-1">
                                    –¢–∞–π–º–∞—É—Ç (—Å–µ–∫)
                                </label>
                                <input type="number" id="ai_timeout" name="ai_timeout"
                                       value="{{ settings.ai_timeout or 60 }}"
                                       min="10" max="300"
                                       class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="ai_top_p" class="block text-sm font-medium text-gray-700 mb-1">
                                    Top P
                                </label>
                                <input type="number" id="ai_top_p" name="ai_top_p"
                                       value="{{ settings.ai_top_p or 0.95 }}"
                                       min="0" max="1" step="0.05"
                                       class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="ai_presence_penalty" class="block text-sm font-medium text-gray-700 mb-1">
                                    Presence Penalty
                                </label>
                                <input type="number" id="ai_presence_penalty" name="ai_presence_penalty"
                                       value="{{ settings.ai_presence_penalty or 0.0 }}"
                                       min="-2" max="2" step="0.1"
                                       class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="ai_frequency_penalty" class="block text-sm font-medium text-gray-700 mb-1">
                                    Frequency Penalty
                                </label>
                                <input type="number" id="ai_frequency_penalty" name="ai_frequency_penalty"
                                       value="{{ settings.ai_frequency_penalty or 0.0 }}"
                                       min="-2" max="2" step="0.1"
                                       class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            </div>
                        </div>
                    </div>
                </details>

                <!-- –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
                <details class="mb-4">
                    <summary class="text-sm font-medium text-purple-700 cursor-pointer hover:text-purple-800 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ AI (–¥–ª—è –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏)
                    </summary>
                    <div class="mt-3 p-4 bg-white rounded-lg border border-gray-200 space-y-4">
                        <p class="text-xs text-gray-500 mb-2">
                            –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π AI-—Ñ—É–Ω–∫—Ü–∏–∏. –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.
                        </p>

                        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                        <div>
                            <label for="ai_category_instruction" class="block text-sm font-medium text-gray-700 mb-1">
                                –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                            </label>
                            <textarea id="ai_category_instruction" name="ai_category_instruction" rows="3"
                                      class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                      placeholder="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ç–æ–≤–∞—Ä–æ–≤...">{{ settings.ai_category_instruction or '' }}</textarea>
                            <button type="button" onclick="loadDefaultInstruction('category_detection')"
                                    class="mt-1 text-xs text-purple-600 hover:text-purple-800">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è</button>
                        </div>

                        <!-- –†–∞–∑–º–µ—Ä—ã -->
                        <div>
                            <label for="ai_size_instruction" class="block text-sm font-medium text-gray-700 mb-1">
                                –ü–∞—Ä—Å–∏–Ω–≥ —Ä–∞–∑–º–µ—Ä–æ–≤
                            </label>
                            <textarea id="ai_size_instruction" name="ai_size_instruction" rows="3"
                                      class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                      placeholder="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤...">{{ settings.ai_size_instruction or '' }}</textarea>
                            <button type="button" onclick="loadDefaultInstruction('size_parsing')"
                                    class="mt-1 text-xs text-purple-600 hover:text-purple-800">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è</button>
                        </div>

                        <!-- SEO –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
                        <div>
                            <label for="ai_seo_title_instruction" class="block text-sm font-medium text-gray-700 mb-1">
                                SEO –ó–∞–≥–æ–ª–æ–≤–æ–∫
                            </label>
                            <textarea id="ai_seo_title_instruction" name="ai_seo_title_instruction" rows="3"
                                      class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                      placeholder="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SEO –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤...">{{ settings.ai_seo_title_instruction or '' }}</textarea>
                            <button type="button" onclick="loadDefaultInstruction('seo_title')"
                                    class="mt-1 text-xs text-purple-600 hover:text-purple-800">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è</button>
                        </div>

                        <!-- –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ -->
                        <div>
                            <label for="ai_keywords_instruction" class="block text-sm font-medium text-gray-700 mb-1">
                                –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
                            </label>
                            <textarea id="ai_keywords_instruction" name="ai_keywords_instruction" rows="3"
                                      class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                      placeholder="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤...">{{ settings.ai_keywords_instruction or '' }}</textarea>
                            <button type="button" onclick="loadDefaultInstruction('keywords')"
                                    class="mt-1 text-xs text-purple-600 hover:text-purple-800">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è</button>
                        </div>

                        <!-- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ -->
                        <div>
                            <label for="ai_bullets_instruction" class="block text-sm font-medium text-gray-700 mb-1">
                                –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ (Bullets)
                            </label>
                            <textarea id="ai_bullets_instruction" name="ai_bullets_instruction" rows="3"
                                      class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                      placeholder="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤ —Ç–æ–≤–∞—Ä–∞...">{{ settings.ai_bullets_instruction or '' }}</textarea>
                            <button type="button" onclick="loadDefaultInstruction('bullet_points')"
                                    class="mt-1 text-xs text-purple-600 hover:text-purple-800">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è</button>
                        </div>

                        <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                        <div>
                            <label for="ai_description_instruction" class="block text-sm font-medium text-gray-700 mb-1">
                                –£–ª—É—á—à–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è
                            </label>
                            <textarea id="ai_description_instruction" name="ai_description_instruction" rows="3"
                                      class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                      placeholder="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞...">{{ settings.ai_description_instruction or '' }}</textarea>
                            <button type="button" onclick="loadDefaultInstruction('description_enhance')"
                                    class="mt-1 text-xs text-purple-600 hover:text-purple-800">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è</button>
                        </div>

                        <!-- Rich –∫–æ–Ω—Ç–µ–Ω—Ç -->
                        <div>
                            <label for="ai_rich_content_instruction" class="block text-sm font-medium text-gray-700 mb-1">
                                Rich –∫–æ–Ω—Ç–µ–Ω—Ç (–∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∞)
                            </label>
                            <textarea id="ai_rich_content_instruction" name="ai_rich_content_instruction" rows="3"
                                      class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                      placeholder="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Rich –∫–æ–Ω—Ç–µ–Ω—Ç–∞...">{{ settings.ai_rich_content_instruction or '' }}</textarea>
                            <button type="button" onclick="loadDefaultInstruction('rich_content')"
                                    class="mt-1 text-xs text-purple-600 hover:text-purple-800">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è</button>
                        </div>

                        <!-- –ê–Ω–∞–ª–∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
                        <div>
                            <label for="ai_analysis_instruction" class="block text-sm font-medium text-gray-700 mb-1">
                                –ê–Ω–∞–ª–∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏
                            </label>
                            <textarea id="ai_analysis_instruction" name="ai_analysis_instruction" rows="3"
                                      class="shadow-sm focus:ring-purple-500 focus:border-purple-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                      placeholder="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞...">{{ settings.ai_analysis_instruction or '' }}</textarea>
                            <button type="button" onclick="loadDefaultInstruction('card_analysis')"
                                    class="mt-1 text-xs text-purple-600 hover:text-purple-800">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è</button>
                        </div>
                    </div>
                </details>

                <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—Ä–∏—é AI -->
                <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="text-sm text-blue-800">–ò—Å—Ç–æ—Ä–∏—è AI –∑–∞–ø—Ä–æ—Å–æ–≤</span>
                        </div>
                        <button type="button" onclick="showAIHistory()"
                                class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                            –û—Ç–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
        <div class="bg-gradient-to-br from-orange-50 to-pink-50 shadow-sm rounded-lg border border-orange-200 p-6">
            <div class="flex items-center mb-4">
                <div class="p-2 bg-orange-100 rounded-lg mr-3">
                    <svg class="h-6 w-6 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∏</h3>
                    <p class="text-xs text-gray-500">AI —Å–æ–∑–¥–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è —Å–ª–∞–π–¥–æ–≤ Rich-–∫–æ–Ω—Ç–µ–Ω—Ç–∞ (1440x810px)</p>
                </div>
            </div>

            <!-- –í–∫–ª—é—á–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é -->
            <div class="mb-4">
                <label class="flex items-center p-3 bg-white rounded-lg border border-orange-200 cursor-pointer hover:bg-orange-50 transition-colors">
                    <input type="checkbox" name="image_gen_enabled" id="image_gen_enabled"
                           {{ 'checked' if settings.image_gen_enabled else '' }}
                           class="h-5 w-5 text-orange-600 focus:ring-orange-500 border-gray-300 rounded"
                           onchange="toggleImageGenSettings()">
                    <span class="ml-3 text-sm font-medium text-gray-900">–í–∫–ª—é—á–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</span>
                </label>
            </div>

            <div id="image_gen_settings_block" class="{{ '' if settings.image_gen_enabled else 'hidden' }}">
                <!-- –ü—Ä–æ–≤–∞–π–¥–µ—Ä -->
                <div class="mb-4">
                    <label for="image_gen_provider" class="block text-sm font-medium text-gray-700 mb-1">
                        –ü—Ä–æ–≤–∞–π–¥–µ—Ä –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                    </label>
                    <select id="image_gen_provider" name="image_gen_provider"
                            class="shadow-sm focus:ring-orange-500 focus:border-orange-500 block w-full sm:text-sm border-gray-300 rounded-md"
                            onchange="updateImageGenProviderHint()">
                        <option value="together_flux" {{ 'selected' if (settings.image_gen_provider or 'together_flux') == 'together_flux' else '' }}>
                            ‚≠ê Together AI Flux (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è! $5 –±–µ—Å–ø–ª–∞—Ç–Ω–æ)
                        </option>
                        <option value="openai_dalle" {{ 'selected' if settings.image_gen_provider == 'openai_dalle' else '' }}>
                            OpenAI DALL-E 3 (–ª—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ, ~$0.04-0.12/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
                        </option>
                        <option value="flux_pro" {{ 'selected' if settings.image_gen_provider == 'flux_pro' else '' }}>
                            Flux.1 Pro —á–µ—Ä–µ–∑ Replicate (~$0.05/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
                        </option>
                        <option value="sdxl" {{ 'selected' if settings.image_gen_provider == 'sdxl' else '' }}>
                            Stable Diffusion XL —á–µ—Ä–µ–∑ Replicate (~$0.01/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
                        </option>
                    </select>
                </div>

                <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è Together AI (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∏–¥–Ω–∞) -->
                <div id="together_hint" class="p-4 bg-purple-50 border border-purple-200 rounded-lg mb-3">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-purple-500 mt-0.5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                        </svg>
                        <div class="text-sm text-purple-700">
                            <strong>‚≠ê –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è! –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å Together AI API –∫–ª—é—á:</strong><br>
                            1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ <a href="https://api.together.xyz" target="_blank" class="underline font-medium">api.together.xyz</a><br>
                            2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ <a href="https://api.together.xyz/settings/api-keys" target="_blank" class="underline">Settings ‚Üí API Keys</a><br>
                            3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–ª—é—á<br>
                            <span class="text-xs text-purple-600 font-semibold">üéÅ $5 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–æ–≤ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏! –í—ã—Å–æ–∫–∏–π –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤.</span>
                        </div>
                    </div>
                </div>

                <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è OpenAI -->
                <div id="openai_hint" class="p-4 bg-green-50 border border-green-200 rounded-lg mb-3 hidden">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-green-500 mt-0.5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="text-sm text-green-700">
                            <strong>–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å OpenAI API –∫–ª—é—á:</strong><br>
                            1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ <a href="https://platform.openai.com" target="_blank" class="underline font-medium">platform.openai.com</a><br>
                            2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ <a href="https://platform.openai.com/api-keys" target="_blank" class="underline">API Keys</a><br>
                            3. –ù–∞–∂–º–∏—Ç–µ "Create new secret key"<br>
                            4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–ª—é—á (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å <code class="bg-green-100 px-1">sk-</code>)<br>
                            <span class="text-xs text-green-600">–ù—É–∂–Ω–∞ –ø—Ä–∏–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã –∏ –±–∞–ª–∞–Ω—Å –æ—Ç $5</span>
                        </div>
                    </div>
                </div>

                <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è Replicate -->
                <div id="replicate_hint" class="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-3 hidden">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-blue-500 mt-0.5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="text-sm text-blue-700">
                            <strong>–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å Replicate API —Ç–æ–∫–µ–Ω:</strong><br>
                            1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ <a href="https://replicate.com" target="_blank" class="underline font-medium">replicate.com</a> (–º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ GitHub)<br>
                            2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ <a href="https://replicate.com/account/api-tokens" target="_blank" class="underline">Account ‚Üí API Tokens</a><br>
                            3. –ù–∞–∂–º–∏—Ç–µ "Create token"<br>
                            4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å <code class="bg-blue-100 px-1">r8_</code>)<br>
                            <span class="text-xs text-blue-600">–ï—Å—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ</span>
                        </div>
                    </div>
                </div>

                <!-- Together AI API –∫–ª—é—á (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∏–¥–∏–º) -->
                <div id="together_api_key_block" class="mb-4">
                    <label for="together_api_key" class="block text-sm font-medium text-gray-700 mb-1">
                        Together AI API –∫–ª—é—á <span class="text-red-500">*</span>
                    </label>
                    <input type="password" id="together_api_key" name="together_api_key"
                           value="{{ settings.together_api_key or '' }}"
                           class="shadow-sm focus:ring-orange-500 focus:border-orange-500 block w-full sm:text-sm border-gray-300 rounded-md"
                           placeholder="–í–∞—à API –∫–ª—é—á –æ—Ç Together AI">
                </div>

                <!-- OpenAI API –∫–ª—é—á -->
                <div id="openai_api_key_block" class="mb-4 hidden">
                    <label for="openai_api_key" class="block text-sm font-medium text-gray-700 mb-1">
                        OpenAI API –∫–ª—é—á <span class="text-red-500">*</span>
                    </label>
                    <input type="password" id="openai_api_key" name="openai_api_key"
                           value="{{ settings.openai_api_key or '' }}"
                           class="shadow-sm focus:ring-orange-500 focus:border-orange-500 block w-full sm:text-sm border-gray-300 rounded-md"
                           placeholder="sk-...">
                </div>

                <!-- Replicate API –∫–ª—é—á -->
                <div id="replicate_api_key_block" class="mb-4 hidden">
                    <label for="replicate_api_key" class="block text-sm font-medium text-gray-700 mb-1">
                        Replicate API —Ç–æ–∫–µ–Ω <span class="text-red-500">*</span>
                    </label>
                    <input type="password" id="replicate_api_key" name="replicate_api_key"
                           value="{{ settings.replicate_api_key or '' }}"
                           class="shadow-sm focus:ring-orange-500 focus:border-orange-500 block w-full sm:text-sm border-gray-300 rounded-md"
                           placeholder="r8_...">
                </div>

                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ DALL-E -->
                <div id="dalle_settings" class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="openai_image_quality" class="block text-sm font-medium text-gray-700 mb-1">
                            –ö–∞—á–µ—Å—Ç–≤–æ DALL-E
                        </label>
                        <select id="openai_image_quality" name="openai_image_quality"
                                class="shadow-sm focus:ring-orange-500 focus:border-orange-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            <option value="standard" {{ 'selected' if (settings.openai_image_quality or 'standard') == 'standard' else '' }}>
                                Standard ($0.04)
                            </option>
                            <option value="hd" {{ 'selected' if settings.openai_image_quality == 'hd' else '' }}>
                                HD ($0.08) - –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π
                            </option>
                        </select>
                    </div>
                    <div>
                        <label for="openai_image_style" class="block text-sm font-medium text-gray-700 mb-1">
                            –°—Ç–∏–ª—å DALL-E
                        </label>
                        <select id="openai_image_style" name="openai_image_style"
                                class="shadow-sm focus:ring-orange-500 focus:border-orange-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            <option value="vivid" {{ 'selected' if (settings.openai_image_style or 'vivid') == 'vivid' else '' }}>
                                Vivid - —è—Ä–∫–∏–π, –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π
                            </option>
                            <option value="natural" {{ 'selected' if settings.openai_image_style == 'natural' else '' }}>
                                Natural - –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π, —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π
                            </option>
                        </select>
                    </div>
                </div>

                <!-- –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="image_gen_width" class="block text-sm font-medium text-gray-700 mb-1">
                            –®–∏—Ä–∏–Ω–∞ (px)
                        </label>
                        <input type="number" id="image_gen_width" name="image_gen_width"
                               value="{{ settings.image_gen_width or 1440 }}"
                               class="shadow-sm focus:ring-orange-500 focus:border-orange-500 block w-full sm:text-sm border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="image_gen_height" class="block text-sm font-medium text-gray-700 mb-1">
                            –í—ã—Å–æ—Ç–∞ (px)
                        </label>
                        <input type="number" id="image_gen_height" name="image_gen_height"
                               value="{{ settings.image_gen_height or 810 }}"
                               class="shadow-sm focus:ring-orange-500 focus:border-orange-500 block w-full sm:text-sm border-gray-300 rounded-md">
                    </div>
                </div>

                <div class="p-3 bg-orange-100 rounded-lg text-sm text-orange-800">
                    <strong>–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</strong> –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Rich-–∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–æ—è–≤–∏—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Ç–æ–≤–∞—Ä–∞.
                </div>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="flex gap-4">
            <button type="submit"
                    class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
            <a href="{{ url_for('auto_import_dashboard') }}"
               class="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                –û—Ç–º–µ–Ω–∞
            </a>
        </div>
    </form>
</div>

<script>
let modelsCache = {};

function toggleAISettings() {
    const checkbox = document.getElementById('ai_enabled');
    const settingsBlock = document.getElementById('ai_settings_block');
    if (checkbox.checked) {
        settingsBlock.classList.remove('hidden');
        loadModels();
    } else {
        settingsBlock.classList.add('hidden');
    }
}

function updateAIProviderSettings() {
    const provider = document.getElementById('ai_provider').value;
    const baseUrlBlock = document.getElementById('ai_base_url_block');
    const baseUrlInput = document.getElementById('ai_api_base_url');
    const cloudruHint = document.getElementById('cloudru_hint');

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è Cloud.ru
    if (provider === 'cloudru') {
        cloudruHint.classList.remove('hidden');
        baseUrlBlock.classList.remove('hidden');
        if (!baseUrlInput.value || baseUrlInput.value === 'https://api.openai.com/v1') {
            baseUrlInput.value = 'https://foundation-models.api.cloud.ru/v1';
        }
    } else if (provider === 'openai') {
        cloudruHint.classList.add('hidden');
        baseUrlBlock.classList.add('hidden');
        baseUrlInput.value = '';
    } else {
        // Custom - —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É Cloud.ru, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º base URL
        cloudruHint.classList.add('hidden');
        baseUrlBlock.classList.remove('hidden');
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
    loadModels();
}

async function loadModels() {
    const provider = document.getElementById('ai_provider').value;
    const modelSelect = document.getElementById('ai_model');
    const modelDescription = document.getElementById('model_description');
    const currentValue = modelSelect.value;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
    if (modelsCache[provider]) {
        populateModels(modelsCache[provider], currentValue);
        return;
    }

    modelDescription.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π...';

    try {
        const response = await fetch(`{{ url_for('auto_import_ai_models') }}?provider=${provider}`);
        const data = await response.json();

        if (data.success && data.models) {
            modelsCache[provider] = data.models;
            populateModels(data.models, currentValue);
        } else {
            modelDescription.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π';
        }
    } catch (e) {
        console.error('Error loading models:', e);
        modelDescription.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π';
    }
}

function populateModels(models, currentValue) {
    const modelSelect = document.getElementById('ai_model');
    const modelDescription = document.getElementById('model_description');

    modelSelect.innerHTML = '';

    for (const [modelId, modelInfo] of Object.entries(models)) {
        const option = document.createElement('option');
        option.value = modelId;
        option.textContent = modelInfo.name + (modelInfo.recommended ? ' (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)' : '');
        option.dataset.description = modelInfo.description || '';

        if (modelId === currentValue || (!currentValue && modelInfo.recommended)) {
            option.selected = true;
            modelDescription.textContent = modelInfo.description || '';
        }

        modelSelect.appendChild(option);
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏ —Å–º–µ–Ω–µ –º–æ–¥–µ–ª–∏
    modelSelect.onchange = function() {
        const selectedOption = this.options[this.selectedIndex];
        modelDescription.textContent = selectedOption.dataset.description || '';
    };
}

async function testAIConnection() {
    const testIcon = document.getElementById('test_icon');
    const testResult = document.getElementById('test_result');

    // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
    testIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>';
    testIcon.classList.add('animate-spin');
    testResult.textContent = '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...';
    testResult.className = 'mt-1 text-xs text-gray-500';

    try {
        const response = await fetch('{{ url_for("auto_import_ai_test") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const data = await response.json();

        testIcon.classList.remove('animate-spin');

        if (data.success) {
            testIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
            testResult.textContent = data.message;
            testResult.className = 'mt-1 text-xs text-green-600';
        } else {
            testIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
            testResult.textContent = data.error || '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
            testResult.className = 'mt-1 text-xs text-red-600';
        }
    } catch (e) {
        testIcon.classList.remove('animate-spin');
        testIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
        testResult.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message;
        testResult.className = 'mt-1 text-xs text-red-600';
    }
}

async function loadDefaultInstruction(type) {
    try {
        const response = await fetch('{{ url_for("auto_import_ai_instructions") }}');
        const data = await response.json();

        if (data.success && data.instructions) {
            // –ú–∞–ø–ø–∏–Ω–≥ —Ç–∏–ø–æ–≤ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã
            const instructionMapping = {
                'category_detection': 'ai_category_instruction',
                'size_parsing': 'ai_size_instruction',
                'seo_title': 'ai_seo_title_instruction',
                'keywords': 'ai_keywords_instruction',
                'bullet_points': 'ai_bullets_instruction',
                'description_enhance': 'ai_description_instruction',
                'rich_content': 'ai_rich_content_instruction',
                'card_analysis': 'ai_analysis_instruction'
            };

            const elementId = instructionMapping[type];
            if (elementId && data.instructions[type]) {
                document.getElementById(elementId).value = data.instructions[type].template;
            }
        }
    } catch (e) {
        console.error('Error loading instructions:', e);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é');
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∏—Å—Ç–æ—Ä–∏–µ–π AI –∑–∞–ø—Ä–æ—Å–æ–≤
async function showAIHistory() {
    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = document.createElement('div');
    modal.id = 'ai-history-modal';
    modal.className = 'fixed inset-0 z-50 overflow-y-auto';
    modal.innerHTML = `
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black opacity-50" onclick="closeAIHistory()"></div>
            <div class="relative bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                <div class="flex items-center justify-between p-4 border-b">
                    <h3 class="text-lg font-semibold">–ò—Å—Ç–æ—Ä–∏—è AI –∑–∞–ø—Ä–æ—Å–æ–≤</h3>
                    <button onclick="closeAIHistory()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="ai-history-content" class="p-4 overflow-y-auto max-h-[70vh]">
                    <div class="flex justify-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                    </div>
                </div>
                <div id="ai-history-pagination" class="p-4 border-t bg-gray-50"></div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    loadAIHistory(1);
}

function closeAIHistory() {
    const modal = document.getElementById('ai-history-modal');
    if (modal) modal.remove();
}

async function loadAIHistory(page) {
    try {
        const response = await fetch(`/auto-import/ai/history?page=${page}&per_page=15`);
        const data = await response.json();

        if (data.success) {
            const content = document.getElementById('ai-history-content');
            if (data.history.length === 0) {
                content.innerHTML = '<p class="text-center text-gray-500 py-8">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—É—Å—Ç–∞</p>';
            } else {
                content.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">–î–∞—Ç–∞</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">–î–µ–π—Å—Ç–≤–∏–µ</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">–¢–æ–≤–∞—Ä</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">–°—Ç–∞—Ç—É—Å</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">–í—Ä–µ–º—è</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase"></th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${data.history.map(item => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 text-sm text-gray-500">${new Date(item.created_at).toLocaleString('ru')}</td>
                                    <td class="px-3 py-2 text-sm">${item.action_type_display || item.action_type}</td>
                                    <td class="px-3 py-2 text-sm text-gray-600 truncate max-w-xs">${item.product_title || '-'}</td>
                                    <td class="px-3 py-2">
                                        <span class="px-2 py-1 text-xs rounded ${item.success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            ${item.success ? 'OK' : '–û—à–∏–±–∫–∞'}
                                        </span>
                                    </td>
                                    <td class="px-3 py-2 text-sm text-gray-500">${item.response_time_ms ? item.response_time_ms + 'ms' : '-'}</td>
                                    <td class="px-3 py-2">
                                        <button onclick="showAIHistoryDetail(${item.id})" class="text-purple-600 hover:text-purple-800 text-sm">
                                            –î–µ—Ç–∞–ª–∏
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
            const pagination = document.getElementById('ai-history-pagination');
            if (data.pagination.pages > 1) {
                pagination.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500">–í—Å–µ–≥–æ: ${data.pagination.total}</span>
                        <div class="flex gap-2">
                            ${data.pagination.has_prev ? `<button onclick="loadAIHistory(${page - 1})" class="px-3 py-1 text-sm bg-gray-200 rounded hover:bg-gray-300">–ù–∞–∑–∞–¥</button>` : ''}
                            <span class="px-3 py-1 text-sm">–°—Ç—Ä. ${page} –∏–∑ ${data.pagination.pages}</span>
                            ${data.pagination.has_next ? `<button onclick="loadAIHistory(${page + 1})" class="px-3 py-1 text-sm bg-gray-200 rounded hover:bg-gray-300">–í–ø–µ—Ä–µ–¥</button>` : ''}
                        </div>
                    </div>
                `;
            } else {
                pagination.innerHTML = `<span class="text-sm text-gray-500">–í—Å–µ–≥–æ: ${data.pagination.total}</span>`;
            }
        }
    } catch (e) {
        console.error('Error loading AI history:', e);
        document.getElementById('ai-history-content').innerHTML = '<p class="text-center text-red-500 py-8">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
    }
}

async function showAIHistoryDetail(id) {
    try {
        const response = await fetch(`/auto-import/ai/history/${id}`);
        const data = await response.json();

        if (data.success) {
            const item = data.history;
            const content = document.getElementById('ai-history-content');
            content.innerHTML = `
                <div class="space-y-4">
                    <button onclick="loadAIHistory(1)" class="text-purple-600 hover:text-purple-800 text-sm flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
                    </button>

                    <div class="grid grid-cols-2 gap-4">
                        <div><span class="text-gray-500">–î–µ–π—Å—Ç–≤–∏–µ:</span> <strong>${item.action_type_display || item.action_type}</strong></div>
                        <div><span class="text-gray-500">–î–∞—Ç–∞:</span> ${new Date(item.created_at).toLocaleString('ru')}</div>
                        <div><span class="text-gray-500">–ü—Ä–æ–≤–∞–π–¥–µ—Ä:</span> ${item.ai_provider || '-'}</div>
                        <div><span class="text-gray-500">–ú–æ–¥–µ–ª—å:</span> ${item.ai_model || '-'}</div>
                        <div><span class="text-gray-500">–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:</span> ${item.response_time_ms ? item.response_time_ms + 'ms' : '-'}</div>
                        <div><span class="text-gray-500">–¢–æ–∫–µ–Ω–æ–≤:</span> ${item.tokens_used || '-'}</div>
                    </div>

                    ${item.system_prompt ? `
                        <div>
                            <h4 class="font-medium text-gray-700 mb-1">–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç:</h4>
                            <pre class="bg-gray-100 p-3 rounded text-xs overflow-x-auto max-h-40">${escapeHtml(item.system_prompt)}</pre>
                        </div>
                    ` : ''}

                    ${item.user_prompt ? `
                        <div>
                            <h4 class="font-medium text-gray-700 mb-1">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç:</h4>
                            <pre class="bg-gray-100 p-3 rounded text-xs overflow-x-auto max-h-40">${escapeHtml(item.user_prompt)}</pre>
                        </div>
                    ` : ''}

                    ${item.raw_response ? `
                        <div>
                            <h4 class="font-medium text-gray-700 mb-1">–û—Ç–≤–µ—Ç AI:</h4>
                            <pre class="bg-gray-100 p-3 rounded text-xs overflow-x-auto max-h-60">${escapeHtml(item.raw_response)}</pre>
                        </div>
                    ` : ''}

                    ${item.error_message ? `
                        <div class="bg-red-50 p-3 rounded border border-red-200">
                            <h4 class="font-medium text-red-700 mb-1">–û—à–∏–±–∫–∞:</h4>
                            <p class="text-red-600 text-sm">${escapeHtml(item.error_message)}</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }
    } catch (e) {
        console.error('Error loading AI history detail:', e);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    updateAIProviderSettings();
    if (document.getElementById('ai_enabled').checked) {
        loadModels();
    }
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    updateImageGenProviderHint();
});

// =====================================================
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
// =====================================================

function toggleImageGenSettings() {
    const checkbox = document.getElementById('image_gen_enabled');
    const settingsBlock = document.getElementById('image_gen_settings_block');
    if (checkbox.checked) {
        settingsBlock.classList.remove('hidden');
        updateImageGenProviderHint();
    } else {
        settingsBlock.classList.add('hidden');
    }
}

function updateImageGenProviderHint() {
    const provider = document.getElementById('image_gen_provider')?.value;
    if (!provider) return;

    const togetherHint = document.getElementById('together_hint');
    const openaiHint = document.getElementById('openai_hint');
    const replicateHint = document.getElementById('replicate_hint');
    const togetherKeyBlock = document.getElementById('together_api_key_block');
    const openaiKeyBlock = document.getElementById('openai_api_key_block');
    const replicateKeyBlock = document.getElementById('replicate_api_key_block');
    const dalleSettings = document.getElementById('dalle_settings');

    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –±–ª–æ–∫–∏
    togetherHint?.classList.add('hidden');
    openaiHint?.classList.add('hidden');
    replicateHint?.classList.add('hidden');
    togetherKeyBlock?.classList.add('hidden');
    openaiKeyBlock?.classList.add('hidden');
    replicateKeyBlock?.classList.add('hidden');
    dalleSettings?.classList.add('hidden');

    if (provider === 'together_flux') {
        // Together AI
        togetherHint?.classList.remove('hidden');
        togetherKeyBlock?.classList.remove('hidden');
    } else if (provider === 'openai_dalle') {
        // OpenAI DALL-E
        openaiHint?.classList.remove('hidden');
        openaiKeyBlock?.classList.remove('hidden');
        dalleSettings?.classList.remove('hidden');
    } else {
        // Flux –∏–ª–∏ SDXL - –∏—Å–ø–æ–ª—å–∑—É—é—Ç Replicate
        replicateHint?.classList.remove('hidden');
        replicateKeyBlock?.classList.remove('hidden');
    }
}
</script>
{% endblock %}
