<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Калькулятор прибыли WB</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <div class="container-xl py-5">
      <header class="hero card shadow-lg border-0 mb-4">
        <div class="card-body d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-4">
          <div>
            <span class="badge rounded-pill bg-primary mb-3">WB отчеты</span>
            <h1 class="mb-2">Калькулятор прибыли Wildberries</h1>
            <p class="text-muted mb-0">
              Загрузите статистику WB и прайс Sexoptovik, выберите интересующие столбцы и получите актуальный расчет
              с логистикой, упаковкой и фактической маржой.
            </p>
          </div>
          {% if state.latest_output %}
          <a class="btn btn-success btn-lg shadow-sm" href="{{ url_for('download') }}">Скачать последний отчет</a>
          {% endif %}
        </div>
      </header>

      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
      <div class="toast-container position-fixed top-0 end-0 p-3">
        {% for category, message in messages %}
        <div class="toast align-items-center text-bg-{{ 'danger' if category == 'danger' else category }} show mb-2">
          <div class="d-flex">
            <div class="toast-body">
              {{ message }}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}
      {% endwith %}

      <section class="card shadow-sm border-0 mb-4">
        <div class="card-body">
          <form action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data">
            <div class="row g-4">
              <div class="col-lg-6">
                <label for="statistics" class="form-label fw-semibold">Отчет Wildberries (.xlsx)</label>
                <input class="form-control form-control-lg" type="file" name="statistics" id="statistics" accept=".xlsx,.xls" />
                {% if state.statistics_path %}
                <p class="form-text">
                  Текущий файл: <span class="fw-semibold">{{ state.statistics_path | basename }}</span>
                </p>
                {% endif %}
              </div>
              <div class="col-lg-6">
                <label for="prices" class="form-label fw-semibold">Прайс Sexoptovik (.csv)</label>
                <input class="form-control form-control-lg" type="file" name="prices" id="prices" accept=".csv" />
                {% if state.price_path %}
                <p class="form-text">
                  Текущий файл: <span class="fw-semibold">{{ state.price_path | basename }}</span>
                </p>
                {% endif %}
                <div class="d-flex flex-wrap gap-2 mt-2">
                  <button
                    class="btn btn-outline-primary btn-sm"
                    type="submit"
                    formaction="{{ url_for('refresh_price') }}"
                    formmethod="post"
                  >
                    Обновить прайс автоматически
                  </button>
                </div>
                {% if state.price_updated %}
                <p class="form-text mt-2">
                  Последнее обновление: <span class="fw-semibold">{{ state.price_updated | replace('T', ' ') }}</span>
                </p>
                {% endif %}
              </div>
            </div>

            <div class="mt-4">
              <label class="form-label fw-semibold">Колонки итогового отчета</label>
              {% if available_columns %}
              <select
                class="form-select"
                name="columns"
                id="columns"
                multiple
                size="{{ available_columns|length if (available_columns|length) < 12 else 12 }}"
              >
                {% for column in available_columns %}
                <option value="{{ column }}" {% if column in selected_columns %}selected{% endif %}>
                  {{ column }}
                </option>
                {% endfor %}
              </select>
              <div class="form-text">
                По умолчанию подставляются столбцы A–AH и AK. Удерживайте Ctrl / Cmd для множественного выбора.
              </div>
              {% else %}
              <div class="alert alert-warning mb-0">
                Сначала загрузите отчет Wildberries, чтобы выбрать необходимые столбцы.
              </div>
              {% endif %}
            </div>

            <div class="d-flex justify-content-end gap-3 mt-4">
              <button type="submit" class="btn btn-primary btn-lg shadow-sm">
                Пересчитать прибыль
              </button>
            </div>
          </form>
        </div>
      </section>

      <section class="row g-4 align-items-stretch">
        <div class="col-xxl-4 col-lg-5">
          <div class="card h-100 shadow-sm border-0">
            <div class="card-body">
              <h2 class="h5 fw-semibold mb-3">Статус файлов</h2>
              <ul class="list-group list-group-flush rounded-3 overflow-hidden">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  Отчет Wildberries
                  <span class="badge bg-{{ 'success' if statistics_ready else 'secondary' }}">
                    {{ 'Загружен' if statistics_ready else 'Нет файла' }}
                  </span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  Прайс Sexoptovik
                  <span class="badge bg-{{ 'success' if price_ready else 'secondary' }}">
                    {{ 'Загружен' if price_ready else 'Нет файла' }}
                  </span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  Итоговый отчет
                  <span class="badge bg-{{ 'success' if state.latest_output else 'secondary' }}">
                    {% if state.latest_output %}
                    Готов ({{ state.latest_output | basename }})
                    {% else %}
                    Нет
                    {% endif %}
                  </span>
                </li>
                {% if last_processed %}
                <li class="list-group-item">
                  Последняя обработка: <strong>{{ last_processed | replace('T', ' ') }}</strong>
                </li>
                {% endif %}
              </ul>

              {% if summary %}
              <hr class="my-4" />
              <h3 class="h6 text-uppercase text-muted mb-3">Сводка по прибыли</h3>
              <div class="summary-grid">
                <div class="summary-card">
                  <span>Начислено ВБ (к оплате)</span>
                  <strong>{{ "{:,.2f}".format(summary.total_revenue).replace(',', ' ') }} ₽</strong>
                </div>
                <div class="summary-card">
                  <span>К перечислению за товар</span>
                  <strong>{{ "{:,.2f}".format(summary.wb_total).replace(',', ' ') }} ₽</strong>
                </div>
                <div class="summary-card">
                  <span>Себестоимость</span>
                  <strong>{{ "{:,.2f}".format(summary.total_cost).replace(',', ' ') }} ₽</strong>
                </div>
                <div class="summary-card highlight">
                  <span>Прибыль</span>
                  <strong>{{ "{:,.2f}".format(summary.total_profit).replace(',', ' ') }} ₽</strong>
                </div>
                <div class="summary-card">
                  <span>Наша доля (33%)</span>
                  <strong>{{ "{:,.2f}".format(summary.our_share).replace(',', ' ') }} ₽</strong>
                </div>
                <div class="summary-card">
                  <span>Логистика</span>
                  <strong>{{ "{:,.2f}".format(summary.logistics_total).replace(',', ' ') }} ₽</strong>
                </div>
                <div class="summary-card">
                  <span>Штрафы</span>
                  <strong>{{ "{:,.2f}".format(summary.fines_total).replace(',', ' ') }} ₽</strong>
                </div>
                <div class="summary-card">
                  <span>Хранение</span>
                  <strong>{{ "{:,.2f}".format(summary.storage_total).replace(',', ' ') }} ₽</strong>
                </div>
                <div class="summary-card">
                  <span>Упаковка</span>
                  <strong>{{ "{:,.2f}".format(summary.packaging_total).replace(',', ' ') }} ₽</strong>
                </div>
                <div class="summary-card">
                  <span>Количество</span>
                  <strong>{{ "{:,.0f}".format(summary.total_qty).replace(',', ' ') }}</strong>
                </div>
                <div class="summary-card">
                  <span>Маржа</span>
                  <strong>{{ "{:,.2f}".format(summary.avg_margin).replace(',', ' ') }}%</strong>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col-xxl-8 col-lg-7">
          <div class="card h-100 shadow-sm border-0">
            <div class="card-body">
              <h2 class="h5 fw-semibold d-flex justify-content-between align-items-center">
                Превью статистики
                <span class="badge rounded-pill bg-primary">{{ preview_rows|length }} строк</span>
              </h2>
              {% if preview_rows %}
              <div class="table-responsive preview-table mt-3">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      {% for column in preview_rows[0].keys() %}
                      <th scope="col">{{ column }}</th>
                      {% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in preview_rows %}
                    <tr>
                      {% for value in row.values() %}
                      <td>{{ value }}</td>
                      {% endfor %}
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% else %}
              <p class="text-muted mb-0">
                Загрузите отчет Wildberries, чтобы увидеть первые строки и проверить выбранные колонки.
              </p>
              {% endif %}
            </div>
          </div>
        </div>
      </section>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-sC20K36lwDZJSh/3LMGQpAf7O6elJzifnT6+cs4xKqyXSOF8+5kPxy4vfyc3Bmw/"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
