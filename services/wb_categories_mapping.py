"""
Полный маппинг категорий WB для товаров для взрослых
Основано на официальном API WB
"""

# Полный список категорий WB для взрослых (parentID=5038)
# Обновлено из WB API: 119 категорий
WB_ADULT_CATEGORIES = {
    7732: "Аксессуары для игрушек эротик",
    5065: "Анальные бусы",
    5193: "Анальные груши",
    5068: "Анальные крюки",
    5064: "Анальные пробки",
    5066: "Анальные шарики",
    5784: "Ароматизаторы эротик",
    5051: "Бандажи эротик",
    5783: "Благовония эротик",
    2602: "Боди эротик",
    5049: "Браслеты эротик",
    2603: "Бюстгальтеры эротик",
    5293: "Вагинальные тренажеры",
    5072: "Вагинальные шарики",
    5576: "Вакуумно-волновые стимуляторы",
    5073: "Вакуумные помпы эротик",
    5121: "Веревки для бондажа",
    5067: "Вибраторы",
    5116: "Вибропули",
    5129: "Вибротрусики",
    5118: "Виброяйца",
    5948: "Возбуждающие напитки",
    5478: "Возбуждающие препараты",
    5779: "Возбуждающие средства",
    5042: "Галстуки эротик",
    5052: "Гартеры эротик",
    5075: "Гидропомпы эротик",
    5039: "Головные уборы эротик",
    5043: "Гольфы эротик",
    2604: "Грации эротик",
    5789: "Дезодоранты эротик",
    5076: "Зажимы для сосков",
    6296: "Запчасти для секс машины",
    5292: "Имитаторы груди",
    5153: "Календари эротические",
    5025: "Кляпы эротик",
    2605: "Колготки эротик",
    5119: "Колеса Вартенберга",
    2606: "Комбинезоны эротик",
    5026: "Комплекты БДСМ",
    2607: "Комплекты эротик",
    5772: "Концентраты феромонов",
    2608: "Корсеты эротик",
    2609: "Леггинсы эротик",
    5482: "Леденцы эротик",
    5040: "Ленты эротик",
    2909: "Лубриканты",
    5044: "Манжеты эротик",
    7034: "Мармелад эротик",
    5023: "Маски эротик",
    5117: "Массажеры простаты",
    5812: "Массажные средства эротик",
    5070: "Мастурбаторы мужские",
    5668: "Мыло эротик",
    5158: "Наборы игрушек для взрослых",
    2610: "Накидки эротик",
    5021: "Наручники эротик",
    5294: "Насадки для вибраторов",
    6302: "Насадки на мастурбатор",
    5085: "Насадки на страпон",
    5091: "Насадки на член",
    5080: "Насосы для секс кукол",
    5086: "Насосы на член",
    4751: "Настольные игры для взрослых",
    5156: "Настольные игры эротик",
    2611: "Неглиже эротик",
    5083: "Оковы эротик",
    5019: "Ошейники эротик",
    2612: "Пеньюары эротик",
    5041: "Перчатки эротик",
    6939: "Печенье эротик",
    2613: "Платья эротик",
    5020: "Плетки эротик",
    6412: "Поводки эротик",
    5037: "Подвязки эротик",
    5046: "Подушки эротик",
    7755: "Помады эротик",
    3392: "Портупеи эротик",
    6062: "Посуда эротик",
    5084: "Пояса верности",
    2614: "Пояса эротик",
    7733: "Приспособления для интимной косметики",
    5780: "Пролонгаторы",
    5074: "Простыни БДСМ",
    5159: "Пульсаторы",
    5132: "Пэстис эротик",
    5289: "Расширители гинекологические",
    5298: "Ролевые костюмы эротик",
    5087: "Руки для фистинга",
    5295: "Свечи БДСМ",
    5880: "Свечи эротик",
    5127: "Секс качели",
    5128: "Секс кресла",
    5082: "Секс куклы",
    6217: "Секс машины",
    6304: "Секс мячи",
    7575: "Слепки эротик",
    5194: "Спринцовки эротик",
    5197: "Средства для очистки секс-игрушек",
    5813: "Средства с феромонами",
    5089: "Стопы для фистинга",
    5071: "Страпоны",
    5050: "Стрэпы эротик",
    5126: "Стэки эротик",
    5296: "Сувениры эротик",
    6303: "Сумки для секс машины",
    2615: "Топы эротик",
    5297: "Трусы для страпона",
    2596: "Трусы эротик",
    5340: "Увеличители члена",
    5047: "Указки эротик",
    5288: "Уретральные зонды",
    5088: "Утяжелители эротик",
    5814: "Уходовые средства эротик",
    5069: "Фаллоимитаторы",
    5122: "Фаллопротезы",
    5150: "Фиксаторы эротик",
    5048: "Чокеры эротик",
    2616: "Чулки эротик",
    5120: "Шлепалки эротик",
    2617: "Шорты эротик",
    5045: "Щеточки эротик",
    5125: "Электростимуляторы",
    5090: "Эрекционные кольца",
    2618: "Юбки эротик",
    # Из категории "Здоровье" (parentID=4268)
    2865: "Презервативы",
}

# Расширенный маппинг: ключевые слова -> WB category
CATEGORY_KEYWORDS_MAPPING = {
    # Анальные игрушки
    'анальные бусы': 5065,
    'анальные груши': 5193,
    'анальная груша': 5193,
    'анальные крюки': 5068,
    'анальный крюк': 5068,
    'анальные пробки': 5064,
    'анальная пробка': 5064,
    'пробка': 5064,
    'втулка': 5064,
    'анальные шарики': 5066,
    'анальный шарик': 5066,

    # Вибраторы и стимуляторы
    'вибратор': 5067,
    'вибраторы': 5067,
    'вибропуля': 5116,
    'вибропули': 5116,
    'виброкольцо': 5067,  # Может быть отдельная категория
    'вибротрусики': 5129,
    'виброяйцо': 5118,
    'виброяйца': 5118,
    'вакуумно-волновой': 5576,
    'вакуумный стимулятор': 5576,
    'волновой стимулятор': 5576,
    'клиторальный стимулятор': 5576,

    # Вагинальные игрушки
    'вагинальные шарики': 5072,
    'вагинальный шарик': 5072,
    'шарики': 5072,
    'вагинальные тренажеры': 5293,
    'вагинальный тренажер': 5293,
    'тренажер кегеля': 5293,

    # Вакуумные помпы
    'вакуумная помпа': 5073,
    'вакуумные помпы': 5073,
    'помпа': 5073,
    'гидропомпа': 5075,
    'гидропомпы': 5075,

    # Белье
    'боди': 2602,
    'бюстгальтер': 2603,
    'лифчик': 2603,
    'грация': 2604,
    'бандаж': 5051,
    'гартер': 5052,
    'гартеры': 5052,
    'пояс для чулок': 5052,
    'галстук': 5042,
    'гольфы': 5043,
    'головной убор': 5039,

    # БДСМ
    'веревка для бондажа': 5121,
    'веревки для бондажа': 5121,
    'веревка': 5121,
    'канат': 5121,
    'браслет': 5049,
    'браслеты': 5049,

    # Средства и препараты
    'ароматизатор': 5784,
    'ароматизаторы': 5784,
    'благовоние': 5783,
    'благовония': 5783,
    'возбуждающий напиток': 5948,
    'возбуждающие напитки': 5948,
    'возбуждающий препарат': 5478,
    'возбуждающие препараты': 5478,
    'возбуждающее средство': 5779,
    'возбуждающие средства': 5779,
    'презерватив': 2865,
    'презервативы': 2865,

    # Аксессуары
    'аксессуар для игрушек': 7732,
    'аксессуары для игрушек': 7732,

    # Мастурбаторы
    'мастурбатор': 5070,
    'мастурбаторы': 5070,
    'мастурбатор мужской': 5070,
    'насадка на мастурбатор': 6302,
    'насадки на мастурбатор': 6302,

    # Белье дополнительное
    'колготки': 2605,
    'комбинезон': 2606,
    'корсет': 2608,
    'леггинсы': 2609,
    'неглиже': 2611,
    'накидка': 2610,
    'чулки': 2616,
    'топ': 2615,
    'юбка': 2618,
    'шорты': 2617,
    'пеньюар': 2612,
    'пояс': 2614,

    # БДСМ дополнительно
    'кляп': 5025,
    'манжета': 5044,
    'манжеты': 5044,
    'маска': 5023,
    'маски': 5023,
    'оковы': 5083,
    'поводок': 6412,
    'поводки': 6412,
    'ошейник': 5019,
    'ошейники': 5019,
    'наручники': 5021,
    'плетка': 5020,
    'плетки': 5020,
    'стек': 5126,
    'стеки': 5126,
    'шлепалка': 5120,
    'шлепалки': 5120,
    'фиксатор': 5150,
    'фиксаторы': 5150,
    'комплект бдсм': 5026,

    # Специализированные игрушки
    'массажер простаты': 5117,
    'простата': 5117,
    'пульсатор': 5159,
    'пульсаторы': 5159,
    'электростимулятор': 5125,
    'электростимуляторы': 5125,
    'фаллопротез': 5122,
    'фаллопротезы': 5122,
    'фаллоимитатор': 5069,
    'фаллоимитаторы': 5069,
    'эрекционное кольцо': 5090,
    'эрекционные кольца': 5090,
    'зажим для сосков': 5076,
    'зажимы для сосков': 5076,
    'зажимы': 5076,

    # Страпоны
    'страпон': 5071,
    'страпоны': 5071,
    'насадка на страпон': 5085,
    'насадки на страпон': 5085,
    'трусы для страпона': 5297,
    'насадка на член': 5091,
    'насадки на член': 5091,

    # Смазки и средства
    'лубрикант': 2909,
    'лубриканты': 2909,
    'пролонгатор': 5780,
    'пролонгаторы': 5780,
    'средства для очистки': 5197,
    'очиститель': 5197,
    'массажное средство': 5812,
    'массажное масло': 5812,
    'феромоны': 5813,
    'средства с феромонами': 5813,

    # Куклы и машины
    'секс кукла': 5082,
    'секс куклы': 5082,
    'кукла': 5082,
    'секс машина': 6217,
    'секс машины': 6217,
    'секс качели': 5127,
    'качели': 5127,
    'секс кресло': 5128,
    'секс кресла': 5128,
    'насос для куклы': 5080,

    # Игры и костюмы
    'настольная игра': 5156,
    'настольные игры': 5156,
    'ролевой костюм': 5298,
    'ролевые костюмы': 5298,
    'костюм': 5298,
    'сувенир': 5296,
    'сувениры': 5296,

    # Аксессуары дополнительно
    'спринцовка': 5194,
    'спринцовки': 5194,
    'расширитель': 5289,
    'расширители': 5289,
    'зонд': 5288,
    'уретральный зонд': 5288,
    'рука для фистинга': 5087,
    'увеличитель члена': 5340,
    'имитатор груди': 5292,
    'перчатки': 5041,
    'чокер': 5048,
    'чокеры': 5048,
    'портупея': 3392,
    'портупеи': 3392,
    'пэстис': 5132,
    'подушка': 5046,
    'свеча': 5880,
    'свечи': 5880,
}

# Маппинг по точным совпадениям категорий из CSV (sexoptovik)
CSV_TO_WB_EXACT_MAPPING = {
    # Анальные
    'Анальные стимуляторы и пробки': 5064,
    'Анальные стимуляторы': 5064,  # Добавлено
    'Анальные пробки': 5064,
    'Анальные пробки, втулки': 5064,
    'Анальные бусы': 5065,
    'Анальные груши': 5193,
    'Анальные шарики': 5066,
    'Анальные крюки': 5068,  # Добавлено

    # Вибраторы
    'Вибраторы и фаллоимитаторы': 5067,
    'Вибраторы': 5067,
    'Нереалистичные': 5067,
    'Реалистичные': 5067,
    'С вибрацией': 5067,
    'Классические': 5067,
    'Точки G': 5067,
    'Фаллоимитаторы': 5067,  # Добавлено

    # Женские стимуляторы
    'Женские стимуляторы': 5576,
    'Клиторальные стимуляторы': 5576,
    'Вакуумные стимуляторы': 5576,
    'Вакуумно-волновые стимуляторы': 5576,  # Добавлено

    # Вагинальные
    'Вагинальные шарики': 5072,
    'Вагинальные тренажеры': 5293,

    # Виброяйца и пули
    'Виброяйца': 5118,
    'Вибропули': 5116,
    'Вибротрусики': 5129,  # Добавлено

    # Помпы
    'Вакуумные помпы': 5073,
    'Помпы': 5073,
    'Гидропомпы': 5075,  # Добавлено

    # Белье
    'Эротическое белье для женщин': 2602,
    'Боди, ками, корсаж': 2602,
    'Боди': 2602,  # Добавлено
    'Пеньюары, сорочки, пижамы': 2602,
    'Трусики': 2602,
    'Бюстгальтеры': 2603,
    'Платья, мини-платья': 2602,  # Добавлено - платья относятся к боди эротик
    'Платья': 2602,  # Добавлено
    'Мини-платья': 2602,  # Добавлено
    'Грации': 2604,  # Добавлено
    'Гартеры': 5052,  # Добавлено
    'Гольфы': 5043,  # Добавлено
    'Головные уборы': 5039,  # Добавлено
    'Галстуки': 5042,  # Добавлено

    # БДСМ
    'БДСМ товары и фетиш': 5121,
    'Плетки, стеки, шлепалки': 5121,
    'Плетки': 5121,  # Добавлено
    'Стеки': 5121,  # Добавлено
    'Маски, шлемы': 5039,
    'Маски': 5039,  # Добавлено
    'Шлемы': 5039,  # Добавлено
    'Ошейники, поводки': 5049,
    'Ошейники': 5049,  # Добавлено
    'Поводки': 5049,  # Добавлено
    'Наручники, фиксаторы': 5049,
    'Наручники': 5049,  # Добавлено
    'Фиксаторы': 5049,  # Добавлено
    'Браслеты': 5049,  # Добавлено
    'Веревки для бондажа': 5121,  # Добавлено

    # Смазки и гели
    'Смазки и гели': 5779,
    'Смазки': 5779,  # Добавлено
    'Гели': 5779,  # Добавлено
    'Возбуждающие': 5779,
    'Возбуждающие средства': 5779,  # Добавлено
    'Возбуждающие препараты': 5478,  # Добавлено
    'Возбуждающие напитки': 5948,  # Добавлено

    # Презервативы и средства
    'Презервативы': 2865,
    'Ароматизаторы': 5784,  # Добавлено
    'Благовония': 5783,  # Добавлено

    # Мастурбаторы
    'Мастурбаторы': 5070,
    'Мастурбаторы мужские': 5070,
    'Насадки на мастурбатор': 6302,

    # Наборы
    'Секс-наборы': 7732,  # Аксессуары для игрушек
    'Наборы': 7732,  # Аксессуары для игрушек
    'Наборы игрушек для взрослых': 5158,

    # Дополнительное белье
    'Колготки': 2605,
    'Комбинезоны': 2606,
    'Корсеты': 2608,
    'Леггинсы': 2609,
    'Неглиже': 2611,
    'Накидки': 2610,
    'Чулки': 2616,
    'Топы': 2615,
    'Юбки': 2618,
    'Шорты': 2617,
    'Комплекты': 2607,

    # БДСМ дополнительно
    'Кляпы': 5025,
    'Комплекты БДСМ': 5026,
    'Манжеты': 5044,
    'Оковы': 5083,
    'Поводки': 6412,
    'Подушки': 5046,
    'Свечи БДСМ': 5295,
    'Простыни БДСМ': 5074,
    'Фиксаторы БДСМ': 5150,

    # Игрушки специализированные
    'Массажеры простаты': 5117,
    'Пульсаторы': 5159,
    'Электростимуляторы': 5125,
    'Фаллопротезы': 5122,
    'Фаллоимитаторы': 5069,
    'Эрекционные кольца': 5090,
    'Насадки на страпон': 5085,
    'Страпоны': 5071,
    'Трусы для страпона': 5297,
    'Насадки на член': 5091,
    'Зажимы для сосков': 5076,
    'Увеличители члена': 5340,

    # Смазки и средства дополнительно
    'Лубриканты': 2909,
    'Пролонгаторы': 5780,
    'Средства для очистки секс-игрушек': 5197,
    'Средства для очистки': 5197,
    'Массажные средства': 5812,
    'Средства с феромонами': 5813,
    'Концентраты феромонов': 5772,

    # Куклы и машины
    'Секс куклы': 5082,
    'Секс машины': 6217,
    'Секс качели': 5127,
    'Секс кресла': 5128,
    'Секс мячи': 6304,
    'Насосы для секс кукол': 5080,
    'Запчасти для секс машины': 6296,
    'Сумки для секс машины': 6303,

    # Игры и сувениры
    'Настольные игры': 5156,
    'Настольные игры для взрослых': 4751,
    'Ролевые костюмы': 5298,
    'Костюмы': 5298,
    'Сувениры': 5296,
    'Календари': 5153,

    # Специальные аксессуары
    'Спринцовки': 5194,
    'Расширители': 5289,
    'Расширители гинекологические': 5289,
    'Уретральные зонды': 5288,
    'Руки для фистинга': 5087,
    'Стопы для фистинга': 5089,
    'Имитаторы груди': 5292,
    'Слепки': 7575,

    # Еда и косметика
    'Леденцы': 5482,
    'Мармелад': 7034,
    'Печенье': 6939,
    'Мыло': 5668,
    'Свечи': 5880,
    'Дезодоранты': 5789,
    'Помады': 7755,
    'Посуда': 6062,

    # Аксессуары дополнительно
    'Перчатки': 5041,
    'Чокеры': 5048,
    'Портупеи': 3392,
    'Пэстис': 5132,
    'Ленты': 5040,
    'Указки': 5047,
    'Щеточки': 5045,
    'Колеса Вартенберга': 5119,
    'Утяжелители': 5088,
    'Пояса верности': 5084,
    'Приспособления для интимной косметики': 7733,
}


def get_best_category_match(csv_category: str, product_title: str = '', all_categories: list = None,
                           external_id: str = None, source_type: str = 'sexoptovik') -> tuple:
    """
    Определяет наилучшее совпадение категории WB

    Приоритет определения (от высшего к низшему):
    1. Ручные исправления для конкретного товара (по external_id)
    2. Ручные исправления для категории
    3. Точное совпадение с CSV категориями
    4. Проверка всех категорий из цепочки
    5. Поиск по ключевым словам в категории
    6. Поиск по ключевым словам в названии товара
    7. Дефолт - общая категория "Товары для взрослых"

    Args:
        csv_category: Основная категория из CSV
        product_title: Название товара
        all_categories: Все категории товара (список)
        external_id: ID товара из внешнего источника
        source_type: Тип источника (sexoptovik и т.д.)

    Returns:
        (subject_id, subject_name, confidence)
    """

    # 0. Проверяем ручные исправления для конкретного товара (наивысший приоритет)
    if external_id:
        try:
            from models import ProductCategoryCorrection, db
            correction = ProductCategoryCorrection.query.filter_by(
                external_id=external_id,
                source_type=source_type
            ).first()

            if correction:
                return (
                    correction.corrected_wb_subject_id,
                    correction.corrected_wb_subject_name or WB_ADULT_CATEGORIES.get(correction.corrected_wb_subject_id, 'Unknown'),
                    1.0  # Максимальная уверенность для ручных исправлений
                )
        except Exception:
            # Если не можем проверить (например, вне контекста Flask), пропускаем
            pass

    # 1. Проверяем ручные исправления для категории
    if csv_category:
        try:
            from models import ProductCategoryCorrection, db
            # Ищем самое свежее исправление для этой категории
            correction = ProductCategoryCorrection.query.filter_by(
                original_category=csv_category,
                source_type=source_type
            ).order_by(ProductCategoryCorrection.created_at.desc()).first()

            if correction:
                return (
                    correction.corrected_wb_subject_id,
                    correction.corrected_wb_subject_name or WB_ADULT_CATEGORIES.get(correction.corrected_wb_subject_id, 'Unknown'),
                    0.98  # Очень высокая уверенность
                )
        except Exception:
            pass

    # 2. Точное совпадение с CSV категориями
    if csv_category in CSV_TO_WB_EXACT_MAPPING:
        subject_id = CSV_TO_WB_EXACT_MAPPING[csv_category]
        return subject_id, WB_ADULT_CATEGORIES[subject_id], 0.95

    # 3. Проверяем все категории из цепочки
    if all_categories:
        for cat in all_categories:
            if cat in CSV_TO_WB_EXACT_MAPPING:
                subject_id = CSV_TO_WB_EXACT_MAPPING[cat]
                return subject_id, WB_ADULT_CATEGORIES[subject_id], 0.90

    # 4. Поиск по ключевым словам в категории
    csv_lower = csv_category.lower() if csv_category else ''
    best_match = None
    best_score = 0.0

    for keyword, subject_id in CATEGORY_KEYWORDS_MAPPING.items():
        if keyword in csv_lower:
            # Чем длиннее совпадение, тем выше score
            score = len(keyword) / len(csv_lower) if len(csv_lower) > 0 else 0
            if score > best_score:
                best_score = score
                best_match = (subject_id, WB_ADULT_CATEGORIES.get(subject_id, 'Unknown'), min(score * 0.85, 0.85))

    if best_match and best_score > 0.3:
        return best_match

    # 5. Поиск по ключевым словам в названии товара
    if product_title:
        title_lower = product_title.lower()
        title_match = None
        title_score = 0.0

        for keyword, subject_id in CATEGORY_KEYWORDS_MAPPING.items():
            if keyword in title_lower:
                score = 0.75  # Ниже уверенность при определении по названию
                if score > title_score:
                    title_score = score
                    title_match = (subject_id, WB_ADULT_CATEGORIES.get(subject_id, 'Unknown'), score)

        if title_match and title_score > 0.5:
            return title_match

    # 6. Дефолт - общая категория "Товары для взрослых" (низкая уверенность)
    return 5038, 'Товары для взрослых', 0.3
